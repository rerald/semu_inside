<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>아바타 상점 - 세무인사이드</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .shop-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .shop-header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .shop-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" fill="white" opacity="0.1"><polygon points="0,100 100,0 200,50 300,0 400,30 500,0 600,20 700,0 800,40 900,0 1000,20 1000,100"/></svg>');
            background-size: cover;
        }

        .shop-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .shop-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .user-info {
            background: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .user-points {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }

        .points-badge {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(255, 140, 0, 0.3);
        }

        .shop-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-button.active {
            color: #007bff;
            background: white;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #007bff, #0056b3);
        }

        .tab-content {
            padding: 30px;
            min-height: 500px;
        }

        .tab-content.hidden {
            display: none;
        }

        .items-grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)) !important;
            gap: 25px !important;
            margin-top: 20px !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .item-card {
            background: white !important;
            border-radius: 15px !important;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important;
            overflow: hidden !important;
            transition: all 0.3s ease !important;
            border: 1px solid #e9ecef !important;
            position: relative !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            min-height: 350px !important;
        }

        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .item-card.highlighted {
            border: 3px solid #007bff;
            box-shadow: 0 20px 40px rgba(0, 123, 255, 0.3);
            animation: highlight-pulse 2s ease-in-out infinite;
        }

        @keyframes highlight-pulse {
            0%, 100% { 
                box-shadow: 0 20px 40px rgba(0, 123, 255, 0.3);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 25px 50px rgba(0, 123, 255, 0.5);
                transform: scale(1.02);
            }
        }

        .admin-preview-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .item-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .item-image img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .rarity-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .rarity-common { background: #6c757d; color: white; }
        .rarity-uncommon { background: #28a745; color: white; }
        .rarity-rare { background: #007bff; color: white; }
        .rarity-epic { background: #6f42c1; color: white; }
        .rarity-legendary { background: #ffc107; color: #212529; }

        .item-info {
            padding: 20px;
        }

        .item-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #212529;
        }

        .item-description {
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 15px;
        }

        .item-price {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .price-display {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ff6b6b;
        }

        .buy-button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .buy-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 123, 255, 0.3);
        }

        .buy-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .owned-badge {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .inventory-item {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 1px solid #e9ecef;
            position: relative;
        }

        .inventory-item.active {
            border: 3px solid #007bff;
            box-shadow: 0 5px 20px rgba(0, 123, 255, 0.3);
        }

        .inventory-image {
            width: 100%;
            height: 150px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .inventory-image img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
        }

        .inventory-info {
            padding: 15px;
            text-align: center;
        }

        .equip-button {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .equip-button.equipped {
            background: #6c757d;
            cursor: default;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.1rem;
            color: #6c757d;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .back-button {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(108, 117, 125, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #495057;
        }

        .empty-state p {
            font-size: 1rem;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .shop-container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .shop-header {
                padding: 20px;
            }
            
            .shop-title {
                font-size: 2rem;
            }
            
            .user-info {
                padding: 15px 20px;
                flex-direction: column;
                align-items: stretch;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .items-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        /* 구매 확인 모달 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            text-align: center;
        }

        .modal h3 {
            color: #212529;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .modal p {
            color: #6c757d;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-button {
            padding: 10px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .confirm-button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .cancel-button {
            background: #6c757d;
            color: white;
        }
    </style>
</head>
<body>
    <div class="shop-container">
        <!-- 헤더 -->
        <div class="shop-header">
            <h1 class="shop-title">🎭 아바타 상점</h1>
            <p class="shop-subtitle">나만의 특별한 아바타를 선택하세요!</p>
        </div>

        <!-- 사용자 정보 -->
        <div class="user-info">
            <div class="user-points">
                <span>💰 내 포인트:</span>
                <div class="points-badge" id="userPointsDisplay">
                    로딩 중...
                </div>
            </div>
            <a href="profile.html" class="back-button">
                ← 프로필로 돌아가기
            </a>
        </div>

        <!-- 탭 네비게이션 -->
        <div class="shop-tabs">
            <button class="tab-button active" onclick="switchTab('shop')">
                🛒 상점
            </button>
            <button class="tab-button" onclick="switchTab('inventory')">
                👤 내 아바타
            </button>
        </div>

        <!-- 상점 탭 -->
        <div id="shop-tab" class="tab-content">
            <div id="shop-loading" class="loading">
                아바타 상품을 불러오는 중입니다...
            </div>
            <div id="shop-items" class="items-grid">
                <!-- 아바타 아이템들이 여기에 동적으로 로드됩니다 -->
            </div>
        </div>

        <!-- 인벤토리 탭 -->
        <div id="inventory-tab" class="tab-content hidden">
            <div id="inventory-loading" class="loading">
                내 아바타를 불러오는 중입니다...
            </div>
            <div id="inventory-items" class="inventory-grid" style="display: none;">
                <!-- 보유한 아바타들이 여기에 동적으로 로드됩니다 -->
            </div>
        </div>
    </div>

    <!-- 구매 확인 모달 -->
    <div id="purchaseModal" class="modal">
        <div class="modal-content">
            <h3>아바타 구매 확인</h3>
            <p id="purchaseModalText"></p>
            <div class="modal-buttons">
                <button class="modal-button confirm-button" onclick="confirmPurchase()">
                    구매하기
                </button>
                <button class="modal-button cancel-button" onclick="closePurchaseModal()">
                    취소
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="assets/js/common.js"></script>
    <script>
        class AvatarShop {
            constructor() {
                this.currentUser = null;
                this.userPoints = 0;
                this.avatarItems = [];
                this.userAvatars = [];
                this.currentActiveAvatar = null;
                this.selectedPurchaseItem = null;
                
                this.init();
            }

            async init() {
                try {
                    console.log('🛒 아바타 상점 초기화 시작');
                    
                    // SemuApp 초기화 대기
                    await this.waitForSemuApp();
                    
                    // 사용자 인증 확인
                    await this.checkAuth();
                    
                    // 데이터 로드
                    await this.loadUserPoints();
                    await this.loadAvatarItems();
                    await this.loadUserAvatars();
                    
                    console.log('✅ 아바타 상점 초기화 완료');
            
            // 강제 표시 보장
            setTimeout(() => {
                this.forceDisplayAvatars();
            }, 1000);
                    
                } catch (error) {
                    console.error('❌ 아바타 상점 초기화 실패:', error);
                    
                    // 오류 메시지 표시
                    const shopLoading = document.getElementById('shop-loading');
                    const inventoryLoading = document.getElementById('inventory-loading');
                    
                    const errorMessage = `
                        <div class="empty-state">
                            <h3>❌ 초기화 오류</h3>
                            <p>${error.message || '아바타 상점을 불러오는데 실패했습니다.'}</p>
                            <button onclick="location.reload()" class="modal-button confirm-button">
                                페이지 새로고침
                            </button>
                        </div>
                    `;
                    
                    if (shopLoading) shopLoading.innerHTML = errorMessage;
                    if (inventoryLoading) inventoryLoading.innerHTML = errorMessage;
                }
            }

            async waitForSemuApp() {
                let attempts = 0;
                const maxAttempts = 100; // 10초 타임아웃
                
                while (attempts < maxAttempts) {
                    // SemuApp과 supabaseClient가 모두 존재하고, 초기화가 완료된 상태인지 확인
                    if (window.semuApp && 
                        window.semuApp.supabaseClient && 
                        window.semuApp.initComplete !== false) {
                        
                        console.log('✅ SemuApp 초기화 완료 확인');
                        
                        // 추가로 checkAuthState가 실행되었는지 확인
                        if (attempts > 10) { // 최소 1초는 대기
                            // 인증 상태를 한번 더 확인
                            try {
                                await window.semuApp.checkAuthState();
                            } catch (error) {
                                console.warn('⚠️ 인증 상태 재확인 중 오류:', error);
                            }
                        }
                        
                        return;
                    }
                    
                    console.log(`⏳ SemuApp 초기화 대기 중... (${attempts + 1}/${maxAttempts})`);
                    if (window.semuApp) {
                        console.log('   - SemuApp 존재:', !!window.semuApp);
                        console.log('   - supabaseClient 존재:', !!window.semuApp.supabaseClient);
                        console.log('   - currentUser 존재:', !!window.semuApp.currentUser);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                // 타임아웃 발생 시 수동 초기화 시도
                console.warn('⚠️ SemuApp 초기화 타임아웃, 수동 초기화 시도');
                
                if (!window.semuApp) {
                    // SemuApp이 없으면 생성
                    window.semuApp = new SemuApp();
                    await window.semuApp.init();
                }
                
                if (!window.semuApp.supabaseClient) {
                    console.error('❌ Supabase 클라이언트 초기화 실패');
                    throw new Error('Supabase 연결에 실패했습니다. 페이지를 새로고침해주세요.');
                }
            }

            async checkAuth() {
                console.log('🔍 사용자 인증 상태 확인 중...');
                
                // SemuApp의 현재 사용자 정보 확인
                this.currentUser = window.semuApp.currentUser;
                console.log('📋 SemuApp.currentUser:', this.currentUser);
                
                // 만약 currentUser가 없다면, Supabase 세션에서 직접 확인
                if (!this.currentUser) {
                    console.log('⚠️ SemuApp.currentUser가 없음, Supabase 세션 직접 확인');
                    
                    try {
                        const { data: { session }, error } = await window.semuApp.supabaseClient.auth.getSession();
                        
                        if (error) {
                            console.error('❌ 세션 조회 실패:', error);
                            throw error;
                        }
                        
                        if (session && session.user) {
                            console.log('✅ Supabase 세션에서 사용자 발견:', session.user.email);
                            
                            // 프로필 정보 조회
                            const { data: profile, error: profileError } = await window.semuApp.supabaseClient
                                .from('profiles')
                                .select('*')
                                .eq('id', session.user.id)
                                .single();
                            
                            if (profileError) {
                                console.error('❌ 프로필 조회 실패:', profileError);
                                throw profileError;
                            }
                            
                            // currentUser 설정
                            this.currentUser = {
                                id: session.user.id,
                                email: session.user.email,
                                ...profile
                            };
                            
                            // SemuApp의 currentUser도 업데이트
                            window.semuApp.currentUser = this.currentUser;
                            
                            console.log('✅ 사용자 정보 복원 완료:', this.currentUser.email);
                        } else {
                            console.log('❌ 유효한 세션이 없음');
                            throw new Error('로그인 세션이 만료되었습니다.');
                        }
                    } catch (error) {
                        console.error('❌ 사용자 인증 실패:', error);
                        alert('로그인이 필요합니다.');
                        window.location.href = 'login.html';
                        return;
                    }
                }
                
                console.log('✅ 사용자 인증 확인:', this.currentUser.email);
            }

            async loadUserPoints() {
                try {
                    const { data, error } = await window.semuApp.supabaseClient
                        .from('user_points')
                        .select('points')
                        .eq('user_id', this.currentUser.id)
                        .single();

                    if (error && error.code !== 'PGRST116') {
                        throw error;
                    }

                    this.userPoints = data?.points || 0;
                    this.updatePointsDisplay();
                    
                    console.log('💰 사용자 포인트 로드:', this.userPoints);
                } catch (error) {
                    console.error('❌ 포인트 로드 실패:', error);
                    this.userPoints = 0;
                    this.updatePointsDisplay();
                }
            }

            updatePointsDisplay() {
                const pointsDisplay = document.getElementById('userPointsDisplay');
                pointsDisplay.textContent = `${this.userPoints.toLocaleString()}P`;
            }

            async loadAvatarItems() {
                try {
                    console.log('🎭 아바타 아이템 로드 중...');
                    
                    const { data, error } = await window.semuApp.supabaseClient
                        .from('avatar_items')
                        .select('*')
                        .eq('is_active', true)
                        .order('rarity', { ascending: true })
                        .order('price', { ascending: true });

                    if (error) {
                        console.error('🔥 Supabase 오류:', error);
                        
                        if (error.code === '42P01') {
                            throw new Error('아바타 시스템이 설정되지 않았습니다. 관리자에게 문의하세요. (테이블 누락)');
                        } else if (error.code === 'PGRST301') {
                            throw new Error('아바타 데이터에 접근할 권한이 없습니다. 로그인을 다시 시도하세요.');
                        } else {
                            throw error;
                        }
                    }

                    this.avatarItems = data || [];
                    console.log('✅ 아바타 아이템 로드 완료:', this.avatarItems.length, '개');
                    
                    if (this.avatarItems.length === 0) {
                        console.warn('⚠️ 아바타 아이템이 없습니다. 샘플 데이터가 필요할 수 있습니다.');
                    }
                    
                    await this.renderShopItems();
                    
                } catch (error) {
                    console.error('❌ 아바타 아이템 로드 실패:', error);
                    this.showError(`아바타 상품을 불러오는데 실패했습니다: ${error.message}`);
                }
            }

            async loadUserAvatars() {
                try {
                    console.log('👤 사용자 아바타 로드 중...');
                    
                    const { data, error } = await window.semuApp.supabaseClient
                        .from('user_avatars')
                        .select(`
                            *,
                            avatar_items (*)
                        `)
                        .eq('user_id', this.currentUser.id);

                    if (error) throw error;

                    this.userAvatars = data || [];
                    
                    // 활성 아바타 찾기
                    this.currentActiveAvatar = this.userAvatars.find(ua => ua.is_active);
                    
                    console.log('✅ 사용자 아바타 로드 완료:', this.userAvatars.length, '개');
                    console.log('🎯 활성 아바타:', this.currentActiveAvatar?.avatar_items?.name);
                    
                    await this.renderInventoryItems();
                    
                } catch (error) {
                    console.error('❌ 사용자 아바타 로드 실패:', error);
                }
            }

            async renderShopItems() {
                const container = document.getElementById('shop-items');
                const loading = document.getElementById('shop-loading');
                
                console.log('🎨 아바타 렌더링 시작:', {
                    avatarItems: this.avatarItems.length,
                    container: !!container,
                    loading: !!loading
                });
                
                if (!container) {
                    console.error('❌ shop-items 컨테이너를 찾을 수 없음');
                    return;
                }
                
                if (this.avatarItems.length === 0) {
                    console.log('⚠️ 아바타 아이템이 없음');
                    loading.innerHTML = `
                        <div class="empty-state">
                            <h3>🛒 상품 준비 중</h3>
                            <p>곧 멋진 아바타들이 입고될 예정입니다!</p>
                        </div>
                    `;
                    return;
                }

                // URL 해시에서 하이라이트할 아바타 ID 추출
                const highlightAvatarId = window.location.hash.replace('#avatar-', '');
                
                // 이미 보유한 아바타 ID 목록
                const ownedItemIds = this.userAvatars.map(ua => ua.avatar_item_id);
                
                console.log('🎨 렌더링 데이터:', {
                    highlightAvatarId,
                    ownedItemIds,
                    avatarItems: this.avatarItems.map(item => ({ id: item.id, name: item.name, price: item.price }))
                });

                const htmlContent = this.avatarItems.map(item => {
                    const isOwned = ownedItemIds.includes(item.id);
                    const canAfford = this.userPoints >= item.price;
                    const isHighlighted = item.id === highlightAvatarId;
                    
                    console.log(`🎨 아바타 "${item.name}" 렌더링:`, {
                        id: item.id,
                        isOwned,
                        canAfford,
                        price: item.price,
                        userPoints: this.userPoints
                    });
                    
                    return `
                        <div class="item-card ${isHighlighted ? 'highlighted' : ''}" id="avatar-${item.id}">
                            <div class="item-image">
                                <img src="${item.image_url}" alt="${item.name}" 
                                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iMzUiIGZpbGw9IiNGRkQ3QjciLz4KPGNpcmNsZSBjeD0iMzAiIGN5PSIzNSIgcj0iMyIgZmlsbD0iIzMzMzMzMyIvPgo8Y2lyY2xlIGN4PSI1MCIgY3k9IjM1IiByPSIzIiBmaWxsPSIjMzMzMzMzIi8+CjxwYXRoIGQ9Ik0yNSA1MEM1NSA1MCA1NSA1MCA1NSA1MCIgc3Ryb2tlPSIjMzMzMzMzIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8L3N2Zz4K'">
                                <div class="rarity-badge rarity-${item.rarity}">
                                    ${this.getRarityText(item.rarity)}
                                </div>
                                ${isHighlighted ? '<div class="admin-preview-badge">👑 관리자 미리보기</div>' : ''}
                            </div>
                            <div class="item-info">
                                <h3 class="item-name">${item.name}</h3>
                                <p class="item-description">${item.description || '멋진 아바타입니다.'}</p>
                                <div class="item-price">
                                    <span class="price-display">${item.price.toLocaleString()}P</span>
                                    ${isOwned ? 
                                        '<span class="owned-badge">보유 중</span>' : 
                                        `<button class="buy-button" 
                                                ${!canAfford ? 'disabled' : ''}
                                                onclick="avatarShop.openPurchaseModal('${item.id}')">
                                            ${!canAfford ? '포인트 부족' : '구매하기'}
                                        </button>`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                console.log('🎨 HTML 생성 완료, DOM에 삽입 중...');
                container.innerHTML = htmlContent;
                
                // 강제로 모든 스타일 적용
                if (loading) {
                    loading.style.display = 'none';
                    loading.style.visibility = 'hidden';
                    loading.style.opacity = '0';
                }
                
                // 컨테이너 강제 표시
                container.style.display = 'grid';
                container.style.visibility = 'visible';
                container.style.opacity = '1';
                container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(280px, 1fr))';
                container.style.gap = '25px';
                container.style.marginTop = '20px';
                container.style.minHeight = '400px';
                
                // 각 카드 강제 표시
                const cards = container.querySelectorAll('.item-card');
                cards.forEach((card, index) => {
                    card.style.display = 'block';
                    card.style.visibility = 'visible';
                    card.style.opacity = '1';
                    card.style.minHeight = '350px';
                    card.style.backgroundColor = 'white';
                    card.style.border = '1px solid #e9ecef';
                    card.style.borderRadius = '15px';
                    card.style.boxShadow = '0 10px 25px rgba(0,0,0,0.1)';
                    card.style.padding = '16px';
                    card.style.margin = '0';
                    console.log(`✅ 카드 ${index + 1} 강제 표시 완료`);
                });
                
                console.log('✅ 아바타 카드 렌더링 완료:', {
                    containerVisible: container.style.display,
                    loadingHidden: loading ? loading.style.display : 'N/A',
                    childrenCount: container.children.length
                });
                
                // 하이라이트된 아바타로 스크롤
                if (highlightAvatarId) {
                    setTimeout(() => {
                        const highlightedElement = document.getElementById(`avatar-${highlightAvatarId}`);
                        if (highlightedElement) {
                            highlightedElement.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'center' 
                            });
                            console.log(`🎯 "${highlightedElement.querySelector('.item-name').textContent}" 아바타로 스크롤 및 하이라이트`);
                        }
                    }, 500);
                }
            }

            async renderInventoryItems() {
                const container = document.getElementById('inventory-items');
                const loading = document.getElementById('inventory-loading');
                
                if (this.userAvatars.length === 0) {
                    loading.innerHTML = `
                        <div class="empty-state">
                            <h3>👤 아바타가 없습니다</h3>
                            <p>상점에서 멋진 아바타를 구매해보세요!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.userAvatars.map(userAvatar => {
                    const item = userAvatar.avatar_items;
                    const isActive = userAvatar.is_active;
                    
                    return `
                        <div class="inventory-item ${isActive ? 'active' : ''}">
                            <div class="inventory-image">
                                <img src="${item.image_url}" alt="${item.name}"
                                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iMzUiIGZpbGw9IiNGRkQ3QjciLz4KPGNpcmNsZSBjeD0iMzAiIGN5PSIzNSIgcj0iMyIgZmlsbD0iIzMzMzMzMyIvPgo8Y2lyY2xlIGN4PSI1MCIgY3k9IjM1IiByPSIzIiBmaWxsPSIjMzMzMzMzIi8+CjxwYXRoIGQ9Ik0yNSA1MEM1NSA1MCA1NSA1MCA1NSA1MCIgc3Ryb2tlPSIjMzMzMzMzIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8L3N2Zz4K'">
                                <div class="rarity-badge rarity-${item.rarity}">
                                    ${this.getRarityText(item.rarity)}
                                </div>
                            </div>
                            <div class="inventory-info">
                                <h3 class="item-name">${item.name}</h3>
                                <p class="item-description">${item.description || '멋진 아바타입니다.'}</p>
                                <button class="equip-button ${isActive ? 'equipped' : ''}"
                                        ${isActive ? 'disabled' : ''}
                                        onclick="avatarShop.equipAvatar('${userAvatar.id}')">
                                    ${isActive ? '착용 중' : '착용하기'}
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                loading.style.display = 'none';
                container.style.display = 'grid';
            }

            getRarityText(rarity) {
                const rarityMap = {
                    'common': '일반',
                    'uncommon': '고급',
                    'rare': '희귀',
                    'epic': '영웅',
                    'legendary': '전설'
                };
                return rarityMap[rarity] || '일반';
            }

            openPurchaseModal(itemId) {
                const item = this.avatarItems.find(item => item.id === itemId);
                if (!item) return;

                this.selectedPurchaseItem = item;
                
                const modalText = document.getElementById('purchaseModalText');
                modalText.innerHTML = `
                    <strong>${item.name}</strong>을(를) <strong>${item.price.toLocaleString()}P</strong>에 구매하시겠습니까?<br>
                    <small style="color: #6c757d;">구매 후 남은 포인트: ${(this.userPoints - item.price).toLocaleString()}P</small>
                `;
                
                document.getElementById('purchaseModal').style.display = 'block';
            }

            closePurchaseModal() {
                document.getElementById('purchaseModal').style.display = 'none';
                this.selectedPurchaseItem = null;
            }

            async confirmPurchase() {
                if (!this.selectedPurchaseItem) return;

                const item = this.selectedPurchaseItem;
                
                try {
                    console.log('💳 아바타 구매 시작:', item.name);
                    
                    // 1. 포인트 차감
                    const { error: pointError } = await window.semuApp.supabaseClient
                        .rpc('subtract_user_points', {
                            target_user_id: this.currentUser.id,
                            points_to_subtract: item.price,
                            description: `아바타 구매: ${item.name}`
                        });

                    if (pointError) throw pointError;

                    // 2. 아바타 추가
                    const { error: avatarError } = await window.semuApp.supabaseClient
                        .from('user_avatars')
                        .insert({
                            user_id: this.currentUser.id,
                            avatar_item_id: item.id,
                            is_active: false
                        });

                    if (avatarError) throw avatarError;

                    // 3. 포인트 거래 기록
                    const { error: transactionError } = await window.semuApp.supabaseClient
                        .from('point_transactions')
                        .insert({
                            user_id: this.currentUser.id,
                            amount: -item.price,
                            transaction_type: 'spend',
                            description: `아바타 구매: ${item.name}`,
                            avatar_item_id: item.id
                        });

                    if (transactionError) throw transactionError;

                    console.log('✅ 아바타 구매 완료:', item.name);
                    
                    // UI 업데이트
                    await this.loadUserPoints();
                    await this.loadUserAvatars();
                    await this.renderShopItems();
                    
                    this.closePurchaseModal();
                    
                    alert(`🎉 ${item.name} 구매가 완료되었습니다!\n'내 아바타' 탭에서 확인하세요.`);
                    
                } catch (error) {
                    console.error('❌ 아바타 구매 실패:', error);
                    alert('구매 중 오류가 발생했습니다. 다시 시도해주세요.');
                }
            }

            async equipAvatar(userAvatarId) {
                try {
                    console.log('👕 아바타 착용 시작:', userAvatarId);
                    
                    // 1. 모든 아바타 비활성화
                    const { error: deactivateError } = await window.semuApp.supabaseClient
                        .from('user_avatars')
                        .update({ is_active: false })
                        .eq('user_id', this.currentUser.id);

                    if (deactivateError) throw deactivateError;

                    // 2. 선택한 아바타 활성화
                    const { error: activateError } = await window.semuApp.supabaseClient
                        .from('user_avatars')
                        .update({ is_active: true })
                        .eq('id', userAvatarId);

                    if (activateError) throw activateError;

                    console.log('✅ 아바타 착용 완료');
                    
                    // UI 업데이트
                    await this.loadUserAvatars();
                    
                    alert('아바타가 착용되었습니다! 🎭');
                    
                } catch (error) {
                    console.error('❌ 아바타 착용 실패:', error);
                    alert('아바타 착용 중 오류가 발생했습니다.');
                }
            }

            showError(message) {
                const loading = document.getElementById('shop-loading');
                loading.innerHTML = `
                    <div class="empty-state">
                        <h3>❌ 오류 발생</h3>
                        <p>${message}</p>
                    </div>
                `;
            }
        }
    }

    // 모달 외부 클릭시 닫기
    window.onclick = function(event) {
        const modal = document.getElementById('purchaseModal');
        if (event.target === modal) {
            avatarShop.closePurchaseModal();
        }
    }

    // 전역 함수들
    function confirmPurchase() {
        avatarShop.confirmPurchase();
    }

    function closePurchaseModal() {
        avatarShop.closePurchaseModal();
    }

    // 탭 전환 함수
    function switchTab(tabName) {
        // 탭 버튼 업데이트
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // 탭 콘텐츠 업데이트
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        document.getElementById(tabName + '-tab').classList.remove('hidden');
    }

    // 전역 강제 표시 함수 (콘솔에서 호출 가능)
    function forceShowAvatars() {
        console.log('🔧 강제 표시 함수 실행 중...');
        
        const container = document.getElementById('shop-items');
        const loading = document.getElementById('shop-loading');
        
        if (!container) {
            console.error('❌ shop-items 컨테이너를 찾을 수 없음');
            return;
        }
        
        // 로딩 완전히 숨기기
        if (loading) {
            loading.style.display = 'none';
            loading.style.visibility = 'hidden';
            loading.style.opacity = '0';
            loading.style.height = '0';
            loading.style.overflow = 'hidden';
        }
        
        // 컨테이너 강제 표시
        container.style.cssText = `
            display: grid !important;
            visibility: visible !important;
            opacity: 1 !important;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)) !important;
            gap: 25px !important;
            margin-top: 20px !important;
            min-height: 400px !important;
            padding: 20px !important;
            background: transparent !important;
        `;
        
        // 각 카드 강제 표시
        const cards = container.querySelectorAll('.item-card');
        console.log(`🎴 발견된 카드 수: ${cards.length}`);
        
        cards.forEach((card, index) => {
            card.style.cssText = `
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                min-height: 350px !important;
                background: white !important;
                border: 1px solid #e9ecef !important;
                border-radius: 15px !important;
                box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important;
                padding: 16px !important;
                margin: 0 !important;
                position: relative !important;
                overflow: hidden !important;
                transition: all 0.3s ease !important;
            `;
            console.log(`✅ 카드 ${index + 1} 강제 표시 완료`);
        });
        
        // 탭 컨텐츠도 확인
        const tabContent = document.getElementById('shop-tab');
        if (tabContent) {
            tabContent.style.display = 'block';
            tabContent.style.visibility = 'visible';
            tabContent.style.opacity = '1';
            tabContent.classList.remove('hidden');
        }
        
        console.log('🎯 강제 표시 완료!', {
            containerDisplay: container.style.display,
            containerVisibility: container.style.visibility,
            containerOpacity: container.style.opacity,
            cardsCount: cards.length,
            tabContentDisplay: tabContent ? tabContent.style.display : 'N/A'
        });
    }

    // 디버깅용 함수
    window.debugAvatarShop = function() {
        console.log('🔍 아바타 상점 디버깅 정보:');
        console.log('avatarShop 인스턴스:', avatarShop);
        console.log('아바타 아이템 수:', avatarShop?.avatarItems?.length || 0);
        console.log('사용자 아바타 수:', avatarShop?.userAvatars?.length || 0);
        console.log('사용자 포인트:', avatarShop?.userPoints || 0);
        
        // DOM 요소 확인
        const shopItems = document.getElementById('shop-items');
        const shopLoading = document.getElementById('shop-loading');
        console.log('shop-items 요소:', {
            exists: !!shopItems,
            display: shopItems?.style.display,
            childrenCount: shopItems?.children.length || 0
        });
        console.log('shop-loading 요소:', {
            exists: !!shopLoading,
            display: shopLoading?.style.display
        });
        
        if (avatarShop?.avatarItems) {
            console.log('아바타 아이템 목록:', avatarShop.avatarItems);
        }
    };

    // 데이터베이스 직접 확인 함수
    window.checkAvatarDatabase = async function() {
        try {
            if (!window.semuApp?.supabaseClient) {
                console.error('❌ Supabase 클라이언트가 없습니다.');
                return;
            }
            
            console.log('🔍 데이터베이스 아바타 테이블 확인 중...');
            
            const { data, error } = await window.semuApp.supabaseClient
                .from('avatar_items')
                .select('*')
                .limit(10);
            
            if (error) {
                console.error('❌ 데이터베이스 조회 실패:', error);
                return;
            }
            
            console.log('✅ 데이터베이스 아바타 아이템:', data);
            console.log('📊 총 아이템 수:', data?.length || 0);
            
            if (data && data.length > 0) {
                console.log('첫 번째 아이템:', data[0]);
            } else {
                console.warn('⚠️ 데이터베이스에 아바타 아이템이 없습니다.');
                console.log('💡 해결책: avatar-shop-sample-data.sql을 실행하세요.');
            }
            
        } catch (error) {
            console.error('❌ 데이터베이스 확인 중 오류:', error);
        }
    };

    // 앱 초기화
    let avatarShop;
    
    document.addEventListener('DOMContentLoaded', () => {
        console.log('🎭 아바타 상점 페이지 로드 완료');
        
        // 먼저 로그인 상태를 간단히 확인 (localStorage에서)
        const quickAuthCheck = () => {
            try {
                const supabaseSession = localStorage.getItem('sb-skpvtqohyspfsmvwrgoc-auth-token');
                if (!supabaseSession) {
                    console.log('⚠️ 저장된 인증 토큰이 없음, 로그인 페이지로 이동');
                    alert('로그인이 필요합니다.');
                    window.location.href = 'login.html';
                    return false;
                }
                return true;
            } catch (error) {
                console.warn('⚠️ 토큰 확인 중 오류:', error);
                return true; // 오류 발생시 계속 진행
            }
        };
        
        if (quickAuthCheck()) {
            avatarShop = new AvatarShop();
        }
    });
    </script>
</body>
</html>
