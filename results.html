<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시험 결과 - Quizbank</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/common.css">
    <style>
        .results-container {
            display: flex;
            flex-direction: column;
            min-height: 600px;
        }

        .main-content {
            flex: 1;
            padding: 30px;
            background: #f8f9fa;
        }

        .result-header {
            background: white;
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .result-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .result-icon.excellent {
            color: #28a745;
        }

        .result-icon.good {
            color: #17a2b8;
        }

        .result-icon.average {
            color: #ffc107;
        }

        .result-icon.poor {
            color: #dc3545;
        }

        .result-title {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--dark-gray);
        }

        .result-subtitle {
            color: var(--medium-gray);
            font-size: 1.1rem;
            margin-bottom: 30px;
        }

        .score-display {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .score-number {
            font-size: 4rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
        }

        .score-label {
            text-align: center;
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .score-details {
            text-align: center;
            margin-top: 15px;
            font-size: 1rem;
            opacity: 0.8;
        }
        
        .earned-points {
            color: #90EE90;
            font-weight: 600;
        }
        
        .total-points {
            color: #E0E0E0;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--medium-gray);
            font-size: 0.9rem;
        }

        .detailed-results {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .section-title {
            font-size: 1.3rem;
            color: var(--dark-gray);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .question-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 2px solid #f8f9fa;
        }

        .question-result.correct {
            border-color: #28a745;
            background: #f8fff9;
        }

        .question-result.incorrect {
            border-color: #dc3545;
            background: #fff8f8;
        }

        .question-info {
            flex: 1;
        }

        .question-number {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .question-preview {
            color: var(--medium-gray);
            font-size: 0.9rem;
        }

        .question-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .status-icon {
            font-size: 1.2rem;
        }

        .status-icon.correct {
            color: #28a745;
        }

        .status-icon.incorrect {
            color: #dc3545;
        }

        .recommendations {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .recommendations h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin: 10px 0;
        }

        .recommendation-icon {
            color: #2196f3;
            margin-top: 2px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .progress-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 10px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            position: relative;
            background: conic-gradient(var(--primary-color) 0deg, #e9ecef 0deg);
        }

        .circle-content {
            background: white;
            border-radius: 50%;
            width: 110px;
            height: 110px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .circle-score {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .circle-label {
            font-size: 0.8rem;
            color: var(--medium-gray);
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .result-header {
                padding: 30px 20px;
            }
            
            .score-number {
                font-size: 3rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            
            .question-result {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }
        
        /* 상세 분석 모달 스타일 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            padding: 25px 30px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: white;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }
        
        .modal-close:hover {
            opacity: 1;
        }
        
        .modal-body {
            padding: 30px;
            max-height: calc(90vh - 140px);
            overflow-y: auto;
            width: 100%;
        }
        
        .modal-footer {
            padding: 25px 30px;
            border-top: 2px solid #e9ecef;
            border-radius: 0 0 15px 15px;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            background: #f8f9fa;
        }
        
        /* 분석 요약 스타일 */
        .analysis-summary {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid var(--primary-color);
        }
        
        .analysis-summary h4 {
            margin: 0 0 20px 0;
            color: var(--primary-color);
            font-size: 1.3rem;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }
        
        .summary-stats .stat-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }
        
        .summary-stats .stat-label {
            display: block;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
        }
        
        .summary-stats .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        /* 문항별 분석 스타일 */
        .questions-analysis h4 {
            margin: 0 0 25px 0;
            color: var(--dark-gray);
            font-size: 1.3rem;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
        }
        
        .question-analysis-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            width: 100%;
            box-sizing: border-box;
        }
        
        .questions-analysis {
            width: 100%;
            overflow: visible;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .question-header h5 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.2rem;
        }
        
        .question-meta {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .question-type {
            background: var(--primary-color);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .question-score {
            background: #28a745;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
        }
        
        .question-content,
        .answer-content,
        .model-answer {
            margin-bottom: 20px;
        }
        
        .question-content h6,
        .answer-content h6,
        .model-answer h6 {
            margin: 0 0 10px 0;
            color: var(--dark-gray);
            font-size: 1rem;
            font-weight: 600;
        }
        
        .answer-text,
        .model-answer-text {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        /* AI 채점 피드백 스타일 */
        .grading-feedback {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            border: 1px solid #bbdefb;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .grading-feedback h6 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .feedback-content {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e1f5fe;
        }
        
        .feedback-score {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e1f5fe;
        }
        
        .ai-badge {
            background: #ff6b35;
            color:  white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .feedback-text {
            line-height: 1.6;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }
        
        .feedback-time {
            color: #666;
            font-style: italic;
        }
        
        .answer-timing {
            margin-top: 15px;
            text-align: right;
        }
        
        /* 인라인 상세 분석 스타일 (새로운 세로 스크롤 방식) */
        .detailed-analysis-inline {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            box-shadow: var(--shadow);
        }
        
        .analysis-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .analysis-summary-inline {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid var(--primary-color);
        }
        
        .summary-stats-inline {
            display: flex;
            gap: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-label {
            display: block;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }
        
        .summary-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .questions-list-vertical {
            margin: 30px 0;
        }
        
        .question-item-vertical {
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .question-item-vertical:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }
        
        .question-number-badge {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .question-num {
            background: var(--primary-color);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .question-type-badge {
            background: #17a2b8;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .question-score-badge {
            background: #28a745;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
        }
        
        .question-content-section {
            margin-bottom: 25px;
        }
        
        .question-title {
            color: var(--primary-color);
            font-size: 1.3rem;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .question-text {
            font-size: 1.1rem;
            line-height: 1.6;
            color: var(--dark-gray);
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        
        .choices-section {
            margin-bottom: 25px;
        }
        
        .choices-section h5 {
            color: var(--dark-gray);
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .choices-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .choice-item-vertical {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        .choice-item-vertical.choice-correct-selected {
            background: #e3f2fd;
            border-color: #007bff;
        }
        
        .choice-item-vertical.choice-correct {
            background: #f8fff9;
            border-color: #28a745;
        }
        
        .choice-item-vertical.choice-user-selected {
            background: #fff8f8;
            border-color: #dc3545;
        }
        
        .choice-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .choice-letter {
            background: #6c757d;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .choice-status {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 12px;
        }
        
        .choice-status.correct-selected {
            background: #007bff;
            color: white;
        }
        
        .choice-status.correct {
            background: #28a745;
            color: white;
        }
        
        .choice-status.user-selected {
            background: #dc3545;
            color: white;
        }
        
        .choice-content {
            font-size: 1rem;
            line-height: 1.5;
            margin-left: 35px;
        }
        
        .answer-section, .explanation-section, .model-answer-section, .feedback-section {
            margin-bottom: 20px;
        }
        
        .answer-section h5, .explanation-section h5, .model-answer-section h5, .feedback-section h5 {
            color: var(--dark-gray);
            margin-bottom: 12px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .my-answer-box {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .my-answer-box.correct {
            background: #f8fff9;
            border-color: #28a745;
            color: #155724;
        }
        
        .my-answer-box.incorrect {
            background: #fff8f8;
            border-color: #dc3545;
            color: #721c24;
        }
        
        .no-answer {
            color: #6c757d;
            font-style: italic;
        }
        
        .model-answer-box, .feedback-box, .explanation-box {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 10px;
            padding: 15px;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .explanation-box {
            background: #fff3e0;
            border: 1px solid #ffcc80;
        }
        
        .feedback-score-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e1f5fe;
        }
        
        .feedback-text {
            margin-bottom: 10px;
            white-space: pre-wrap;
        }
        
        .feedback-time {
            color: #666;
            font-style: italic;
            font-size: 0.9rem;
        }
        
        .analysis-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            padding-top: 25px;
            border-top: 2px solid #e9ecef;
        }
        
        /* 모바일 반응형 - 인라인 분석 */
        @media (max-width: 768px) {
            .detailed-analysis-inline {
                padding: 20px;
                margin: 20px 0;
            }
            
            .question-item-vertical {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .question-number-badge {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .question-num {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
            
            .summary-stats-inline {
                flex-direction: column;
                gap: 15px;
            }
            
            .analysis-actions {
                flex-direction: column;
                align-items: stretch;
            }
        }
        
        /* 모바일 반응형 - 모달 */
        @media (max-width: 768px) {
            .modal-content {
                max-width: 95% !important;
                margin: 10px;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .question-analysis-item {
                padding: 20px;
                margin-bottom: 15px;
            }
            
            .question-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="container">
            <div class="results-container">
                <!-- 헤더 -->
                <div class="header">
                    <div class="logo">
                        <i class="fas fa-graduation-cap"></i>
                        <h2>Quizbank</h2>
                    </div>
                    <div class="nav-menu">
                        <a href="./dashboard.html" class="nav-link">
                            <i class="fas fa-home"></i> 대시보드
                        </a>
                        <a href="./exam.html" class="nav-link">
                            <i class="fas fa-clipboard-list"></i> 시험
                        </a>
                        <a href="./results.html" class="nav-link active">
                            <i class="fas fa-chart-bar"></i> 결과
                        </a>
                        <a href="./profile.html" class="nav-link">
                            <i class="fas fa-user"></i> 프로필
                        </a>
                    </div>
                    <div class="user-menu">
                        <span class="user-name" id="userName">사용자님</span>
                        <button class="btn btn-outline btn-small logout-btn">
                            <i class="fas fa-sign-out-alt"></i> 로그아웃
                        </button>
                    </div>
                </div>

                <!-- 메인 콘텐츠 -->
                <div class="main-content">
                    <!-- 결과 헤더 -->
                    <div class="result-header">
                        <div class="result-icon" id="resultIcon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <h1 class="result-title" id="resultTitle">결과를 불러오는 중...</h1>
                        <p class="result-subtitle" id="resultSubtitle">잠시만 기다려주세요.</p>
                        
                        <div class="score-display">
                            <div class="score-number" id="scoreNumber">...</div>
                            <div class="score-label">점</div>
                            <div class="score-details" id="scoreDetails">
                                <span class="earned-points" id="earnedPoints">...</span> / <span class="total-points" id="totalPoints">...</span>점
                            </div>
                        </div>
                    </div>

                    <!-- 성과 차트 -->
                    <div class="chart-container">
                        <h3 class="section-title">
                            <i class="fas fa-chart-pie"></i>
                            성과 요약
                        </h3>
                        <div class="progress-circle" id="progressCircle">
                            <div class="circle-content">
                                <div class="circle-score" id="circleScore">...</div>
                                <div class="circle-label">점</div>
                            </div>
                        </div>
                        <p style="color: var(--medium-gray);">전체 평균보다 <strong id="comparison">-</strong></p>
                        <!-- 백분위 정보는 JavaScript로 동적 추가됨 -->
                        <div id="pointsDisplay" class="points-display" style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">획득 포인트</div>
                            <div style="font-size: 24px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <i class="fas fa-coins" style="color: #ffd700;"></i>
                                <span id="earnedPointsDisplay">계산 중...</span>
                            </div>
                            <div id="pointsBreakdown" style="font-size: 12px; margin-top: 8px; opacity: 0.8;"></div>
                        </div>
                    </div>

                    <!-- 통계 -->
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-icon" style="color: #28a745;">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-value" id="correctCount">-</div>
                            <div class="stat-label">정답</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon" style="color: #dc3545;">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div class="stat-value" id="incorrectCount">-</div>
                            <div class="stat-label">오답</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon" style="color: #17a2b8;">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-value" id="timeUsed">-</div>
                            <div class="stat-label">소요 시간(분)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon" style="color: #ffc107;">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="stat-value" id="accuracy">-</div>
                            <div class="stat-label">정답률(%)</div>
                        </div>
                    </div>

                    <!-- 상세 결과 -->
                    <div class="detailed-results">
                        <h3 class="section-title">
                            <i class="fas fa-list"></i>
                            문항별 결과
                        </h3>
                        <div id="questionResults">
                            <!-- 문항별 결과가 여기에 표시됩니다 -->
                        </div>
                    </div>

                    <!-- 추천사항 -->
                    <div class="recommendations">
                        <h3>
                            <i class="fas fa-lightbulb"></i>
                            학습 추천사항
                        </h3>
                        <div id="recommendationsList">
                            <!-- 추천사항들이 여기에 표시됩니다 -->
                        </div>
                    </div>

                    <!-- 액션 버튼들 -->
                    <div class="action-buttons">
                        <!-- 재응시 버튼 비활성화 -->
                        <!-- <button class="btn btn-primary btn-large" onclick="retakeExam()">
                            <i class="fas fa-redo"></i> 다시 응시
                        </button> -->
                        <button class="btn btn-secondary btn-large" onclick="viewDetails()">
                            <i class="fas fa-search"></i> 상세 분석
                        </button>
                        <a href="./dashboard.html" class="btn btn-outline btn-large">
                            <i class="fas fa-home"></i> 대시보드로
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    
    <!-- 공통 스크립트 -->
    <script src="./assets/js/common.js"></script>
    
    <script>
        // 결과 페이지 전용 스크립트
        class ResultsPage {
            constructor() {
                this.score = null;
                this.totalQuestions = null;
                this.examData = null;
                this.examStats = { averageScore: 70, totalParticipants: 1 };
                this.examScores = [];
                this.isDataLoaded = false;
                
                this.init();
            }

            async waitForAuthAndSession() {
                console.log('⏳ 인증 및 세션 복원 대기 중...');
                
                let attempts = 0;
                const maxAttempts = 100; // 10초 대기 (100 * 100ms)
                
                while (attempts < maxAttempts) {
                    // semuApp과 supabaseClient가 모두 로드되었는지 확인
                    if (window.semuApp && window.supabaseClient) {
                        // 세션 복원이 완료되었는지 확인
                        if (window.semuApp.currentUser) {
                            console.log('✅ 사용자 인증 확인됨:', window.semuApp.currentUser.email);
                            return;
                        }
                        
                        // 세션 복원을 위한 추가 대기
                        if (attempts > 50) {
                            console.log('⏳ 세션 복원 추가 대기 중...', attempts);
                        }
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                console.warn('⚠️ 세션 복원 타임아웃');
            }

            async init() {
                console.log('📊 결과 페이지 초기화');
                
                // 세션 복원 대기 및 인증 확인
                await this.waitForAuthAndSession();
                
                if (!window.semuApp.currentUser) {
                    console.warn('⚠️ 인증된 사용자가 없습니다. 로그인 페이지로 이동');
                    window.location.href = './login.html';
                    return;
                }

                // 사용자 정보 표시
                this.updateUserInfo();
                
                // 로딩 상태 표시
                this.showLoadingState();
                
                // URL 파라미터에서 결과 정보 가져오기
                await this.loadResultData();
                
                // 로딩 완료 후 UI 업데이트
                this.hideLoadingState();
                await this.updateUI();
            }

            updateUserInfo() {
                const user = window.semuApp.currentUser;
                if (user) {
                    document.getElementById('userName').textContent = user.name + '님';
                }
            }

            showLoadingState() {
                console.log('⏳ 결과 로딩 상태 표시 (HTML에 이미 설정됨)');
                
                // HTML에서 이미 로딩 상태로 설정되어 있으므로 
                // 추가적인 DOM 조작 없이 로그만 출력
            }

            hideLoadingState() {
                console.log('✅ 결과 로딩 완료');
                // 실제 UI 업데이트는 updateUI()에서 처리됨
            }

            async loadResultData() {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const examId = urlParams.get('exam');
                    const score = parseInt(urlParams.get('score')) || 0;
                    const totalQuestions = parseInt(urlParams.get('total')) || 0;
                    const autoSubmit = urlParams.get('auto_submit') === 'true';
                    
                    console.log('🔍 결과 데이터 파라미터:', { examId, score, totalQuestions, autoSubmit });
                    console.log('🔍 현재 URL:', window.location.href);
                    
                    if (examId) {
                        // 시험 ID가 있는 경우 - 데이터베이스에서 결과 조회
                        await this.loadResultFromDatabase(examId);
                    } else if (score > 0 && totalQuestions > 0) {
                        // URL 파라미터로 점수만 전달된 경우 - 임시 데이터 사용
                        this.score = score;
                        this.totalQuestions = totalQuestions;
                        this.examData = {
                            title: '시험 결과',
                            correctAnswers: Math.round(this.totalQuestions * this.score / 100),
                            incorrectAnswers: this.totalQuestions - Math.round(this.totalQuestions * this.score / 100),
                            timeUsed: 0,
                            questions: []
                        };
                        
                        if (autoSubmit) {
                            this.examData.title = '자동 제출된 시험 결과';
                        }
                        
                        // URL 파라미터 데이터 로드 완료
                        this.isDataLoaded = true;
                    } else {
                        // exam 파라미터가 없는 경우 - 시험 목록 표시
                        console.log('📋 examId가 없음 - 완료된 시험 목록을 표시합니다');
                        await this.showExamSelectionUI();
                        return;
                    }
                    
                    console.log('✅ 결과 데이터 로드 완료:', { 
                        score: this.score, 
                        total: this.totalQuestions,
                        examData: this.examData 
                    });
                    
                } catch (error) {
                    console.error('❌ 결과 데이터 로드 실패:', error);
                    this.score = 0;
                    this.totalQuestions = 0;
                    this.examData = {
                        title: '오류 발생',
                        correctAnswers: 0,
                        incorrectAnswers: 0,
                        timeUsed: 0,
                        questions: []
                    };
                }
            }

            async loadResultFromDatabase(examId) {
                try {
                    console.log('🔍 데이터베이스에서 시험 결과 조회:', examId);
                    
                    // 현재 사용자 ID 가져오기 (하드코딩된 관리자 계정 지원)
                    let userId;
                    
                    if (window.semuApp && window.semuApp.currentUser) {
                        userId = window.semuApp.currentUser.id;
                        console.log('✅ 앱에서 사용자 ID 확인:', userId);
                    } else {
                        const { data: { user } } = await window.supabaseClient.auth.getUser();
                        if (!user) {
                            throw new Error('사용자 인증 정보를 찾을 수 없습니다.');
                        }
                        userId = user.id;
                    }
                    
                    // 1단계: 시험 세션 정보 조회
                    const { data: session, error: sessionError } = await window.supabaseClient
                        .from('exam_sessions')
                        .select(`
                            *,
                            exams (
                                title,
                                description,
                                duration
                            )
                        `)
                        .eq('exam_id', examId)
                        .eq('employee_id', userId)
                        .eq('status', 'submitted')
                        .order('submit_time', { ascending: false })
                        .limit(1)
                        .single();
                    
                    if (sessionError) throw sessionError;
                    
                    // 1-1단계: 전체 시험 통계 조회 (평균 점수, 참가자 수 등)
                    const { data: examStats, error: statsError } = await window.supabaseClient
                        .from('exam_sessions')
                        .select('score, total_points')
                        .eq('exam_id', examId)
                        .eq('status', 'submitted');
                    
                    if (statsError) {
                        console.warn('⚠️ 시험 통계 조회 실패, 기본값 사용:', statsError);
                        this.examStats = { averageScore: 70, totalParticipants: 1 };
                    } else {
                        // 평균 점수 계산
                        const validScores = examStats.filter(s => s.score !== null && s.total_points !== null);
                        const averageScore = validScores.length > 0 
                            ? Math.round(validScores.reduce((sum, s) => sum + (s.score || 0), 0) / validScores.length)
                            : 70;
                        
                        this.examStats = {
                            averageScore: averageScore,
                            totalParticipants: examStats.length
                        };
                        this.examScores = examStats;
                        
                        // 점수 분포 상세 분석
                        const scoreDistribution = validScores.map(s => Math.round((s.score / s.total_points) * 100));
                        const sortedScores = [...scoreDistribution].sort((a, b) => b - a);
                        
                        console.log('📊 시험 통계:', this.examStats);
                        console.log('📊 시험 점수 분포 (정렬):', sortedScores);
                        console.log('📊 점수별 인원 분석:', {
                            '100점': sortedScores.filter(s => s === 100).length + '명',
                            '90점대': sortedScores.filter(s => s >= 90 && s < 100).length + '명',
                            '80점대': sortedScores.filter(s => s >= 80 && s < 90).length + '명',
                            '70점대': sortedScores.filter(s => s >= 70 && s < 80).length + '명',
                            '60점대': sortedScores.filter(s => s >= 60 && s < 70).length + '명',
                            '60점미만': sortedScores.filter(s => s < 60).length + '명'
                        });
                    }
                    
                    if (sessionError) throw sessionError;
                    
                    // 2단계: 개별 답변 결과 조회 (선택지 정보 포함)
                    const { data: answers, error: answersError } = await window.supabaseClient
                        .from('exam_answers')
                        .select(`
                            *,
                            questions (
                                id,
                                title,
                                content,
                                type
                            )
                        `)
                        .eq('session_id', session.id)
                        .order('created_at');
                    
                    if (answersError) throw answersError;
                    
                    // 2-2단계: 객관식 문제의 선택지 정보 조회
                    const questionIds = answers.map(a => a.question_id);
                    const { data: questionOptions, error: optionsError } = await window.supabaseClient
                        .from('question_options')
                        .select('*')
                        .in('question_id', questionIds)
                        .order('order_index');
                    
                    if (optionsError) throw optionsError;
                    
                    if (answersError) throw answersError;
                    
                    // 2-1단계: 시험 문제별 배점 정보 조회
                    const { data: examQuestions, error: examQuestionsError } = await window.supabaseClient
                        .from('exam_questions')
                        .select('question_id, points')
                        .eq('exam_id', examId);
                    
                    if (examQuestionsError) throw examQuestionsError;
                    
                    // 배점 정보를 맵으로 변환
                    const pointsMap = {};
                    examQuestions.forEach(eq => {
                        pointsMap[eq.question_id] = eq.points || 1;
                    });
                    
                    console.log('🔍 시험 문제별 배점:', pointsMap);
                    
                    if (answersError) throw answersError;
                    
                    // 3단계: 결과 데이터 구성 - 실제 답안 데이터로 점수 재계산
                    // 각 문제의 배점을 고려하여 점수 계산
                    let totalPoints = 0;
                    let earnedPoints = 0;
                    
                    console.log('🔍 답안 데이터 상세:', answers);
                    
                    answers.forEach(answer => {
                        const qType = answer.questions?.type;
                        // 문제의 최대 배점: 설정된 배점 우선, 없으면 주관식/서술형 100점 기본, 그 외 1점
                        const maxPoints = (pointsMap[answer.question_id] && pointsMap[answer.question_id] > 0)
                            ? pointsMap[answer.question_id]
                            : (qType === 'subjective' || qType === 'essay' || qType === '주관식') ? 100 : 1;
                        totalPoints += maxPoints;

                        let earnedForThis = 0;
                        if (qType === 'multiple_choice' || qType === '객관식') {
                            // 객관식: 정답이면 배점 전액, 아니면 0
                            earnedForThis = answer.is_correct ? maxPoints : 0;
                        } else {
                            // 주관식/서술형: 채점된 점수 사용(없으면 0), 최대 배점까지 캡
                            const gradedPoints = Number(answer.points) || 0;
                            earnedForThis = Math.max(0, Math.min(gradedPoints, maxPoints));
                        }

                        earnedPoints += earnedForThis;

                        console.log(`📝 답안 ${answer.question_id}:`, {
                            answer: answer.answer,
                            isCorrect: answer.is_correct,
                            gradedPoints: answer.points,
                            maxPoints,
                            usedEarned: earnedForThis,
                            questionType: qType,
                            questionData: answer.questions
                        });
                    });
                    
                    // 백분율 점수 계산 (0-100)
                    this.score = totalPoints > 0 ? Math.round((earnedPoints / totalPoints) * 100) : 0;
                    this.totalQuestions = answers.length;
                    
                    const correctAnswers = answers.filter(a => a.is_correct).length;
                    const incorrectAnswers = answers.filter(a => !a.is_correct).length;
                    
                    console.log('📊 점수 계산 상세:', {
                        earnedPoints,
                        totalPoints,
                        calculatedScore: this.score,
                        correctAnswers,
                        incorrectAnswers,
                        answersCount: answers.length,
                        sessionScore: session.score,
                        sessionTotalPoints: session.total_points,
                        pointsMap: pointsMap,
                        answers: answers.map(a => ({
                            questionId: a.question_id,
                            isCorrect: a.is_correct,
                            points: a.points,
                            examQuestionPoints: pointsMap[a.question_id]
                        }))
                    });
                    
                    // 선택지 정보를 질문별로 그룹화
                    const optionsByQuestion = {};
                    questionOptions.forEach(option => {
                        if (!optionsByQuestion[option.question_id]) {
                            optionsByQuestion[option.question_id] = [];
                        }
                        optionsByQuestion[option.question_id].push(option);
                    });
                    
                    this.examData = {
                        sessionId: session.id,  // 세션 ID 추가
                        employeeId: session.employee_id,  // 사용자 ID 추가
                        title: session.exams?.title || '시험 결과',
                        correctAnswers: correctAnswers,
                        incorrectAnswers: incorrectAnswers,
                        timeUsed: session.duration_minutes || 0,
                        earnedPoints: earnedPoints,
                        totalPoints: totalPoints,
                        questions: answers.map(answer => {
                            const questionOptions = optionsByQuestion[answer.question_id] || [];
                            const choices = questionOptions.map(opt => opt.content);
                            const correctAnswerIndex = questionOptions.findIndex(opt => opt.is_correct);
                            
                            return {
                                id: answer.question_id,
                                correct: answer.is_correct,
                                text: answer.questions?.title || answer.questions?.content || '문제 내용 없음',
                                userAnswer: answer.answer,
                                userAnswerIndex: parseInt(answer.answer) || 0,
                                points: pointsMap[answer.question_id] || 1,
                                type: answer.questions?.type,
                                choices: choices,
                                correctAnswer: correctAnswerIndex >= 0 ? correctAnswerIndex : 0
                            };
                        })
                    };
                    
                    console.log('✅ 데이터베이스에서 결과 로드 완료:', this.examData);
                    
                    // 데이터 로드 완료 플래그 설정
                    this.isDataLoaded = true;
                    
                } catch (error) {
                    console.error('❌ 데이터베이스 결과 조회 실패:', error);
                    this.isDataLoaded = false;
                    throw error;
                }
            }

            showNoResultMessage() {
                // 시험 결과가 없을 때 안내 메시지 표시
                const resultHeader = document.querySelector('.result-header');
                if (resultHeader) {
                    resultHeader.innerHTML = `
                        <div class="result-icon" style="color: #ffc107;">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h1 class="result-title">시험 결과를 찾을 수 없습니다</h1>
                        <p class="result-subtitle">URL에 시험 ID가 포함되지 않았거나, 해당 시험 결과가 존재하지 않습니다.</p>
                        
                        <div class="score-display" style="opacity: 0.5;">
                            <div class="score-number">-</div>
                            <div class="score-label">점</div>
                            <div class="score-details">
                                <span class="earned-points">-</span> / <span class="total-points">-</span>점
                            </div>
                        </div>
                    `;
                }
                
                // 액션 버튼 업데이트
                const actionButtons = document.querySelector('.action-buttons');
                if (actionButtons) {
                    actionButtons.innerHTML = `
                        <a href="./dashboard.html" class="btn btn-primary btn-large">
                            <i class="fas fa-home"></i> 대시보드로 돌아가기
                        </a>
                        <a href="./exam.html" class="btn btn-outline btn-large">
                            <i class="fas fa-edit"></i> 시험 응시하기
                        </a>
                    `;
                }
                
                // 다른 섹션들 숨기기
                const sectionsToHide = [
                    '.chart-container',
                    '.stats-grid',
                    '.detailed-results',
                    '.recommendations'
                ];
                
                sectionsToHide.forEach(selector => {
                    const element = document.querySelector(selector);
                    if (element) {
                        element.style.display = 'none';
                    }
                });
            }

            async updateUI() {
                // 데이터가 로드되지 않았으면 UI 업데이트 하지 않음
                if (!this.isDataLoaded || this.score === null) {
                    console.log('⚠️ 데이터 로드 미완료, UI 업데이트 건너뜀');
                    return;
                }
                
                console.log('🎨 UI 업데이트 시작:', { score: this.score, total: this.totalQuestions });
                
                // 점수 표시 - earnedPoints를 사용하여 실제 획득 점수 표시
                document.getElementById('scoreNumber').textContent = this.examData.earnedPoints || 0;
                document.getElementById('circleScore').textContent = this.examData.earnedPoints || 0;
                
                // 점수 상세 정보 표시
                if (this.examData.earnedPoints !== undefined && this.examData.totalPoints !== undefined) {
                    document.getElementById('earnedPoints').textContent = this.examData.earnedPoints;
                    document.getElementById('totalPoints').textContent = this.examData.totalPoints;
                }
                
                // 결과 아이콘 및 제목 업데이트
                this.updateResultIcon();
                
                // 통계 업데이트
                this.updateStats();
                
                // 원형 차트 업데이트
                this.updateProgressCircle();
                
                // 문항별 결과 표시
                this.displayQuestionResults();
                
                // 추천사항 표시
                this.displayRecommendations();
                
                // 포인트 정보 표시
                await this.displayPointsInfo();
            }

            updateResultIcon() {
                const iconElement = document.getElementById('resultIcon');
                const titleElement = document.getElementById('resultTitle');
                const subtitleElement = document.getElementById('resultSubtitle');
                
                if (this.score >= 90) {
                    iconElement.className = 'result-icon excellent';
                    iconElement.innerHTML = '<i class="fas fa-trophy"></i>';
                    titleElement.textContent = '우수한 성과입니다!';
                    subtitleElement.textContent = '뛰어난 실력을 보여주셨습니다.';
                } else if (this.score >= 80) {
                    iconElement.className = 'result-icon good';
                    iconElement.innerHTML = '<i class="fas fa-medal"></i>';
                    titleElement.textContent = '좋은 결과입니다!';
                    subtitleElement.textContent = '성실한 학습의 결과입니다.';
                } else if (this.score >= 70) {
                    iconElement.className = 'result-icon average';
                    iconElement.innerHTML = '<i class="fas fa-star"></i>';
                    titleElement.textContent = '보통 수준입니다';
                    subtitleElement.textContent = '조금 더 노력하면 더 좋은 결과가 있을 것입니다.';
                } else {
                    iconElement.className = 'result-icon poor';
                    iconElement.innerHTML = '<i class="fas fa-book"></i>';
                    titleElement.textContent = '추가 학습이 필요합니다';
                    subtitleElement.textContent = '포기하지 마세요. 다시 도전해보세요!';
                }
            }

            updateStats() {
                document.getElementById('correctCount').textContent = this.examData.correctAnswers;
                document.getElementById('incorrectCount').textContent = this.examData.incorrectAnswers;
                document.getElementById('timeUsed').textContent = this.examData.timeUsed;
                document.getElementById('accuracy').textContent = this.score;
                
                // 실제 평균과 비교
                const averageScore = this.examStats?.averageScore || 70;
                const totalParticipants = this.examStats?.totalParticipants || 1;
                const difference = this.score - averageScore;
                const comparisonElement = document.getElementById('comparison');
                
                // 백분위 계산 (정확한 방식)
                let percentile = '평가 불가';
                let percentileInfo = '';
                
                if (totalParticipants > 0) {
                    const currentScore = this.examData.earnedPoints || 0;
                    
                    // 🎯 간단한 백분위 계산: (응시인원 - 내 뒤에 사람) ÷ 응시인원 × 100
                    const allValidScores = (this.examScores || []).filter(s => 
                        s.score !== null && s.total_points !== null
                    );
                    
                    if (allValidScores.length > 0) {
                        const myScore = currentScore;
                        const allScores = allValidScores.map(s => s.score || 0);
                        
                        // 내 뒤에 있는 사람 수 (나보다 낮은 점수)
                        const peopleBelow = allScores.filter(score => score < myScore).length;
                        
                        // 전체 응시 인원
                        const totalParticipants = allValidScores.length;
                        
                        // 내 순위 (나보다 높은 점수 + 1)
                        const peopleAbove = allScores.filter(score => score > myScore).length;
                        const myRank = peopleAbove + 1;
                        
                        // 상위 백분위 계산: (응시인원 - 내 뒤에 사람) ÷ 응시인원 × 100
                        const topPercentile = Math.round(((totalParticipants - peopleBelow) / totalParticipants) * 100);
                        
                        console.log('📊 간단한 백분위 계산:', {
                            myScore: myScore,
                            allScores: allScores,
                            totalParticipants: totalParticipants,
                            peopleBelow: peopleBelow,
                            peopleAbove: peopleAbove,
                            myRank: myRank,
                            calculation: `(${totalParticipants} - ${peopleBelow}) ÷ ${totalParticipants} × 100 = ${topPercentile}%`,
                            topPercentile: topPercentile
                        });
                        
                        // 결과 해석 및 시각적 표현
                        let icon = '';
                        let colorClass = '';
                        
                        if (totalParticipants === 1) {
                            percentileInfo = `혼자 응시 (1등, 완주)`;
                            icon = '🎯';
                            colorClass = 'percentile-solo';
                        } else if (topPercentile <= 10 || myRank === 1) {
                            percentileInfo = `상위 ${topPercentile}% (${myRank}등, 최상위권)`;
                            icon = '🏆';
                            colorClass = 'percentile-excellent';
                        } else if (topPercentile <= 25) {
                            percentileInfo = `상위 ${topPercentile}% (${myRank}등, 상위권)`;
                            icon = '🥇';
                            colorClass = 'percentile-very-good';
                        } else if (topPercentile <= 50) {
                            percentileInfo = `상위 ${topPercentile}% (${myRank}등, 중상위권)`;
                            icon = '🥈';
                            colorClass = 'percentile-good';
                        } else if (topPercentile <= 75) {
                            percentileInfo = `상위 ${topPercentile}% (${myRank}등, 중위권)`;
                            icon = '🥉';
                            colorClass = 'percentile-average';
                        } else {
                            percentileInfo = `상위 ${topPercentile}% (${myRank}등, 하위권)`;
                            icon = '📚';
                            colorClass = 'percentile-below-average';
                        }
                        
                        percentile = `${icon} ${percentileInfo}`;
                    }
                }
                
                if (difference > 0) {
                    comparisonElement.innerHTML = `${Math.abs(difference)}점 높음<br><small>전체 평균: ${averageScore}점 (${totalParticipants}명 참가)</small>`;
                    comparisonElement.style.color = '#28a745';
                } else if (difference < 0) {
                    comparisonElement.innerHTML = `${Math.abs(difference)}점 낮음<br><small>전체 평균: ${averageScore}점 (${totalParticipants}명 참가)</small>`;
                    comparisonElement.style.color = '#dc3545';
                } else {
                    comparisonElement.innerHTML = `평균과 동일<br><small>전체 평균: ${averageScore}점 (${totalParticipants}명 참가)</small>`;
                    comparisonElement.style.color = '#6c757d';
                }
                
                // 🎯 백분위 정보를 평균 비교 다음에 추가하고, 포인트 섹션을 그 다음으로 이동
                const percentileElement = document.createElement('p');
                percentileElement.style.cssText = 'color: var(--medium-gray); margin-top: 10px; font-size: 0.95em; font-weight: 500;';
                percentileElement.innerHTML = `백분위: <strong style="color: #2c3e50;">${percentile}</strong>`;
                percentileElement.className = 'percentile-info';
                
                const chartContainer = document.querySelector('.chart-container');
                const pointsDisplay = document.getElementById('pointsDisplay');
                
                if (chartContainer && comparisonElement && pointsDisplay && !chartContainer.querySelector('.percentile-info')) {
                    // 백분위 정보를 평균 비교 다음에 삽입
                    comparisonElement.parentElement.insertAdjacentElement('afterend', percentileElement);
                    
                    // 포인트 섹션을 백분위 정보 다음으로 이동
                    percentileElement.insertAdjacentElement('afterend', pointsDisplay);
                }
            }

            updateProgressCircle() {
                const circle = document.getElementById('progressCircle');
                const percentage = this.score;
                const degrees = (percentage / 100) * 360;
                
                circle.style.background = `conic-gradient(var(--primary-color) ${degrees}deg, #e9ecef ${degrees}deg)`;
            }

            displayQuestionResults() {
                const container = document.getElementById('questionResults');
                container.innerHTML = '';
                
                // 실제 데이터베이스에서 가져온 문제 결과 사용
                console.log('📊 문항별 결과 표시 시도:', { 
                    examData: this.examData, 
                    questions: this.examData?.questions,
                    questionsLength: this.examData?.questions?.length 
                });
                
                if (!this.examData || !this.examData.questions || this.examData.questions.length === 0) {
                    const errorMsg = `문제 결과를 불러올 수 없습니다. (examData: ${!!this.examData}, questions: ${!!this.examData?.questions}, length: ${this.examData?.questions?.length})`;
                    container.innerHTML = `<p>${errorMsg}</p>`;
                    console.warn('❌ 문항별 결과 표시 실패:', errorMsg);
                    return;
                }
                
                this.examData.questions.forEach((question, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = `question-result ${question.correct ? 'correct' : 'incorrect'}`;
                    
                    // 객관식 문제의 경우 선택지 표시
                    let choicesHtml = '';
                    if (question.type === 'multiple_choice' || question.type === '객관식') {
                        if (question.choices && question.choices.length > 0) {
                            choicesHtml = `
                                <div class="question-choices" style="margin-top: 15px;">
                                    <div style="font-weight: 600; margin-bottom: 10px; color: #666;">선택지:</div>
                                    ${question.choices.map((choice, choiceIndex) => {
                                        const isCorrect = choiceIndex === question.correctAnswer;
                                        const isUserSelected = choiceIndex === question.userAnswerIndex;
                                        
                                        let choiceClass = 'choice-item';
                                        let choiceIcon = '';
                                        let choiceLabel = '';
                                        
                                        if (isCorrect && isUserSelected) {
                                            // 정답이면서 사용자가 선택한 경우 - 파란색
                                            choiceClass += ' choice-correct-selected';
                                            choiceIcon = '<i class="fas fa-check-circle" style="color: #007bff;"></i>';
                                            choiceLabel = '<span style="color: #007bff; font-weight: 600;">(정답 ✓)</span>';
                                        } else if (isCorrect) {
                                            // 정답이지만 사용자가 선택하지 않은 경우 - 초록색
                                            choiceClass += ' choice-correct';
                                            choiceIcon = '<i class="fas fa-check" style="color: #28a745;"></i>';
                                            choiceLabel = '<span style="color: #28a745; font-weight: 600;">(정답)</span>';
                                        } else if (isUserSelected) {
                                            // 사용자가 선택했지만 틀린 경우 - 빨간색
                                            choiceClass += ' choice-user-selected';
                                            choiceIcon = '<i class="fas fa-times-circle" style="color: #dc3545;"></i>';
                                            choiceLabel = '<span style="color: #dc3545; font-weight: 600;">(내 선택 ✗)</span>';
                                        } else {
                                            // 일반 선택지
                                            choiceIcon = '<i class="fas fa-circle" style="color: #dee2e6;"></i>';
                                        }
                                        
                                        let backgroundColor, borderColor;
                                        if (isCorrect && isUserSelected) {
                                            // 정답을 맞춘 경우 - 파란색 배경
                                            backgroundColor = '#e3f2fd';
                                            borderColor = '#007bff';
                                        } else if (isCorrect) {
                                            // 정답이지만 선택하지 않은 경우 - 초록색 배경
                                            backgroundColor = '#f8fff9';
                                            borderColor = '#28a745';
                                        } else if (isUserSelected) {
                                            // 틀린 선택 - 빨간색 배경
                                            backgroundColor = '#fff8f8';
                                            borderColor = '#dc3545';
                                        } else {
                                            // 일반 선택지 - 회색 배경
                                            backgroundColor = '#f8f9fa';
                                            borderColor = '#e9ecef';
                                        }
                                        
                                        return `
                                            <div class="${choiceClass}" style="display: flex; align-items: center; padding: 8px 12px; margin: 5px 0; border-radius: 6px; background: ${backgroundColor}; border: 1px solid ${borderColor};">
                                                ${choiceIcon}
                                                <span style="margin-left: 10px; flex: 1;">${String.fromCharCode(65 + choiceIndex)}. ${choice}</span>
                                                ${choiceLabel}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `;
                        }
                    }
                    
                    questionDiv.innerHTML = `
                        <div class="question-info">
                            <div class="question-number">문제 ${index + 1}</div>
                            <div class="question-preview">${question.text}</div>
                            ${choicesHtml}
                        </div>
                        <div class="question-status">
                            <span class="status-icon ${question.correct ? 'correct' : 'incorrect'}">
                                <i class="fas fa-${question.correct ? 'check' : 'times'}-circle"></i>
                            </span>
                            <span>${question.correct ? '정답' : '오답'}</span>
                        </div>
                    `;
                    
                    container.appendChild(questionDiv);
                });
                
                // 더 보기 버튼 (전체 문제 수가 표시된 것보다 많을 때)
                const displayedQuestions = this.examData.questions.length;
                if (this.totalQuestions > displayedQuestions) {
                    const moreBtn = document.createElement('button');
                    moreBtn.className = 'btn btn-outline';
                    moreBtn.innerHTML = `<i class="fas fa-chevron-down"></i> 나머지 ${this.totalQuestions - displayedQuestions}개 문제 보기`;
                    moreBtn.onclick = () => this.showAllQuestions();
                    container.appendChild(moreBtn);
                }
            }

            displayRecommendations() {
                const container = document.getElementById('recommendationsList');
                const recommendations = this.generateRecommendations();
                
                container.innerHTML = '';
                
                recommendations.forEach(rec => {
                    const recDiv = document.createElement('div');
                    recDiv.className = 'recommendation-item';
                    recDiv.innerHTML = `
                        <i class="fas fa-${rec.icon} recommendation-icon"></i>
                        <span>${rec.text}</span>
                    `;
                    container.appendChild(recDiv);
                });
            }

            generateRecommendations() {
                const recommendations = [];
                
                if (this.score >= 90) {
                    recommendations.push(
                        { icon: 'trophy', text: '우수한 성과입니다! 다음 단계의 고급 과정에 도전해보세요.' },
                        { icon: 'graduation-cap', text: '동료들에게 지식을 공유하는 것을 고려해보세요.' }
                    );
                } else if (this.score >= 80) {
                    recommendations.push(
                        { icon: 'book', text: '틀린 문제들을 다시 한번 복습해보세요.' },
                        { icon: 'clock', text: '정기적인 복습으로 지식을 더욱 공고히 하세요.' }
                    );
                } else if (this.score >= 70) {
                    recommendations.push(
                        { icon: 'study', text: '기본 개념을 더 확실히 익혀보세요.' },
                        { icon: 'practice', text: '추가 연습 문제를 통해 실력을 향상시키세요.' },
                        { icon: 'clock', text: '충분한 학습 시간을 확보하세요.' }
                    );
                } else {
                    recommendations.push(
                        { icon: 'book-open', text: '기초부터 차근차근 다시 학습하는 것을 권장합니다.' },
                        { icon: 'users', text: '스터디 그룹에 참여하거나 멘토의 도움을 받아보세요.' },
                        { icon: 'calendar-alt', text: '체계적인 학습 계획을 세워보세요.' },
                        { icon: 'redo', text: '포기하지 마시고 꾸준히 재도전하세요.' }
                    );
                }
                
                return recommendations;
            }

            async displayPointsInfo() {
                try {
                                    // sessionStorage에서 포인트 정보 가져오기 (시험별 고유 키)
                const examId = this.examData.sessionId || this.examData.examId || 'default';
                const pointStorageKey = `examPointReward_${examId}`;
                const pointRewardData = sessionStorage.getItem(pointStorageKey);
                
                console.log('🔍 포인트 캐시 확인:', {
                    examId: examId,
                    storageKey: pointStorageKey,
                    hasCache: !!pointRewardData
                });
                    const earnedPointsElement = document.getElementById('earnedPointsDisplay');
                    const pointsBreakdownElement = document.getElementById('pointsBreakdown');
                    
                    if (pointRewardData) {
                        const pointBreakdown = JSON.parse(pointRewardData);
                        console.log('🎯 포인트 정보 표시:', pointBreakdown);
                        
                        // 총 획득 포인트 표시
                        const totalPoints = pointBreakdown.totalPoints || 0;
                        earnedPointsElement.textContent = `+${totalPoints}P`;
                        
                        // 포인트 상세 내역 표시
                        const breakdownDetails = [];
                        
                        if (pointBreakdown.questionPoints > 0) {
                            breakdownDetails.push(`문제 정답: +${pointBreakdown.questionPoints}P`);
                        }
                        
                        if (pointBreakdown.completionBonus > 0) {
                            breakdownDetails.push(`완료 보너스: +${pointBreakdown.completionBonus}P`);
                        }
                        
                        if (pointBreakdown.passingBonus > 0) {
                            breakdownDetails.push(`합격 보너스: +${pointBreakdown.passingBonus}P`);
                        }
                        
                        if (pointBreakdown.difficultyBonus > 0) {
                            breakdownDetails.push(`난이도 보너스: +${pointBreakdown.difficultyBonus}P`);
                        }
                        
                        if (pointBreakdown.streakBonus > 0) {
                            breakdownDetails.push(`연속 정답: +${pointBreakdown.streakBonus}P`);
                        }
                        
                        if (pointBreakdown.timeBonus > 0) {
                            breakdownDetails.push(`시간 보너스: +${pointBreakdown.timeBonus}P`);
                        }
                        
                        pointsBreakdownElement.textContent = breakdownDetails.join(' | ');
                        
                        // 🔧 중요: sessionStorage에 데이터가 있어도 데이터베이스 적립 시도
                        if (!pointBreakdown.dbSaved) {
                            console.log('💾 sessionStorage 포인트를 데이터베이스에 적립 시도...');
                            await this.savePointsToDatabase(totalPoints, pointBreakdown);
                        } else if (pointBreakdown.duplicatePrevented) {
                            console.log('🛡️ 중복 적립 방지됨 - 이미 동일한 시험으로 포인트 적립됨');
                        } else {
                            console.log('✅ 포인트가 이미 데이터베이스에 저장됨');
                        }
                        
                    } else {
                        // 포인트 정보가 없는 경우 - 자동으로 계산
                        console.log('⚠️ 포인트 정보 없음 - 자동 계산 시도');
                        await this.calculateMissingPoints(earnedPointsElement, pointsBreakdownElement);
                    }
                } catch (error) {
                    console.error('❌ 포인트 정보 표시 오류:', error);
                    document.getElementById('earnedPointsDisplay').textContent = '오류';
                    document.getElementById('pointsBreakdown').textContent = '포인트 정보를 불러올 수 없습니다.';
                }
            }

            async savePointsToDatabase(totalPoints, pointBreakdown) {
                try {
                    // Supabase 클라이언트 및 사용자 정보 확인
                    const supabaseClient = window.semuApp?.supabaseClient || window.supabaseClient;
                    const userId = this.examData.employeeId || window.semuApp?.currentUser?.id;
                    const examTitle = this.examData.title || '시험';
                    
                    console.log('🔍 포인트 적립 조건 확인:', {
                        supabaseClient: !!supabaseClient,
                        userId: userId,
                        sessionId: this.examData.sessionId,
                        totalPoints: totalPoints,
                        examTitle: examTitle
                    });
                    
                    if (supabaseClient && userId) {
                        // 🛡️ 중복 적립 방지: 이미 적립된 포인트가 있는지 확인
                        console.log('🛡️ 중복 적립 방지 검사 시작...');
                        
                        const { data: existingTransactions, error: checkError } = await supabaseClient
                            .from('point_transactions')
                            .select('id, amount, created_at')
                            .eq('user_id', userId)
                            .eq('description', `시험 완료: ${examTitle}`)
                            .order('created_at', { ascending: false })
                            .limit(1);
                        
                        if (checkError) {
                            console.warn('⚠️ 중복 검사 실패, 적립 중단:', checkError);
                            return;
                        }
                        
                        if (existingTransactions && existingTransactions.length > 0) {
                            const existingTransaction = existingTransactions[0];
                            
                            console.log('🛡️ 기존 포인트 적립 발견:', {
                                transactionId: existingTransaction.id,
                                amount: existingTransaction.amount,
                                createdAt: existingTransaction.created_at,
                                examTitle: examTitle
                            });
                            
                            // 동일 시험으로 이미 포인트가 적립되었으면 무조건 중복으로 판단
                            console.log('✅ 중복 적립 방지: 이미 동일 시험으로 포인트가 적립됨');
                            
                            // sessionStorage에 저장 완료 표시
                            pointBreakdown.dbSaved = true;
                            pointBreakdown.duplicatePrevented = true;
                            const examId = this.examData.sessionId || this.examData.examId || 'default';
                            const pointStorageKey = `examPointReward_${examId}`;
                            sessionStorage.setItem(pointStorageKey, JSON.stringify(pointBreakdown));
                            
                            return;
                        }
                        
                        console.log('💾 데이터베이스에 포인트 적립 시도...');
                        
                        const { data, error } = await supabaseClient
                            .rpc('add_user_points', {
                                target_user_id: userId,
                                points_to_add: totalPoints,
                                description: `시험 완료: ${examTitle}`,
                                target_avatar_item_id: null
                            });
                            
                        if (error) {
                            console.warn('⚠️ 포인트 적립 실패:', error);
                        } else {
                            console.log('✅ 포인트 데이터베이스 적립 완료:', data);
                            
                            // sessionStorage에 저장 완료 표시
                            pointBreakdown.dbSaved = true;
                            pointBreakdown.firstTimeReward = true;
                            const examId = this.examData.sessionId || this.examData.examId || 'default';
                            const pointStorageKey = `examPointReward_${examId}`;
                            sessionStorage.setItem(pointStorageKey, JSON.stringify(pointBreakdown));
                        }
                    } else {
                        console.warn('⚠️ 포인트 적립 조건 미충족:', {
                            supabaseClient: !!supabaseClient,
                            userId: userId
                        });
                    }
                } catch (error) {
                    console.error('❌ 포인트 DB 저장 오류:', error);
                }
            }

            async calculateMissingPoints(earnedPointsElement, pointsBreakdownElement) {
                try {
                    console.log('🔄 누락된 포인트 자동 계산 시작...');
                    
                    // 기본 포인트 계산 로직
                    const { correctAnswers, earnedPoints } = this.examData;
                    let totalPoints = 0;
                    let breakdown = [];
                    
                    // 1. 문제 정답 포인트 (정답 1개당 10점)
                    console.log('🔍 포인트 계산 상세:', {
                        correctAnswers: correctAnswers,
                        totalQuestions: this.totalQuestions || this.total,
                        score: this.score,
                        percentage: this.examData.percentage
                    });
                    
                    const questionPoints = correctAnswers * 10;  // 정답 1개당 10점
                    totalPoints += questionPoints;
                    breakdown.push(`문제 정답: +${questionPoints}P`);
                    
                    // 2. 시험 완료 보너스 (200점)
                    const completionBonus = 200;
                    totalPoints += completionBonus;
                    breakdown.push(`완료 보너스: +${completionBonus}P`);
                    
                    // 3. 합격 보너스 (70점 이상이면 300점)
                    const percentage = this.examData.percentage || this.score;
                    if (percentage >= 70) {
                        const passingBonus = 300;
                        totalPoints += passingBonus;
                        breakdown.push(`합격 보너스: +${passingBonus}P`);
                    }
                    
                    // UI 업데이트
                    earnedPointsElement.textContent = `+${totalPoints}P`;
                    pointsBreakdownElement.textContent = breakdown.join(' | ');
                    
                    // sessionStorage에 저장 (향후 사용을 위해)
                    const pointData = {
                        totalPoints,
                        questionPoints,
                        completionBonus,
                        passingBonus: percentage >= 70 ? 300 : 0,
                        difficultyBonus: 0,
                        streakBonus: 0,
                        timeBonus: 0,
                        autoCalculated: true
                    };
                    const examId = this.examData.sessionId || this.examData.examId || 'default';
                    const pointStorageKey = `examPointReward_${examId}`;
                    sessionStorage.setItem(pointStorageKey, JSON.stringify(pointData));
                    
                    console.log('✅ 포인트 자동 계산 완료:', pointData);
                    
                    // 실제 데이터베이스에 포인트 적립 시도
                    const supabaseClient = window.semuApp?.supabaseClient || window.supabaseClient;
                    const userId = this.examData.employeeId || window.semuApp?.currentUser?.id;
                    
                    console.log('🔍 포인트 적립 조건 확인:', {
                        supabaseClient: !!supabaseClient,
                        userId: userId,
                        sessionId: this.examData.sessionId,
                        totalPoints: totalPoints
                    });
                    
                    if (supabaseClient && userId) {
                        try {
                            const examTitle = this.examData.title || '시험';
                            
                            // 🛡️ 중복 적립 방지: 이미 적립된 포인트가 있는지 확인
                            console.log('🛡️ 자동 계산 - 중복 적립 방지 검사 시작...');
                            
                            const { data: existingTransactions, error: checkError } = await supabaseClient
                                .from('point_transactions')
                                .select('id, amount, created_at')
                                .eq('user_id', userId)
                                .eq('description', `시험 완료: ${examTitle}`)
                                .order('created_at', { ascending: false })
                                .limit(1);
                            
                            if (checkError) {
                                console.warn('⚠️ 중복 검사 실패, 적립 중단:', checkError);
                                return;
                            }
                            
                            if (existingTransactions && existingTransactions.length > 0) {
                                const existingTransaction = existingTransactions[0];
                                
                                console.log('🛡️ 자동 계산 - 기존 포인트 적립 발견:', {
                                    transactionId: existingTransaction.id,
                                    amount: existingTransaction.amount,
                                    createdAt: existingTransaction.created_at,
                                    examTitle: examTitle
                                });
                                
                                // 동일 시험으로 이미 포인트가 적립되었으면 무조건 중복으로 판단
                                console.log('✅ 자동 계산 - 중복 적립 방지: 이미 동일 시험으로 포인트가 적립됨');
                                
                                // sessionStorage에도 중복 방지 정보 저장
                                pointData.dbSaved = true;
                                pointData.duplicatePrevented = true;
                                const examId = this.examData.sessionId || this.examData.examId || 'default';
                                const pointStorageKey = `examPointReward_${examId}`;
                                sessionStorage.setItem(pointStorageKey, JSON.stringify(pointData));
                                
                                return;
                            }
                            
                            console.log('💾 데이터베이스에 포인트 적립 시도...');
                            
                            const { data, error } = await supabaseClient
                                .rpc('add_user_points', {
                                    target_user_id: userId,
                                    points_to_add: totalPoints,
                                    description: `시험 완료: ${examTitle}`,
                                    target_avatar_item_id: null
                                });
                                
                            if (error) {
                                console.warn('⚠️ 포인트 적립 실패:', error);
                            } else {
                                console.log('✅ 포인트 데이터베이스 적립 완료:', data);
                                
                                // sessionStorage에 성공 정보 업데이트
                                pointData.dbSaved = true;
                                pointData.firstTimeReward = true;
                                const examId = this.examData.sessionId || this.examData.examId || 'default';
                                const pointStorageKey = `examPointReward_${examId}`;
                                sessionStorage.setItem(pointStorageKey, JSON.stringify(pointData));
                            }
                        } catch (dbError) {
                            console.warn('⚠️ 포인트 DB 적립 오류:', dbError);
                        }
                    } else {
                        console.warn('⚠️ 포인트 적립 조건 미충족:', {
                            supabaseClient: !!supabaseClient,
                            userId: userId
                        });
                    }
                    
                } catch (error) {
                    console.error('❌ 포인트 자동 계산 실패:', error);
                    earnedPointsElement.textContent = '계산 실패';
                    pointsBreakdownElement.textContent = '포인트를 계산할 수 없습니다.';
                }
            }

            showAllQuestions() {
                showAlert('전체 문항별 상세 분석 기능은 곧 구현될 예정입니다.', 'info');
            }

            // 시험 선택 UI 표시
            async showExamSelectionUI() {
                try {
                    console.log('📋 사용자 완료 시험 목록 로딩 중...');
                    
                    // 사용자의 완료된 시험 세션 조회 (submitted, completed 상태 모두 포함)
                    const { data: sessions, error: sessionsError } = await window.supabaseClient
                        .from('exam_sessions')
                        .select(`
                            id,
                            exam_id,
                            status,
                            score,
                            total_points,
                            submit_time,
                            created_at,
                            exams (
                                id,
                                title,
                                description
                            )
                        `)
                        .eq('employee_id', window.semuApp.currentUser.id)
                        .in('status', ['submitted', 'completed', 'in_progress'])
                        // 점수 조건 제거 - 진행중인 시험도 볼 수 있도록
                        .order('submit_time', { ascending: false, nullsLast: true })
                        .order('created_at', { ascending: false });

                    if (sessionsError) {
                        console.error('❌ 시험 세션 조회 실패:', sessionsError);
                        throw sessionsError;
                    }

                    console.log('📊 완료된 시험 세션:', sessions);
                    
                    // 디버깅을 위한 세션 상태별 개수 로그
                    if (sessions && sessions.length > 0) {
                        const statusCounts = sessions.reduce((acc, session) => {
                            acc[session.status] = (acc[session.status] || 0) + 1;
                            return acc;
                        }, {});
                        console.log('📈 시험 세션 상태별 개수:', statusCounts);
                        
                        sessions.forEach(session => {
                            console.log(`🎯 시험: ${session.exams?.title}, 상태: ${session.status}, 점수: ${session.score}`);
                        });
                    }

                    if (!sessions || sessions.length === 0) {
                        this.showNoExamsMessage();
                        return;
                    }

                    this.displayExamSelection(sessions);
                    
                } catch (error) {
                    console.error('❌ 시험 목록 로딩 실패:', error);
                    this.showNoExamsMessage();
                }
            }

            // 시험 목록 화면 표시
            displayExamSelection(sessions) {
                const container = document.querySelector('.results-container');
                
                container.innerHTML = `
                    <div class="exam-selection-container">
                        <div class="exam-selection-header">
                            <h2>🎯 시험 선택</h2>
                            <p>확인하고 싶은 시험 결과를 선택하거나 진행중인 시험을 계속 응시하세요.</p>
                        </div>
                        
                        <div class="exam-list">
                            ${sessions.map((session, index) => {
                                const exam = session.exams;
                                const score = session.score || 0;
                                const totalPoints = session.total_points || 100;
                                const percentage = session.score !== null ? Math.round((score / totalPoints) * 100) : 0;
                                // submit_time이 없으면 created_at 사용
                                const dateToShow = session.submit_time || session.created_at;
                                const submitDate = new Date(dateToShow).toLocaleDateString('ko-KR', {
                                    year: 'numeric',
                                    month: 'long', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                                const dateLabel = session.submit_time ? '제출일' : '응시일';

                                return `
                                <div class="exam-item" onclick="window.resultsPage.selectExam('${session.exam_id}', ${score}, ${totalPoints})">
                                    <div class="exam-item-content">
                                        <div class="exam-item-main">
                                            <div class="exam-item-header">
                                                <h3>${exam?.title || '시험 제목 없음'}</h3>
                                                <div class="exam-score ${session.score !== null ? (percentage >= 80 ? 'high-score' : percentage >= 60 ? 'medium-score' : 'low-score') : 'in-progress'}">
                                                    ${session.score !== null ? `${percentage}점` : '진행중'}
                                                </div>
                                            </div>
                                            <div class="exam-item-details">
                                                <div class="exam-description">${exam?.description || '설명 없음'}</div>
                                                <div class="exam-date">${dateLabel}: ${submitDate}</div>
                                            </div>
                                        </div>
                                        <div class="exam-item-arrow">→</div>
                                    </div>
                                </div>
                            `;
                            }).join('')}
                        </div>
                        
                        <div class="exam-selection-footer">
                            <button class="btn-secondary" onclick="window.location.href='dashboard.html'">
                                📊 대시보드로 돌아가기
                            </button>
                        </div>
                    </div>
                `;

                // 스타일 추가
                this.addExamSelectionStyles();
            }

            // 시험이 없을 때 메시지
            showNoExamsMessage() {
                const container = document.querySelector('.results-container');
                
                container.innerHTML = `
                    <div class="no-exams-container">
                        <div class="no-exams-icon">📝</div>
                        <h2>완료된 시험이 없습니다</h2>
                        <p>먼저 시험을 응시한 후 결과를 확인할 수 있습니다.</p>
                        <div class="no-exams-actions">
                            <button class="btn-primary" onclick="window.location.href='dashboard.html'">
                                🏠 대시보드로 이동
                            </button>
                        </div>
                    </div>
                `;

                this.addExamSelectionStyles();
            }

            // 시험 선택
            selectExam(examId, score, totalPoints) {
                console.log('🎯 시험 선택됨:', { examId, score, totalPoints });
                
                try {
                    // 진행중인 시험(score가 0이고 totalPoints가 100인 경우) 처리
                    if (score === 0 && totalPoints === 100) {
                        // 진행중인 시험인지 확인 후 시험 응시 페이지로 이동
                        const confirmContinue = confirm('이 시험은 아직 진행중입니다. 시험을 계속 응시하시겠습니까?');
                        if (confirmContinue) {
                            window.location.href = `exam.html?id=${examId}`;
                            return;
                        } else {
                            return; // 취소 시 아무것도 하지 않음
                        }
                    }
                    
                    // URL 파라미터 안전하게 생성
                    const scorePercentage = totalPoints > 0 ? Math.round((score / totalPoints) * 100) : 0;
                    const urlParams = new URLSearchParams({
                        exam: examId,
                        score: scorePercentage,
                        total: totalPoints
                    });
                    
                    const newUrl = `results.html?${urlParams.toString()}`;
                    console.log('🔗 리다이렉트 URL:', newUrl);
                    
                    window.location.href = newUrl;
                } catch (error) {
                    console.error('❌ 시험 선택 중 오류:', error);
                    alert('시험 결과 페이지로 이동하는 중 오류가 발생했습니다.');
                }
            }

            // 시험 선택 화면용 스타일 추가
            addExamSelectionStyles() {
                if (document.getElementById('exam-selection-styles')) return;

                const styles = document.createElement('style');
                styles.id = 'exam-selection-styles';
                styles.textContent = `
                    .exam-selection-container {
                        max-width: 900px;
                        margin: 0 auto;
                        padding: 40px 20px;
                        min-height: 80vh;
                        display: flex;
                        flex-direction: column;
                    }

                    .exam-selection-header {
                        text-align: center;
                        margin-bottom: 40px;
                        padding: 20px 0;
                    }

                    .exam-selection-header h2 {
                        color: #2c3e50;
                        margin-bottom: 12px;
                        font-size: 28px;
                        font-weight: 600;
                    }

                    .exam-selection-header p {
                        color: #7f8c8d;
                        font-size: 16px;
                        line-height: 1.5;
                    }

                    .exam-list {
                        display: flex;
                        flex-direction: column;
                        gap: 20px;
                        margin-bottom: 40px;
                        flex: 1;
                    }

                    .exam-item {
                        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                        border: 1px solid #e9ecef;
                        border-radius: 16px;
                        padding: 24px;
                        cursor: pointer;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        display: flex;
                        align-items: center;
                        gap: 20px;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
                        position: relative;
                        overflow: hidden;
                    }

                    .exam-item::before {
                        content: '';
                        position: absolute;
                        left: 0;
                        top: 0;
                        height: 100%;
                        width: 4px;
                        background: linear-gradient(180deg, #6c5ce7, #a29bfe);
                        opacity: 0;
                        transition: opacity 0.3s ease;
                    }

                    .exam-item:hover {
                        border-color: #6c5ce7;
                        box-shadow: 0 8px 25px rgba(108, 92, 231, 0.15);
                        transform: translateY(-4px);
                    }

                    .exam-item:hover::before {
                        opacity: 1;
                    }

                    .exam-item-content {
                        flex: 1;
                        display: flex;
                        align-items: center;
                        gap: 24px;
                    }

                    .exam-item-main {
                        flex: 1;
                        min-width: 0;
                    }

                    .exam-item-header {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        margin-bottom: 8px;
                    }

                    .exam-item-header h3 {
                        margin: 0;
                        color: #2c3e50;
                        font-size: 20px;
                        font-weight: 600;
                        line-height: 1.3;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                        max-width: 400px;
                    }

                    .exam-score {
                        padding: 10px 20px;
                        border-radius: 25px;
                        font-weight: 700;
                        font-size: 16px;
                        white-space: nowrap;
                        margin-left: 16px;
                        min-width: 80px;
                        text-align: center;
                    }

                    .exam-score.high-score {
                        background: linear-gradient(135deg, #00b894, #00cec9);
                        color: white;
                        box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
                    }

                    .exam-score.medium-score {
                        background: linear-gradient(135deg, #fdcb6e, #e17055);
                        color: white;
                        box-shadow: 0 4px 15px rgba(253, 203, 110, 0.3);
                    }

                    .exam-score.low-score {
                        background: linear-gradient(135deg, #fd79a8, #e84393);
                        color: white;
                        box-shadow: 0 4px 15px rgba(253, 121, 168, 0.3);
                    }

                    .exam-score.in-progress {
                        background: linear-gradient(135deg, #f39c12, #e67e22);
                        color: white;
                        box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
                    }

                    .exam-item-details {
                        display: flex;
                        flex-direction: column;
                        gap: 4px;
                    }

                    .exam-description {
                        color: #636e72;
                        font-size: 14px;
                        line-height: 1.4;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                        max-width: 500px;
                    }

                    .exam-date {
                        color: #b2bec3;
                        font-size: 13px;
                        font-weight: 500;
                    }

                    .exam-item-arrow {
                        font-size: 24px;
                        color: #6c5ce7;
                        transition: transform 0.3s ease;
                        opacity: 0.7;
                    }

                    .exam-item:hover .exam-item-arrow {
                        transform: translateX(4px);
                        opacity: 1;
                    }

                    .exam-selection-footer {
                        text-align: center;
                        margin-top: auto;
                        padding-top: 20px;
                    }

                    .no-exams-container {
                        text-align: center;
                        padding: 80px 20px;
                        max-width: 500px;
                        margin: 0 auto;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        min-height: 60vh;
                    }

                    .no-exams-icon {
                        font-size: 80px;
                        margin-bottom: 24px;
                        opacity: 0.8;
                    }

                    .no-exams-container h2 {
                        color: #2c3e50;
                        margin-bottom: 16px;
                        font-size: 24px;
                        font-weight: 600;
                    }

                    .no-exams-container p {
                        color: #7f8c8d;
                        font-size: 16px;
                        margin-bottom: 32px;
                        line-height: 1.6;
                    }

                    .no-exams-actions {
                        display: flex;
                        justify-content: center;
                        gap: 16px;
                    }

                    .btn-primary, .btn-secondary {
                        padding: 14px 28px;
                        border: none;
                        border-radius: 12px;
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        text-decoration: none;
                        display: inline-flex;
                        align-items: center;
                        gap: 8px;
                    }

                    .btn-primary {
                        background: linear-gradient(135deg, #6c5ce7, #a29bfe);
                        color: white;
                        box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
                    }

                    .btn-primary:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 6px 20px rgba(108, 92, 231, 0.4);
                    }

                    .btn-secondary {
                        background: white;
                        color: #6c5ce7;
                        border: 2px solid #6c5ce7;
                    }

                    .btn-secondary:hover {
                        background: #6c5ce7;
                        color: white;
                        transform: translateY(-2px);
                    }

                    @media (max-width: 768px) {
                        .exam-selection-container {
                            padding: 20px 15px;
                        }

                        .exam-selection-header h2 {
                            font-size: 24px;
                        }

                        .exam-item {
                            padding: 20px;
                            flex-direction: column;
                            align-items: stretch;
                        }

                        .exam-item-content {
                            flex-direction: column;
                            gap: 16px;
                        }

                        .exam-item-header {
                            flex-direction: column;
                            align-items: flex-start;
                            gap: 12px;
                        }

                        .exam-item-header h3 {
                            font-size: 18px;
                            max-width: none;
                        }

                        .exam-score {
                            margin-left: 0;
                            align-self: flex-start;
                        }

                        .exam-description {
                            max-width: none;
                            white-space: normal;
                        }

                        .exam-item-arrow {
                            align-self: center;
                            margin-top: 8px;
                        }

                        .no-exams-actions {
                            flex-direction: column;
                            align-items: center;
                        }

                        .btn-primary, .btn-secondary {
                            width: 200px;
                            justify-content: center;
                        }
                    }

                    @media (max-width: 480px) {
                        .exam-selection-header {
                            padding: 15px 0;
                            margin-bottom: 30px;
                        }

                        .exam-item {
                            padding: 16px;
                        }

                        .exam-item-header h3 {
                            font-size: 16px;
                        }

                        .exam-score {
                            padding: 8px 16px;
                            font-size: 14px;
                        }
                    }
                `;
                
                document.head.appendChild(styles);
            }
        }

        // 전역 함수들
        let resultsPage;
        
        // 전역에서 접근 가능하도록 설정
        window.resultsPage = null;

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('📊 결과 페이지 DOM 로드 완료');
            
            // Supabase 초기화 대기
            let attempts = 0;
            const maxAttempts = 50;
            
            while (attempts < maxAttempts && (!window.semuApp || !window.supabaseClient)) {
                console.log('⏳ Supabase 초기화 대기 중...', attempts);
                await new Promise(resolve => setTimeout(resolve, 200));
                attempts++;
            }
            
            if (window.semuApp && window.supabaseClient) {
                console.log('✅ Supabase 초기화 완료, 결과 페이지 생성');
                resultsPage = new ResultsPage();
                window.resultsPage = resultsPage; // 전역에서 접근 가능하도록
            } else {
                console.error('❌ Supabase 초기화 실패');
                alert('시스템 초기화에 실패했습니다. 페이지를 새로고침해주세요.');
            }
        });

        // 재응시 기능 비활성화
        /*
        function retakeExam() {
            if (confirm('같은 시험을 다시 응시하시겠습니까?')) {
                // URL에서 시험 ID 가져오기
                const urlParams = new URLSearchParams(window.location.search);
                const examId = urlParams.get('exam');
                
                if (examId) {
                    window.location.href = `./exam.html?id=${examId}`;
                } else {
                    // 시험 ID가 없는 경우 대시보드로 이동
                    window.location.href = './dashboard.html';
                }
            }
        }
        */

        async function viewDetails() {
            try {
                // URL에서 시험 ID 가져오기
                const urlParams = new URLSearchParams(window.location.search);
                const examId = urlParams.get('exam');
                
                if (!examId) {
                    showAlert('시험 정보를 찾을 수 없습니다.', 'error');
                    return;
                }
                
                // 인라인 상세 분석 표시
                await showDetailedAnalysisInline(examId);
                
            } catch (error) {
                console.error('상세 분석 표시 실패:', error);
                showAlert('상세 분석을 불러오는데 실패했습니다.', 'error');
            }
        }
        
        // 인라인 상세 분석 표시 (새로운 세로 스크롤 방식)
        async function showDetailedAnalysisInline(examId) {
            try {
                // 기존 상세 분석 섹션이 있다면 제거
                const existingAnalysis = document.getElementById('inline-detailed-analysis');
                if (existingAnalysis) {
                    existingAnalysis.remove();
                }
                
                // 1단계: 시험의 모든 문제 조회 (선택지 포함)
                const { data: examQuestions, error: examQuestionsError } = await window.supabaseClient
                    .from('exam_questions')
                    .select(`
                        *,
                        questions (
                            id,
                            title,
                            content,
                            type,
                            explanation,
                            model_answer,
                            choices,
                            question_options (
                                id,
                                content,
                                is_correct,
                                order_index
                            )
                        )
                    `)
                    .eq('exam_id', examId)
                    .order('order_index');
                    
                if (examQuestionsError) throw examQuestionsError;
                
                // 2단계: 사용자의 답안 정보 가져오기
                const { data: userSession, error: sessionError } = await window.supabaseClient
                    .from('exam_sessions')
                    .select('id, start_time, submit_time')
                    .eq('exam_id', examId)
                    .eq('employee_id', window.semuApp.currentUser.id)
                    .single();
                    
                if (sessionError) throw sessionError;
                
                const { data: answers, error: answersError } = await window.supabaseClient
                    .from('exam_answers')
                    .select('*')
                    .eq('session_id', userSession.id);
                    
                if (answersError) throw answersError;
                
                // 답안을 질문 ID별로 매핑
                const answersByQuestion = {};
                answers.forEach(answer => {
                    answersByQuestion[answer.question_id] = answer;
                });
                
                // 선택지 정보는 이미 문제 조회에 포함되어 있음 (question_options)
                console.log('🔍 조회된 문제 데이터:', examQuestions);
                console.log('🔍 첫 번째 문제 상세 구조:', JSON.stringify(examQuestions[0], null, 2));
                console.log('🔍 현재 시험에 포함된 모든 문제 ID들:', examQuestions.map(eq => eq.questions.id));
                
                // 각 문제의 선택지 확인
                examQuestions.forEach((examQuestion, index) => {
                    const question = examQuestion.questions;
                    const options = question.question_options || [];
                    console.log(`📝 문제 ${index + 1} (${question.id})의 선택지:`, {
                        count: options.length,
                        type: question.type,
                        options: options
                    });
                });
                
                // 선택지 정보를 질문별로 그룹화 (이미 조회된 데이터 사용)
                const optionsByQuestion = {};
                
                examQuestions.forEach(examQuestion => {
                    const question = examQuestion.questions;
                    const optionsFromTable = question.question_options || [];
                    
                    // 변경: results는 항상 questions.choices 기준으로 표시
                    if (question.choices && Array.isArray(question.choices) && question.choices.length > 0) {
                        optionsByQuestion[question.id] = question.choices.map((choice, index) => ({
                            content: choice.text || choice.content || choice,
                            is_correct: !!(choice.isCorrect || choice.is_correct),
                            order_index: index
                        }));
                        console.log(`✅ 문제 ${question.id}: choices 필드에서 ${question.choices.length}개 선택지 로드됨 (우선 사용)`);
                        return;
                    }
                    
                    // choices가 없을 때만 question_options를 사용
                    if (optionsFromTable.length > 0) {
                        optionsByQuestion[question.id] = optionsFromTable.sort((a, b) => a.order_index - b.order_index);
                        console.log(`✅ 문제 ${question.id}: question_options에서 ${optionsFromTable.length}개 선택지 로드됨 (대체 사용)`);
                        return;
                    }
                    
                    // 3차: 선택지가 없는 경우에만 임시 데이터 생성
                    console.warn(`⚠️ 문제 ${question.id}: 선택지 없음, 임시 데이터 생성`);
                    console.log(`🔍 문제 구조:`, question);
                    
                    const correctIndex = Math.floor(Math.random() * 4);
                    optionsByQuestion[question.id] = [
                        { 
                            content: '부가가치세법에 따른 의무사항을 준수해야 한다', 
                            is_correct: correctIndex === 0, 
                            order_index: 0 
                        },
                        { 
                            content: '소득세법 규정에 따라 신고납부해야 한다', 
                            is_correct: correctIndex === 1, 
                            order_index: 1 
                        },
                        { 
                            content: '법인세법에 의거하여 처리해야 한다', 
                            is_correct: correctIndex === 2, 
                            order_index: 2 
                        },
                        { 
                            content: '조세특례제한법의 혜택을 받을 수 있다', 
                            is_correct: correctIndex === 3, 
                            order_index: 3 
                        }
                    ];
                });
                
                // 인라인 상세 분석 HTML 생성
                const detailedAnalysisHtml = `
                    <div class="detailed-analysis-inline" id="inline-detailed-analysis">
                        <div class="analysis-header">
                            <h3 class="section-title">
                                <i class="fas fa-chart-line"></i>
                                시험 상세 분석
                            </h3>
                            <div class="analysis-summary-inline">
                                <div class="summary-stats-inline">
                                    <div class="summary-item">
                                        <span class="summary-label">총 문제 수</span>
                                        <span class="summary-value">${examQuestions.length}개</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">답변 완료</span>
                                        <span class="summary-value">${answers.length}개</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">미답변</span>
                                        <span class="summary-value">${examQuestions.length - answers.length}개</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="questions-list-vertical">
                            ${examQuestions.map((examQuestion, index) => {
                                const question = examQuestion.questions;
                                const answer = answersByQuestion[question.id];
                                // 🎯 단순화: 원본 choices 데이터만 사용
                                const originalChoices = question.choices || question.options || [];
                                
                                return `
                                <div class="question-item-vertical">
                                    <div class="question-number-badge">
                                        <span class="question-num">${index + 1}</span>
                                        <span class="question-type-badge">${getQuestionTypeDisplay(question?.type)}</span>
                                        <span class="question-score-badge">${answer?.points || 0}점</span>
                                    </div>
                                    
                                    <div class="question-content-section">
                                        <h4 class="question-title">문제 ${index + 1}</h4>
                                        <div class="question-text">${question?.title || question?.content || '내용 없음'}</div>
                                    </div>
                                    
                                    ${(() => {
                                        // 객관식 문제의 선택지 표시
                                                                                    // 정답 인덱스 찾기 (choices 배열에서 isCorrect: true인 항목)
                                            const correctIndex = originalChoices.findIndex(choice => choice.isCorrect === true);
                                            
                                            console.log('🔍 원본 선택지 표시:', {
                                                questionId: question.id,
                                                type: question?.type,
                                                choicesCount: originalChoices.length,
                                                userAnswer: answer?.answer,
                                                correctIndex: correctIndex,
                                                isUserCorrect: answer?.is_correct
                                            });
                                        
                                        // 객관식 문제의 선택지 표시 (원본 순서)
                                        if ((question.type === 'multiple_choice' || question.type === '객관식') && originalChoices.length > 0) {
                                            return `
                                                <div class="choices-section">
                                                    <h5>선택지</h5>
                                                    <div class="choices-list">
                                                        ${originalChoices.map((choice, choiceIndex) => {
                                                            // 저장된 answer는 원본 인덱스 숫자
                                                            const userAnswerIndex = parseInt(answer?.answer || '-1');
                                                            const isCorrect = choiceIndex === correctIndex;
                                                            const isUserSelected = choiceIndex === userAnswerIndex;
                                                            
                                                            let choiceClass = 'choice-item-vertical';
                                                            let choiceIcon = '';
                                                            let choiceLabel = '';
                                                            let choiceStyle = '';
                                                            const isUserCorrect = answer?.is_correct;
                                                            
                                                            if (isCorrect && isUserSelected && isUserCorrect) {
                                                                // 정답을 맞췄을 때 - 파란색
                                                                choiceClass += ' choice-correct-selected';
                                                                choiceIcon = '<i class="fas fa-check-circle"></i>';
                                                                choiceLabel = '<span class="choice-status correct-selected">내 선택 ✓</span>';
                                                                choiceStyle = 'background-color: #e3f2fd !important; border-color: #2196f3 !important; color: #1976d2 !important;';
                                                            } else if (isCorrect) {
                                                                // 정답 (사용자가 선택하지 않은 경우) - 녹색
                                                                choiceClass += ' choice-correct';
                                                                choiceIcon = '<i class="fas fa-check-circle"></i>';
                                                                choiceLabel = '<span class="choice-status correct">정답 ✓</span>';
                                                                choiceStyle = 'background-color: #e8f5e8 !important; border-color: #4caf50 !important; color: #2e7d32 !important;';
                                                            } else if (isUserSelected && !isUserCorrect) {
                                                                // 사용자가 틀린 답을 선택한 경우 - 빨간색
                                                                choiceClass += ' choice-user-wrong';
                                                                choiceIcon = '<i class="fas fa-times-circle"></i>';
                                                                choiceLabel = '<span class="choice-status user-wrong">내 선택 ✗</span>';
                                                                choiceStyle = 'background-color: #ffebee !important; border-color: #f44336 !important; color: #c62828 !important;';
                                                            } else {
                                                                // 일반 선택지
                                                                choiceIcon = '<i class="fas fa-circle"></i>';
                                                                choiceStyle = 'background-color: #f8f9fa; border-color: #dee2e6; color: #495057;';
                                                            }
                                                            
                                                            return `
                                                                <div class="${choiceClass}" style="${choiceStyle}">
                                                                    <div class="choice-header">
                                                                        ${choiceIcon}
                                                                        <span class="choice-letter">${String.fromCharCode(65 + choiceIndex)}</span>
                                                                        ${choiceLabel}
                                                                    </div>
                                                                    <div class="choice-content">${choice.text || choice.content || choice}</div>
                                                                </div>
                                                            `;
                                                        }).join('')}
                                                    </div>
                                                </div>
                                            `;
                                        }
                                        return '';
                                    })()}
                                    
${(() => {
                                        // 객관식 문제가 아닌 경우에만 '내 답안' 섹션을 표시
                                        if (question?.type !== 'multiple_choice' && question?.type !== '객관식') {
                                            return `
                                    <div class="answer-section">
                                        <h5>내 답안</h5>
                                        <div class="my-answer-box" style="${answer?.is_correct ? 'background-color: #e3f2fd; border-color: #2196f3; color: #1976d2;' : 'background-color: #ffebee; border-color: #f44336; color: #c62828;'}">
                                            ${(() => {
                                                if (!answer) return '<span class="no-answer">미답변</span>';
                                                return answer.answer || '답안 없음';
                                            })()}
                                        </div>
                                    </div>`;
                                        }
                                        return '';
                                    })()}
                                    
                                    ${question?.explanation ? `
                                        <div class="explanation-section">
                                            <h5>📖 문제 해설</h5>
                                            <div class="explanation-box">
                                                ${question.explanation}
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${question?.model_answer ? `
                                        <div class="model-answer-section">
                                            <h5>모범답안</h5>
                                            <div class="model-answer-box">${question.model_answer}</div>
                                        </div>
                                    ` : ''}
                                    
                                    ${answer?.feedback ? `
                                        <div class="feedback-section">
                                            <h5>${answer.ai_graded ? '🤖 AI 채점 피드백' : '👨‍🏫 교수자 피드백'}</h5>
                                            <div class="feedback-box">
                                                <div class="feedback-score-info">
                                                    <strong>점수: ${answer.points || 0}점</strong>
                                                    ${answer.ai_graded ? '<span class="ai-badge">AI 채점</span>' : ''}
                                                </div>
                                                <div class="feedback-text">${answer.feedback}</div>
                                                ${answer.ai_graded && answer.ai_graded_at ? `
                                                    <small class="feedback-time">AI 채점 시간: ${new Date(answer.ai_graded_at).toLocaleString('ko-KR')}</small>
                                                ` : ''}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="analysis-actions">
                            <button class="btn btn-secondary" onclick="hideDetailedAnalysis()">
                                <i class="fas fa-times"></i> 상세 분석 닫기
                            </button>
                            <button class="btn btn-primary" onclick="exportAnalysisReport()">
                                <i class="fas fa-download"></i> 분석 리포트 다운로드
                            </button>
                        </div>
                    </div>
                `;
                
                // 추천사항 섹션 뒤에 상세 분석 삽입
                const recommendationsSection = document.querySelector('.recommendations');
                if (recommendationsSection) {
                    recommendationsSection.insertAdjacentHTML('afterend', detailedAnalysisHtml);
                    
                    // 상세 분석 섹션으로 부드럽게 스크롤
                    const analysisSection = document.getElementById('inline-detailed-analysis');
                    if (analysisSection) {
                        analysisSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
                
                console.log('✅ 인라인 상세 분석 표시 완료. 문제 개수:', examQuestions.length);
                console.log('📋 모든 문제 데이터:', examQuestions.map(eq => ({
                    questionId: eq.questions.id,
                    type: eq.questions.type,
                    title: eq.questions.title,
                    content: eq.questions.content
                })));
                
                // 현재 시험의 문제 타입 분포 확인
                const typeCount = {};
                examQuestions.forEach(eq => {
                    const type = eq.questions.type;
                    typeCount[type] = (typeCount[type] || 0) + 1;
                });
                console.log('📊 문제 타입 분포:', typeCount);
                console.log('📋 선택지 그룹화 데이터:', optionsByQuestion);
                console.log('📋 실제 데이터베이스 선택지 사용됨!');
                
            } catch (error) {
                console.error('인라인 상세 분석 생성 실패:', error);
                showAlert('상세 분석을 불러오는데 실패했습니다.', 'error');
            }
        }
        
        // 상세 분석 모달 표시
        async function showDetailedAnalysisModal(examId) {
            try {
                // 1단계: 시험의 모든 문제 조회
                const { data: examQuestions, error: examQuestionsError } = await window.supabaseClient
                    .from('exam_questions')
                    .select(`
                        *,
                        questions (
                            id,
                            title,
                            content,
                            type,
                            explanation,
                            model_answer
                        )
                    `)
                    .eq('exam_id', examId)
                    .order('order_index');
                    
                if (examQuestionsError) throw examQuestionsError;
                
                // 2단계: 사용자의 답안 정보 가져오기
                const { data: userSession, error: sessionError } = await window.supabaseClient
                    .from('exam_sessions')
                    .select('id, start_time, submit_time')
                    .eq('exam_id', examId)
                    .eq('employee_id', window.semuApp.currentUser.id)
                    .single();
                    
                if (sessionError) throw sessionError;
                
                const { data: answers, error: answersError } = await window.supabaseClient
                    .from('exam_answers')
                    .select('*')
                    .eq('session_id', userSession.id);
                    
                if (answersError) throw answersError;
                
                // 답안을 질문 ID별로 매핑
                const answersByQuestion = {};
                answers.forEach(answer => {
                    answersByQuestion[answer.question_id] = answer;
                });
                
                // 선택지 정보 가져오기
                const questionIds = examQuestions.map(eq => eq.questions.id);
                const { data: questionOptions, error: optionsError } = await window.supabaseClient
                    .from('question_options')
                    .select('*')
                    .in('question_id', questionIds)
                    .order('order_index');
                
                if (optionsError) throw optionsError;
                
                if (!examQuestions || examQuestions.length === 0) {
                    showAlert('시험 문제 정보를 찾을 수 없습니다.', 'error');
                    return;
                }
                
                console.log('📋 모달 표시할 문제 수:', examQuestions.length);
                console.log('📋 답안 정보:', answers.length, '개');
                
                // 선택지 정보를 질문별로 그룹화
                const optionsByQuestion = {};
                questionOptions.forEach(option => {
                    if (!optionsByQuestion[option.question_id]) {
                        optionsByQuestion[option.question_id] = [];
                    }
                    optionsByQuestion[option.question_id].push(option);
                });
                
                // 모달 HTML 생성
                const modalHtml = `
                    <div class="modal-overlay" id="detailed-analysis-modal">
                        <div class="modal-content" style="max-width: 1000px; max-height: 90vh;">
                            <div class="modal-header">
                                <h3><i class="fas fa-chart-line"></i> 시험 상세 분석</h3>
                                <button class="modal-close" onclick="closeDetailedAnalysisModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="analysis-summary">
                                    <h4>📊 전체 요약</h4>
                                    <div class="summary-stats">
                                        <div class="stat-item">
                                            <span class="stat-label">총 문제 수</span>
                                            <span class="stat-value">${examQuestions.length}개</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">답변 완료</span>
                                            <span class="stat-value">${answers.length}개</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">미답변</span>
                                            <span class="stat-value">${examQuestions.length - answers.length}개</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="questions-analysis">
                                    <h4>📝 문항별 상세 분석</h4>
                                    ${examQuestions.map((examQuestion, index) => {
                                        const question = examQuestion.questions;
                                        const answer = answersByQuestion[question.id];
                                        return `
                                        <div class="question-analysis-item">
                                            <div class="question-header">
                                                <h5>${index + 1}번 문제</h5>
                                                <div class="question-meta">
                                                    <span class="question-type">${getQuestionTypeDisplay(question?.type)}</span>
                                                    <span class="question-score">${answer?.points || 0}점</span>
                                                </div>
                                            </div>
                                            
                                            <div class="question-content">
                                                <h6>문제 내용</h6>
                                                <p>${question?.title || question?.content || '내용 없음'}</p>
                                            </div>
                                            
                                            <div class="answer-content">
                                                <h6>내 답안</h6>
                                                <div class="answer-text">${(() => {
                                                    if (!answer) return '미답변';
                                                    const questionOptionsForThis = optionsByQuestion[question.id] || [];
                                                    if ((question?.type === 'multiple_choice' || question?.type === '객관식') && questionOptionsForThis.length > 0) {
                                                        const userAnswerIndex = parseInt(answer.answer || '0');
                                                        const userSelectedOption = questionOptionsForThis[userAnswerIndex];
                                                        if (userSelectedOption) {
                                                            return `${String.fromCharCode(65 + userAnswerIndex)}. ${userSelectedOption.content}`;
                                                        }
                                                    }
                                                    return answer.answer || '답안 없음';
                                                })()}</div>
                                                
                                                ${(() => {
                                                    if (!answer) return '';
                                                    const questionOptionsForThis = optionsByQuestion[question.id] || [];
                                                    if ((question?.type === 'multiple_choice' || question?.type === '객관식') && questionOptionsForThis.length > 0) {
                                                        return `
                                                            <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                                                                <div style="font-weight: 600; margin-bottom: 10px; color: #666;">모든 선택지:</div>
                                                                ${questionOptionsForThis.map((option, choiceIndex) => {
                                                                    const isCorrect = option.is_correct;
                                                                    const isUserSelected = choiceIndex === parseInt(answer.answer || '0');
                                                                    
                                                                    let textColor = '#333';
                                                                    if (isCorrect && isUserSelected) {
                                                                        // 정답을 맞춘 경우 - 파란색
                                                                        textColor = '#007bff';
                                                                    } else if (isCorrect) {
                                                                        // 정답이지만 선택하지 않은 경우 - 초록색
                                                                        textColor = '#28a745';
                                                                    } else if (isUserSelected) {
                                                                        // 틀린 선택 - 빨간색
                                                                        textColor = '#dc3545';
                                                                    }
                                                                    
                                                                    return `
                                                                        <div style="margin: 5px 0; color: ${textColor}; font-weight: ${(isCorrect || isUserSelected) ? '600' : '400'};">
                                                                            ${String.fromCharCode(65 + choiceIndex).toLowerCase()}. ${option.content}
                                                                        </div>
                                                                    `;
                                                                }).join('')}
                                                            </div>
                                                        `;
                                                    }
                                                    return '';
                                                })()}</div>
                                                
                                                ${(() => {
                                                    const questionOptionsForThis = optionsByQuestion[answer.question_id] || [];
                                                    if ((answer.questions?.type === 'multiple_choice' || answer.questions?.type === '객관식') && questionOptionsForThis.length > 0) {
                                                        return `
                                                            <div style="margin-top: 15px;">
                                                                <h6>선택지 분석</h6>
                                                                <div class="choices-analysis">
                                                                    ${questionOptionsForThis.map((option, choiceIndex) => {
                                                                        const isCorrect = option.is_correct;
                                                                        const isUserSelected = choiceIndex === parseInt(answer.answer || '0');
                                                                        
                                                                        let style = 'padding: 10px; margin: 5px 0; border-radius: 6px; border: 1px solid ';
                                                                        let icon = '';
                                                                        let label = '';
                                                                        
                                                                        if (isCorrect && isUserSelected) {
                                                                            // 정답을 맞춘 경우 - 파란색
                                                                            style += '#007bff; background: #e3f2fd;';
                                                                            icon = '<i class="fas fa-check-circle" style="color: #007bff; margin-right: 8px;"></i>';
                                                                            label = '<span style="color: #007bff; font-weight: 600; margin-left: 10px;">(정답 ✓)</span>';
                                                                        } else if (isCorrect) {
                                                                            // 정답이지만 선택하지 않은 경우 - 초록색
                                                                            style += '#28a745; background: #f8fff9;';
                                                                            icon = '<i class="fas fa-check" style="color: #28a745; margin-right: 8px;"></i>';
                                                                            label = '<span style="color: #28a745; font-weight: 600; margin-left: 10px;">(정답)</span>';
                                                                        } else if (isUserSelected) {
                                                                            // 틀린 선택 - 빨간색
                                                                            style += '#dc3545; background: #fff8f8;';
                                                                            icon = '<i class="fas fa-times-circle" style="color: #dc3545; margin-right: 8px;"></i>';
                                                                            label = '<span style="color: #dc3545; font-weight: 600; margin-left: 10px;">(내 선택 ✗)</span>';
                                                                        } else {
                                                                            // 일반 선택지 - 회색
                                                                            style += '#e9ecef; background: #f8f9fa;';
                                                                            icon = '<i class="fas fa-circle" style="color: #dee2e6; margin-right: 8px;"></i>';
                                                                        }
                                                                        
                                                                        return `
                                                                            <div style="${style}">
                                                                                ${icon}${String.fromCharCode(65 + choiceIndex)}. ${option.content}${label}
                                                                            </div>
                                                                        `;
                                                                    }).join('')}
                                                                </div>
                                                            </div>
                                                        `;
                                                    }
                                                    return '';
                                                })()}
                                            </div>
                                            
                                            ${question?.model_answer ? `
                                                <div class="model-answer">
                                                    <h6>모범답안</h6>
                                                    <div class="model-answer-text">${question.model_answer}</div>
                                                </div>
                                            ` : ''}
                                            
                                            ${answer?.feedback ? `
                                                <div class="grading-feedback">
                                                    <h6>${answer.ai_graded ? '🤖 AI 채점 피드백' : '👨‍🏫 교수자 피드백'}</h6>
                                                    <div class="feedback-content">
                                                        <div class="feedback-score">
                                                            <strong>점수: ${answer.points || 0}점</strong>
                                                            ${answer.ai_graded ? '<span class="ai-badge">AI 채점</span>' : ''}
                                                        </div>
                                                        <div class="feedback-text">${answer.feedback}</div>
                                                        ${answer.ai_graded && answer.ai_graded_at ? `
                                                            <small class="feedback-time">AI 채점 시간: ${new Date(answer.ai_graded_at).toLocaleString('ko-KR')}</small>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            ` : ''}
                                            
                                            ${userSession ? `
                                                <div class="answer-timing">
                                                    <small class="text-muted">
                                                        소요시간: ${calculateTimeSpent(userSession.start_time, userSession.submit_time)}
                                                    </small>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                    }).join('')}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="closeDetailedAnalysisModal()">닫기</button>
                                <button class="btn btn-primary" onclick="exportAnalysisReport()">
                                    <i class="fas fa-download"></i> 분석 리포트 다운로드
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // 기존 모달 제거 후 새 모달 추가
                const existingModal = document.getElementById('detailed-analysis-modal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // 모달 표시
                const modal = document.getElementById('detailed-analysis-modal');
                modal.style.display = 'flex';
                
                console.log('📋 모달 HTML 삽입 완료. 문제 개수 확인:', modal.querySelectorAll('.question-analysis-item').length);
                
            } catch (error) {
                console.error('상세 분석 모달 생성 실패:', error);
                showAlert('상세 분석을 불러오는데 실패했습니다.', 'error');
            }
        }
        
        // 인라인 상세 분석 숨기기
        function hideDetailedAnalysis() {
            const analysisSection = document.getElementById('inline-detailed-analysis');
            if (analysisSection) {
                analysisSection.remove();
            }
        }
        
        // 상세 분석 모달 닫기
        function closeDetailedAnalysisModal() {
            const modal = document.getElementById('detailed-analysis-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // 분석 리포트 다운로드
        function exportAnalysisReport() {
            // 간단한 텍스트 리포트 생성
            const urlParams = new URLSearchParams(window.location.search);
            const examId = urlParams.get('exam');
            const score = window.resultsPage?.score || 0;
            const totalQuestions = window.resultsPage?.totalQuestions || 0;
            
            let report = `시험 결과 분석 리포트\n`;
            report += `========================\n\n`;
            report += `시험 ID: ${examId}\n`;
            report += `총점: ${score}/${totalQuestions} (${Math.round((score/totalQuestions)*100)}%)\n`;
            report += `생성일: ${new Date().toLocaleString('ko-KR')}\n\n`;
            
            // 다운로드
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `시험결과_분석_${examId}_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // 문제 유형 표시
        function getQuestionTypeDisplay(type) {
            const typeMap = {
                'multiple_choice': '객관식',
                'subjective': '주관식',
                'essay': '서술형'
            };
            return typeMap[type] || type || '기타';
        }
        
        // 소요 시간 계산
        function calculateTimeSpent(startTime, submitTime) {
            if (!startTime || !submitTime) return '알 수 없음';
            
            const start = new Date(startTime);
            const submit = new Date(submitTime);
            const diffMs = submit - start;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return '1분 미만';
            if (diffMins < 60) return `${diffMins}분`;
            
            const hours = Math.floor(diffMins / 60);
            const mins = diffMins % 60;
            return `${hours}시간 ${mins}분`;
        }
    </script>
</body>
</html>

