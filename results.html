<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏãúÌóò Í≤∞Í≥º - Quizbank</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/common.css">
    <style>
        .results-container {
            display: flex;
            flex-direction: column;
            min-height: 600px;
        }

        .main-content {
            flex: 1;
            padding: 30px;
            background: #f8f9fa;
        }

        .result-header {
            background: white;
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .result-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .result-icon.excellent {
            color: #28a745;
        }

        .result-icon.good {
            color: #17a2b8;
        }

        .result-icon.average {
            color: #ffc107;
        }

        .result-icon.poor {
            color: #dc3545;
        }

        .result-title {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--dark-gray);
        }

        .result-subtitle {
            color: var(--medium-gray);
            font-size: 1.1rem;
            margin-bottom: 30px;
        }

        .score-display {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .score-number {
            font-size: 4rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
        }

        .score-label {
            text-align: center;
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .score-details {
            text-align: center;
            margin-top: 15px;
            font-size: 1rem;
            opacity: 0.8;
        }
        
        .earned-points {
            color: #90EE90;
            font-weight: 600;
        }
        
        .total-points {
            color: #E0E0E0;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--medium-gray);
            font-size: 0.9rem;
        }

        .detailed-results {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .section-title {
            font-size: 1.3rem;
            color: var(--dark-gray);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .question-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 2px solid #f8f9fa;
        }

        .question-result.correct {
            border-color: #28a745;
            background: #f8fff9;
        }

        .question-result.incorrect {
            border-color: #dc3545;
            background: #fff8f8;
        }

        .question-info {
            flex: 1;
        }

        .question-number {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .question-preview {
            color: var(--medium-gray);
            font-size: 0.9rem;
        }

        .question-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .status-icon {
            font-size: 1.2rem;
        }

        .status-icon.correct {
            color: #28a745;
        }

        .status-icon.incorrect {
            color: #dc3545;
        }

        .recommendations {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .recommendations h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin: 10px 0;
        }

        .recommendation-icon {
            color: #2196f3;
            margin-top: 2px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .progress-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 10px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            position: relative;
            background: conic-gradient(var(--primary-color) 0deg, #e9ecef 0deg);
        }

        .circle-content {
            background: white;
            border-radius: 50%;
            width: 110px;
            height: 110px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .circle-score {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .circle-label {
            font-size: 0.8rem;
            color: var(--medium-gray);
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .result-header {
                padding: 30px 20px;
            }
            
            .score-number {
                font-size: 3rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            
            .question-result {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }
        
        /* ÏÉÅÏÑ∏ Î∂ÑÏÑù Î™®Îã¨ Ïä§ÌÉÄÏùº */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            padding: 25px 30px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: white;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }
        
        .modal-close:hover {
            opacity: 1;
        }
        
        .modal-body {
            padding: 30px;
            max-height: calc(90vh - 140px);
            overflow-y: auto;
            width: 100%;
        }
        
        .modal-footer {
            padding: 25px 30px;
            border-top: 2px solid #e9ecef;
            border-radius: 0 0 15px 15px;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            background: #f8f9fa;
        }
        
        /* Î∂ÑÏÑù ÏöîÏïΩ Ïä§ÌÉÄÏùº */
        .analysis-summary {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid var(--primary-color);
        }
        
        .analysis-summary h4 {
            margin: 0 0 20px 0;
            color: var(--primary-color);
            font-size: 1.3rem;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }
        
        .summary-stats .stat-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }
        
        .summary-stats .stat-label {
            display: block;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
        }
        
        .summary-stats .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        /* Î¨∏Ìï≠Î≥Ñ Î∂ÑÏÑù Ïä§ÌÉÄÏùº */
        .questions-analysis h4 {
            margin: 0 0 25px 0;
            color: var(--dark-gray);
            font-size: 1.3rem;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
        }
        
        .question-analysis-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            width: 100%;
            box-sizing: border-box;
        }
        
        .questions-analysis {
            width: 100%;
            overflow: visible;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .question-header h5 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.2rem;
        }
        
        .question-meta {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .question-type {
            background: var(--primary-color);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .question-score {
            background: #28a745;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
        }
        
        .question-content,
        .answer-content,
        .model-answer {
            margin-bottom: 20px;
        }
        
        .question-content h6,
        .answer-content h6,
        .model-answer h6 {
            margin: 0 0 10px 0;
            color: var(--dark-gray);
            font-size: 1rem;
            font-weight: 600;
        }
        
        .answer-text,
        .model-answer-text {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        /* AI Ï±ÑÏ†ê ÌîºÎìúÎ∞± Ïä§ÌÉÄÏùº */
        .grading-feedback {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            border: 1px solid #bbdefb;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .grading-feedback h6 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .feedback-content {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e1f5fe;
        }
        
        .feedback-score {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e1f5fe;
        }
        
        .ai-badge {
            background: #ff6b35;
            color:  white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .feedback-text {
            line-height: 1.6;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }
        
        .feedback-time {
            color: #666;
            font-style: italic;
        }
        
        .answer-timing {
            margin-top: 15px;
            text-align: right;
        }
        
        /* Ïù∏ÎùºÏù∏ ÏÉÅÏÑ∏ Î∂ÑÏÑù Ïä§ÌÉÄÏùº (ÏÉàÎ°úÏö¥ ÏÑ∏Î°ú Ïä§ÌÅ¨Î°§ Î∞©Ïãù) */
        .detailed-analysis-inline {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            box-shadow: var(--shadow);
        }
        
        .analysis-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .analysis-summary-inline {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid var(--primary-color);
        }
        
        .summary-stats-inline {
            display: flex;
            gap: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-label {
            display: block;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }
        
        .summary-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .questions-list-vertical {
            margin: 30px 0;
        }
        
        .question-item-vertical {
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .question-item-vertical:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }
        
        .question-number-badge {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .question-num {
            background: var(--primary-color);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .question-type-badge {
            background: #17a2b8;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .question-score-badge {
            background: #28a745;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
        }
        
        .question-content-section {
            margin-bottom: 25px;
        }
        
        .question-title {
            color: var(--primary-color);
            font-size: 1.3rem;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .question-text {
            font-size: 1.1rem;
            line-height: 1.6;
            color: var(--dark-gray);
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        
        .choices-section {
            margin-bottom: 25px;
        }
        
        .choices-section h5 {
            color: var(--dark-gray);
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .choices-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .choice-item-vertical {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        .choice-item-vertical.choice-correct-selected {
            background: #e3f2fd;
            border-color: #007bff;
        }
        
        .choice-item-vertical.choice-correct {
            background: #f8fff9;
            border-color: #28a745;
        }
        
        .choice-item-vertical.choice-user-selected {
            background: #fff8f8;
            border-color: #dc3545;
        }
        
        .choice-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .choice-letter {
            background: #6c757d;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .choice-status {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 12px;
        }
        
        .choice-status.correct-selected {
            background: #007bff;
            color: white;
        }
        
        .choice-status.correct {
            background: #28a745;
            color: white;
        }
        
        .choice-status.user-selected {
            background: #dc3545;
            color: white;
        }
        
        .choice-content {
            font-size: 1rem;
            line-height: 1.5;
            margin-left: 35px;
        }
        
        .answer-section, .explanation-section, .model-answer-section, .feedback-section {
            margin-bottom: 20px;
        }
        
        .answer-section h5, .explanation-section h5, .model-answer-section h5, .feedback-section h5 {
            color: var(--dark-gray);
            margin-bottom: 12px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .my-answer-box {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .my-answer-box.correct {
            background: #f8fff9;
            border-color: #28a745;
            color: #155724;
        }
        
        .my-answer-box.incorrect {
            background: #fff8f8;
            border-color: #dc3545;
            color: #721c24;
        }
        
        .no-answer {
            color: #6c757d;
            font-style: italic;
        }
        
        .model-answer-box, .feedback-box, .explanation-box {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 10px;
            padding: 15px;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .explanation-box {
            background: #fff3e0;
            border: 1px solid #ffcc80;
        }
        
        .feedback-score-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e1f5fe;
        }
        
        .feedback-text {
            margin-bottom: 10px;
            white-space: pre-wrap;
        }
        
        .feedback-time {
            color: #666;
            font-style: italic;
            font-size: 0.9rem;
        }
        
        .analysis-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            padding-top: 25px;
            border-top: 2px solid #e9ecef;
        }
        
        /* Î™®Î∞îÏùº Î∞òÏùëÌòï - Ïù∏ÎùºÏù∏ Î∂ÑÏÑù */
        @media (max-width: 768px) {
            .detailed-analysis-inline {
                padding: 20px;
                margin: 20px 0;
            }
            
            .question-item-vertical {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .question-number-badge {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .question-num {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
            
            .summary-stats-inline {
                flex-direction: column;
                gap: 15px;
            }
            
            .analysis-actions {
                flex-direction: column;
                align-items: stretch;
            }
        }
        
        /* Î™®Î∞îÏùº Î∞òÏùëÌòï - Î™®Îã¨ */
        @media (max-width: 768px) {
            .modal-content {
                max-width: 95% !important;
                margin: 10px;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .question-analysis-item {
                padding: 20px;
                margin-bottom: 15px;
            }
            
            .question-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="container">
            <div class="results-container">
                <!-- Ìó§Îçî -->
                <div class="header">
                    <div class="logo">
                        <i class="fas fa-graduation-cap"></i>
                        <h2>Quizbank</h2>
                    </div>
                    <div class="nav-menu">
                        <a href="./dashboard.html" class="nav-link">
                            <i class="fas fa-home"></i> ÎåÄÏãúÎ≥¥Îìú
                        </a>
                        <a href="./exam.html" class="nav-link">
                            <i class="fas fa-clipboard-list"></i> ÏãúÌóò
                        </a>
                        <a href="./results.html" class="nav-link active">
                            <i class="fas fa-chart-bar"></i> Í≤∞Í≥º
                        </a>
                        <a href="./profile.html" class="nav-link">
                            <i class="fas fa-user"></i> ÌîÑÎ°úÌïÑ
                        </a>
                    </div>
                    <div class="user-menu">
                        <span class="user-name" id="userName">ÏÇ¨Ïö©ÏûêÎãò</span>
                        <button class="btn btn-outline btn-small logout-btn">
                            <i class="fas fa-sign-out-alt"></i> Î°úÍ∑∏ÏïÑÏõÉ
                        </button>
                    </div>
                </div>

                <!-- Î©îÏù∏ ÏΩòÌÖêÏ∏† -->
                <div class="main-content">
                    <!-- Í≤∞Í≥º Ìó§Îçî -->
                    <div class="result-header">
                        <div class="result-icon" id="resultIcon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <h1 class="result-title" id="resultTitle">Í≤∞Í≥ºÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</h1>
                        <p class="result-subtitle" id="resultSubtitle">Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.</p>
                        
                        <div class="score-display">
                            <div class="score-number" id="scoreNumber">...</div>
                            <div class="score-label">Ï†ê</div>
                            <div class="score-details" id="scoreDetails">
                                <span class="earned-points" id="earnedPoints">...</span> / <span class="total-points" id="totalPoints">...</span>Ï†ê
                            </div>
                        </div>
                    </div>

                    <!-- ÏÑ±Í≥º Ï∞®Ìä∏ -->
                    <div class="chart-container">
                        <h3 class="section-title">
                            <i class="fas fa-chart-pie"></i>
                            ÏÑ±Í≥º ÏöîÏïΩ
                        </h3>
                        <div class="progress-circle" id="progressCircle">
                            <div class="circle-content">
                                <div class="circle-score" id="circleScore">...</div>
                                <div class="circle-label">Ï†ê</div>
                            </div>
                        </div>
                        <p style="color: var(--medium-gray);">Ï†ÑÏ≤¥ ÌèâÍ∑†Î≥¥Îã§ <strong id="comparison">-</strong></p>
                        <!-- Î∞±Î∂ÑÏúÑ Ï†ïÎ≥¥Îäî JavaScriptÎ°ú ÎèôÏ†Å Ï∂îÍ∞ÄÎê® -->
                        <div id="pointsDisplay" class="points-display" style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">ÌöçÎìù Ìè¨Ïù∏Ìä∏</div>
                            <div style="font-size: 24px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <i class="fas fa-coins" style="color: #ffd700;"></i>
                                <span id="earnedPointsDisplay">Í≥ÑÏÇ∞ Ï§ë...</span>
                            </div>
                            <div id="pointsBreakdown" style="font-size: 12px; margin-top: 8px; opacity: 0.8;"></div>
                        </div>
                    </div>

                    <!-- ÌÜµÍ≥Ñ -->
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-icon" style="color: #28a745;">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-value" id="correctCount">-</div>
                            <div class="stat-label">Ï†ïÎãµ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon" style="color: #dc3545;">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div class="stat-value" id="incorrectCount">-</div>
                            <div class="stat-label">Ïò§Îãµ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon" style="color: #17a2b8;">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-value" id="timeUsed">-</div>
                            <div class="stat-label">ÏÜåÏöî ÏãúÍ∞Ñ(Î∂Ñ)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon" style="color: #ffc107;">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="stat-value" id="accuracy">-</div>
                            <div class="stat-label">Ï†ïÎãµÎ•†(%)</div>
                        </div>
                    </div>

                    <!-- ÏÉÅÏÑ∏ Í≤∞Í≥º -->
                    <div class="detailed-results">
                        <h3 class="section-title">
                            <i class="fas fa-list"></i>
                            Î¨∏Ìï≠Î≥Ñ Í≤∞Í≥º
                        </h3>
                        <div id="questionResults">
                            <!-- Î¨∏Ìï≠Î≥Ñ Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                        </div>
                    </div>

                    <!-- Ï∂îÏ≤úÏÇ¨Ìï≠ -->
                    <div class="recommendations">
                        <h3>
                            <i class="fas fa-lightbulb"></i>
                            ÌïôÏäµ Ï∂îÏ≤úÏÇ¨Ìï≠
                        </h3>
                        <div id="recommendationsList">
                            <!-- Ï∂îÏ≤úÏÇ¨Ìï≠Îì§Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                        </div>
                    </div>

                    <!-- Ïï°ÏÖò Î≤ÑÌäºÎì§ -->
                    <div class="action-buttons">
                        <!-- Ïû¨ÏùëÏãú Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî -->
                        <!-- <button class="btn btn-primary btn-large" onclick="retakeExam()">
                            <i class="fas fa-redo"></i> Îã§Ïãú ÏùëÏãú
                        </button> -->
                        <button class="btn btn-secondary btn-large" onclick="viewDetails()">
                            <i class="fas fa-search"></i> ÏÉÅÏÑ∏ Î∂ÑÏÑù
                        </button>
                        <a href="./dashboard.html" class="btn btn-outline btn-large">
                            <i class="fas fa-home"></i> ÎåÄÏãúÎ≥¥ÎìúÎ°ú
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    
    <!-- Í≥µÌÜµ Ïä§ÌÅ¨Î¶ΩÌä∏ -->
    <script src="./assets/js/common.js"></script>
    
    <script>
        // Í≤∞Í≥º ÌéòÏù¥ÏßÄ Ï†ÑÏö© Ïä§ÌÅ¨Î¶ΩÌä∏
        class ResultsPage {
            constructor() {
                this.score = null;
                this.totalQuestions = null;
                this.examData = null;
                this.examStats = { averageScore: 70, totalParticipants: 1 };
                this.examScores = [];
                this.isDataLoaded = false;
                
                this.init();
            }

            async waitForAuthAndSession() {
                console.log('‚è≥ Ïù∏Ï¶ù Î∞è ÏÑ∏ÏÖò Î≥µÏõê ÎåÄÍ∏∞ Ï§ë...');
                
                let attempts = 0;
                const maxAttempts = 100; // 10Ï¥à ÎåÄÍ∏∞ (100 * 100ms)
                
                while (attempts < maxAttempts) {
                    // semuAppÍ≥º supabaseClientÍ∞Ä Î™®Îëê Î°úÎìúÎêòÏóàÎäîÏßÄ ÌôïÏù∏
                    if (window.semuApp && window.supabaseClient) {
                        // ÏÑ∏ÏÖò Î≥µÏõêÏù¥ ÏôÑÎ£åÎêòÏóàÎäîÏßÄ ÌôïÏù∏
                        if (window.semuApp.currentUser) {
                            console.log('‚úÖ ÏÇ¨Ïö©Ïûê Ïù∏Ï¶ù ÌôïÏù∏Îê®:', window.semuApp.currentUser.email);
                            return;
                        }
                        
                        // ÏÑ∏ÏÖò Î≥µÏõêÏùÑ ÏúÑÌïú Ï∂îÍ∞Ä ÎåÄÍ∏∞
                        if (attempts > 50) {
                            console.log('‚è≥ ÏÑ∏ÏÖò Î≥µÏõê Ï∂îÍ∞Ä ÎåÄÍ∏∞ Ï§ë...', attempts);
                        }
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                console.warn('‚ö†Ô∏è ÏÑ∏ÏÖò Î≥µÏõê ÌÉÄÏûÑÏïÑÏõÉ');
            }

            async init() {
                console.log('üìä Í≤∞Í≥º ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî');
                
                // ÏÑ∏ÏÖò Î≥µÏõê ÎåÄÍ∏∞ Î∞è Ïù∏Ï¶ù ÌôïÏù∏
                await this.waitForAuthAndSession();
                
                if (!window.semuApp.currentUser) {
                    console.warn('‚ö†Ô∏è Ïù∏Ï¶ùÎêú ÏÇ¨Ïö©ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§. Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô');
                    window.location.href = './login.html';
                    return;
                }

                // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÌëúÏãú
                this.updateUserInfo();
                
                // Î°úÎî© ÏÉÅÌÉú ÌëúÏãú
                this.showLoadingState();
                
                // URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú Í≤∞Í≥º Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                await this.loadResultData();
                
                // Î°úÎî© ÏôÑÎ£å ÌõÑ UI ÏóÖÎç∞Ïù¥Ìä∏
                this.hideLoadingState();
                await this.updateUI();
            }

            updateUserInfo() {
                const user = window.semuApp.currentUser;
                if (user) {
                    document.getElementById('userName').textContent = user.name + 'Îãò';
                }
            }

            showLoadingState() {
                console.log('‚è≥ Í≤∞Í≥º Î°úÎî© ÏÉÅÌÉú ÌëúÏãú (HTMLÏóê Ïù¥ÎØ∏ ÏÑ§Ï†ïÎê®)');
                
                // HTMLÏóêÏÑú Ïù¥ÎØ∏ Î°úÎî© ÏÉÅÌÉúÎ°ú ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÏúºÎØÄÎ°ú 
                // Ï∂îÍ∞ÄÏ†ÅÏù∏ DOM Ï°∞Ïûë ÏóÜÏù¥ Î°úÍ∑∏Îßå Ï∂úÎ†•
            }

            hideLoadingState() {
                console.log('‚úÖ Í≤∞Í≥º Î°úÎî© ÏôÑÎ£å');
                // Ïã§Ï†ú UI ÏóÖÎç∞Ïù¥Ìä∏Îäî updateUI()ÏóêÏÑú Ï≤òÎ¶¨Îê®
            }

            async loadResultData() {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const examId = urlParams.get('exam');
                    const score = parseInt(urlParams.get('score')) || 0;
                    const totalQuestions = parseInt(urlParams.get('total')) || 0;
                    const autoSubmit = urlParams.get('auto_submit') === 'true';
                    
                    console.log('üîç Í≤∞Í≥º Îç∞Ïù¥ÌÑ∞ ÌååÎùºÎØ∏ÌÑ∞:', { examId, score, totalQuestions, autoSubmit });
                    console.log('üîç ÌòÑÏû¨ URL:', window.location.href);
                    
                    if (examId) {
                        // ÏãúÌóò IDÍ∞Ä ÏûàÎäî Í≤ΩÏö∞ - Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ÏóêÏÑú Í≤∞Í≥º Ï°∞Ìöå
                        await this.loadResultFromDatabase(examId);
                    } else if (score > 0 && totalQuestions > 0) {
                        // URL ÌååÎùºÎØ∏ÌÑ∞Î°ú Ï†êÏàòÎßå Ï†ÑÎã¨Îêú Í≤ΩÏö∞ - ÏûÑÏãú Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
                        this.score = score;
                        this.totalQuestions = totalQuestions;
                        this.examData = {
                            title: 'ÏãúÌóò Í≤∞Í≥º',
                            correctAnswers: Math.round(this.totalQuestions * this.score / 100),
                            incorrectAnswers: this.totalQuestions - Math.round(this.totalQuestions * this.score / 100),
                            timeUsed: 0,
                            questions: []
                        };
                        
                        if (autoSubmit) {
                            this.examData.title = 'ÏûêÎèô Ï†úÏ∂úÎêú ÏãúÌóò Í≤∞Í≥º';
                        }
                        
                        // URL ÌååÎùºÎØ∏ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å
                        this.isDataLoaded = true;
                    } else {
                        // exam ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ - ÏãúÌóò Î™©Î°ù ÌëúÏãú
                        console.log('üìã examIdÍ∞Ä ÏóÜÏùå - ÏôÑÎ£åÎêú ÏãúÌóò Î™©Î°ùÏùÑ ÌëúÏãúÌï©ÎãàÎã§');
                        await this.showExamSelectionUI();
                        return;
                    }
                    
                    console.log('‚úÖ Í≤∞Í≥º Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å:', { 
                        score: this.score, 
                        total: this.totalQuestions,
                        examData: this.examData 
                    });
                    
                } catch (error) {
                    console.error('‚ùå Í≤∞Í≥º Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                    this.score = 0;
                    this.totalQuestions = 0;
                    this.examData = {
                        title: 'Ïò§Î•ò Î∞úÏÉù',
                        correctAnswers: 0,
                        incorrectAnswers: 0,
                        timeUsed: 0,
                        questions: []
                    };
                }
            }

            async loadResultFromDatabase(examId) {
                try {
                    console.log('üîç Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ÏóêÏÑú ÏãúÌóò Í≤∞Í≥º Ï°∞Ìöå:', examId);
                    
                    // ÌòÑÏû¨ ÏÇ¨Ïö©Ïûê ID Í∞ÄÏ†∏Ïò§Í∏∞ (ÌïòÎìúÏΩîÎî©Îêú Í¥ÄÎ¶¨Ïûê Í≥ÑÏ†ï ÏßÄÏõê)
                    let userId;
                    
                    if (window.semuApp && window.semuApp.currentUser) {
                        userId = window.semuApp.currentUser.id;
                        console.log('‚úÖ Ïï±ÏóêÏÑú ÏÇ¨Ïö©Ïûê ID ÌôïÏù∏:', userId);
                    } else {
                        const { data: { user } } = await window.supabaseClient.auth.getUser();
                        if (!user) {
                            throw new Error('ÏÇ¨Ïö©Ïûê Ïù∏Ï¶ù Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                        }
                        userId = user.id;
                    }
                    
                    // 1Îã®Í≥Ñ: ÏãúÌóò ÏÑ∏ÏÖò Ï†ïÎ≥¥ Ï°∞Ìöå
                    const { data: session, error: sessionError } = await window.supabaseClient
                        .from('exam_sessions')
                        .select(`
                            *,
                            exams (
                                title,
                                description,
                                duration
                            )
                        `)
                        .eq('exam_id', examId)
                        .eq('employee_id', userId)
                        .eq('status', 'submitted')
                        .order('submit_time', { ascending: false })
                        .limit(1)
                        .single();
                    
                    if (sessionError) throw sessionError;
                    
                    // 1-1Îã®Í≥Ñ: Ï†ÑÏ≤¥ ÏãúÌóò ÌÜµÍ≥Ñ Ï°∞Ìöå (ÌèâÍ∑† Ï†êÏàò, Ï∞∏Í∞ÄÏûê Ïàò Îì±)
                    const { data: examStats, error: statsError } = await window.supabaseClient
                        .from('exam_sessions')
                        .select('score, total_points')
                        .eq('exam_id', examId)
                        .eq('status', 'submitted');
                    
                    if (statsError) {
                        console.warn('‚ö†Ô∏è ÏãúÌóò ÌÜµÍ≥Ñ Ï°∞Ìöå Ïã§Ìå®, Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©:', statsError);
                        this.examStats = { averageScore: 70, totalParticipants: 1 };
                    } else {
                        // ÌèâÍ∑† Ï†êÏàò Í≥ÑÏÇ∞
                        const validScores = examStats.filter(s => s.score !== null && s.total_points !== null);
                        const averageScore = validScores.length > 0 
                            ? Math.round(validScores.reduce((sum, s) => sum + (s.score || 0), 0) / validScores.length)
                            : 70;
                        
                        this.examStats = {
                            averageScore: averageScore,
                            totalParticipants: examStats.length
                        };
                        this.examScores = examStats;
                        
                        // Ï†êÏàò Î∂ÑÌè¨ ÏÉÅÏÑ∏ Î∂ÑÏÑù
                        const scoreDistribution = validScores.map(s => Math.round((s.score / s.total_points) * 100));
                        const sortedScores = [...scoreDistribution].sort((a, b) => b - a);
                        
                        console.log('üìä ÏãúÌóò ÌÜµÍ≥Ñ:', this.examStats);
                        console.log('üìä ÏãúÌóò Ï†êÏàò Î∂ÑÌè¨ (Ï†ïÎ†¨):', sortedScores);
                        console.log('üìä Ï†êÏàòÎ≥Ñ Ïù∏Ïõê Î∂ÑÏÑù:', {
                            '100Ï†ê': sortedScores.filter(s => s === 100).length + 'Î™Ö',
                            '90Ï†êÎåÄ': sortedScores.filter(s => s >= 90 && s < 100).length + 'Î™Ö',
                            '80Ï†êÎåÄ': sortedScores.filter(s => s >= 80 && s < 90).length + 'Î™Ö',
                            '70Ï†êÎåÄ': sortedScores.filter(s => s >= 70 && s < 80).length + 'Î™Ö',
                            '60Ï†êÎåÄ': sortedScores.filter(s => s >= 60 && s < 70).length + 'Î™Ö',
                            '60Ï†êÎØ∏Îßå': sortedScores.filter(s => s < 60).length + 'Î™Ö'
                        });
                    }
                    
                    if (sessionError) throw sessionError;
                    
                    // 2Îã®Í≥Ñ: Í∞úÎ≥Ñ ÎãµÎ≥Ä Í≤∞Í≥º Ï°∞Ìöå (ÏÑ†ÌÉùÏßÄ Ï†ïÎ≥¥ Ìè¨Ìï®)
                    const { data: answers, error: answersError } = await window.supabaseClient
                        .from('exam_answers')
                        .select(`
                            *,
                            questions (
                                id,
                                title,
                                content,
                                type
                            )
                        `)
                        .eq('session_id', session.id)
                        .order('created_at');
                    
                    if (answersError) throw answersError;
                    
                    // 2-2Îã®Í≥Ñ: Í∞ùÍ¥ÄÏãù Î¨∏Ï†úÏùò ÏÑ†ÌÉùÏßÄ Ï†ïÎ≥¥ Ï°∞Ìöå
                    const questionIds = answers.map(a => a.question_id);
                    const { data: questionOptions, error: optionsError } = await window.supabaseClient
                        .from('question_options')
                        .select('*')
                        .in('question_id', questionIds)
                        .order('order_index');
                    
                    if (optionsError) throw optionsError;
                    
                    if (answersError) throw answersError;
                    
                    // 2-1Îã®Í≥Ñ: ÏãúÌóò Î¨∏Ï†úÎ≥Ñ Î∞∞Ï†ê Ï†ïÎ≥¥ Ï°∞Ìöå
                    const { data: examQuestions, error: examQuestionsError } = await window.supabaseClient
                        .from('exam_questions')
                        .select('question_id, points')
                        .eq('exam_id', examId);
                    
                    if (examQuestionsError) throw examQuestionsError;
                    
                    // Î∞∞Ï†ê Ï†ïÎ≥¥Î•º ÎßµÏúºÎ°ú Î≥ÄÌôò
                    const pointsMap = {};
                    examQuestions.forEach(eq => {
                        pointsMap[eq.question_id] = eq.points || 1;
                    });
                    
                    console.log('üîç ÏãúÌóò Î¨∏Ï†úÎ≥Ñ Î∞∞Ï†ê:', pointsMap);
                    
                    if (answersError) throw answersError;
                    
                    // 3Îã®Í≥Ñ: Í≤∞Í≥º Îç∞Ïù¥ÌÑ∞ Íµ¨ÏÑ± - Ïã§Ï†ú ÎãµÏïà Îç∞Ïù¥ÌÑ∞Î°ú Ï†êÏàò Ïû¨Í≥ÑÏÇ∞
                    // Í∞Å Î¨∏Ï†úÏùò Î∞∞Ï†êÏùÑ Í≥†Î†§ÌïòÏó¨ Ï†êÏàò Í≥ÑÏÇ∞
                    let totalPoints = 0;
                    let earnedPoints = 0;
                    
                    console.log('üîç ÎãµÏïà Îç∞Ïù¥ÌÑ∞ ÏÉÅÏÑ∏:', answers);
                    
                    answers.forEach(answer => {
                        const qType = answer.questions?.type;
                        // Î¨∏Ï†úÏùò ÏµúÎåÄ Î∞∞Ï†ê: ÏÑ§Ï†ïÎêú Î∞∞Ï†ê Ïö∞ÏÑ†, ÏóÜÏúºÎ©¥ Ï£ºÍ¥ÄÏãù/ÏÑúÏà†Ìòï 100Ï†ê Í∏∞Î≥∏, Í∑∏ Ïô∏ 1Ï†ê
                        const maxPoints = (pointsMap[answer.question_id] && pointsMap[answer.question_id] > 0)
                            ? pointsMap[answer.question_id]
                            : (qType === 'subjective' || qType === 'essay' || qType === 'Ï£ºÍ¥ÄÏãù') ? 100 : 1;
                        totalPoints += maxPoints;

                        let earnedForThis = 0;
                        if (qType === 'multiple_choice' || qType === 'Í∞ùÍ¥ÄÏãù') {
                            // Í∞ùÍ¥ÄÏãù: Ï†ïÎãµÏù¥Î©¥ Î∞∞Ï†ê Ï†ÑÏï°, ÏïÑÎãàÎ©¥ 0
                            earnedForThis = answer.is_correct ? maxPoints : 0;
                        } else {
                            // Ï£ºÍ¥ÄÏãù/ÏÑúÏà†Ìòï: Ï±ÑÏ†êÎêú Ï†êÏàò ÏÇ¨Ïö©(ÏóÜÏúºÎ©¥ 0), ÏµúÎåÄ Î∞∞Ï†êÍπåÏßÄ Ï∫°
                            const gradedPoints = Number(answer.points) || 0;
                            earnedForThis = Math.max(0, Math.min(gradedPoints, maxPoints));
                        }

                        earnedPoints += earnedForThis;

                        console.log(`üìù ÎãµÏïà ${answer.question_id}:`, {
                            answer: answer.answer,
                            isCorrect: answer.is_correct,
                            gradedPoints: answer.points,
                            maxPoints,
                            usedEarned: earnedForThis,
                            questionType: qType,
                            questionData: answer.questions
                        });
                    });
                    
                    // Î∞±Î∂ÑÏú® Ï†êÏàò Í≥ÑÏÇ∞ (0-100)
                    this.score = totalPoints > 0 ? Math.round((earnedPoints / totalPoints) * 100) : 0;
                    this.totalQuestions = answers.length;
                    
                    const correctAnswers = answers.filter(a => a.is_correct).length;
                    const incorrectAnswers = answers.filter(a => !a.is_correct).length;
                    
                    console.log('üìä Ï†êÏàò Í≥ÑÏÇ∞ ÏÉÅÏÑ∏:', {
                        earnedPoints,
                        totalPoints,
                        calculatedScore: this.score,
                        correctAnswers,
                        incorrectAnswers,
                        answersCount: answers.length,
                        sessionScore: session.score,
                        sessionTotalPoints: session.total_points,
                        pointsMap: pointsMap,
                        answers: answers.map(a => ({
                            questionId: a.question_id,
                            isCorrect: a.is_correct,
                            points: a.points,
                            examQuestionPoints: pointsMap[a.question_id]
                        }))
                    });
                    
                    // ÏÑ†ÌÉùÏßÄ Ï†ïÎ≥¥Î•º ÏßàÎ¨∏Î≥ÑÎ°ú Í∑∏Î£πÌôî
                    const optionsByQuestion = {};
                    questionOptions.forEach(option => {
                        if (!optionsByQuestion[option.question_id]) {
                            optionsByQuestion[option.question_id] = [];
                        }
                        optionsByQuestion[option.question_id].push(option);
                    });
                    
                    this.examData = {
                        sessionId: session.id,  // ÏÑ∏ÏÖò ID Ï∂îÍ∞Ä
                        employeeId: session.employee_id,  // ÏÇ¨Ïö©Ïûê ID Ï∂îÍ∞Ä
                        title: session.exams?.title || 'ÏãúÌóò Í≤∞Í≥º',
                        correctAnswers: correctAnswers,
                        incorrectAnswers: incorrectAnswers,
                        timeUsed: session.duration_minutes || 0,
                        earnedPoints: earnedPoints,
                        totalPoints: totalPoints,
                        questions: answers.map(answer => {
                            const questionOptions = optionsByQuestion[answer.question_id] || [];
                            const choices = questionOptions.map(opt => opt.content);
                            const correctAnswerIndex = questionOptions.findIndex(opt => opt.is_correct);
                            
                            return {
                                id: answer.question_id,
                                correct: answer.is_correct,
                                text: answer.questions?.title || answer.questions?.content || 'Î¨∏Ï†ú ÎÇ¥Ïö© ÏóÜÏùå',
                                userAnswer: answer.answer,
                                userAnswerIndex: parseInt(answer.answer) || 0,
                                points: pointsMap[answer.question_id] || 1,
                                type: answer.questions?.type,
                                choices: choices,
                                correctAnswer: correctAnswerIndex >= 0 ? correctAnswerIndex : 0
                            };
                        })
                    };
                    
                    console.log('‚úÖ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ÏóêÏÑú Í≤∞Í≥º Î°úÎìú ÏôÑÎ£å:', this.examData);
                    
                    // Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï
                    this.isDataLoaded = true;
                    
                } catch (error) {
                    console.error('‚ùå Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Í≤∞Í≥º Ï°∞Ìöå Ïã§Ìå®:', error);
                    this.isDataLoaded = false;
                    throw error;
                }
            }

            showNoResultMessage() {
                // ÏãúÌóò Í≤∞Í≥ºÍ∞Ä ÏóÜÏùÑ Îïå ÏïàÎÇ¥ Î©îÏãúÏßÄ ÌëúÏãú
                const resultHeader = document.querySelector('.result-header');
                if (resultHeader) {
                    resultHeader.innerHTML = `
                        <div class="result-icon" style="color: #ffc107;">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h1 class="result-title">ÏãúÌóò Í≤∞Í≥ºÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§</h1>
                        <p class="result-subtitle">URLÏóê ÏãúÌóò IDÍ∞Ä Ìè¨Ìï®ÎêòÏßÄ ÏïäÏïòÍ±∞ÎÇò, Ìï¥Îãπ ÏãúÌóò Í≤∞Í≥ºÍ∞Ä Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§.</p>
                        
                        <div class="score-display" style="opacity: 0.5;">
                            <div class="score-number">-</div>
                            <div class="score-label">Ï†ê</div>
                            <div class="score-details">
                                <span class="earned-points">-</span> / <span class="total-points">-</span>Ï†ê
                            </div>
                        </div>
                    `;
                }
                
                // Ïï°ÏÖò Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏
                const actionButtons = document.querySelector('.action-buttons');
                if (actionButtons) {
                    actionButtons.innerHTML = `
                        <a href="./dashboard.html" class="btn btn-primary btn-large">
                            <i class="fas fa-home"></i> ÎåÄÏãúÎ≥¥ÎìúÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
                        </a>
                        <a href="./exam.html" class="btn btn-outline btn-large">
                            <i class="fas fa-edit"></i> ÏãúÌóò ÏùëÏãúÌïòÍ∏∞
                        </a>
                    `;
                }
                
                // Îã§Î•∏ ÏÑπÏÖòÎì§ Ïà®Í∏∞Í∏∞
                const sectionsToHide = [
                    '.chart-container',
                    '.stats-grid',
                    '.detailed-results',
                    '.recommendations'
                ];
                
                sectionsToHide.forEach(selector => {
                    const element = document.querySelector(selector);
                    if (element) {
                        element.style.display = 'none';
                    }
                });
            }

            async updateUI() {
                // Îç∞Ïù¥ÌÑ∞Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏúºÎ©¥ UI ÏóÖÎç∞Ïù¥Ìä∏ ÌïòÏßÄ ÏïäÏùå
                if (!this.isDataLoaded || this.score === null) {
                    console.log('‚ö†Ô∏è Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÎØ∏ÏôÑÎ£å, UI ÏóÖÎç∞Ïù¥Ìä∏ Í±¥ÎÑàÎúÄ');
                    return;
                }
                
                console.log('üé® UI ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë:', { score: this.score, total: this.totalQuestions });
                
                // Ï†êÏàò ÌëúÏãú - earnedPointsÎ•º ÏÇ¨Ïö©ÌïòÏó¨ Ïã§Ï†ú ÌöçÎìù Ï†êÏàò ÌëúÏãú
                document.getElementById('scoreNumber').textContent = this.examData.earnedPoints || 0;
                document.getElementById('circleScore').textContent = this.examData.earnedPoints || 0;
                
                // Ï†êÏàò ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌëúÏãú
                if (this.examData.earnedPoints !== undefined && this.examData.totalPoints !== undefined) {
                    document.getElementById('earnedPoints').textContent = this.examData.earnedPoints;
                    document.getElementById('totalPoints').textContent = this.examData.totalPoints;
                }
                
                // Í≤∞Í≥º ÏïÑÏù¥ÏΩò Î∞è Ï†úÎ™© ÏóÖÎç∞Ïù¥Ìä∏
                this.updateResultIcon();
                
                // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                this.updateStats();
                
                // ÏõêÌòï Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                this.updateProgressCircle();
                
                // Î¨∏Ìï≠Î≥Ñ Í≤∞Í≥º ÌëúÏãú
                this.displayQuestionResults();
                
                // Ï∂îÏ≤úÏÇ¨Ìï≠ ÌëúÏãú
                this.displayRecommendations();
                
                // Ìè¨Ïù∏Ìä∏ Ï†ïÎ≥¥ ÌëúÏãú
                await this.displayPointsInfo();
            }

            updateResultIcon() {
                const iconElement = document.getElementById('resultIcon');
                const titleElement = document.getElementById('resultTitle');
                const subtitleElement = document.getElementById('resultSubtitle');
                
                if (this.score >= 90) {
                    iconElement.className = 'result-icon excellent';
                    iconElement.innerHTML = '<i class="fas fa-trophy"></i>';
                    titleElement.textContent = 'Ïö∞ÏàòÌïú ÏÑ±Í≥ºÏûÖÎãàÎã§!';
                    subtitleElement.textContent = 'Îõ∞Ïñ¥ÎÇú Ïã§Î†•ÏùÑ Î≥¥Ïó¨Ï£ºÏÖ®ÏäµÎãàÎã§.';
                } else if (this.score >= 80) {
                    iconElement.className = 'result-icon good';
                    iconElement.innerHTML = '<i class="fas fa-medal"></i>';
                    titleElement.textContent = 'Ï¢ãÏùÄ Í≤∞Í≥ºÏûÖÎãàÎã§!';
                    subtitleElement.textContent = 'ÏÑ±Ïã§Ìïú ÌïôÏäµÏùò Í≤∞Í≥ºÏûÖÎãàÎã§.';
                } else if (this.score >= 70) {
                    iconElement.className = 'result-icon average';
                    iconElement.innerHTML = '<i class="fas fa-star"></i>';
                    titleElement.textContent = 'Î≥¥ÌÜµ ÏàòÏ§ÄÏûÖÎãàÎã§';
                    subtitleElement.textContent = 'Ï°∞Í∏à Îçî ÎÖ∏Î†•ÌïòÎ©¥ Îçî Ï¢ãÏùÄ Í≤∞Í≥ºÍ∞Ä ÏûàÏùÑ Í≤ÉÏûÖÎãàÎã§.';
                } else {
                    iconElement.className = 'result-icon poor';
                    iconElement.innerHTML = '<i class="fas fa-book"></i>';
                    titleElement.textContent = 'Ï∂îÍ∞Ä ÌïôÏäµÏù¥ ÌïÑÏöîÌï©ÎãàÎã§';
                    subtitleElement.textContent = 'Ìè¨Í∏∞ÌïòÏßÄ ÎßàÏÑ∏Ïöî. Îã§Ïãú ÎèÑÏ†ÑÌï¥Î≥¥ÏÑ∏Ïöî!';
                }
            }

            updateStats() {
                document.getElementById('correctCount').textContent = this.examData.correctAnswers;
                document.getElementById('incorrectCount').textContent = this.examData.incorrectAnswers;
                document.getElementById('timeUsed').textContent = this.examData.timeUsed;
                document.getElementById('accuracy').textContent = this.score;
                
                // Ïã§Ï†ú ÌèâÍ∑†Í≥º ÎπÑÍµê
                const averageScore = this.examStats?.averageScore || 70;
                const totalParticipants = this.examStats?.totalParticipants || 1;
                const difference = this.score - averageScore;
                const comparisonElement = document.getElementById('comparison');
                
                // Î∞±Î∂ÑÏúÑ Í≥ÑÏÇ∞ (Ï†ïÌôïÌïú Î∞©Ïãù)
                let percentile = 'ÌèâÍ∞Ä Î∂àÍ∞Ä';
                let percentileInfo = '';
                
                if (totalParticipants > 0) {
                    const currentScore = this.examData.earnedPoints || 0;
                    
                    // üéØ Í∞ÑÎã®Ìïú Î∞±Î∂ÑÏúÑ Í≥ÑÏÇ∞: (ÏùëÏãúÏù∏Ïõê - ÎÇ¥ Îí§Ïóê ÏÇ¨Îûå) √∑ ÏùëÏãúÏù∏Ïõê √ó 100
                    const allValidScores = (this.examScores || []).filter(s => 
                        s.score !== null && s.total_points !== null
                    );
                    
                    if (allValidScores.length > 0) {
                        const myScore = currentScore;
                        const allScores = allValidScores.map(s => s.score || 0);
                        
                        // ÎÇ¥ Îí§Ïóê ÏûàÎäî ÏÇ¨Îûå Ïàò (ÎÇòÎ≥¥Îã§ ÎÇÆÏùÄ Ï†êÏàò)
                        const peopleBelow = allScores.filter(score => score < myScore).length;
                        
                        // Ï†ÑÏ≤¥ ÏùëÏãú Ïù∏Ïõê
                        const totalParticipants = allValidScores.length;
                        
                        // ÎÇ¥ ÏàúÏúÑ (ÎÇòÎ≥¥Îã§ ÎÜíÏùÄ Ï†êÏàò + 1)
                        const peopleAbove = allScores.filter(score => score > myScore).length;
                        const myRank = peopleAbove + 1;
                        
                        // ÏÉÅÏúÑ Î∞±Î∂ÑÏúÑ Í≥ÑÏÇ∞: (ÏùëÏãúÏù∏Ïõê - ÎÇ¥ Îí§Ïóê ÏÇ¨Îûå) √∑ ÏùëÏãúÏù∏Ïõê √ó 100
                        const topPercentile = Math.round(((totalParticipants - peopleBelow) / totalParticipants) * 100);
                        
                        console.log('üìä Í∞ÑÎã®Ìïú Î∞±Î∂ÑÏúÑ Í≥ÑÏÇ∞:', {
                            myScore: myScore,
                            allScores: allScores,
                            totalParticipants: totalParticipants,
                            peopleBelow: peopleBelow,
                            peopleAbove: peopleAbove,
                            myRank: myRank,
                            calculation: `(${totalParticipants} - ${peopleBelow}) √∑ ${totalParticipants} √ó 100 = ${topPercentile}%`,
                            topPercentile: topPercentile
                        });
                        
                        // Í≤∞Í≥º Ìï¥ÏÑù Î∞è ÏãúÍ∞ÅÏ†Å ÌëúÌòÑ
                        let icon = '';
                        let colorClass = '';
                        
                        if (totalParticipants === 1) {
                            percentileInfo = `ÌòºÏûê ÏùëÏãú (1Îì±, ÏôÑÏ£º)`;
                            icon = 'üéØ';
                            colorClass = 'percentile-solo';
                        } else if (topPercentile <= 10 || myRank === 1) {
                            percentileInfo = `ÏÉÅÏúÑ ${topPercentile}% (${myRank}Îì±, ÏµúÏÉÅÏúÑÍ∂å)`;
                            icon = 'üèÜ';
                            colorClass = 'percentile-excellent';
                        } else if (topPercentile <= 25) {
                            percentileInfo = `ÏÉÅÏúÑ ${topPercentile}% (${myRank}Îì±, ÏÉÅÏúÑÍ∂å)`;
                            icon = 'ü•á';
                            colorClass = 'percentile-very-good';
                        } else if (topPercentile <= 50) {
                            percentileInfo = `ÏÉÅÏúÑ ${topPercentile}% (${myRank}Îì±, Ï§ëÏÉÅÏúÑÍ∂å)`;
                            icon = 'ü•à';
                            colorClass = 'percentile-good';
                        } else if (topPercentile <= 75) {
                            percentileInfo = `ÏÉÅÏúÑ ${topPercentile}% (${myRank}Îì±, Ï§ëÏúÑÍ∂å)`;
                            icon = 'ü•â';
                            colorClass = 'percentile-average';
                        } else {
                            percentileInfo = `ÏÉÅÏúÑ ${topPercentile}% (${myRank}Îì±, ÌïòÏúÑÍ∂å)`;
                            icon = 'üìö';
                            colorClass = 'percentile-below-average';
                        }
                        
                        percentile = `${icon} ${percentileInfo}`;
                    }
                }
                
                if (difference > 0) {
                    comparisonElement.innerHTML = `${Math.abs(difference)}Ï†ê ÎÜíÏùå<br><small>Ï†ÑÏ≤¥ ÌèâÍ∑†: ${averageScore}Ï†ê (${totalParticipants}Î™Ö Ï∞∏Í∞Ä)</small>`;
                    comparisonElement.style.color = '#28a745';
                } else if (difference < 0) {
                    comparisonElement.innerHTML = `${Math.abs(difference)}Ï†ê ÎÇÆÏùå<br><small>Ï†ÑÏ≤¥ ÌèâÍ∑†: ${averageScore}Ï†ê (${totalParticipants}Î™Ö Ï∞∏Í∞Ä)</small>`;
                    comparisonElement.style.color = '#dc3545';
                } else {
                    comparisonElement.innerHTML = `ÌèâÍ∑†Í≥º ÎèôÏùº<br><small>Ï†ÑÏ≤¥ ÌèâÍ∑†: ${averageScore}Ï†ê (${totalParticipants}Î™Ö Ï∞∏Í∞Ä)</small>`;
                    comparisonElement.style.color = '#6c757d';
                }
                
                // üéØ Î∞±Î∂ÑÏúÑ Ï†ïÎ≥¥Î•º ÌèâÍ∑† ÎπÑÍµê Îã§ÏùåÏóê Ï∂îÍ∞ÄÌïòÍ≥†, Ìè¨Ïù∏Ìä∏ ÏÑπÏÖòÏùÑ Í∑∏ Îã§ÏùåÏúºÎ°ú Ïù¥Îèô
                const percentileElement = document.createElement('p');
                percentileElement.style.cssText = 'color: var(--medium-gray); margin-top: 10px; font-size: 0.95em; font-weight: 500;';
                percentileElement.innerHTML = `Î∞±Î∂ÑÏúÑ: <strong style="color: #2c3e50;">${percentile}</strong>`;
                percentileElement.className = 'percentile-info';
                
                const chartContainer = document.querySelector('.chart-container');
                const pointsDisplay = document.getElementById('pointsDisplay');
                
                if (chartContainer && comparisonElement && pointsDisplay && !chartContainer.querySelector('.percentile-info')) {
                    // Î∞±Î∂ÑÏúÑ Ï†ïÎ≥¥Î•º ÌèâÍ∑† ÎπÑÍµê Îã§ÏùåÏóê ÏÇΩÏûÖ
                    comparisonElement.parentElement.insertAdjacentElement('afterend', percentileElement);
                    
                    // Ìè¨Ïù∏Ìä∏ ÏÑπÏÖòÏùÑ Î∞±Î∂ÑÏúÑ Ï†ïÎ≥¥ Îã§ÏùåÏúºÎ°ú Ïù¥Îèô
                    percentileElement.insertAdjacentElement('afterend', pointsDisplay);
                }
            }

            updateProgressCircle() {
                const circle = document.getElementById('progressCircle');
                const percentage = this.score;
                const degrees = (percentage / 100) * 360;
                
                circle.style.background = `conic-gradient(var(--primary-color) ${degrees}deg, #e9ecef ${degrees}deg)`;
            }

            displayQuestionResults() {
                const container = document.getElementById('questionResults');
                container.innerHTML = '';
                
                // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ÏóêÏÑú Í∞ÄÏ†∏Ïò® Î¨∏Ï†ú Í≤∞Í≥º ÏÇ¨Ïö©
                console.log('üìä Î¨∏Ìï≠Î≥Ñ Í≤∞Í≥º ÌëúÏãú ÏãúÎèÑ:', { 
                    examData: this.examData, 
                    questions: this.examData?.questions,
                    questionsLength: this.examData?.questions?.length 
                });
                
                if (!this.examData || !this.examData.questions || this.examData.questions.length === 0) {
                    const errorMsg = `Î¨∏Ï†ú Í≤∞Í≥ºÎ•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§. (examData: ${!!this.examData}, questions: ${!!this.examData?.questions}, length: ${this.examData?.questions?.length})`;
                    container.innerHTML = `<p>${errorMsg}</p>`;
                    console.warn('‚ùå Î¨∏Ìï≠Î≥Ñ Í≤∞Í≥º ÌëúÏãú Ïã§Ìå®:', errorMsg);
                    return;
                }
                
                this.examData.questions.forEach((question, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = `question-result ${question.correct ? 'correct' : 'incorrect'}`;
                    
                    // Í∞ùÍ¥ÄÏãù Î¨∏Ï†úÏùò Í≤ΩÏö∞ ÏÑ†ÌÉùÏßÄ ÌëúÏãú
                    let choicesHtml = '';
                    if (question.type === 'multiple_choice' || question.type === 'Í∞ùÍ¥ÄÏãù') {
                        if (question.choices && question.choices.length > 0) {
                            choicesHtml = `
                                <div class="question-choices" style="margin-top: 15px;">
                                    <div style="font-weight: 600; margin-bottom: 10px; color: #666;">ÏÑ†ÌÉùÏßÄ:</div>
                                    ${question.choices.map((choice, choiceIndex) => {
                                        const isCorrect = choiceIndex === question.correctAnswer;
                                        const isUserSelected = choiceIndex === question.userAnswerIndex;
                                        
                                        let choiceClass = 'choice-item';
                                        let choiceIcon = '';
                                        let choiceLabel = '';
                                        
                                        if (isCorrect && isUserSelected) {
                                            // Ï†ïÎãµÏù¥Î©¥ÏÑú ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÑ†ÌÉùÌïú Í≤ΩÏö∞ - ÌååÎûÄÏÉâ
                                            choiceClass += ' choice-correct-selected';
                                            choiceIcon = '<i class="fas fa-check-circle" style="color: #007bff;"></i>';
                                            choiceLabel = '<span style="color: #007bff; font-weight: 600;">(Ï†ïÎãµ ‚úì)</span>';
                                        } else if (isCorrect) {
                                            // Ï†ïÎãµÏù¥ÏßÄÎßå ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÑ†ÌÉùÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ - Ï¥àÎ°ùÏÉâ
                                            choiceClass += ' choice-correct';
                                            choiceIcon = '<i class="fas fa-check" style="color: #28a745;"></i>';
                                            choiceLabel = '<span style="color: #28a745; font-weight: 600;">(Ï†ïÎãµ)</span>';
                                        } else if (isUserSelected) {
                                            // ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÑ†ÌÉùÌñàÏßÄÎßå ÌãÄÎ¶∞ Í≤ΩÏö∞ - Îπ®Í∞ÑÏÉâ
                                            choiceClass += ' choice-user-selected';
                                            choiceIcon = '<i class="fas fa-times-circle" style="color: #dc3545;"></i>';
                                            choiceLabel = '<span style="color: #dc3545; font-weight: 600;">(ÎÇ¥ ÏÑ†ÌÉù ‚úó)</span>';
                                        } else {
                                            // ÏùºÎ∞ò ÏÑ†ÌÉùÏßÄ
                                            choiceIcon = '<i class="fas fa-circle" style="color: #dee2e6;"></i>';
                                        }
                                        
                                        let backgroundColor, borderColor;
                                        if (isCorrect && isUserSelected) {
                                            // Ï†ïÎãµÏùÑ ÎßûÏ∂ò Í≤ΩÏö∞ - ÌååÎûÄÏÉâ Î∞∞Í≤Ω
                                            backgroundColor = '#e3f2fd';
                                            borderColor = '#007bff';
                                        } else if (isCorrect) {
                                            // Ï†ïÎãµÏù¥ÏßÄÎßå ÏÑ†ÌÉùÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ - Ï¥àÎ°ùÏÉâ Î∞∞Í≤Ω
                                            backgroundColor = '#f8fff9';
                                            borderColor = '#28a745';
                                        } else if (isUserSelected) {
                                            // ÌãÄÎ¶∞ ÏÑ†ÌÉù - Îπ®Í∞ÑÏÉâ Î∞∞Í≤Ω
                                            backgroundColor = '#fff8f8';
                                            borderColor = '#dc3545';
                                        } else {
                                            // ÏùºÎ∞ò ÏÑ†ÌÉùÏßÄ - ÌöåÏÉâ Î∞∞Í≤Ω
                                            backgroundColor = '#f8f9fa';
                                            borderColor = '#e9ecef';
                                        }
                                        
                                        return `
                                            <div class="${choiceClass}" style="display: flex; align-items: center; padding: 8px 12px; margin: 5px 0; border-radius: 6px; background: ${backgroundColor}; border: 1px solid ${borderColor};">
                                                ${choiceIcon}
                                                <span style="margin-left: 10px; flex: 1;">${String.fromCharCode(65 + choiceIndex)}. ${choice}</span>
                                                ${choiceLabel}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `;
                        }
                    }
                    
                    questionDiv.innerHTML = `
                        <div class="question-info">
                            <div class="question-number">Î¨∏Ï†ú ${index + 1}</div>
                            <div class="question-preview">${question.text}</div>
                            ${choicesHtml}
                        </div>
                        <div class="question-status">
                            <span class="status-icon ${question.correct ? 'correct' : 'incorrect'}">
                                <i class="fas fa-${question.correct ? 'check' : 'times'}-circle"></i>
                            </span>
                            <span>${question.correct ? 'Ï†ïÎãµ' : 'Ïò§Îãµ'}</span>
                        </div>
                    `;
                    
                    container.appendChild(questionDiv);
                });
                
                // Îçî Î≥¥Í∏∞ Î≤ÑÌäº (Ï†ÑÏ≤¥ Î¨∏Ï†ú ÏàòÍ∞Ä ÌëúÏãúÎêú Í≤ÉÎ≥¥Îã§ ÎßéÏùÑ Îïå)
                const displayedQuestions = this.examData.questions.length;
                if (this.totalQuestions > displayedQuestions) {
                    const moreBtn = document.createElement('button');
                    moreBtn.className = 'btn btn-outline';
                    moreBtn.innerHTML = `<i class="fas fa-chevron-down"></i> ÎÇòÎ®∏ÏßÄ ${this.totalQuestions - displayedQuestions}Í∞ú Î¨∏Ï†ú Î≥¥Í∏∞`;
                    moreBtn.onclick = () => this.showAllQuestions();
                    container.appendChild(moreBtn);
                }
            }

            displayRecommendations() {
                const container = document.getElementById('recommendationsList');
                const recommendations = this.generateRecommendations();
                
                container.innerHTML = '';
                
                recommendations.forEach(rec => {
                    const recDiv = document.createElement('div');
                    recDiv.className = 'recommendation-item';
                    recDiv.innerHTML = `
                        <i class="fas fa-${rec.icon} recommendation-icon"></i>
                        <span>${rec.text}</span>
                    `;
                    container.appendChild(recDiv);
                });
            }

            generateRecommendations() {
                const recommendations = [];
                
                if (this.score >= 90) {
                    recommendations.push(
                        { icon: 'trophy', text: 'Ïö∞ÏàòÌïú ÏÑ±Í≥ºÏûÖÎãàÎã§! Îã§Ïùå Îã®Í≥ÑÏùò Í≥†Í∏â Í≥ºÏ†ïÏóê ÎèÑÏ†ÑÌï¥Î≥¥ÏÑ∏Ïöî.' },
                        { icon: 'graduation-cap', text: 'ÎèôÎ£åÎì§ÏóêÍ≤å ÏßÄÏãùÏùÑ Í≥µÏú†ÌïòÎäî Í≤ÉÏùÑ Í≥†Î†§Ìï¥Î≥¥ÏÑ∏Ïöî.' }
                    );
                } else if (this.score >= 80) {
                    recommendations.push(
                        { icon: 'book', text: 'ÌãÄÎ¶∞ Î¨∏Ï†úÎì§ÏùÑ Îã§Ïãú ÌïúÎ≤à Î≥µÏäµÌï¥Î≥¥ÏÑ∏Ïöî.' },
                        { icon: 'clock', text: 'Ï†ïÍ∏∞Ï†ÅÏù∏ Î≥µÏäµÏúºÎ°ú ÏßÄÏãùÏùÑ ÎçîÏö± Í≥µÍ≥†Ìûà ÌïòÏÑ∏Ïöî.' }
                    );
                } else if (this.score >= 70) {
                    recommendations.push(
                        { icon: 'study', text: 'Í∏∞Î≥∏ Í∞úÎÖêÏùÑ Îçî ÌôïÏã§Ìûà ÏùµÌòÄÎ≥¥ÏÑ∏Ïöî.' },
                        { icon: 'practice', text: 'Ï∂îÍ∞Ä Ïó∞Ïäµ Î¨∏Ï†úÎ•º ÌÜµÌï¥ Ïã§Î†•ÏùÑ Ìñ•ÏÉÅÏãúÌÇ§ÏÑ∏Ïöî.' },
                        { icon: 'clock', text: 'Ï∂©Î∂ÑÌïú ÌïôÏäµ ÏãúÍ∞ÑÏùÑ ÌôïÎ≥¥ÌïòÏÑ∏Ïöî.' }
                    );
                } else {
                    recommendations.push(
                        { icon: 'book-open', text: 'Í∏∞Ï¥àÎ∂ÄÌÑ∞ Ï∞®Í∑ºÏ∞®Í∑º Îã§Ïãú ÌïôÏäµÌïòÎäî Í≤ÉÏùÑ Í∂åÏû•Ìï©ÎãàÎã§.' },
                        { icon: 'users', text: 'Ïä§ÌÑ∞Îîî Í∑∏Î£πÏóê Ï∞∏Ïó¨ÌïòÍ±∞ÎÇò Î©òÌÜ†Ïùò ÎèÑÏõÄÏùÑ Î∞õÏïÑÎ≥¥ÏÑ∏Ïöî.' },
                        { icon: 'calendar-alt', text: 'Ï≤¥Í≥ÑÏ†ÅÏù∏ ÌïôÏäµ Í≥ÑÌöçÏùÑ ÏÑ∏ÏõåÎ≥¥ÏÑ∏Ïöî.' },
                        { icon: 'redo', text: 'Ìè¨Í∏∞ÌïòÏßÄ ÎßàÏãúÍ≥† Íæ∏Ï§ÄÌûà Ïû¨ÎèÑÏ†ÑÌïòÏÑ∏Ïöî.' }
                    );
                }
                
                return recommendations;
            }

            async displayPointsInfo() {
                try {
                                    // sessionStorageÏóêÏÑú Ìè¨Ïù∏Ìä∏ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ (ÏãúÌóòÎ≥Ñ Í≥†Ïú† ÌÇ§)
                const examId = this.examData.sessionId || this.examData.examId || 'default';
                const pointStorageKey = `examPointReward_${examId}`;
                const pointRewardData = sessionStorage.getItem(pointStorageKey);
                
                console.log('üîç Ìè¨Ïù∏Ìä∏ Ï∫êÏãú ÌôïÏù∏:', {
                    examId: examId,
                    storageKey: pointStorageKey,
                    hasCache: !!pointRewardData
                });
                    const earnedPointsElement = document.getElementById('earnedPointsDisplay');
                    const pointsBreakdownElement = document.getElementById('pointsBreakdown');
                    
                    if (pointRewardData) {
                        const pointBreakdown = JSON.parse(pointRewardData);
                        console.log('üéØ Ìè¨Ïù∏Ìä∏ Ï†ïÎ≥¥ ÌëúÏãú:', pointBreakdown);
                        
                        // Ï¥ù ÌöçÎìù Ìè¨Ïù∏Ìä∏ ÌëúÏãú
                        const totalPoints = pointBreakdown.totalPoints || 0;
                        earnedPointsElement.textContent = `+${totalPoints}P`;
                        
                        // Ìè¨Ïù∏Ìä∏ ÏÉÅÏÑ∏ ÎÇ¥Ïó≠ ÌëúÏãú
                        const breakdownDetails = [];
                        
                        if (pointBreakdown.questionPoints > 0) {
                            breakdownDetails.push(`Î¨∏Ï†ú Ï†ïÎãµ: +${pointBreakdown.questionPoints}P`);
                        }
                        
                        if (pointBreakdown.completionBonus > 0) {
                            breakdownDetails.push(`ÏôÑÎ£å Î≥¥ÎÑàÏä§: +${pointBreakdown.completionBonus}P`);
                        }
                        
                        if (pointBreakdown.passingBonus > 0) {
                            breakdownDetails.push(`Ìï©Í≤© Î≥¥ÎÑàÏä§: +${pointBreakdown.passingBonus}P`);
                        }
                        
                        if (pointBreakdown.difficultyBonus > 0) {
                            breakdownDetails.push(`ÎÇúÏù¥ÎèÑ Î≥¥ÎÑàÏä§: +${pointBreakdown.difficultyBonus}P`);
                        }
                        
                        if (pointBreakdown.streakBonus > 0) {
                            breakdownDetails.push(`Ïó∞ÏÜç Ï†ïÎãµ: +${pointBreakdown.streakBonus}P`);
                        }
                        
                        if (pointBreakdown.timeBonus > 0) {
                            breakdownDetails.push(`ÏãúÍ∞Ñ Î≥¥ÎÑàÏä§: +${pointBreakdown.timeBonus}P`);
                        }
                        
                        pointsBreakdownElement.textContent = breakdownDetails.join(' | ');
                        
                        // üîß Ï§ëÏöî: sessionStorageÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏñ¥ÎèÑ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï†ÅÎ¶Ω ÏãúÎèÑ
                        if (!pointBreakdown.dbSaved) {
                            console.log('üíæ sessionStorage Ìè¨Ïù∏Ìä∏Î•º Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Ïóê Ï†ÅÎ¶Ω ÏãúÎèÑ...');
                            await this.savePointsToDatabase(totalPoints, pointBreakdown);
                        } else if (pointBreakdown.duplicatePrevented) {
                            console.log('üõ°Ô∏è Ï§ëÎ≥µ Ï†ÅÎ¶Ω Î∞©ÏßÄÎê® - Ïù¥ÎØ∏ ÎèôÏùºÌïú ÏãúÌóòÏúºÎ°ú Ìè¨Ïù∏Ìä∏ Ï†ÅÎ¶ΩÎê®');
                        } else {
                            console.log('‚úÖ Ìè¨Ïù∏Ìä∏Í∞Ä Ïù¥ÎØ∏ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Ïóê Ï†ÄÏû•Îê®');
                        }
                        
                    } else {
                        // Ìè¨Ïù∏Ìä∏ Ï†ïÎ≥¥Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ - ÏûêÎèôÏúºÎ°ú Í≥ÑÏÇ∞
                        console.log('‚ö†Ô∏è Ìè¨Ïù∏Ìä∏ Ï†ïÎ≥¥ ÏóÜÏùå - ÏûêÎèô Í≥ÑÏÇ∞ ÏãúÎèÑ');
                        await this.calculateMissingPoints(earnedPointsElement, pointsBreakdownElement);
                    }
                } catch (error) {
                    console.error('‚ùå Ìè¨Ïù∏Ìä∏ Ï†ïÎ≥¥ ÌëúÏãú Ïò§Î•ò:', error);
                    document.getElementById('earnedPointsDisplay').textContent = 'Ïò§Î•ò';
                    document.getElementById('pointsBreakdown').textContent = 'Ìè¨Ïù∏Ìä∏ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.';
                }
            }

            async savePointsToDatabase(totalPoints, pointBreakdown) {
                try {
                    // Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Î∞è ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÌôïÏù∏
                    const supabaseClient = window.semuApp?.supabaseClient || window.supabaseClient;
                    const userId = this.examData.employeeId || window.semuApp?.currentUser?.id;
                    const examTitle = this.examData.title || 'ÏãúÌóò';
                    
                    console.log('üîç Ìè¨Ïù∏Ìä∏ Ï†ÅÎ¶Ω Ï°∞Í±¥ ÌôïÏù∏:', {
                        supabaseClient: !!supabaseClient,
                        userId: userId,
                        sessionId: this.examData.sessionId,
                        totalPoints: totalPoints,
                        examTitle: examTitle
                    });
                    
                    if (supabaseClient && userId) {
                        // üõ°Ô∏è Ï§ëÎ≥µ Ï†ÅÎ¶Ω Î∞©ÏßÄ: Ïù¥ÎØ∏ Ï†ÅÎ¶ΩÎêú Ìè¨Ïù∏Ìä∏Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
                        console.log('üõ°Ô∏è Ï§ëÎ≥µ Ï†ÅÎ¶Ω Î∞©ÏßÄ Í≤ÄÏÇ¨ ÏãúÏûë...');
                        
                        const { data: existingTransactions, error: checkError } = await supabaseClient
                            .from('point_transactions')
                            .select('id, amount, created_at')
                            .eq('user_id', userId)
                            .eq('description', `ÏãúÌóò ÏôÑÎ£å: ${examTitle}`)
                            .order('created_at', { ascending: false })
                            .limit(1);
                        
                        if (checkError) {
                            console.warn('‚ö†Ô∏è Ï§ëÎ≥µ Í≤ÄÏÇ¨ Ïã§Ìå®, Ï†ÅÎ¶Ω Ï§ëÎã®:', checkError);
                            return;
                        }
                        
                        if (existingTransactions && existingTransactions.length > 0) {
                            const existingTransaction = existingTransactions[0];
                            
                            console.log('üõ°Ô∏è Í∏∞Ï°¥ Ìè¨Ïù∏Ìä∏ Ï†ÅÎ¶Ω Î∞úÍ≤¨:', {
                                transactionId: existingTransaction.id,
                                amount: existingTransaction.amount,
                                createdAt: existingTransaction.created_at,
                                examTitle: examTitle
                            });
                            
                            // ÎèôÏùº ÏãúÌóòÏúºÎ°ú Ïù¥ÎØ∏ Ìè¨Ïù∏Ìä∏Í∞Ä Ï†ÅÎ¶ΩÎêòÏóàÏúºÎ©¥ Î¨¥Ï°∞Í±¥ Ï§ëÎ≥µÏúºÎ°ú ÌåêÎã®
                            console.log('‚úÖ Ï§ëÎ≥µ Ï†ÅÎ¶Ω Î∞©ÏßÄ: Ïù¥ÎØ∏ ÎèôÏùº ÏãúÌóòÏúºÎ°ú Ìè¨Ïù∏Ìä∏Í∞Ä Ï†ÅÎ¶ΩÎê®');
                            
                            // sessionStorageÏóê Ï†ÄÏû• ÏôÑÎ£å ÌëúÏãú
                            pointBreakdown.dbSaved = true;
                            pointBreakdown.duplicatePrevented = true;
                            const examId = this.examData.sessionId || this.examData.examId || 'default';
                            const pointStorageKey = `examPointReward_${examId}`;
                            sessionStorage.setItem(pointStorageKey, JSON.stringify(pointBreakdown));
                            
                            return;
                        }
                        
                        console.log('üíæ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Ïóê Ìè¨Ïù∏Ìä∏ Ï†ÅÎ¶Ω ÏãúÎèÑ...');
                        
                        const { data, error } = await supabaseClient
                            .rpc('add_user_points', {
                                target_user_id: userId,
                                points_to_add: totalPoints,
                                description: `ÏãúÌóò ÏôÑÎ£å: ${examTitle}`,
                                target_avatar_item_id: null
                            });
                            
                        if (error) {
                            console.warn('‚ö†Ô∏è Ìè¨Ïù∏Ìä∏ Ï†ÅÎ¶Ω Ïã§Ìå®:', error);
                        } else {
                            console.log('‚úÖ Ìè¨Ïù∏Ìä∏ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï†ÅÎ¶Ω ÏôÑÎ£å:', data);
                            
                            // sessionStorageÏóê Ï†ÄÏû• ÏôÑÎ£å ÌëúÏãú
                            pointBreakdown.dbSaved = true;
                            pointBreakdown.firstTimeReward = true;
                            const examId = this.examData.sessionId || this.examData.examId || 'default';
                            const pointStorageKey = `examPointReward_${examId}`;
                            sessionStorage.setItem(pointStorageKey, JSON.stringify(pointBreakdown));
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Ìè¨Ïù∏Ìä∏ Ï†ÅÎ¶Ω Ï°∞Í±¥ ÎØ∏Ï∂©Ï°±:', {
                            supabaseClient: !!supabaseClient,
                            userId: userId
                        });
                    }
                } catch (error) {
                    console.error('‚ùå Ìè¨Ïù∏Ìä∏ DB Ï†ÄÏû• Ïò§Î•ò:', error);
                }
            }

            async calculateMissingPoints(earnedPointsElement, pointsBreakdownElement) {
                try {
                    console.log('üîÑ ÎàÑÎùΩÎêú Ìè¨Ïù∏Ìä∏ ÏûêÎèô Í≥ÑÏÇ∞ ÏãúÏûë...');
                    
                    // Í∏∞Î≥∏ Ìè¨Ïù∏Ìä∏ Í≥ÑÏÇ∞ Î°úÏßÅ
                    const { correctAnswers, earnedPoints } = this.examData;
                    let totalPoints = 0;
                    let breakdown = [];
                    
                    // 1. Î¨∏Ï†ú Ï†ïÎãµ Ìè¨Ïù∏Ìä∏ (Ï†ïÎãµ 1Í∞úÎãπ 10Ï†ê)
                    console.log('üîç Ìè¨Ïù∏Ìä∏ Í≥ÑÏÇ∞ ÏÉÅÏÑ∏:', {
                        correctAnswers: correctAnswers,
                        totalQuestions: this.totalQuestions || this.total,
                        score: this.score,
                        percentage: this.examData.percentage
                    });
                    
                    const questionPoints = correctAnswers * 10;  // Ï†ïÎãµ 1Í∞úÎãπ 10Ï†ê
                    totalPoints += questionPoints;
                    breakdown.push(`Î¨∏Ï†ú Ï†ïÎãµ: +${questionPoints}P`);
                    
                    // 2. ÏãúÌóò ÏôÑÎ£å Î≥¥ÎÑàÏä§ (200Ï†ê)
                    const completionBonus = 200;
                    totalPoints += completionBonus;
                    breakdown.push(`ÏôÑÎ£å Î≥¥ÎÑàÏä§: +${completionBonus}P`);
                    
                    // 3. Ìï©Í≤© Î≥¥ÎÑàÏä§ (70Ï†ê Ïù¥ÏÉÅÏù¥Î©¥ 300Ï†ê)
                    const percentage = this.examData.percentage || this.score;
                    if (percentage >= 70) {
                        const passingBonus = 300;
                        totalPoints += passingBonus;
                        breakdown.push(`Ìï©Í≤© Î≥¥ÎÑàÏä§: +${passingBonus}P`);
                    }
                    
                    // UI ÏóÖÎç∞Ïù¥Ìä∏
                    earnedPointsElement.textContent = `+${totalPoints}P`;
                    pointsBreakdownElement.textContent = breakdown.join(' | ');
                    
                    // sessionStorageÏóê Ï†ÄÏû• (Ìñ•ÌõÑ ÏÇ¨Ïö©ÏùÑ ÏúÑÌï¥)
                    const pointData = {
                        totalPoints,
                        questionPoints,
                        completionBonus,
                        passingBonus: percentage >= 70 ? 300 : 0,
                        difficultyBonus: 0,
                        streakBonus: 0,
                        timeBonus: 0,
                        autoCalculated: true
                    };
                    const examId = this.examData.sessionId || this.examData.examId || 'default';
                    const pointStorageKey = `examPointReward_${examId}`;
                    sessionStorage.setItem(pointStorageKey, JSON.stringify(pointData));
                    
                    console.log('‚úÖ Ìè¨Ïù∏Ìä∏ ÏûêÎèô Í≥ÑÏÇ∞ ÏôÑÎ£å:', pointData);
                    
                    // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Ïóê Ìè¨Ïù∏Ìä∏ Ï†ÅÎ¶Ω ÏãúÎèÑ
                    const supabaseClient = window.semuApp?.supabaseClient || window.supabaseClient;
                    const userId = this.examData.employeeId || window.semuApp?.currentUser?.id;
                    
                    console.log('üîç Ìè¨Ïù∏Ìä∏ Ï†ÅÎ¶Ω Ï°∞Í±¥ ÌôïÏù∏:', {
                        supabaseClient: !!supabaseClient,
                        userId: userId,
                        sessionId: this.examData.sessionId,
                        totalPoints: totalPoints
                    });
                    
                    if (supabaseClient && userId) {
                        try {
                            const examTitle = this.examData.title || 'ÏãúÌóò';
                            
                            // üõ°Ô∏è Ï§ëÎ≥µ Ï†ÅÎ¶Ω Î∞©ÏßÄ: Ïù¥ÎØ∏ Ï†ÅÎ¶ΩÎêú Ìè¨Ïù∏Ìä∏Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
                            console.log('üõ°Ô∏è ÏûêÎèô Í≥ÑÏÇ∞ - Ï§ëÎ≥µ Ï†ÅÎ¶Ω Î∞©ÏßÄ Í≤ÄÏÇ¨ ÏãúÏûë...');
                            
                            const { data: existingTransactions, error: checkError } = await supabaseClient
                                .from('point_transactions')
                                .select('id, amount, created_at')
                                .eq('user_id', userId)
                                .eq('description', `ÏãúÌóò ÏôÑÎ£å: ${examTitle}`)
                                .order('created_at', { ascending: false })
                                .limit(1);
                            
                            if (checkError) {
                                console.warn('‚ö†Ô∏è Ï§ëÎ≥µ Í≤ÄÏÇ¨ Ïã§Ìå®, Ï†ÅÎ¶Ω Ï§ëÎã®:', checkError);
                                return;
                            }
                            
                            if (existingTransactions && existingTransactions.length > 0) {
                                const existingTransaction = existingTransactions[0];
                                
                                console.log('üõ°Ô∏è ÏûêÎèô Í≥ÑÏÇ∞ - Í∏∞Ï°¥ Ìè¨Ïù∏Ìä∏ Ï†ÅÎ¶Ω Î∞úÍ≤¨:', {
                                    transactionId: existingTransaction.id,
                                    amount: existingTransaction.amount,
                                    createdAt: existingTransaction.created_at,
                                    examTitle: examTitle
                                });
                                
                                // ÎèôÏùº ÏãúÌóòÏúºÎ°ú Ïù¥ÎØ∏ Ìè¨Ïù∏Ìä∏Í∞Ä Ï†ÅÎ¶ΩÎêòÏóàÏúºÎ©¥ Î¨¥Ï°∞Í±¥ Ï§ëÎ≥µÏúºÎ°ú ÌåêÎã®
                                console.log('‚úÖ ÏûêÎèô Í≥ÑÏÇ∞ - Ï§ëÎ≥µ Ï†ÅÎ¶Ω Î∞©ÏßÄ: Ïù¥ÎØ∏ ÎèôÏùº ÏãúÌóòÏúºÎ°ú Ìè¨Ïù∏Ìä∏Í∞Ä Ï†ÅÎ¶ΩÎê®');
                                
                                // sessionStorageÏóêÎèÑ Ï§ëÎ≥µ Î∞©ÏßÄ Ï†ïÎ≥¥ Ï†ÄÏû•
                                pointData.dbSaved = true;
                                pointData.duplicatePrevented = true;
                                const examId = this.examData.sessionId || this.examData.examId || 'default';
                                const pointStorageKey = `examPointReward_${examId}`;
                                sessionStorage.setItem(pointStorageKey, JSON.stringify(pointData));
                                
                                return;
                            }
                            
                            console.log('üíæ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Ïóê Ìè¨Ïù∏Ìä∏ Ï†ÅÎ¶Ω ÏãúÎèÑ...');
                            
                            const { data, error } = await supabaseClient
                                .rpc('add_user_points', {
                                    target_user_id: userId,
                                    points_to_add: totalPoints,
                                    description: `ÏãúÌóò ÏôÑÎ£å: ${examTitle}`,
                                    target_avatar_item_id: null
                                });
                                
                            if (error) {
                                console.warn('‚ö†Ô∏è Ìè¨Ïù∏Ìä∏ Ï†ÅÎ¶Ω Ïã§Ìå®:', error);
                            } else {
                                console.log('‚úÖ Ìè¨Ïù∏Ìä∏ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï†ÅÎ¶Ω ÏôÑÎ£å:', data);
                                
                                // sessionStorageÏóê ÏÑ±Í≥µ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                                pointData.dbSaved = true;
                                pointData.firstTimeReward = true;
                                const examId = this.examData.sessionId || this.examData.examId || 'default';
                                const pointStorageKey = `examPointReward_${examId}`;
                                sessionStorage.setItem(pointStorageKey, JSON.stringify(pointData));
                            }
                        } catch (dbError) {
                            console.warn('‚ö†Ô∏è Ìè¨Ïù∏Ìä∏ DB Ï†ÅÎ¶Ω Ïò§Î•ò:', dbError);
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Ìè¨Ïù∏Ìä∏ Ï†ÅÎ¶Ω Ï°∞Í±¥ ÎØ∏Ï∂©Ï°±:', {
                            supabaseClient: !!supabaseClient,
                            userId: userId
                        });
                    }
                    
                } catch (error) {
                    console.error('‚ùå Ìè¨Ïù∏Ìä∏ ÏûêÎèô Í≥ÑÏÇ∞ Ïã§Ìå®:', error);
                    earnedPointsElement.textContent = 'Í≥ÑÏÇ∞ Ïã§Ìå®';
                    pointsBreakdownElement.textContent = 'Ìè¨Ïù∏Ìä∏Î•º Í≥ÑÏÇ∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§.';
                }
            }

            showAllQuestions() {
                showAlert('Ï†ÑÏ≤¥ Î¨∏Ìï≠Î≥Ñ ÏÉÅÏÑ∏ Î∂ÑÏÑù Í∏∞Îä•ÏùÄ Í≥ß Íµ¨ÌòÑÎê† ÏòàÏ†ïÏûÖÎãàÎã§.', 'info');
            }

            // ÏãúÌóò ÏÑ†ÌÉù UI ÌëúÏãú
            async showExamSelectionUI() {
                try {
                    console.log('üìã ÏÇ¨Ïö©Ïûê ÏôÑÎ£å ÏãúÌóò Î™©Î°ù Î°úÎî© Ï§ë...');
                    
                    // ÏÇ¨Ïö©ÏûêÏùò ÏôÑÎ£åÎêú ÏãúÌóò ÏÑ∏ÏÖò Ï°∞Ìöå (submitted, completed ÏÉÅÌÉú Î™®Îëê Ìè¨Ìï®)
                    const { data: sessions, error: sessionsError } = await window.supabaseClient
                        .from('exam_sessions')
                        .select(`
                            id,
                            exam_id,
                            status,
                            score,
                            total_points,
                            submit_time,
                            created_at,
                            exams (
                                id,
                                title,
                                description
                            )
                        `)
                        .eq('employee_id', window.semuApp.currentUser.id)
                        .in('status', ['submitted', 'completed', 'in_progress'])
                        // Ï†êÏàò Ï°∞Í±¥ Ï†úÍ±∞ - ÏßÑÌñâÏ§ëÏù∏ ÏãúÌóòÎèÑ Î≥º Ïàò ÏûàÎèÑÎ°ù
                        .order('submit_time', { ascending: false, nullsLast: true })
                        .order('created_at', { ascending: false });

                    if (sessionsError) {
                        console.error('‚ùå ÏãúÌóò ÏÑ∏ÏÖò Ï°∞Ìöå Ïã§Ìå®:', sessionsError);
                        throw sessionsError;
                    }

                    console.log('üìä ÏôÑÎ£åÎêú ÏãúÌóò ÏÑ∏ÏÖò:', sessions);
                    
                    // ÎîîÎ≤ÑÍπÖÏùÑ ÏúÑÌïú ÏÑ∏ÏÖò ÏÉÅÌÉúÎ≥Ñ Í∞úÏàò Î°úÍ∑∏
                    if (sessions && sessions.length > 0) {
                        const statusCounts = sessions.reduce((acc, session) => {
                            acc[session.status] = (acc[session.status] || 0) + 1;
                            return acc;
                        }, {});
                        console.log('üìà ÏãúÌóò ÏÑ∏ÏÖò ÏÉÅÌÉúÎ≥Ñ Í∞úÏàò:', statusCounts);
                        
                        sessions.forEach(session => {
                            console.log(`üéØ ÏãúÌóò: ${session.exams?.title}, ÏÉÅÌÉú: ${session.status}, Ï†êÏàò: ${session.score}`);
                        });
                    }

                    if (!sessions || sessions.length === 0) {
                        this.showNoExamsMessage();
                        return;
                    }

                    this.displayExamSelection(sessions);
                    
                } catch (error) {
                    console.error('‚ùå ÏãúÌóò Î™©Î°ù Î°úÎî© Ïã§Ìå®:', error);
                    this.showNoExamsMessage();
                }
            }

            // ÏãúÌóò Î™©Î°ù ÌôîÎ©¥ ÌëúÏãú
            displayExamSelection(sessions) {
                const container = document.querySelector('.results-container');
                
                container.innerHTML = `
                    <div class="exam-selection-container">
                        <div class="exam-selection-header">
                            <h2>üéØ ÏãúÌóò ÏÑ†ÌÉù</h2>
                            <p>ÌôïÏù∏ÌïòÍ≥† Ïã∂ÏùÄ ÏãúÌóò Í≤∞Í≥ºÎ•º ÏÑ†ÌÉùÌïòÍ±∞ÎÇò ÏßÑÌñâÏ§ëÏù∏ ÏãúÌóòÏùÑ Í≥ÑÏÜç ÏùëÏãúÌïòÏÑ∏Ïöî.</p>
                        </div>
                        
                        <div class="exam-list">
                            ${sessions.map((session, index) => {
                                const exam = session.exams;
                                const score = session.score || 0;
                                const totalPoints = session.total_points || 100;
                                const percentage = session.score !== null ? Math.round((score / totalPoints) * 100) : 0;
                                // submit_timeÏù¥ ÏóÜÏúºÎ©¥ created_at ÏÇ¨Ïö©
                                const dateToShow = session.submit_time || session.created_at;
                                const submitDate = new Date(dateToShow).toLocaleDateString('ko-KR', {
                                    year: 'numeric',
                                    month: 'long', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                                const dateLabel = session.submit_time ? 'Ï†úÏ∂úÏùº' : 'ÏùëÏãúÏùº';

                                return `
                                <div class="exam-item" onclick="window.resultsPage.selectExam('${session.exam_id}', ${score}, ${totalPoints})">
                                    <div class="exam-item-content">
                                        <div class="exam-item-main">
                                            <div class="exam-item-header">
                                                <h3>${exam?.title || 'ÏãúÌóò Ï†úÎ™© ÏóÜÏùå'}</h3>
                                                <div class="exam-score ${session.score !== null ? (percentage >= 80 ? 'high-score' : percentage >= 60 ? 'medium-score' : 'low-score') : 'in-progress'}">
                                                    ${session.score !== null ? `${percentage}Ï†ê` : 'ÏßÑÌñâÏ§ë'}
                                                </div>
                                            </div>
                                            <div class="exam-item-details">
                                                <div class="exam-description">${exam?.description || 'ÏÑ§Î™Ö ÏóÜÏùå'}</div>
                                                <div class="exam-date">${dateLabel}: ${submitDate}</div>
                                            </div>
                                        </div>
                                        <div class="exam-item-arrow">‚Üí</div>
                                    </div>
                                </div>
                            `;
                            }).join('')}
                        </div>
                        
                        <div class="exam-selection-footer">
                            <button class="btn-secondary" onclick="window.location.href='dashboard.html'">
                                üìä ÎåÄÏãúÎ≥¥ÎìúÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
                            </button>
                        </div>
                    </div>
                `;

                // Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä
                this.addExamSelectionStyles();
            }

            // ÏãúÌóòÏù¥ ÏóÜÏùÑ Îïå Î©îÏãúÏßÄ
            showNoExamsMessage() {
                const container = document.querySelector('.results-container');
                
                container.innerHTML = `
                    <div class="no-exams-container">
                        <div class="no-exams-icon">üìù</div>
                        <h2>ÏôÑÎ£åÎêú ÏãúÌóòÏù¥ ÏóÜÏäµÎãàÎã§</h2>
                        <p>Î®ºÏ†Ä ÏãúÌóòÏùÑ ÏùëÏãúÌïú ÌõÑ Í≤∞Í≥ºÎ•º ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.</p>
                        <div class="no-exams-actions">
                            <button class="btn-primary" onclick="window.location.href='dashboard.html'">
                                üè† ÎåÄÏãúÎ≥¥ÎìúÎ°ú Ïù¥Îèô
                            </button>
                        </div>
                    </div>
                `;

                this.addExamSelectionStyles();
            }

            // ÏãúÌóò ÏÑ†ÌÉù
            selectExam(examId, score, totalPoints) {
                console.log('üéØ ÏãúÌóò ÏÑ†ÌÉùÎê®:', { examId, score, totalPoints });
                
                try {
                    // ÏßÑÌñâÏ§ëÏù∏ ÏãúÌóò(scoreÍ∞Ä 0Ïù¥Í≥† totalPointsÍ∞Ä 100Ïù∏ Í≤ΩÏö∞) Ï≤òÎ¶¨
                    if (score === 0 && totalPoints === 100) {
                        // ÏßÑÌñâÏ§ëÏù∏ ÏãúÌóòÏù∏ÏßÄ ÌôïÏù∏ ÌõÑ ÏãúÌóò ÏùëÏãú ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
                        const confirmContinue = confirm('Ïù¥ ÏãúÌóòÏùÄ ÏïÑÏßÅ ÏßÑÌñâÏ§ëÏûÖÎãàÎã§. ÏãúÌóòÏùÑ Í≥ÑÏÜç ÏùëÏãúÌïòÏãúÍ≤†ÏäµÎãàÍπå?');
                        if (confirmContinue) {
                            window.location.href = `exam.html?id=${examId}`;
                            return;
                        } else {
                            return; // Ï∑®ÏÜå Ïãú ÏïÑÎ¨¥Í≤ÉÎèÑ ÌïòÏßÄ ÏïäÏùå
                        }
                    }
                    
                    // URL ÌååÎùºÎØ∏ÌÑ∞ ÏïàÏ†ÑÌïòÍ≤å ÏÉùÏÑ±
                    const scorePercentage = totalPoints > 0 ? Math.round((score / totalPoints) * 100) : 0;
                    const urlParams = new URLSearchParams({
                        exam: examId,
                        score: scorePercentage,
                        total: totalPoints
                    });
                    
                    const newUrl = `results.html?${urlParams.toString()}`;
                    console.log('üîó Î¶¨Îã§Ïù¥Î†âÌä∏ URL:', newUrl);
                    
                    window.location.href = newUrl;
                } catch (error) {
                    console.error('‚ùå ÏãúÌóò ÏÑ†ÌÉù Ï§ë Ïò§Î•ò:', error);
                    alert('ÏãúÌóò Í≤∞Í≥º ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌïòÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }
            }

            // ÏãúÌóò ÏÑ†ÌÉù ÌôîÎ©¥Ïö© Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä
            addExamSelectionStyles() {
                if (document.getElementById('exam-selection-styles')) return;

                const styles = document.createElement('style');
                styles.id = 'exam-selection-styles';
                styles.textContent = `
                    .exam-selection-container {
                        max-width: 900px;
                        margin: 0 auto;
                        padding: 40px 20px;
                        min-height: 80vh;
                        display: flex;
                        flex-direction: column;
                    }

                    .exam-selection-header {
                        text-align: center;
                        margin-bottom: 40px;
                        padding: 20px 0;
                    }

                    .exam-selection-header h2 {
                        color: #2c3e50;
                        margin-bottom: 12px;
                        font-size: 28px;
                        font-weight: 600;
                    }

                    .exam-selection-header p {
                        color: #7f8c8d;
                        font-size: 16px;
                        line-height: 1.5;
                    }

                    .exam-list {
                        display: flex;
                        flex-direction: column;
                        gap: 20px;
                        margin-bottom: 40px;
                        flex: 1;
                    }

                    .exam-item {
                        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                        border: 1px solid #e9ecef;
                        border-radius: 16px;
                        padding: 24px;
                        cursor: pointer;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        display: flex;
                        align-items: center;
                        gap: 20px;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
                        position: relative;
                        overflow: hidden;
                    }

                    .exam-item::before {
                        content: '';
                        position: absolute;
                        left: 0;
                        top: 0;
                        height: 100%;
                        width: 4px;
                        background: linear-gradient(180deg, #6c5ce7, #a29bfe);
                        opacity: 0;
                        transition: opacity 0.3s ease;
                    }

                    .exam-item:hover {
                        border-color: #6c5ce7;
                        box-shadow: 0 8px 25px rgba(108, 92, 231, 0.15);
                        transform: translateY(-4px);
                    }

                    .exam-item:hover::before {
                        opacity: 1;
                    }

                    .exam-item-content {
                        flex: 1;
                        display: flex;
                        align-items: center;
                        gap: 24px;
                    }

                    .exam-item-main {
                        flex: 1;
                        min-width: 0;
                    }

                    .exam-item-header {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        margin-bottom: 8px;
                    }

                    .exam-item-header h3 {
                        margin: 0;
                        color: #2c3e50;
                        font-size: 20px;
                        font-weight: 600;
                        line-height: 1.3;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                        max-width: 400px;
                    }

                    .exam-score {
                        padding: 10px 20px;
                        border-radius: 25px;
                        font-weight: 700;
                        font-size: 16px;
                        white-space: nowrap;
                        margin-left: 16px;
                        min-width: 80px;
                        text-align: center;
                    }

                    .exam-score.high-score {
                        background: linear-gradient(135deg, #00b894, #00cec9);
                        color: white;
                        box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
                    }

                    .exam-score.medium-score {
                        background: linear-gradient(135deg, #fdcb6e, #e17055);
                        color: white;
                        box-shadow: 0 4px 15px rgba(253, 203, 110, 0.3);
                    }

                    .exam-score.low-score {
                        background: linear-gradient(135deg, #fd79a8, #e84393);
                        color: white;
                        box-shadow: 0 4px 15px rgba(253, 121, 168, 0.3);
                    }

                    .exam-score.in-progress {
                        background: linear-gradient(135deg, #f39c12, #e67e22);
                        color: white;
                        box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
                    }

                    .exam-item-details {
                        display: flex;
                        flex-direction: column;
                        gap: 4px;
                    }

                    .exam-description {
                        color: #636e72;
                        font-size: 14px;
                        line-height: 1.4;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                        max-width: 500px;
                    }

                    .exam-date {
                        color: #b2bec3;
                        font-size: 13px;
                        font-weight: 500;
                    }

                    .exam-item-arrow {
                        font-size: 24px;
                        color: #6c5ce7;
                        transition: transform 0.3s ease;
                        opacity: 0.7;
                    }

                    .exam-item:hover .exam-item-arrow {
                        transform: translateX(4px);
                        opacity: 1;
                    }

                    .exam-selection-footer {
                        text-align: center;
                        margin-top: auto;
                        padding-top: 20px;
                    }

                    .no-exams-container {
                        text-align: center;
                        padding: 80px 20px;
                        max-width: 500px;
                        margin: 0 auto;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        min-height: 60vh;
                    }

                    .no-exams-icon {
                        font-size: 80px;
                        margin-bottom: 24px;
                        opacity: 0.8;
                    }

                    .no-exams-container h2 {
                        color: #2c3e50;
                        margin-bottom: 16px;
                        font-size: 24px;
                        font-weight: 600;
                    }

                    .no-exams-container p {
                        color: #7f8c8d;
                        font-size: 16px;
                        margin-bottom: 32px;
                        line-height: 1.6;
                    }

                    .no-exams-actions {
                        display: flex;
                        justify-content: center;
                        gap: 16px;
                    }

                    .btn-primary, .btn-secondary {
                        padding: 14px 28px;
                        border: none;
                        border-radius: 12px;
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        text-decoration: none;
                        display: inline-flex;
                        align-items: center;
                        gap: 8px;
                    }

                    .btn-primary {
                        background: linear-gradient(135deg, #6c5ce7, #a29bfe);
                        color: white;
                        box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
                    }

                    .btn-primary:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 6px 20px rgba(108, 92, 231, 0.4);
                    }

                    .btn-secondary {
                        background: white;
                        color: #6c5ce7;
                        border: 2px solid #6c5ce7;
                    }

                    .btn-secondary:hover {
                        background: #6c5ce7;
                        color: white;
                        transform: translateY(-2px);
                    }

                    @media (max-width: 768px) {
                        .exam-selection-container {
                            padding: 20px 15px;
                        }

                        .exam-selection-header h2 {
                            font-size: 24px;
                        }

                        .exam-item {
                            padding: 20px;
                            flex-direction: column;
                            align-items: stretch;
                        }

                        .exam-item-content {
                            flex-direction: column;
                            gap: 16px;
                        }

                        .exam-item-header {
                            flex-direction: column;
                            align-items: flex-start;
                            gap: 12px;
                        }

                        .exam-item-header h3 {
                            font-size: 18px;
                            max-width: none;
                        }

                        .exam-score {
                            margin-left: 0;
                            align-self: flex-start;
                        }

                        .exam-description {
                            max-width: none;
                            white-space: normal;
                        }

                        .exam-item-arrow {
                            align-self: center;
                            margin-top: 8px;
                        }

                        .no-exams-actions {
                            flex-direction: column;
                            align-items: center;
                        }

                        .btn-primary, .btn-secondary {
                            width: 200px;
                            justify-content: center;
                        }
                    }

                    @media (max-width: 480px) {
                        .exam-selection-header {
                            padding: 15px 0;
                            margin-bottom: 30px;
                        }

                        .exam-item {
                            padding: 16px;
                        }

                        .exam-item-header h3 {
                            font-size: 16px;
                        }

                        .exam-score {
                            padding: 8px 16px;
                            font-size: 14px;
                        }
                    }
                `;
                
                document.head.appendChild(styles);
            }
        }

        // Ï†ÑÏó≠ Ìï®ÏàòÎì§
        let resultsPage;
        
        // Ï†ÑÏó≠ÏóêÏÑú Ï†ëÍ∑º Í∞ÄÎä•ÌïòÎèÑÎ°ù ÏÑ§Ï†ï
        window.resultsPage = null;

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üìä Í≤∞Í≥º ÌéòÏù¥ÏßÄ DOM Î°úÎìú ÏôÑÎ£å');
            
            // Supabase Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞
            let attempts = 0;
            const maxAttempts = 50;
            
            while (attempts < maxAttempts && (!window.semuApp || !window.supabaseClient)) {
                console.log('‚è≥ Supabase Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞ Ï§ë...', attempts);
                await new Promise(resolve => setTimeout(resolve, 200));
                attempts++;
            }
            
            if (window.semuApp && window.supabaseClient) {
                console.log('‚úÖ Supabase Ï¥àÍ∏∞Ìôî ÏôÑÎ£å, Í≤∞Í≥º ÌéòÏù¥ÏßÄ ÏÉùÏÑ±');
                resultsPage = new ResultsPage();
                window.resultsPage = resultsPage; // Ï†ÑÏó≠ÏóêÏÑú Ï†ëÍ∑º Í∞ÄÎä•ÌïòÎèÑÎ°ù
            } else {
                console.error('‚ùå Supabase Ï¥àÍ∏∞Ìôî Ïã§Ìå®');
                alert('ÏãúÏä§ÌÖú Ï¥àÍ∏∞ÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
            }
        });

        // Ïû¨ÏùëÏãú Í∏∞Îä• ÎπÑÌôúÏÑ±Ìôî
        /*
        function retakeExam() {
            if (confirm('Í∞ôÏùÄ ÏãúÌóòÏùÑ Îã§Ïãú ÏùëÏãúÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                // URLÏóêÏÑú ÏãúÌóò ID Í∞ÄÏ†∏Ïò§Í∏∞
                const urlParams = new URLSearchParams(window.location.search);
                const examId = urlParams.get('exam');
                
                if (examId) {
                    window.location.href = `./exam.html?id=${examId}`;
                } else {
                    // ÏãúÌóò IDÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞ ÎåÄÏãúÎ≥¥ÎìúÎ°ú Ïù¥Îèô
                    window.location.href = './dashboard.html';
                }
            }
        }
        */

        async function viewDetails() {
            try {
                // URLÏóêÏÑú ÏãúÌóò ID Í∞ÄÏ†∏Ïò§Í∏∞
                const urlParams = new URLSearchParams(window.location.search);
                const examId = urlParams.get('exam');
                
                if (!examId) {
                    showAlert('ÏãúÌóò Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                    return;
                }
                
                // Ïù∏ÎùºÏù∏ ÏÉÅÏÑ∏ Î∂ÑÏÑù ÌëúÏãú
                await showDetailedAnalysisInline(examId);
                
            } catch (error) {
                console.error('ÏÉÅÏÑ∏ Î∂ÑÏÑù ÌëúÏãú Ïã§Ìå®:', error);
                showAlert('ÏÉÅÏÑ∏ Î∂ÑÏÑùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            }
        }
        
        // Ïù∏ÎùºÏù∏ ÏÉÅÏÑ∏ Î∂ÑÏÑù ÌëúÏãú (ÏÉàÎ°úÏö¥ ÏÑ∏Î°ú Ïä§ÌÅ¨Î°§ Î∞©Ïãù)
        async function showDetailedAnalysisInline(examId) {
            try {
                // Í∏∞Ï°¥ ÏÉÅÏÑ∏ Î∂ÑÏÑù ÏÑπÏÖòÏù¥ ÏûàÎã§Î©¥ Ï†úÍ±∞
                const existingAnalysis = document.getElementById('inline-detailed-analysis');
                if (existingAnalysis) {
                    existingAnalysis.remove();
                }
                
                // 1Îã®Í≥Ñ: ÏãúÌóòÏùò Î™®Îì† Î¨∏Ï†ú Ï°∞Ìöå (ÏÑ†ÌÉùÏßÄ Ìè¨Ìï®)
                const { data: examQuestions, error: examQuestionsError } = await window.supabaseClient
                    .from('exam_questions')
                    .select(`
                        *,
                        questions (
                            id,
                            title,
                            content,
                            type,
                            explanation,
                            model_answer,
                            choices,
                            question_options (
                                id,
                                content,
                                is_correct,
                                order_index
                            )
                        )
                    `)
                    .eq('exam_id', examId)
                    .order('order_index');
                    
                if (examQuestionsError) throw examQuestionsError;
                
                // 2Îã®Í≥Ñ: ÏÇ¨Ïö©ÏûêÏùò ÎãµÏïà Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                const { data: userSession, error: sessionError } = await window.supabaseClient
                    .from('exam_sessions')
                    .select('id, start_time, submit_time')
                    .eq('exam_id', examId)
                    .eq('employee_id', window.semuApp.currentUser.id)
                    .single();
                    
                if (sessionError) throw sessionError;
                
                const { data: answers, error: answersError } = await window.supabaseClient
                    .from('exam_answers')
                    .select('*')
                    .eq('session_id', userSession.id);
                    
                if (answersError) throw answersError;
                
                // ÎãµÏïàÏùÑ ÏßàÎ¨∏ IDÎ≥ÑÎ°ú Îß§Ìïë
                const answersByQuestion = {};
                answers.forEach(answer => {
                    answersByQuestion[answer.question_id] = answer;
                });
                
                // ÏÑ†ÌÉùÏßÄ Ï†ïÎ≥¥Îäî Ïù¥ÎØ∏ Î¨∏Ï†ú Ï°∞ÌöåÏóê Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏùå (question_options)
                console.log('üîç Ï°∞ÌöåÎêú Î¨∏Ï†ú Îç∞Ïù¥ÌÑ∞:', examQuestions);
                console.log('üîç Ï≤´ Î≤àÏß∏ Î¨∏Ï†ú ÏÉÅÏÑ∏ Íµ¨Ï°∞:', JSON.stringify(examQuestions[0], null, 2));
                console.log('üîç ÌòÑÏû¨ ÏãúÌóòÏóê Ìè¨Ìï®Îêú Î™®Îì† Î¨∏Ï†ú IDÎì§:', examQuestions.map(eq => eq.questions.id));
                
                // Í∞Å Î¨∏Ï†úÏùò ÏÑ†ÌÉùÏßÄ ÌôïÏù∏
                examQuestions.forEach((examQuestion, index) => {
                    const question = examQuestion.questions;
                    const options = question.question_options || [];
                    console.log(`üìù Î¨∏Ï†ú ${index + 1} (${question.id})Ïùò ÏÑ†ÌÉùÏßÄ:`, {
                        count: options.length,
                        type: question.type,
                        options: options
                    });
                });
                
                // ÏÑ†ÌÉùÏßÄ Ï†ïÎ≥¥Î•º ÏßàÎ¨∏Î≥ÑÎ°ú Í∑∏Î£πÌôî (Ïù¥ÎØ∏ Ï°∞ÌöåÎêú Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©)
                const optionsByQuestion = {};
                
                examQuestions.forEach(examQuestion => {
                    const question = examQuestion.questions;
                    const optionsFromTable = question.question_options || [];
                    
                    // Î≥ÄÍ≤Ω: resultsÎäî Ìï≠ÏÉÅ questions.choices Í∏∞Ï§ÄÏúºÎ°ú ÌëúÏãú
                    if (question.choices && Array.isArray(question.choices) && question.choices.length > 0) {
                        optionsByQuestion[question.id] = question.choices.map((choice, index) => ({
                            content: choice.text || choice.content || choice,
                            is_correct: !!(choice.isCorrect || choice.is_correct),
                            order_index: index
                        }));
                        console.log(`‚úÖ Î¨∏Ï†ú ${question.id}: choices ÌïÑÎìúÏóêÏÑú ${question.choices.length}Í∞ú ÏÑ†ÌÉùÏßÄ Î°úÎìúÎê® (Ïö∞ÏÑ† ÏÇ¨Ïö©)`);
                        return;
                    }
                    
                    // choicesÍ∞Ä ÏóÜÏùÑ ÎïåÎßå question_optionsÎ•º ÏÇ¨Ïö©
                    if (optionsFromTable.length > 0) {
                        optionsByQuestion[question.id] = optionsFromTable.sort((a, b) => a.order_index - b.order_index);
                        console.log(`‚úÖ Î¨∏Ï†ú ${question.id}: question_optionsÏóêÏÑú ${optionsFromTable.length}Í∞ú ÏÑ†ÌÉùÏßÄ Î°úÎìúÎê® (ÎåÄÏ≤¥ ÏÇ¨Ïö©)`);
                        return;
                    }
                    
                    // 3Ï∞®: ÏÑ†ÌÉùÏßÄÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞ÏóêÎßå ÏûÑÏãú Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                    console.warn(`‚ö†Ô∏è Î¨∏Ï†ú ${question.id}: ÏÑ†ÌÉùÏßÄ ÏóÜÏùå, ÏûÑÏãú Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±`);
                    console.log(`üîç Î¨∏Ï†ú Íµ¨Ï°∞:`, question);
                    
                    const correctIndex = Math.floor(Math.random() * 4);
                    optionsByQuestion[question.id] = [
                        { 
                            content: 'Î∂ÄÍ∞ÄÍ∞ÄÏπòÏÑ∏Î≤ïÏóê Îî∞Î•∏ ÏùòÎ¨¥ÏÇ¨Ìï≠ÏùÑ Ï§ÄÏàòÌï¥Ïïº ÌïúÎã§', 
                            is_correct: correctIndex === 0, 
                            order_index: 0 
                        },
                        { 
                            content: 'ÏÜåÎìùÏÑ∏Î≤ï Í∑úÏ†ïÏóê Îî∞Îùº Ïã†Í≥†ÎÇ©Î∂ÄÌï¥Ïïº ÌïúÎã§', 
                            is_correct: correctIndex === 1, 
                            order_index: 1 
                        },
                        { 
                            content: 'Î≤ïÏù∏ÏÑ∏Î≤ïÏóê ÏùòÍ±∞ÌïòÏó¨ Ï≤òÎ¶¨Ìï¥Ïïº ÌïúÎã§', 
                            is_correct: correctIndex === 2, 
                            order_index: 2 
                        },
                        { 
                            content: 'Ï°∞ÏÑ∏ÌäπÎ°ÄÏ†úÌïúÎ≤ïÏùò ÌòúÌÉùÏùÑ Î∞õÏùÑ Ïàò ÏûàÎã§', 
                            is_correct: correctIndex === 3, 
                            order_index: 3 
                        }
                    ];
                });
                
                // Ïù∏ÎùºÏù∏ ÏÉÅÏÑ∏ Î∂ÑÏÑù HTML ÏÉùÏÑ±
                const detailedAnalysisHtml = `
                    <div class="detailed-analysis-inline" id="inline-detailed-analysis">
                        <div class="analysis-header">
                            <h3 class="section-title">
                                <i class="fas fa-chart-line"></i>
                                ÏãúÌóò ÏÉÅÏÑ∏ Î∂ÑÏÑù
                            </h3>
                            <div class="analysis-summary-inline">
                                <div class="summary-stats-inline">
                                    <div class="summary-item">
                                        <span class="summary-label">Ï¥ù Î¨∏Ï†ú Ïàò</span>
                                        <span class="summary-value">${examQuestions.length}Í∞ú</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">ÎãµÎ≥Ä ÏôÑÎ£å</span>
                                        <span class="summary-value">${answers.length}Í∞ú</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">ÎØ∏ÎãµÎ≥Ä</span>
                                        <span class="summary-value">${examQuestions.length - answers.length}Í∞ú</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="questions-list-vertical">
                            ${examQuestions.map((examQuestion, index) => {
                                const question = examQuestion.questions;
                                const answer = answersByQuestion[question.id];
                                // üéØ Îã®ÏàúÌôî: ÏõêÎ≥∏ choices Îç∞Ïù¥ÌÑ∞Îßå ÏÇ¨Ïö©
                                const originalChoices = question.choices || question.options || [];
                                
                                return `
                                <div class="question-item-vertical">
                                    <div class="question-number-badge">
                                        <span class="question-num">${index + 1}</span>
                                        <span class="question-type-badge">${getQuestionTypeDisplay(question?.type)}</span>
                                        <span class="question-score-badge">${answer?.points || 0}Ï†ê</span>
                                    </div>
                                    
                                    <div class="question-content-section">
                                        <h4 class="question-title">Î¨∏Ï†ú ${index + 1}</h4>
                                        <div class="question-text">${question?.title || question?.content || 'ÎÇ¥Ïö© ÏóÜÏùå'}</div>
                                    </div>
                                    
                                    ${(() => {
                                        // Í∞ùÍ¥ÄÏãù Î¨∏Ï†úÏùò ÏÑ†ÌÉùÏßÄ ÌëúÏãú
                                                                                    // Ï†ïÎãµ Ïù∏Îç±Ïä§ Ï∞æÍ∏∞ (choices Î∞∞Ïó¥ÏóêÏÑú isCorrect: trueÏù∏ Ìï≠Î™©)
                                            const correctIndex = originalChoices.findIndex(choice => choice.isCorrect === true);
                                            
                                            console.log('üîç ÏõêÎ≥∏ ÏÑ†ÌÉùÏßÄ ÌëúÏãú:', {
                                                questionId: question.id,
                                                type: question?.type,
                                                choicesCount: originalChoices.length,
                                                userAnswer: answer?.answer,
                                                correctIndex: correctIndex,
                                                isUserCorrect: answer?.is_correct
                                            });
                                        
                                        // Í∞ùÍ¥ÄÏãù Î¨∏Ï†úÏùò ÏÑ†ÌÉùÏßÄ ÌëúÏãú (ÏõêÎ≥∏ ÏàúÏÑú)
                                        if ((question.type === 'multiple_choice' || question.type === 'Í∞ùÍ¥ÄÏãù') && originalChoices.length > 0) {
                                            return `
                                                <div class="choices-section">
                                                    <h5>ÏÑ†ÌÉùÏßÄ</h5>
                                                    <div class="choices-list">
                                                        ${originalChoices.map((choice, choiceIndex) => {
                                                            // Ï†ÄÏû•Îêú answerÎäî ÏõêÎ≥∏ Ïù∏Îç±Ïä§ Ïà´Ïûê
                                                            const userAnswerIndex = parseInt(answer?.answer || '-1');
                                                            const isCorrect = choiceIndex === correctIndex;
                                                            const isUserSelected = choiceIndex === userAnswerIndex;
                                                            
                                                            let choiceClass = 'choice-item-vertical';
                                                            let choiceIcon = '';
                                                            let choiceLabel = '';
                                                            let choiceStyle = '';
                                                            const isUserCorrect = answer?.is_correct;
                                                            
                                                            if (isCorrect && isUserSelected && isUserCorrect) {
                                                                // Ï†ïÎãµÏùÑ ÎßûÏ∑ÑÏùÑ Îïå - ÌååÎûÄÏÉâ
                                                                choiceClass += ' choice-correct-selected';
                                                                choiceIcon = '<i class="fas fa-check-circle"></i>';
                                                                choiceLabel = '<span class="choice-status correct-selected">ÎÇ¥ ÏÑ†ÌÉù ‚úì</span>';
                                                                choiceStyle = 'background-color: #e3f2fd !important; border-color: #2196f3 !important; color: #1976d2 !important;';
                                                            } else if (isCorrect) {
                                                                // Ï†ïÎãµ (ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÑ†ÌÉùÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞) - ÎÖπÏÉâ
                                                                choiceClass += ' choice-correct';
                                                                choiceIcon = '<i class="fas fa-check-circle"></i>';
                                                                choiceLabel = '<span class="choice-status correct">Ï†ïÎãµ ‚úì</span>';
                                                                choiceStyle = 'background-color: #e8f5e8 !important; border-color: #4caf50 !important; color: #2e7d32 !important;';
                                                            } else if (isUserSelected && !isUserCorrect) {
                                                                // ÏÇ¨Ïö©ÏûêÍ∞Ä ÌãÄÎ¶∞ ÎãµÏùÑ ÏÑ†ÌÉùÌïú Í≤ΩÏö∞ - Îπ®Í∞ÑÏÉâ
                                                                choiceClass += ' choice-user-wrong';
                                                                choiceIcon = '<i class="fas fa-times-circle"></i>';
                                                                choiceLabel = '<span class="choice-status user-wrong">ÎÇ¥ ÏÑ†ÌÉù ‚úó</span>';
                                                                choiceStyle = 'background-color: #ffebee !important; border-color: #f44336 !important; color: #c62828 !important;';
                                                            } else {
                                                                // ÏùºÎ∞ò ÏÑ†ÌÉùÏßÄ
                                                                choiceIcon = '<i class="fas fa-circle"></i>';
                                                                choiceStyle = 'background-color: #f8f9fa; border-color: #dee2e6; color: #495057;';
                                                            }
                                                            
                                                            return `
                                                                <div class="${choiceClass}" style="${choiceStyle}">
                                                                    <div class="choice-header">
                                                                        ${choiceIcon}
                                                                        <span class="choice-letter">${String.fromCharCode(65 + choiceIndex)}</span>
                                                                        ${choiceLabel}
                                                                    </div>
                                                                    <div class="choice-content">${choice.text || choice.content || choice}</div>
                                                                </div>
                                                            `;
                                                        }).join('')}
                                                    </div>
                                                </div>
                                            `;
                                        }
                                        return '';
                                    })()}
                                    
${(() => {
                                        // Í∞ùÍ¥ÄÏãù Î¨∏Ï†úÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞ÏóêÎßå 'ÎÇ¥ ÎãµÏïà' ÏÑπÏÖòÏùÑ ÌëúÏãú
                                        if (question?.type !== 'multiple_choice' && question?.type !== 'Í∞ùÍ¥ÄÏãù') {
                                            return `
                                    <div class="answer-section">
                                        <h5>ÎÇ¥ ÎãµÏïà</h5>
                                        <div class="my-answer-box" style="${answer?.is_correct ? 'background-color: #e3f2fd; border-color: #2196f3; color: #1976d2;' : 'background-color: #ffebee; border-color: #f44336; color: #c62828;'}">
                                            ${(() => {
                                                if (!answer) return '<span class="no-answer">ÎØ∏ÎãµÎ≥Ä</span>';
                                                return answer.answer || 'ÎãµÏïà ÏóÜÏùå';
                                            })()}
                                        </div>
                                    </div>`;
                                        }
                                        return '';
                                    })()}
                                    
                                    ${question?.explanation ? `
                                        <div class="explanation-section">
                                            <h5>üìñ Î¨∏Ï†ú Ìï¥ÏÑ§</h5>
                                            <div class="explanation-box">
                                                ${question.explanation}
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${question?.model_answer ? `
                                        <div class="model-answer-section">
                                            <h5>Î™®Î≤îÎãµÏïà</h5>
                                            <div class="model-answer-box">${question.model_answer}</div>
                                        </div>
                                    ` : ''}
                                    
                                    ${answer?.feedback ? `
                                        <div class="feedback-section">
                                            <h5>${answer.ai_graded ? 'ü§ñ AI Ï±ÑÏ†ê ÌîºÎìúÎ∞±' : 'üë®‚Äçüè´ ÍµêÏàòÏûê ÌîºÎìúÎ∞±'}</h5>
                                            <div class="feedback-box">
                                                <div class="feedback-score-info">
                                                    <strong>Ï†êÏàò: ${answer.points || 0}Ï†ê</strong>
                                                    ${answer.ai_graded ? '<span class="ai-badge">AI Ï±ÑÏ†ê</span>' : ''}
                                                </div>
                                                <div class="feedback-text">${answer.feedback}</div>
                                                ${answer.ai_graded && answer.ai_graded_at ? `
                                                    <small class="feedback-time">AI Ï±ÑÏ†ê ÏãúÍ∞Ñ: ${new Date(answer.ai_graded_at).toLocaleString('ko-KR')}</small>
                                                ` : ''}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="analysis-actions">
                            <button class="btn btn-secondary" onclick="hideDetailedAnalysis()">
                                <i class="fas fa-times"></i> ÏÉÅÏÑ∏ Î∂ÑÏÑù Îã´Í∏∞
                            </button>
                            <button class="btn btn-primary" onclick="exportAnalysisReport()">
                                <i class="fas fa-download"></i> Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏ Îã§Ïö¥Î°úÎìú
                            </button>
                        </div>
                    </div>
                `;
                
                // Ï∂îÏ≤úÏÇ¨Ìï≠ ÏÑπÏÖò Îí§Ïóê ÏÉÅÏÑ∏ Î∂ÑÏÑù ÏÇΩÏûÖ
                const recommendationsSection = document.querySelector('.recommendations');
                if (recommendationsSection) {
                    recommendationsSection.insertAdjacentHTML('afterend', detailedAnalysisHtml);
                    
                    // ÏÉÅÏÑ∏ Î∂ÑÏÑù ÏÑπÏÖòÏúºÎ°ú Î∂ÄÎìúÎüΩÍ≤å Ïä§ÌÅ¨Î°§
                    const analysisSection = document.getElementById('inline-detailed-analysis');
                    if (analysisSection) {
                        analysisSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
                
                console.log('‚úÖ Ïù∏ÎùºÏù∏ ÏÉÅÏÑ∏ Î∂ÑÏÑù ÌëúÏãú ÏôÑÎ£å. Î¨∏Ï†ú Í∞úÏàò:', examQuestions.length);
                console.log('üìã Î™®Îì† Î¨∏Ï†ú Îç∞Ïù¥ÌÑ∞:', examQuestions.map(eq => ({
                    questionId: eq.questions.id,
                    type: eq.questions.type,
                    title: eq.questions.title,
                    content: eq.questions.content
                })));
                
                // ÌòÑÏû¨ ÏãúÌóòÏùò Î¨∏Ï†ú ÌÉÄÏûÖ Î∂ÑÌè¨ ÌôïÏù∏
                const typeCount = {};
                examQuestions.forEach(eq => {
                    const type = eq.questions.type;
                    typeCount[type] = (typeCount[type] || 0) + 1;
                });
                console.log('üìä Î¨∏Ï†ú ÌÉÄÏûÖ Î∂ÑÌè¨:', typeCount);
                console.log('üìã ÏÑ†ÌÉùÏßÄ Í∑∏Î£πÌôî Îç∞Ïù¥ÌÑ∞:', optionsByQuestion);
                console.log('üìã Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏÑ†ÌÉùÏßÄ ÏÇ¨Ïö©Îê®!');
                
            } catch (error) {
                console.error('Ïù∏ÎùºÏù∏ ÏÉÅÏÑ∏ Î∂ÑÏÑù ÏÉùÏÑ± Ïã§Ìå®:', error);
                showAlert('ÏÉÅÏÑ∏ Î∂ÑÏÑùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            }
        }
        
        // ÏÉÅÏÑ∏ Î∂ÑÏÑù Î™®Îã¨ ÌëúÏãú
        async function showDetailedAnalysisModal(examId) {
            try {
                // 1Îã®Í≥Ñ: ÏãúÌóòÏùò Î™®Îì† Î¨∏Ï†ú Ï°∞Ìöå
                const { data: examQuestions, error: examQuestionsError } = await window.supabaseClient
                    .from('exam_questions')
                    .select(`
                        *,
                        questions (
                            id,
                            title,
                            content,
                            type,
                            explanation,
                            model_answer
                        )
                    `)
                    .eq('exam_id', examId)
                    .order('order_index');
                    
                if (examQuestionsError) throw examQuestionsError;
                
                // 2Îã®Í≥Ñ: ÏÇ¨Ïö©ÏûêÏùò ÎãµÏïà Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                const { data: userSession, error: sessionError } = await window.supabaseClient
                    .from('exam_sessions')
                    .select('id, start_time, submit_time')
                    .eq('exam_id', examId)
                    .eq('employee_id', window.semuApp.currentUser.id)
                    .single();
                    
                if (sessionError) throw sessionError;
                
                const { data: answers, error: answersError } = await window.supabaseClient
                    .from('exam_answers')
                    .select('*')
                    .eq('session_id', userSession.id);
                    
                if (answersError) throw answersError;
                
                // ÎãµÏïàÏùÑ ÏßàÎ¨∏ IDÎ≥ÑÎ°ú Îß§Ìïë
                const answersByQuestion = {};
                answers.forEach(answer => {
                    answersByQuestion[answer.question_id] = answer;
                });
                
                // ÏÑ†ÌÉùÏßÄ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                const questionIds = examQuestions.map(eq => eq.questions.id);
                const { data: questionOptions, error: optionsError } = await window.supabaseClient
                    .from('question_options')
                    .select('*')
                    .in('question_id', questionIds)
                    .order('order_index');
                
                if (optionsError) throw optionsError;
                
                if (!examQuestions || examQuestions.length === 0) {
                    showAlert('ÏãúÌóò Î¨∏Ï†ú Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                    return;
                }
                
                console.log('üìã Î™®Îã¨ ÌëúÏãúÌï† Î¨∏Ï†ú Ïàò:', examQuestions.length);
                console.log('üìã ÎãµÏïà Ï†ïÎ≥¥:', answers.length, 'Í∞ú');
                
                // ÏÑ†ÌÉùÏßÄ Ï†ïÎ≥¥Î•º ÏßàÎ¨∏Î≥ÑÎ°ú Í∑∏Î£πÌôî
                const optionsByQuestion = {};
                questionOptions.forEach(option => {
                    if (!optionsByQuestion[option.question_id]) {
                        optionsByQuestion[option.question_id] = [];
                    }
                    optionsByQuestion[option.question_id].push(option);
                });
                
                // Î™®Îã¨ HTML ÏÉùÏÑ±
                const modalHtml = `
                    <div class="modal-overlay" id="detailed-analysis-modal">
                        <div class="modal-content" style="max-width: 1000px; max-height: 90vh;">
                            <div class="modal-header">
                                <h3><i class="fas fa-chart-line"></i> ÏãúÌóò ÏÉÅÏÑ∏ Î∂ÑÏÑù</h3>
                                <button class="modal-close" onclick="closeDetailedAnalysisModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="analysis-summary">
                                    <h4>üìä Ï†ÑÏ≤¥ ÏöîÏïΩ</h4>
                                    <div class="summary-stats">
                                        <div class="stat-item">
                                            <span class="stat-label">Ï¥ù Î¨∏Ï†ú Ïàò</span>
                                            <span class="stat-value">${examQuestions.length}Í∞ú</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">ÎãµÎ≥Ä ÏôÑÎ£å</span>
                                            <span class="stat-value">${answers.length}Í∞ú</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">ÎØ∏ÎãµÎ≥Ä</span>
                                            <span class="stat-value">${examQuestions.length - answers.length}Í∞ú</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="questions-analysis">
                                    <h4>üìù Î¨∏Ìï≠Î≥Ñ ÏÉÅÏÑ∏ Î∂ÑÏÑù</h4>
                                    ${examQuestions.map((examQuestion, index) => {
                                        const question = examQuestion.questions;
                                        const answer = answersByQuestion[question.id];
                                        return `
                                        <div class="question-analysis-item">
                                            <div class="question-header">
                                                <h5>${index + 1}Î≤à Î¨∏Ï†ú</h5>
                                                <div class="question-meta">
                                                    <span class="question-type">${getQuestionTypeDisplay(question?.type)}</span>
                                                    <span class="question-score">${answer?.points || 0}Ï†ê</span>
                                                </div>
                                            </div>
                                            
                                            <div class="question-content">
                                                <h6>Î¨∏Ï†ú ÎÇ¥Ïö©</h6>
                                                <p>${question?.title || question?.content || 'ÎÇ¥Ïö© ÏóÜÏùå'}</p>
                                            </div>
                                            
                                            <div class="answer-content">
                                                <h6>ÎÇ¥ ÎãµÏïà</h6>
                                                <div class="answer-text">${(() => {
                                                    if (!answer) return 'ÎØ∏ÎãµÎ≥Ä';
                                                    const questionOptionsForThis = optionsByQuestion[question.id] || [];
                                                    if ((question?.type === 'multiple_choice' || question?.type === 'Í∞ùÍ¥ÄÏãù') && questionOptionsForThis.length > 0) {
                                                        const userAnswerIndex = parseInt(answer.answer || '0');
                                                        const userSelectedOption = questionOptionsForThis[userAnswerIndex];
                                                        if (userSelectedOption) {
                                                            return `${String.fromCharCode(65 + userAnswerIndex)}. ${userSelectedOption.content}`;
                                                        }
                                                    }
                                                    return answer.answer || 'ÎãµÏïà ÏóÜÏùå';
                                                })()}</div>
                                                
                                                ${(() => {
                                                    if (!answer) return '';
                                                    const questionOptionsForThis = optionsByQuestion[question.id] || [];
                                                    if ((question?.type === 'multiple_choice' || question?.type === 'Í∞ùÍ¥ÄÏãù') && questionOptionsForThis.length > 0) {
                                                        return `
                                                            <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                                                                <div style="font-weight: 600; margin-bottom: 10px; color: #666;">Î™®Îì† ÏÑ†ÌÉùÏßÄ:</div>
                                                                ${questionOptionsForThis.map((option, choiceIndex) => {
                                                                    const isCorrect = option.is_correct;
                                                                    const isUserSelected = choiceIndex === parseInt(answer.answer || '0');
                                                                    
                                                                    let textColor = '#333';
                                                                    if (isCorrect && isUserSelected) {
                                                                        // Ï†ïÎãµÏùÑ ÎßûÏ∂ò Í≤ΩÏö∞ - ÌååÎûÄÏÉâ
                                                                        textColor = '#007bff';
                                                                    } else if (isCorrect) {
                                                                        // Ï†ïÎãµÏù¥ÏßÄÎßå ÏÑ†ÌÉùÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ - Ï¥àÎ°ùÏÉâ
                                                                        textColor = '#28a745';
                                                                    } else if (isUserSelected) {
                                                                        // ÌãÄÎ¶∞ ÏÑ†ÌÉù - Îπ®Í∞ÑÏÉâ
                                                                        textColor = '#dc3545';
                                                                    }
                                                                    
                                                                    return `
                                                                        <div style="margin: 5px 0; color: ${textColor}; font-weight: ${(isCorrect || isUserSelected) ? '600' : '400'};">
                                                                            ${String.fromCharCode(65 + choiceIndex).toLowerCase()}. ${option.content}
                                                                        </div>
                                                                    `;
                                                                }).join('')}
                                                            </div>
                                                        `;
                                                    }
                                                    return '';
                                                })()}</div>
                                                
                                                ${(() => {
                                                    const questionOptionsForThis = optionsByQuestion[answer.question_id] || [];
                                                    if ((answer.questions?.type === 'multiple_choice' || answer.questions?.type === 'Í∞ùÍ¥ÄÏãù') && questionOptionsForThis.length > 0) {
                                                        return `
                                                            <div style="margin-top: 15px;">
                                                                <h6>ÏÑ†ÌÉùÏßÄ Î∂ÑÏÑù</h6>
                                                                <div class="choices-analysis">
                                                                    ${questionOptionsForThis.map((option, choiceIndex) => {
                                                                        const isCorrect = option.is_correct;
                                                                        const isUserSelected = choiceIndex === parseInt(answer.answer || '0');
                                                                        
                                                                        let style = 'padding: 10px; margin: 5px 0; border-radius: 6px; border: 1px solid ';
                                                                        let icon = '';
                                                                        let label = '';
                                                                        
                                                                        if (isCorrect && isUserSelected) {
                                                                            // Ï†ïÎãµÏùÑ ÎßûÏ∂ò Í≤ΩÏö∞ - ÌååÎûÄÏÉâ
                                                                            style += '#007bff; background: #e3f2fd;';
                                                                            icon = '<i class="fas fa-check-circle" style="color: #007bff; margin-right: 8px;"></i>';
                                                                            label = '<span style="color: #007bff; font-weight: 600; margin-left: 10px;">(Ï†ïÎãµ ‚úì)</span>';
                                                                        } else if (isCorrect) {
                                                                            // Ï†ïÎãµÏù¥ÏßÄÎßå ÏÑ†ÌÉùÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ - Ï¥àÎ°ùÏÉâ
                                                                            style += '#28a745; background: #f8fff9;';
                                                                            icon = '<i class="fas fa-check" style="color: #28a745; margin-right: 8px;"></i>';
                                                                            label = '<span style="color: #28a745; font-weight: 600; margin-left: 10px;">(Ï†ïÎãµ)</span>';
                                                                        } else if (isUserSelected) {
                                                                            // ÌãÄÎ¶∞ ÏÑ†ÌÉù - Îπ®Í∞ÑÏÉâ
                                                                            style += '#dc3545; background: #fff8f8;';
                                                                            icon = '<i class="fas fa-times-circle" style="color: #dc3545; margin-right: 8px;"></i>';
                                                                            label = '<span style="color: #dc3545; font-weight: 600; margin-left: 10px;">(ÎÇ¥ ÏÑ†ÌÉù ‚úó)</span>';
                                                                        } else {
                                                                            // ÏùºÎ∞ò ÏÑ†ÌÉùÏßÄ - ÌöåÏÉâ
                                                                            style += '#e9ecef; background: #f8f9fa;';
                                                                            icon = '<i class="fas fa-circle" style="color: #dee2e6; margin-right: 8px;"></i>';
                                                                        }
                                                                        
                                                                        return `
                                                                            <div style="${style}">
                                                                                ${icon}${String.fromCharCode(65 + choiceIndex)}. ${option.content}${label}
                                                                            </div>
                                                                        `;
                                                                    }).join('')}
                                                                </div>
                                                            </div>
                                                        `;
                                                    }
                                                    return '';
                                                })()}
                                            </div>
                                            
                                            ${question?.model_answer ? `
                                                <div class="model-answer">
                                                    <h6>Î™®Î≤îÎãµÏïà</h6>
                                                    <div class="model-answer-text">${question.model_answer}</div>
                                                </div>
                                            ` : ''}
                                            
                                            ${answer?.feedback ? `
                                                <div class="grading-feedback">
                                                    <h6>${answer.ai_graded ? 'ü§ñ AI Ï±ÑÏ†ê ÌîºÎìúÎ∞±' : 'üë®‚Äçüè´ ÍµêÏàòÏûê ÌîºÎìúÎ∞±'}</h6>
                                                    <div class="feedback-content">
                                                        <div class="feedback-score">
                                                            <strong>Ï†êÏàò: ${answer.points || 0}Ï†ê</strong>
                                                            ${answer.ai_graded ? '<span class="ai-badge">AI Ï±ÑÏ†ê</span>' : ''}
                                                        </div>
                                                        <div class="feedback-text">${answer.feedback}</div>
                                                        ${answer.ai_graded && answer.ai_graded_at ? `
                                                            <small class="feedback-time">AI Ï±ÑÏ†ê ÏãúÍ∞Ñ: ${new Date(answer.ai_graded_at).toLocaleString('ko-KR')}</small>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            ` : ''}
                                            
                                            ${userSession ? `
                                                <div class="answer-timing">
                                                    <small class="text-muted">
                                                        ÏÜåÏöîÏãúÍ∞Ñ: ${calculateTimeSpent(userSession.start_time, userSession.submit_time)}
                                                    </small>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                    }).join('')}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="closeDetailedAnalysisModal()">Îã´Í∏∞</button>
                                <button class="btn btn-primary" onclick="exportAnalysisReport()">
                                    <i class="fas fa-download"></i> Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏ Îã§Ïö¥Î°úÎìú
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Í∏∞Ï°¥ Î™®Îã¨ Ï†úÍ±∞ ÌõÑ ÏÉà Î™®Îã¨ Ï∂îÍ∞Ä
                const existingModal = document.getElementById('detailed-analysis-modal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Î™®Îã¨ ÌëúÏãú
                const modal = document.getElementById('detailed-analysis-modal');
                modal.style.display = 'flex';
                
                console.log('üìã Î™®Îã¨ HTML ÏÇΩÏûÖ ÏôÑÎ£å. Î¨∏Ï†ú Í∞úÏàò ÌôïÏù∏:', modal.querySelectorAll('.question-analysis-item').length);
                
            } catch (error) {
                console.error('ÏÉÅÏÑ∏ Î∂ÑÏÑù Î™®Îã¨ ÏÉùÏÑ± Ïã§Ìå®:', error);
                showAlert('ÏÉÅÏÑ∏ Î∂ÑÏÑùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            }
        }
        
        // Ïù∏ÎùºÏù∏ ÏÉÅÏÑ∏ Î∂ÑÏÑù Ïà®Í∏∞Í∏∞
        function hideDetailedAnalysis() {
            const analysisSection = document.getElementById('inline-detailed-analysis');
            if (analysisSection) {
                analysisSection.remove();
            }
        }
        
        // ÏÉÅÏÑ∏ Î∂ÑÏÑù Î™®Îã¨ Îã´Í∏∞
        function closeDetailedAnalysisModal() {
            const modal = document.getElementById('detailed-analysis-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏ Îã§Ïö¥Î°úÎìú
        function exportAnalysisReport() {
            // Í∞ÑÎã®Ìïú ÌÖçÏä§Ìä∏ Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±
            const urlParams = new URLSearchParams(window.location.search);
            const examId = urlParams.get('exam');
            const score = window.resultsPage?.score || 0;
            const totalQuestions = window.resultsPage?.totalQuestions || 0;
            
            let report = `ÏãúÌóò Í≤∞Í≥º Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏\n`;
            report += `========================\n\n`;
            report += `ÏãúÌóò ID: ${examId}\n`;
            report += `Ï¥ùÏ†ê: ${score}/${totalQuestions} (${Math.round((score/totalQuestions)*100)}%)\n`;
            report += `ÏÉùÏÑ±Ïùº: ${new Date().toLocaleString('ko-KR')}\n\n`;
            
            // Îã§Ïö¥Î°úÎìú
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ÏãúÌóòÍ≤∞Í≥º_Î∂ÑÏÑù_${examId}_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // Î¨∏Ï†ú Ïú†Ìòï ÌëúÏãú
        function getQuestionTypeDisplay(type) {
            const typeMap = {
                'multiple_choice': 'Í∞ùÍ¥ÄÏãù',
                'subjective': 'Ï£ºÍ¥ÄÏãù',
                'essay': 'ÏÑúÏà†Ìòï'
            };
            return typeMap[type] || type || 'Í∏∞ÌÉÄ';
        }
        
        // ÏÜåÏöî ÏãúÍ∞Ñ Í≥ÑÏÇ∞
        function calculateTimeSpent(startTime, submitTime) {
            if (!startTime || !submitTime) return 'Ïïå Ïàò ÏóÜÏùå';
            
            const start = new Date(startTime);
            const submit = new Date(submitTime);
            const diffMs = submit - start;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return '1Î∂Ñ ÎØ∏Îßå';
            if (diffMins < 60) return `${diffMins}Î∂Ñ`;
            
            const hours = Math.floor(diffMins / 60);
            const mins = diffMins % 60;
            return `${hours}ÏãúÍ∞Ñ ${mins}Î∂Ñ`;
        }
    </script>
</body>
</html>

