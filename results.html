<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œí—˜ ê²°ê³¼ - ì„¸ë¬´ì¸ì‚¬ì´ë“œ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/common.css">
    <style>
        .results-container {
            display: flex;
            flex-direction: column;
            min-height: 600px;
        }

        .main-content {
            flex: 1;
            padding: 30px;
            background: #f8f9fa;
        }

        .result-header {
            background: white;
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .result-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .result-icon.excellent {
            color: #28a745;
        }

        .result-icon.good {
            color: #17a2b8;
        }

        .result-icon.average {
            color: #ffc107;
        }

        .result-icon.poor {
            color: #dc3545;
        }

        .result-title {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--dark-gray);
        }

        .result-subtitle {
            color: var(--medium-gray);
            font-size: 1.1rem;
            margin-bottom: 30px;
        }

        .score-display {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .score-number {
            font-size: 4rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
        }

        .score-label {
            text-align: center;
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--medium-gray);
            font-size: 0.9rem;
        }

        .detailed-results {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .section-title {
            font-size: 1.3rem;
            color: var(--dark-gray);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .question-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 2px solid #f8f9fa;
        }

        .question-result.correct {
            border-color: #28a745;
            background: #f8fff9;
        }

        .question-result.incorrect {
            border-color: #dc3545;
            background: #fff8f8;
        }

        .question-info {
            flex: 1;
        }

        .question-number {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .question-preview {
            color: var(--medium-gray);
            font-size: 0.9rem;
        }

        .question-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .status-icon {
            font-size: 1.2rem;
        }

        .status-icon.correct {
            color: #28a745;
        }

        .status-icon.incorrect {
            color: #dc3545;
        }

        .recommendations {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .recommendations h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin: 10px 0;
        }

        .recommendation-icon {
            color: #2196f3;
            margin-top: 2px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .progress-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 10px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            position: relative;
            background: conic-gradient(var(--primary-color) 0deg, #e9ecef 0deg);
        }

        .circle-content {
            background: white;
            border-radius: 50%;
            width: 110px;
            height: 110px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .circle-score {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .circle-label {
            font-size: 0.8rem;
            color: var(--medium-gray);
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .result-header {
                padding: 30px 20px;
            }
            
            .score-number {
                font-size: 3rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            
            .question-result {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }
        
        /* ìƒì„¸ ë¶„ì„ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            padding: 25px 30px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: white;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }
        
        .modal-close:hover {
            opacity: 1;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .modal-footer {
            padding: 25px 30px;
            border-top: 2px solid #e9ecef;
            border-radius: 0 0 15px 15px;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            background: #f8f9fa;
        }
        
        /* ë¶„ì„ ìš”ì•½ ìŠ¤íƒ€ì¼ */
        .analysis-summary {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid var(--primary-color);
        }
        
        .analysis-summary h4 {
            margin: 0 0 20px 0;
            color: var(--primary-color);
            font-size: 1.3rem;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }
        
        .summary-stats .stat-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }
        
        .summary-stats .stat-label {
            display: block;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
        }
        
        .summary-stats .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        /* ë¬¸í•­ë³„ ë¶„ì„ ìŠ¤íƒ€ì¼ */
        .questions-analysis h4 {
            margin: 0 0 25px 0;
            color: var(--dark-gray);
            font-size: 1.3rem;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
        }
        
        .question-analysis-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .question-header h5 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.2rem;
        }
        
        .question-meta {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .question-type {
            background: var(--primary-color);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .question-score {
            background: #28a745;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
        }
        
        .question-content,
        .answer-content,
        .model-answer {
            margin-bottom: 20px;
        }
        
        .question-content h6,
        .answer-content h6,
        .model-answer h6 {
            margin: 0 0 10px 0;
            color: var(--dark-gray);
            font-size: 1rem;
            font-weight: 600;
        }
        
        .answer-text,
        .model-answer-text {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        /* AI ì±„ì  í”¼ë“œë°± ìŠ¤íƒ€ì¼ */
        .grading-feedback {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            border: 1px solid #bbdefb;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .grading-feedback h6 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .feedback-content {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e1f5fe;
        }
        
        .feedback-score {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e1f5fe;
        }
        
        .ai-badge {
            background: #ff6b35;
            color:  white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .feedback-text {
            line-height: 1.6;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }
        
        .feedback-time {
            color: #666;
            font-style: italic;
        }
        
        .answer-timing {
            margin-top: 15px;
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="container">
            <div class="results-container">
                <!-- í—¤ë” -->
                <div class="header">
                    <div class="logo">
                        <i class="fas fa-graduation-cap"></i>
                        <h2>ì„¸ë¬´ì¸ì‚¬ì´ë“œ</h2>
                    </div>
                    <div class="nav-menu">
                        <a href="./dashboard.html" class="nav-link">
                            <i class="fas fa-home"></i> ëŒ€ì‹œë³´ë“œ
                        </a>
                        <a href="./exam.html" class="nav-link">
                            <i class="fas fa-clipboard-list"></i> ì‹œí—˜
                        </a>
                        <a href="./results.html" class="nav-link active">
                            <i class="fas fa-chart-bar"></i> ê²°ê³¼
                        </a>
                        <a href="./profile.html" class="nav-link">
                            <i class="fas fa-user"></i> í”„ë¡œí•„
                        </a>
                    </div>
                    <div class="user-menu">
                        <span class="user-name" id="userName">ì‚¬ìš©ìë‹˜</span>
                        <button class="btn btn-outline btn-small logout-btn">
                            <i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ
                        </button>
                    </div>
                </div>

                <!-- ë©”ì¸ ì½˜í…ì¸  -->
                <div class="main-content">
                    <!-- ê²°ê³¼ í—¤ë” -->
                    <div class="result-header">
                        <div class="result-icon" id="resultIcon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <h1 class="result-title" id="resultTitle">ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h1>
                        <p class="result-subtitle" id="resultSubtitle">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
                        
                        <div class="score-display">
                            <div class="score-number" id="scoreNumber">...</div>
                            <div class="score-label">ì </div>
                        </div>
                    </div>

                    <!-- ì„±ê³¼ ì°¨íŠ¸ -->
                    <div class="chart-container">
                        <h3 class="section-title">
                            <i class="fas fa-chart-pie"></i>
                            ì„±ê³¼ ìš”ì•½
                        </h3>
                        <div class="progress-circle" id="progressCircle">
                            <div class="circle-content">
                                <div class="circle-score" id="circleScore">...</div>
                                <div class="circle-label">ì </div>
                            </div>
                        </div>
                        <p style="color: var(--medium-gray);">ì „ì²´ í‰ê· ë³´ë‹¤ <strong id="comparison">-</strong></p>
                    </div>

                    <!-- í†µê³„ -->
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-icon" style="color: #28a745;">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-value" id="correctCount">-</div>
                            <div class="stat-label">ì •ë‹µ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon" style="color: #dc3545;">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div class="stat-value" id="incorrectCount">-</div>
                            <div class="stat-label">ì˜¤ë‹µ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon" style="color: #17a2b8;">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-value" id="timeUsed">-</div>
                            <div class="stat-label">ì†Œìš” ì‹œê°„(ë¶„)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon" style="color: #ffc107;">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="stat-value" id="accuracy">-</div>
                            <div class="stat-label">ì •ë‹µë¥ (%)</div>
                        </div>
                    </div>

                    <!-- ìƒì„¸ ê²°ê³¼ -->
                    <div class="detailed-results">
                        <h3 class="section-title">
                            <i class="fas fa-list"></i>
                            ë¬¸í•­ë³„ ê²°ê³¼
                        </h3>
                        <div id="questionResults">
                            <!-- ë¬¸í•­ë³„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>

                    <!-- ì¶”ì²œì‚¬í•­ -->
                    <div class="recommendations">
                        <h3>
                            <i class="fas fa-lightbulb"></i>
                            í•™ìŠµ ì¶”ì²œì‚¬í•­
                        </h3>
                        <div id="recommendationsList">
                            <!-- ì¶”ì²œì‚¬í•­ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>

                    <!-- ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
                    <div class="action-buttons">
                        <!-- ì¬ì‘ì‹œ ë²„íŠ¼ ë¹„í™œì„±í™” -->
                        <!-- <button class="btn btn-primary btn-large" onclick="retakeExam()">
                            <i class="fas fa-redo"></i> ë‹¤ì‹œ ì‘ì‹œ
                        </button> -->
                        <button class="btn btn-secondary btn-large" onclick="viewDetails()">
                            <i class="fas fa-search"></i> ìƒì„¸ ë¶„ì„
                        </button>
                        <a href="./dashboard.html" class="btn btn-outline btn-large">
                            <i class="fas fa-home"></i> ëŒ€ì‹œë³´ë“œë¡œ
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    
    <!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="./assets/js/common.js"></script>
    
    <script>
        // ê²°ê³¼ í˜ì´ì§€ ì „ìš© ìŠ¤í¬ë¦½íŠ¸
        class ResultsPage {
            constructor() {
                this.score = null;
                this.totalQuestions = null;
                this.examData = null;
                this.isDataLoaded = false;
                
                this.init();
            }

            async waitForAuthAndSession() {
                console.log('â³ ì¸ì¦ ë° ì„¸ì…˜ ë³µì› ëŒ€ê¸° ì¤‘...');
                
                let attempts = 0;
                const maxAttempts = 100; // 10ì´ˆ ëŒ€ê¸° (100 * 100ms)
                
                while (attempts < maxAttempts) {
                    // semuAppê³¼ supabaseClientê°€ ëª¨ë‘ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
                    if (window.semuApp && window.supabaseClient) {
                        // ì„¸ì…˜ ë³µì›ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
                        if (window.semuApp.currentUser) {
                            console.log('âœ… ì‚¬ìš©ì ì¸ì¦ í™•ì¸ë¨:', window.semuApp.currentUser.email);
                            return;
                        }
                        
                        // ì„¸ì…˜ ë³µì›ì„ ìœ„í•œ ì¶”ê°€ ëŒ€ê¸°
                        if (attempts > 50) {
                            console.log('â³ ì„¸ì…˜ ë³µì› ì¶”ê°€ ëŒ€ê¸° ì¤‘...', attempts);
                        }
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                console.warn('âš ï¸ ì„¸ì…˜ ë³µì› íƒ€ì„ì•„ì›ƒ');
            }

            async init() {
                console.log('ğŸ“Š ê²°ê³¼ í˜ì´ì§€ ì´ˆê¸°í™”');
                
                // ì„¸ì…˜ ë³µì› ëŒ€ê¸° ë° ì¸ì¦ í™•ì¸
                await this.waitForAuthAndSession();
                
                if (!window.semuApp.currentUser) {
                    console.warn('âš ï¸ ì¸ì¦ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™');
                    window.location.href = './login.html';
                    return;
                }

                // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
                this.updateUserInfo();
                
                // ë¡œë”© ìƒíƒœ í‘œì‹œ
                this.showLoadingState();
                
                // URL íŒŒë¼ë¯¸í„°ì—ì„œ ê²°ê³¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                await this.loadResultData();
                
                // ë¡œë”© ì™„ë£Œ í›„ UI ì—…ë°ì´íŠ¸
                this.hideLoadingState();
                this.updateUI();
            }

            updateUserInfo() {
                const user = window.semuApp.currentUser;
                if (user) {
                    document.getElementById('userName').textContent = user.name + 'ë‹˜';
                }
            }

            showLoadingState() {
                console.log('â³ ê²°ê³¼ ë¡œë”© ìƒíƒœ í‘œì‹œ (HTMLì— ì´ë¯¸ ì„¤ì •ë¨)');
                
                // HTMLì—ì„œ ì´ë¯¸ ë¡œë”© ìƒíƒœë¡œ ì„¤ì •ë˜ì–´ ìˆìœ¼ë¯€ë¡œ 
                // ì¶”ê°€ì ì¸ DOM ì¡°ì‘ ì—†ì´ ë¡œê·¸ë§Œ ì¶œë ¥
            }

            hideLoadingState() {
                console.log('âœ… ê²°ê³¼ ë¡œë”© ì™„ë£Œ');
                // ì‹¤ì œ UI ì—…ë°ì´íŠ¸ëŠ” updateUI()ì—ì„œ ì²˜ë¦¬ë¨
            }

            async loadResultData() {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const examId = urlParams.get('exam');
                    const score = parseInt(urlParams.get('score')) || 0;
                    const totalQuestions = parseInt(urlParams.get('total')) || 0;
                    const autoSubmit = urlParams.get('auto_submit') === 'true';
                    
                    console.log('ğŸ” ê²°ê³¼ ë°ì´í„° íŒŒë¼ë¯¸í„°:', { examId, score, totalQuestions, autoSubmit });
                    console.log('ğŸ” í˜„ì¬ URL:', window.location.href);
                    
                    if (examId) {
                        // ì‹œí—˜ IDê°€ ìˆëŠ” ê²½ìš° - ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê²°ê³¼ ì¡°íšŒ
                        await this.loadResultFromDatabase(examId);
                    } else if (score > 0 && totalQuestions > 0) {
                        // URL íŒŒë¼ë¯¸í„°ë¡œ ì ìˆ˜ë§Œ ì „ë‹¬ëœ ê²½ìš° - ì„ì‹œ ë°ì´í„° ì‚¬ìš©
                        this.score = score;
                        this.totalQuestions = totalQuestions;
                        this.examData = {
                            title: 'ì‹œí—˜ ê²°ê³¼',
                            correctAnswers: Math.round(this.totalQuestions * this.score / 100),
                            incorrectAnswers: this.totalQuestions - Math.round(this.totalQuestions * this.score / 100),
                            timeUsed: 0,
                            questions: []
                        };
                        
                        if (autoSubmit) {
                            this.examData.title = 'ìë™ ì œì¶œëœ ì‹œí—˜ ê²°ê³¼';
                        }
                        
                        // URL íŒŒë¼ë¯¸í„° ë°ì´í„° ë¡œë“œ ì™„ë£Œ
                        this.isDataLoaded = true;
                    } else {
                        // ê¸°ë³¸ê°’ ì„¤ì •
                        this.score = 0;
                        this.totalQuestions = 0;
                        this.examData = {
                            title: 'ì‹œí—˜ ê²°ê³¼ ì—†ìŒ',
                            correctAnswers: 0,
                            incorrectAnswers: 0,
                            timeUsed: 0,
                            questions: []
                        };
                        
                        // ê¸°ë³¸ê°’ë„ ë¡œë“œ ì™„ë£Œë¡œ ì²˜ë¦¬
                        this.isDataLoaded = true;
                    }
                    
                    console.log('âœ… ê²°ê³¼ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', { 
                        score: this.score, 
                        total: this.totalQuestions,
                        examData: this.examData 
                    });
                    
                } catch (error) {
                    console.error('âŒ ê²°ê³¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    this.score = 0;
                    this.totalQuestions = 0;
                    this.examData = {
                        title: 'ì˜¤ë¥˜ ë°œìƒ',
                        correctAnswers: 0,
                        incorrectAnswers: 0,
                        timeUsed: 0,
                        questions: []
                    };
                }
            }

            async loadResultFromDatabase(examId) {
                try {
                    console.log('ğŸ” ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‹œí—˜ ê²°ê³¼ ì¡°íšŒ:', examId);
                    
                    // í˜„ì¬ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸° (í•˜ë“œì½”ë”©ëœ ê´€ë¦¬ì ê³„ì • ì§€ì›)
                    let userId;
                    
                    if (window.semuApp && window.semuApp.currentUser) {
                        userId = window.semuApp.currentUser.id;
                        console.log('âœ… ì•±ì—ì„œ ì‚¬ìš©ì ID í™•ì¸:', userId);
                    } else {
                        const { data: { user } } = await window.supabaseClient.auth.getUser();
                        if (!user) {
                            throw new Error('ì‚¬ìš©ì ì¸ì¦ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        }
                        userId = user.id;
                    }
                    
                    // 1ë‹¨ê³„: ì‹œí—˜ ì„¸ì…˜ ì •ë³´ ì¡°íšŒ
                    const { data: session, error: sessionError } = await window.supabaseClient
                        .from('exam_sessions')
                        .select(`
                            *,
                            exams (
                                title,
                                description,
                                duration
                            )
                        `)
                        .eq('exam_id', examId)
                        .eq('employee_id', userId)
                        .eq('status', 'submitted')
                        .order('submit_time', { ascending: false })
                        .limit(1)
                        .single();
                    
                    if (sessionError) throw sessionError;
                    
                    // 2ë‹¨ê³„: ê°œë³„ ë‹µë³€ ê²°ê³¼ ì¡°íšŒ
                    const { data: answers, error: answersError } = await window.supabaseClient
                        .from('exam_answers')
                        .select(`
                            *,
                            questions (
                                title,
                                content
                            )
                        `)
                        .eq('session_id', session.id)
                        .order('created_at');
                    
                    if (answersError) throw answersError;
                    
                    // 3ë‹¨ê³„: ê²°ê³¼ ë°ì´í„° êµ¬ì„±
                    this.score = session.score || 0;
                    this.totalQuestions = session.total_points || 0;
                    
                    const correctAnswers = answers.filter(a => a.is_correct).length;
                    const incorrectAnswers = answers.filter(a => !a.is_correct).length;
                    
                    this.examData = {
                        title: session.exams?.title || 'ì‹œí—˜ ê²°ê³¼',
                        correctAnswers: correctAnswers,
                        incorrectAnswers: incorrectAnswers,
                        timeUsed: session.duration_minutes || 0,
                        questions: answers.map(answer => ({
                            id: answer.question_id,
                            correct: answer.is_correct,
                            text: answer.questions?.title || answer.questions?.content || 'ë¬¸ì œ ë‚´ìš© ì—†ìŒ',
                            userAnswer: answer.answer,
                            points: answer.points
                        }))
                    };
                    
                    console.log('âœ… ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê²°ê³¼ ë¡œë“œ ì™„ë£Œ:', this.examData);
                    
                    // ë°ì´í„° ë¡œë“œ ì™„ë£Œ í”Œë˜ê·¸ ì„¤ì •
                    this.isDataLoaded = true;
                    
                } catch (error) {
                    console.error('âŒ ë°ì´í„°ë² ì´ìŠ¤ ê²°ê³¼ ì¡°íšŒ ì‹¤íŒ¨:', error);
                    this.isDataLoaded = false;
                    throw error;
                }
            }

            updateUI() {
                // ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ UI ì—…ë°ì´íŠ¸ í•˜ì§€ ì•ŠìŒ
                if (!this.isDataLoaded || this.score === null) {
                    console.log('âš ï¸ ë°ì´í„° ë¡œë“œ ë¯¸ì™„ë£Œ, UI ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€');
                    return;
                }
                
                console.log('ğŸ¨ UI ì—…ë°ì´íŠ¸ ì‹œì‘:', { score: this.score, total: this.totalQuestions });
                
                // ì ìˆ˜ í‘œì‹œ
                document.getElementById('scoreNumber').textContent = this.score;
                document.getElementById('circleScore').textContent = this.score;
                
                // ê²°ê³¼ ì•„ì´ì½˜ ë° ì œëª© ì—…ë°ì´íŠ¸
                this.updateResultIcon();
                
                // í†µê³„ ì—…ë°ì´íŠ¸
                this.updateStats();
                
                // ì›í˜• ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                this.updateProgressCircle();
                
                // ë¬¸í•­ë³„ ê²°ê³¼ í‘œì‹œ
                this.displayQuestionResults();
                
                // ì¶”ì²œì‚¬í•­ í‘œì‹œ
                this.displayRecommendations();
            }

            updateResultIcon() {
                const iconElement = document.getElementById('resultIcon');
                const titleElement = document.getElementById('resultTitle');
                const subtitleElement = document.getElementById('resultSubtitle');
                
                if (this.score >= 90) {
                    iconElement.className = 'result-icon excellent';
                    iconElement.innerHTML = '<i class="fas fa-trophy"></i>';
                    titleElement.textContent = 'ìš°ìˆ˜í•œ ì„±ê³¼ì…ë‹ˆë‹¤!';
                    subtitleElement.textContent = 'ë›°ì–´ë‚œ ì‹¤ë ¥ì„ ë³´ì—¬ì£¼ì…¨ìŠµë‹ˆë‹¤.';
                } else if (this.score >= 80) {
                    iconElement.className = 'result-icon good';
                    iconElement.innerHTML = '<i class="fas fa-medal"></i>';
                    titleElement.textContent = 'ì¢‹ì€ ê²°ê³¼ì…ë‹ˆë‹¤!';
                    subtitleElement.textContent = 'ì„±ì‹¤í•œ í•™ìŠµì˜ ê²°ê³¼ì…ë‹ˆë‹¤.';
                } else if (this.score >= 70) {
                    iconElement.className = 'result-icon average';
                    iconElement.innerHTML = '<i class="fas fa-star"></i>';
                    titleElement.textContent = 'ë³´í†µ ìˆ˜ì¤€ì…ë‹ˆë‹¤';
                    subtitleElement.textContent = 'ì¡°ê¸ˆ ë” ë…¸ë ¥í•˜ë©´ ë” ì¢‹ì€ ê²°ê³¼ê°€ ìˆì„ ê²ƒì…ë‹ˆë‹¤.';
                } else {
                    iconElement.className = 'result-icon poor';
                    iconElement.innerHTML = '<i class="fas fa-book"></i>';
                    titleElement.textContent = 'ì¶”ê°€ í•™ìŠµì´ í•„ìš”í•©ë‹ˆë‹¤';
                    subtitleElement.textContent = 'í¬ê¸°í•˜ì§€ ë§ˆì„¸ìš”. ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!';
                }
            }

            updateStats() {
                document.getElementById('correctCount').textContent = this.examData.correctAnswers;
                document.getElementById('incorrectCount').textContent = this.examData.incorrectAnswers;
                document.getElementById('timeUsed').textContent = this.examData.timeUsed;
                document.getElementById('accuracy').textContent = this.score;
                
                // í‰ê· ê³¼ ë¹„êµ
                const averageScore = 70; // Mock í‰ê·  ì ìˆ˜
                const difference = this.score - averageScore;
                const comparisonElement = document.getElementById('comparison');
                
                if (difference > 0) {
                    comparisonElement.textContent = `${difference}ì  ë†’ìŒ`;
                    comparisonElement.style.color = '#28a745';
                } else if (difference < 0) {
                    comparisonElement.textContent = `${Math.abs(difference)}ì  ë‚®ìŒ`;
                    comparisonElement.style.color = '#dc3545';
                } else {
                    comparisonElement.textContent = 'í‰ê· ê³¼ ë™ì¼';
                    comparisonElement.style.color = '#6c757d';
                }
            }

            updateProgressCircle() {
                const circle = document.getElementById('progressCircle');
                const percentage = this.score;
                const degrees = (percentage / 100) * 360;
                
                circle.style.background = `conic-gradient(var(--primary-color) ${degrees}deg, #e9ecef ${degrees}deg)`;
            }

            displayQuestionResults() {
                const container = document.getElementById('questionResults');
                container.innerHTML = '';
                
                // ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê°€ì ¸ì˜¨ ë¬¸ì œ ê²°ê³¼ ì‚¬ìš©
                console.log('ğŸ“Š ë¬¸í•­ë³„ ê²°ê³¼ í‘œì‹œ ì‹œë„:', { 
                    examData: this.examData, 
                    questions: this.examData?.questions,
                    questionsLength: this.examData?.questions?.length 
                });
                
                if (!this.examData || !this.examData.questions || this.examData.questions.length === 0) {
                    const errorMsg = `ë¬¸ì œ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (examData: ${!!this.examData}, questions: ${!!this.examData?.questions}, length: ${this.examData?.questions?.length})`;
                    container.innerHTML = `<p>${errorMsg}</p>`;
                    console.warn('âŒ ë¬¸í•­ë³„ ê²°ê³¼ í‘œì‹œ ì‹¤íŒ¨:', errorMsg);
                    return;
                }
                
                this.examData.questions.forEach((question, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = `question-result ${question.correct ? 'correct' : 'incorrect'}`;
                    
                    questionDiv.innerHTML = `
                        <div class="question-info">
                            <div class="question-number">ë¬¸ì œ ${index + 1}</div>
                            <div class="question-preview">${question.text}</div>
                        </div>
                        <div class="question-status">
                            <span class="status-icon ${question.correct ? 'correct' : 'incorrect'}">
                                <i class="fas fa-${question.correct ? 'check' : 'times'}-circle"></i>
                            </span>
                            <span>${question.correct ? 'ì •ë‹µ' : 'ì˜¤ë‹µ'}</span>
                        </div>
                    `;
                    
                    container.appendChild(questionDiv);
                });
                
                // ë” ë³´ê¸° ë²„íŠ¼ (ì „ì²´ ë¬¸ì œ ìˆ˜ê°€ í‘œì‹œëœ ê²ƒë³´ë‹¤ ë§ì„ ë•Œ)
                const displayedQuestions = this.examData.questions.length;
                if (this.totalQuestions > displayedQuestions) {
                    const moreBtn = document.createElement('button');
                    moreBtn.className = 'btn btn-outline';
                    moreBtn.innerHTML = `<i class="fas fa-chevron-down"></i> ë‚˜ë¨¸ì§€ ${this.totalQuestions - displayedQuestions}ê°œ ë¬¸ì œ ë³´ê¸°`;
                    moreBtn.onclick = () => this.showAllQuestions();
                    container.appendChild(moreBtn);
                }
            }

            displayRecommendations() {
                const container = document.getElementById('recommendationsList');
                const recommendations = this.generateRecommendations();
                
                container.innerHTML = '';
                
                recommendations.forEach(rec => {
                    const recDiv = document.createElement('div');
                    recDiv.className = 'recommendation-item';
                    recDiv.innerHTML = `
                        <i class="fas fa-${rec.icon} recommendation-icon"></i>
                        <span>${rec.text}</span>
                    `;
                    container.appendChild(recDiv);
                });
            }

            generateRecommendations() {
                const recommendations = [];
                
                if (this.score >= 90) {
                    recommendations.push(
                        { icon: 'trophy', text: 'ìš°ìˆ˜í•œ ì„±ê³¼ì…ë‹ˆë‹¤! ë‹¤ìŒ ë‹¨ê³„ì˜ ê³ ê¸‰ ê³¼ì •ì— ë„ì „í•´ë³´ì„¸ìš”.' },
                        { icon: 'graduation-cap', text: 'ë™ë£Œë“¤ì—ê²Œ ì§€ì‹ì„ ê³µìœ í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”.' }
                    );
                } else if (this.score >= 80) {
                    recommendations.push(
                        { icon: 'book', text: 'í‹€ë¦° ë¬¸ì œë“¤ì„ ë‹¤ì‹œ í•œë²ˆ ë³µìŠµí•´ë³´ì„¸ìš”.' },
                        { icon: 'clock', text: 'ì •ê¸°ì ì¸ ë³µìŠµìœ¼ë¡œ ì§€ì‹ì„ ë”ìš± ê³µê³ íˆ í•˜ì„¸ìš”.' }
                    );
                } else if (this.score >= 70) {
                    recommendations.push(
                        { icon: 'study', text: 'ê¸°ë³¸ ê°œë…ì„ ë” í™•ì‹¤íˆ ìµí˜€ë³´ì„¸ìš”.' },
                        { icon: 'practice', text: 'ì¶”ê°€ ì—°ìŠµ ë¬¸ì œë¥¼ í†µí•´ ì‹¤ë ¥ì„ í–¥ìƒì‹œí‚¤ì„¸ìš”.' },
                        { icon: 'clock', text: 'ì¶©ë¶„í•œ í•™ìŠµ ì‹œê°„ì„ í™•ë³´í•˜ì„¸ìš”.' }
                    );
                } else {
                    recommendations.push(
                        { icon: 'book-open', text: 'ê¸°ì´ˆë¶€í„° ì°¨ê·¼ì°¨ê·¼ ë‹¤ì‹œ í•™ìŠµí•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.' },
                        { icon: 'users', text: 'ìŠ¤í„°ë”” ê·¸ë£¹ì— ì°¸ì—¬í•˜ê±°ë‚˜ ë©˜í† ì˜ ë„ì›€ì„ ë°›ì•„ë³´ì„¸ìš”.' },
                        { icon: 'calendar-alt', text: 'ì²´ê³„ì ì¸ í•™ìŠµ ê³„íšì„ ì„¸ì›Œë³´ì„¸ìš”.' },
                        { icon: 'redo', text: 'í¬ê¸°í•˜ì§€ ë§ˆì‹œê³  ê¾¸ì¤€íˆ ì¬ë„ì „í•˜ì„¸ìš”.' }
                    );
                }
                
                return recommendations;
            }

            showAllQuestions() {
                showAlert('ì „ì²´ ë¬¸í•­ë³„ ìƒì„¸ ë¶„ì„ ê¸°ëŠ¥ì€ ê³§ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤.', 'info');
            }
        }

        // ì „ì—­ í•¨ìˆ˜ë“¤
        let resultsPage;

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸ“Š ê²°ê³¼ í˜ì´ì§€ DOM ë¡œë“œ ì™„ë£Œ');
            
            // Supabase ì´ˆê¸°í™” ëŒ€ê¸°
            let attempts = 0;
            const maxAttempts = 50;
            
            while (attempts < maxAttempts && (!window.semuApp || !window.supabaseClient)) {
                console.log('â³ Supabase ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘...', attempts);
                await new Promise(resolve => setTimeout(resolve, 200));
                attempts++;
            }
            
            if (window.semuApp && window.supabaseClient) {
                console.log('âœ… Supabase ì´ˆê¸°í™” ì™„ë£Œ, ê²°ê³¼ í˜ì´ì§€ ìƒì„±');
                resultsPage = new ResultsPage();
            } else {
                console.error('âŒ Supabase ì´ˆê¸°í™” ì‹¤íŒ¨');
                alert('ì‹œìŠ¤í…œ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            }
        });

        // ì¬ì‘ì‹œ ê¸°ëŠ¥ ë¹„í™œì„±í™”
        /*
        function retakeExam() {
            if (confirm('ê°™ì€ ì‹œí—˜ì„ ë‹¤ì‹œ ì‘ì‹œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // URLì—ì„œ ì‹œí—˜ ID ê°€ì ¸ì˜¤ê¸°
                const urlParams = new URLSearchParams(window.location.search);
                const examId = urlParams.get('exam');
                
                if (examId) {
                    window.location.href = `./exam.html?id=${examId}`;
                } else {
                    // ì‹œí—˜ IDê°€ ì—†ëŠ” ê²½ìš° ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
                    window.location.href = './dashboard.html';
                }
            }
        }
        */

        async function viewDetails() {
            try {
                // URLì—ì„œ ì‹œí—˜ ID ê°€ì ¸ì˜¤ê¸°
                const urlParams = new URLSearchParams(window.location.search);
                const examId = urlParams.get('exam');
                
                if (!examId) {
                    showAlert('ì‹œí—˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }
                
                // ìƒì„¸ ë¶„ì„ ëª¨ë‹¬ í‘œì‹œ
                await showDetailedAnalysisModal(examId);
                
            } catch (error) {
                console.error('ìƒì„¸ ë¶„ì„ í‘œì‹œ ì‹¤íŒ¨:', error);
                showAlert('ìƒì„¸ ë¶„ì„ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        // ìƒì„¸ ë¶„ì„ ëª¨ë‹¬ í‘œì‹œ
        async function showDetailedAnalysisModal(examId) {
            try {
                // ë‹µì•ˆ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const { data: answers, error } = await window.supabaseClient
                    .from('exam_answers')
                    .select(`
                        *,
                        questions (
                            id,
                            title,
                            content,
                            type,
                            model_answer
                        ),
                        exam_sessions (
                            start_time,
                            submit_time
                        )
                    `)
                    .eq('exam_sessions.exam_id', examId)
                    .eq('exam_sessions.user_id', window.semuApp.currentUser.id);
                
                if (error) throw error;
                
                if (!answers || answers.length === 0) {
                    showAlert('ë‹µì•ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }
                
                // ëª¨ë‹¬ HTML ìƒì„±
                const modalHtml = `
                    <div class="modal-overlay" id="detailed-analysis-modal">
                        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
                            <div class="modal-header">
                                <h3><i class="fas fa-chart-line"></i> ì‹œí—˜ ìƒì„¸ ë¶„ì„</h3>
                                <button class="modal-close" onclick="closeDetailedAnalysisModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="analysis-summary">
                                    <h4>ğŸ“Š ì „ì²´ ìš”ì•½</h4>
                                    <div class="summary-stats">
                                        <div class="stat-item">
                                            <span class="stat-label">ì´ ë¬¸ì œ ìˆ˜</span>
                                            <span class="stat-value">${answers.length}ê°œ</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">AI ì±„ì  ì™„ë£Œ</span>
                                            <span class="stat-value">${answers.filter(a => a.ai_graded).length}ê°œ</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">ìˆ˜ë™ ì±„ì  ì™„ë£Œ</span>
                                            <span class="stat-value">${answers.filter(a => !a.ai_graded && a.points !== null).length}ê°œ</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="questions-analysis">
                                    <h4>ğŸ“ ë¬¸í•­ë³„ ìƒì„¸ ë¶„ì„</h4>
                                    ${answers.map((answer, index) => `
                                        <div class="question-analysis-item">
                                            <div class="question-header">
                                                <h5>${index + 1}ë²ˆ ë¬¸ì œ</h5>
                                                <div class="question-meta">
                                                    <span class="question-type">${getQuestionTypeDisplay(answer.questions?.type)}</span>
                                                    <span class="question-score">${answer.points || 0}ì </span>
                                                </div>
                                            </div>
                                            
                                            <div class="question-content">
                                                <h6>ë¬¸ì œ ë‚´ìš©</h6>
                                                <p>${answer.questions?.title || answer.questions?.content || 'ë‚´ìš© ì—†ìŒ'}</p>
                                            </div>
                                            
                                            <div class="answer-content">
                                                <h6>ë‚´ ë‹µì•ˆ</h6>
                                                <div class="answer-text">${answer.answer || 'ë‹µì•ˆ ì—†ìŒ'}</div>
                                            </div>
                                            
                                            ${answer.questions?.model_answer ? `
                                                <div class="model-answer">
                                                    <h6>ëª¨ë²”ë‹µì•ˆ</h6>
                                                    <div class="model-answer-text">${answer.questions.model_answer}</div>
                                                </div>
                                            ` : ''}
                                            
                                            ${answer.feedback ? `
                                                <div class="grading-feedback">
                                                    <h6>${answer.ai_graded ? 'ğŸ¤– AI ì±„ì  í”¼ë“œë°±' : 'ğŸ‘¨â€ğŸ« êµìˆ˜ì í”¼ë“œë°±'}</h6>
                                                    <div class="feedback-content">
                                                        <div class="feedback-score">
                                                            <strong>ì ìˆ˜: ${answer.points || 0}ì </strong>
                                                            ${answer.ai_graded ? '<span class="ai-badge">AI ì±„ì </span>' : ''}
                                                        </div>
                                                        <div class="feedback-text">${answer.feedback}</div>
                                                        ${answer.ai_graded && answer.ai_graded_at ? `
                                                            <small class="feedback-time">AI ì±„ì  ì‹œê°„: ${new Date(answer.ai_graded_at).toLocaleString('ko-KR')}</small>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            ` : ''}
                                            
                                            ${answer.exam_sessions ? `
                                                <div class="answer-timing">
                                                    <small class="text-muted">
                                                        ì†Œìš”ì‹œê°„: ${calculateTimeSpent(answer.exam_sessions.start_time, answer.exam_sessions.submit_time)}
                                                    </small>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="closeDetailedAnalysisModal()">ë‹«ê¸°</button>
                                <button class="btn btn-primary" onclick="exportAnalysisReport()">
                                    <i class="fas fa-download"></i> ë¶„ì„ ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // ê¸°ì¡´ ëª¨ë‹¬ ì œê±° í›„ ìƒˆ ëª¨ë‹¬ ì¶”ê°€
                const existingModal = document.getElementById('detailed-analysis-modal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // ëª¨ë‹¬ í‘œì‹œ
                const modal = document.getElementById('detailed-analysis-modal');
                modal.style.display = 'flex';
                
            } catch (error) {
                console.error('ìƒì„¸ ë¶„ì„ ëª¨ë‹¬ ìƒì„± ì‹¤íŒ¨:', error);
                showAlert('ìƒì„¸ ë¶„ì„ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        // ìƒì„¸ ë¶„ì„ ëª¨ë‹¬ ë‹«ê¸°
        function closeDetailedAnalysisModal() {
            const modal = document.getElementById('detailed-analysis-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // ë¶„ì„ ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ
        function exportAnalysisReport() {
            // ê°„ë‹¨í•œ í…ìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ìƒì„±
            const urlParams = new URLSearchParams(window.location.search);
            const examId = urlParams.get('exam');
            const score = window.resultsPage?.score || 0;
            const totalQuestions = window.resultsPage?.totalQuestions || 0;
            
            let report = `ì‹œí—˜ ê²°ê³¼ ë¶„ì„ ë¦¬í¬íŠ¸\n`;
            report += `========================\n\n`;
            report += `ì‹œí—˜ ID: ${examId}\n`;
            report += `ì´ì : ${score}/${totalQuestions} (${Math.round((score/totalQuestions)*100)}%)\n`;
            report += `ìƒì„±ì¼: ${new Date().toLocaleString('ko-KR')}\n\n`;
            
            // ë‹¤ìš´ë¡œë“œ
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ì‹œí—˜ê²°ê³¼_ë¶„ì„_${examId}_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // ë¬¸ì œ ìœ í˜• í‘œì‹œ
        function getQuestionTypeDisplay(type) {
            const typeMap = {
                'multiple_choice': 'ê°ê´€ì‹',
                'subjective': 'ì£¼ê´€ì‹',
                'essay': 'ì„œìˆ í˜•'
            };
            return typeMap[type] || type || 'ê¸°íƒ€';
        }
        
        // ì†Œìš” ì‹œê°„ ê³„ì‚°
        function calculateTimeSpent(startTime, submitTime) {
            if (!startTime || !submitTime) return 'ì•Œ ìˆ˜ ì—†ìŒ';
            
            const start = new Date(startTime);
            const submit = new Date(submitTime);
            const diffMs = submit - start;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return '1ë¶„ ë¯¸ë§Œ';
            if (diffMins < 60) return `${diffMins}ë¶„`;
            
            const hours = Math.floor(diffMins / 60);
            const mins = diffMins % 60;
            return `${hours}ì‹œê°„ ${mins}ë¶„`;
        }
    </script>
</body>
</html>
