
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•„ë°”íƒ€ ìƒì  - ì„¸ë¬´ì¸ì‚¬ì´ë“œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .shop-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .shop-header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .shop-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .shop-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .user-info {
            background: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .user-points {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }

        .points-badge {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(255, 140, 0, 0.3);
        }

        .shop-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background: white;
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }

        .tab-button:hover {
            background: #e9ecef;
        }

        .tab-content {
            padding: 30px;
            min-height: 500px;
        }

        .tab-content.hidden {
            display: none;
        }

        .items-grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)) !important;
            gap: 25px !important;
            margin-top: 20px !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .item-card {
            background: white !important;
            border-radius: 15px !important;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important;
            overflow: hidden !important;
            transition: all 0.3s ease !important;
            border: 1px solid #e9ecef !important;
            position: relative !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            min-height: 350px !important;
        }

        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .item-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 15px 15px 0 0;
        }

        .item-info {
            padding: 20px;
        }

        .item-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .item-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .item-price {
            font-size: 1.3rem;
            font-weight: 700;
            color: #007bff;
            margin-bottom: 15px;
        }

        .item-price.free {
            color: #28a745;
        }

        .item-price.expensive {
            color: #dc3545;
        }

        .purchase-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .purchase-btn.primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .purchase-btn.primary:hover {
            background: linear-gradient(135deg, #0056b3, #004085);
        }

        .purchase-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 1.1rem;
        }

        .empty-state {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal p {
            margin-bottom: 30px;
            color: #666;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.primary {
            background: #007bff;
            color: white;
        }

        .modal-btn.secondary {
            background: #6c757d;
            color: white;
        }

        .modal-btn:hover {
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .items-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="shop-container">
        <!-- í—¤ë” -->
        <div class="shop-header">
            <h1 class="shop-title">ğŸ­ ì•„ë°”íƒ€ ìƒì </h1>
            <p class="shop-subtitle">ë©‹ì§„ ì•„ë°”íƒ€ë¡œ ë‚˜ë§Œì˜ ê°œì„±ì„ í‘œí˜„í•´ë³´ì„¸ìš”!</p>
        </div>

        <!-- ì‚¬ìš©ì ì •ë³´ -->
        <div class="user-info">
            <div>
                <h3>ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹</h3>
                <p>í¬ì¸íŠ¸ë¥¼ ì‚¬ìš©í•´ì„œ ë©‹ì§„ ì•„ë°”íƒ€ë¥¼ êµ¬ë§¤í•´ë³´ì„¸ìš”.</p>
            </div>
            <div class="user-points">
                <span>ğŸ’° ë³´ìœ  í¬ì¸íŠ¸:</span>
                <span class="points-badge" id="user-points">0P</span>
            </div>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="shop-tabs">
            <button class="tab-button active" onclick="switchTab('shop')">
                ğŸ›’ ìƒì 
            </button>
            <button class="tab-button" onclick="switchTab('inventory')">
                ğŸ‘¤ ë‚´ ì•„ë°”íƒ€
            </button>
        </div>

        <!-- ìƒì  íƒ­ -->
        <div id="shop-tab" class="tab-content">
            <div id="shop-loading" class="loading">
                ì•„ë°”íƒ€ ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
            </div>
            <div id="shop-items" class="items-grid">
                <!-- ì•„ë°”íƒ€ ì•„ì´í…œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ì¸ë²¤í† ë¦¬ íƒ­ -->
        <div id="inventory-tab" class="tab-content hidden">
            <div id="inventory-loading" class="loading">
                ë‚´ ì•„ë°”íƒ€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
            </div>
            <div id="inventory-items" class="items-grid">
                <!-- ì‚¬ìš©ìê°€ ë³´ìœ í•œ ì•„ë°”íƒ€ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <!-- êµ¬ë§¤ í™•ì¸ ëª¨ë‹¬ -->
    <div id="purchaseModal" class="modal">
        <div class="modal-content">
            <h2>ğŸ›’ êµ¬ë§¤ í™•ì¸</h2>
            <p id="purchase-message">ì •ë§ë¡œ ì´ ì•„ë°”íƒ€ë¥¼ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="confirmPurchase()">êµ¬ë§¤í•˜ê¸°</button>
                <button class="modal-btn secondary" onclick="closePurchaseModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script src="assets/js/common.js"></script>
    <script>
        // ì•„ë°”íƒ€ ìƒì  í´ë˜ìŠ¤
        class AvatarShop {
            constructor() {
                this.avatarItems = [];
                this.userAvatars = [];
                this.userPoints = 0;
                this.currentUser = null;
                this.selectedItemId = null;
                
                this.init();
            }

            async init() {
                console.log('ğŸ›’ ì•„ë°”íƒ€ ìƒì  ì´ˆê¸°í™” ì‹œì‘');
                
                try {
                    // SemuApp ì´ˆê¸°í™” ëŒ€ê¸°
                    await this.waitForSemuApp();
                    
                    // ì‚¬ìš©ì ì¸ì¦ í™•ì¸
                    await this.checkAuth();
                    
                    // ë°ì´í„° ë¡œë“œ
                    await this.loadUserPoints();
                    await this.loadAvatarItems();
                    await this.loadUserAvatars();
                    
                    console.log('âœ… ì•„ë°”íƒ€ ìƒì  ì´ˆê¸°í™” ì™„ë£Œ');
                    
                    // ê°•ì œ í‘œì‹œ ë³´ì¥
                    setTimeout(() => {
                        this.forceDisplayAvatars();
                    }, 1000);
                    
                } catch (error) {
                    console.error('âŒ ì•„ë°”íƒ€ ìƒì  ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    this.showError('ì•„ë°”íƒ€ ìƒì ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            async waitForSemuApp() {
                console.log('â³ SemuApp ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘...');
                
                let attempts = 0;
                const maxAttempts = 100;
                
                while (attempts < maxAttempts) {
                    if (window.semuApp && window.semuApp.supabaseClient) {
                        console.log('âœ… SemuApp ì´ˆê¸°í™” ì™„ë£Œ í™•ì¸');
                        return;
                    }
                    
                    attempts++;
                    console.log(`   - SemuApp ì¡´ì¬: ${!!window.semuApp}`);
                    console.log(`   - supabaseClient ì¡´ì¬: ${!!(window.semuApp && window.semuApp.supabaseClient)}`);
                    console.log(`   - currentUser ì¡´ì¬: ${!!(window.semuApp && window.semuApp.currentUser)}`);
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // ìˆ˜ë™ ì´ˆê¸°í™” ì‹œë„
                console.log('âš ï¸ SemuApp ìë™ ì´ˆê¸°í™” ì‹¤íŒ¨, ìˆ˜ë™ ì´ˆê¸°í™” ì‹œë„');
                if (window.SemuApp) {
                    window.semuApp = new window.SemuApp();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            async checkAuth() {
                console.log('ğŸ” ì‚¬ìš©ì ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘...');
                
                if (window.semuApp && window.semuApp.currentUser) {
                    this.currentUser = window.semuApp.currentUser;
                    console.log('âœ… SemuAppì—ì„œ ì‚¬ìš©ì ì •ë³´ í™•ì¸:', this.currentUser.email);
                } else {
                    console.log('ğŸ“‹ SemuApp.currentUser: null');
                    console.log('âš ï¸ SemuApp.currentUserê°€ ì—†ìŒ, Supabase ì„¸ì…˜ ì§ì ‘ í™•ì¸');
                    
                    // Supabase ì„¸ì…˜ ì§ì ‘ í™•ì¸
                    try {
                        const { data: { session } } = await window.semuApp.supabaseClient.auth.getSession();
                        if (session && session.user) {
                            console.log('âœ… Supabase ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì ë°œê²¬:', session.user.email);
                            
                            // í”„ë¡œí•„ ì •ë³´ ì¡°íšŒ
                            const { data: profile } = await window.semuApp.supabaseClient
                                .from('profiles')
                                .select('*')
                                .eq('id', session.user.id)
                                .single();
                            
                            this.currentUser = {
                                id: session.user.id,
                                email: session.user.email,
                                ...profile
                            };
                            
                            console.log('âœ… ì‚¬ìš©ì ì •ë³´ ë³µì› ì™„ë£Œ:', this.currentUser.email);
                        } else {
                            throw new Error('ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤');
                        }
                    } catch (error) {
                        console.error('âŒ ì¸ì¦ í™•ì¸ ì‹¤íŒ¨:', error);
                        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        window.location.href = 'login.html';
                        return;
                    }
                }
                
                console.log('âœ… ì‚¬ìš©ì ì¸ì¦ í™•ì¸:', this.currentUser.email);
            }

            async loadUserPoints() {
                try {
                    const { data, error } = await window.semuApp.supabaseClient
                        .from('user_points')
                        .select('points')
                        .eq('user_id', this.currentUser.id)
                        .single();
                    
                    if (error) throw error;
                    
                    this.userPoints = data?.points || 0;
                    console.log('ğŸ’° ì‚¬ìš©ì í¬ì¸íŠ¸ ë¡œë“œ:', this.userPoints);
                    
                    // UI ì—…ë°ì´íŠ¸
                    document.getElementById('user-points').textContent = `${this.userPoints}P`;
                } catch (error) {
                    console.error('âŒ í¬ì¸íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                    this.userPoints = 0;
                }
            }

            async loadAvatarItems() {
                console.log('ğŸ­ ì•„ë°”íƒ€ ì•„ì´í…œ ë¡œë“œ ì¤‘...');
                
                try {
                    const { data, error } = await window.semuApp.supabaseClient
                        .from('avatar_items')
                        .select('*')
                        .eq('is_active', true)
                        .order('price', { ascending: true });
                    
                    if (error) {
                        console.error('âŒ ì•„ë°”íƒ€ ì•„ì´í…œ ë¡œë“œ ì‹¤íŒ¨:', error);
                        if (error.code === '42P01') {
                            console.error('âŒ avatar_items í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                            this.showError('ì•„ë°”íƒ€ ì‹œìŠ¤í…œì´ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                        } else if (error.code === 'PGRST301') {
                            console.error('âŒ RLS ì •ì±… ì˜¤ë¥˜');
                            this.showError('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                        }
                        return;
                    }
                    
                    this.avatarItems = data || [];
                    console.log('âœ… ì•„ë°”íƒ€ ì•„ì´í…œ ë¡œë“œ ì™„ë£Œ:', this.avatarItems.length, 'ê°œ');
                    
                    // ìƒì  ì•„ì´í…œ ë Œë”ë§
                    this.renderShopItems();
                } catch (error) {
                    console.error('âŒ ì•„ë°”íƒ€ ì•„ì´í…œ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                    this.showError('ì•„ë°”íƒ€ ì•„ì´í…œì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            async loadUserAvatars() {
                console.log('ğŸ‘¤ ì‚¬ìš©ì ì•„ë°”íƒ€ ë¡œë“œ ì¤‘...');
                
                try {
                    const { data, error } = await window.semuApp.supabaseClient
                        .from('user_avatars')
                        .select(`
                            *,
                            avatar_items (*)
                        `)
                        .eq('user_id', this.currentUser.id);
                    
                    if (error) throw error;
                    
                    this.userAvatars = data || [];
                    console.log('âœ… ì‚¬ìš©ì ì•„ë°”íƒ€ ë¡œë“œ ì™„ë£Œ:', this.userAvatars.length, 'ê°œ');
                    
                    if (this.userAvatars.length > 0) {
                        const activeAvatar = this.userAvatars.find(ua => ua.is_active);
                        if (activeAvatar) {
                            console.log('ğŸ¯ í™œì„± ì•„ë°”íƒ€:', activeAvatar.avatar_items.name);
                        }
                    }
                    
                    // ì¸ë²¤í† ë¦¬ ë Œë”ë§
                    this.renderInventoryItems();
                } catch (error) {
                    console.error('âŒ ì‚¬ìš©ì ì•„ë°”íƒ€ ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            }

            renderShopItems() {
                const container = document.getElementById('shop-items');
                const loading = document.getElementById('shop-loading');
                
                console.log('ğŸ¨ ì•„ë°”íƒ€ ë Œë”ë§ ì‹œì‘:', {
                    avatarItems: this.avatarItems.length,
                    container: !!container,
                    loading: !!loading
                });
                
                if (!container) {
                    console.error('âŒ shop-items ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                    return;
                }
                
                if (this.avatarItems.length === 0) {
                    loading.innerHTML = `
                        <div class="empty-state">
                            <h3>ğŸ›’ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</h3>
                            <p>ì•„ì§ íŒë§¤ ì¤‘ì¸ ì•„ë°”íƒ€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    `;
                    return;
                }
                
                // ì†Œìœ í•œ ì•„ì´í…œ ID ëª©ë¡
                const ownedItemIds = this.userAvatars.map(ua => ua.avatar_item_id);
                
                // URL í•´ì‹œì—ì„œ í•˜ì´ë¼ì´íŠ¸í•  ì•„ë°”íƒ€ ID í™•ì¸
                const hash = window.location.hash;
                const highlightAvatarId = hash ? hash.replace('#avatar-', '') : '';
                
                console.log('ğŸ¨ ë Œë”ë§ ë°ì´í„°:', {
                    highlightAvatarId,
                    ownedItemIds,
                    avatarItems: this.avatarItems.length
                });
                
                const htmlContent = this.avatarItems.map(item => {
                    const isOwned = ownedItemIds.includes(item.id);
                    const canAfford = this.userPoints >= item.price;
                    const isHighlighted = highlightAvatarId === item.id;
                    
                    console.log(`ğŸ¨ ì•„ë°”íƒ€ "${item.name}" ë Œë”ë§:`, {
                        id: item.id,
                        isOwned,
                        canAfford,
                        price: item.price,
                        userPoints: this.userPoints
                    });
                    
                    return `
                        <div class="item-card ${isHighlighted ? 'highlighted' : ''}" id="avatar-${item.id}">
                            <img src="${item.image_url || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuaXoOazleWKoOi9veWbvueJhzwvdGV4dD48L3N2Zz4='}" 
                                 alt="${item.name}" 
                                 class="item-image"
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuaXoOazleWKoOi9veWbvueJhzwvdGV4dD48L3N2Zz4='">
                            <div class="item-info">
                                <h3 class="item-name">${item.name}</h3>
                                <p class="item-description">${item.description || 'ë©‹ì§„ ì•„ë°”íƒ€ì…ë‹ˆë‹¤.'}</p>
                                <div class="item-price ${item.price === 0 ? 'free' : (item.price > this.userPoints ? 'expensive' : '')}">
                                    ${item.price === 0 ? 'ğŸ†“ ë¬´ë£Œ' : `ğŸ’° ${item.price}P`}
                                </div>
                                ${isOwned ? 
                                    '<button class="purchase-btn" disabled>âœ… ë³´ìœ ì¤‘</button>' :
                                    `<button class="purchase-btn primary ${!canAfford ? 'disabled' : ''}" 
                                            ${!canAfford ? 'disabled' : ''}
                                            onclick="avatarShop.openPurchaseModal('${item.id}')">
                                        ${!canAfford ? 'í¬ì¸íŠ¸ ë¶€ì¡±' : 'êµ¬ë§¤í•˜ê¸°'}
                                    </button>`
                                }
                            </div>
                        </div>
                    `;
                }).join('');

                console.log('ğŸ¨ HTML ìƒì„± ì™„ë£Œ, DOMì— ì‚½ì… ì¤‘...');
                container.innerHTML = htmlContent;
                
                // ê°•ì œë¡œ ëª¨ë“  ìŠ¤íƒ€ì¼ ì ìš©
                if (loading) {
                    loading.style.display = 'none';
                    loading.style.visibility = 'hidden';
                    loading.style.opacity = '0';
                }
                
                // ì»¨í…Œì´ë„ˆ ê°•ì œ í‘œì‹œ
                container.style.display = 'grid';
                container.style.visibility = 'visible';
                container.style.opacity = '1';
                container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(280px, 1fr))';
                container.style.gap = '25px';
                container.style.marginTop = '20px';
                container.style.minHeight = '400px';
                
                // ê° ì¹´ë“œ ê°•ì œ í‘œì‹œ
                const cards = container.querySelectorAll('.item-card');
                cards.forEach((card, index) => {
                    card.style.display = 'block';
                    card.style.visibility = 'visible';
                    card.style.opacity = '1';
                    card.style.minHeight = '350px';
                    card.style.backgroundColor = 'white';
                    card.style.border = '1px solid #e9ecef';
                    card.style.borderRadius = '15px';
                    card.style.boxShadow = '0 10px 25px rgba(0,0,0,0.1)';
                    card.style.padding = '16px';
                    card.style.margin = '0';
                    console.log(`âœ… ì¹´ë“œ ${index + 1} ê°•ì œ í‘œì‹œ ì™„ë£Œ`);
                });
                
                console.log('âœ… ì•„ë°”íƒ€ ì¹´ë“œ ë Œë”ë§ ì™„ë£Œ:', {
                    containerVisible: container.style.display,
                    loadingHidden: loading ? loading.style.display : 'N/A',
                    childrenCount: container.children.length
                });
                
                // í•˜ì´ë¼ì´íŠ¸ëœ ì•„ë°”íƒ€ë¡œ ìŠ¤í¬ë¡¤
                if (highlightAvatarId) {
                    setTimeout(() => {
                        const highlightedElement = document.getElementById(`avatar-${highlightAvatarId}`);
                        if (highlightedElement) {
                            highlightedElement.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'center' 
                            });
                            console.log(`ğŸ¯ "${highlightedElement.querySelector('.item-name').textContent}" ì•„ë°”íƒ€ë¡œ ìŠ¤í¬ë¡¤ ë° í•˜ì´ë¼ì´íŠ¸`);
                        }
                    }, 500);
                }
            }

            renderInventoryItems() {
                const container = document.getElementById('inventory-items');
                const loading = document.getElementById('inventory-loading');
                
                if (this.userAvatars.length === 0) {
                    loading.innerHTML = `
                        <div class="empty-state">
                            <h3>ğŸ‘¤ ì•„ë°”íƒ€ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                            <p>ìƒì ì—ì„œ ë©‹ì§„ ì•„ë°”íƒ€ë¥¼ êµ¬ë§¤í•´ë³´ì„¸ìš”!</p>
                        </div>
                    `;
                    return;
                }
                
                const htmlContent = this.userAvatars.map(userAvatar => {
                    const item = userAvatar.avatar_items;
                    const isActive = userAvatar.is_active;
                    
                    return `
                        <div class="item-card ${isActive ? 'active' : ''}">
                            <img src="${item.image_url || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuaXoOazleWKoOi9veWbvueJhzwvdGV4dD48L3N2Zz4='}" 
                                 alt="${item.name}" 
                                 class="item-image">
                            <div class="item-info">
                                <h3 class="item-name">${item.name} ${isActive ? 'ğŸ‘‘' : ''}</h3>
                                <p class="item-description">${item.description || 'ë©‹ì§„ ì•„ë°”íƒ€ì…ë‹ˆë‹¤.'}</p>
                                <button class="purchase-btn primary" 
                                        onclick="avatarShop.equipAvatar('${userAvatar.id}')"
                                        ${isActive ? 'disabled' : ''}>
                                    ${isActive ? 'ì°©ìš©ì¤‘' : 'ì°©ìš©í•˜ê¸°'}
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = htmlContent;
                loading.style.display = 'none';
            }

            openPurchaseModal(itemId) {
                const item = this.avatarItems.find(i => i.id === itemId);
                if (!item) return;
                
                this.selectedItemId = itemId;
                
                const modal = document.getElementById('purchaseModal');
                const message = document.getElementById('purchase-message');
                
                message.innerHTML = `
                    <strong>${item.name}</strong>ì„(ë¥¼) êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>
                    <span style="color: #007bff; font-weight: 600;">ğŸ’° ${item.price === 0 ? 'ë¬´ë£Œ' : item.price + 'P'}</span>
                `;
                
                modal.style.display = 'block';
            }

            closePurchaseModal() {
                const modal = document.getElementById('purchaseModal');
                modal.style.display = 'none';
                this.selectedItemId = null;
            }

            async confirmPurchase() {
                if (!this.selectedItemId) return;
                
                const item = this.avatarItems.find(i => i.id === this.selectedItemId);
                if (!item) return;
                
                if (this.userPoints < item.price) {
                    alert('í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                    return;
                }
                
                try {
                    // êµ¬ë§¤ ì²˜ë¦¬
                    const { error: purchaseError } = await window.semuApp.supabaseClient
                        .from('user_avatars')
                        .insert({
                            user_id: this.currentUser.id,
                            avatar_item_id: item.id,
                            is_active: false
                        });
                    
                    if (purchaseError) throw purchaseError;
                    
                    // í¬ì¸íŠ¸ ì°¨ê°
                    const { error: pointsError } = await window.semuApp.supabaseClient
                        .from('user_points')
                        .update({ points: this.userPoints - item.price })
                        .eq('user_id', this.currentUser.id);
                    
                    if (pointsError) throw pointsError;
                    
                    // í¬ì¸íŠ¸ ê±°ë˜ ê¸°ë¡
                    const { error: transactionError } = await window.semuApp.supabaseClient
                        .from('point_transactions')
                        .insert({
                            user_id: this.currentUser.id,
                            amount: -item.price,
                            transaction_type: 'spend',
                            description: `ì•„ë°”íƒ€ êµ¬ë§¤: ${item.name}`,
                            avatar_item_id: item.id
                        });
                    
                    if (transactionError) throw transactionError;
                    
                    alert('êµ¬ë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    this.closePurchaseModal();
                    
                    // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                    await this.loadUserPoints();
                    await this.loadUserAvatars();
                    this.renderShopItems();
                    
                } catch (error) {
                    console.error('âŒ êµ¬ë§¤ ì‹¤íŒ¨:', error);
                    alert('êµ¬ë§¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            async equipAvatar(userAvatarId) {
                try {
                    // ëª¨ë“  ì•„ë°”íƒ€ ë¹„í™œì„±í™”
                    await window.semuApp.supabaseClient
                        .from('user_avatars')
                        .update({ is_active: false })
                        .eq('user_id', this.currentUser.id);
                    
                    // ì„ íƒí•œ ì•„ë°”íƒ€ í™œì„±í™”
                    const { error } = await window.semuApp.supabaseClient
                        .from('user_avatars')
                        .update({ is_active: true })
                        .eq('id', userAvatarId);
                    
                    if (error) throw error;
                    
                    alert('ì•„ë°”íƒ€ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    await this.loadUserAvatars();
                    
                } catch (error) {
                    console.error('âŒ ì•„ë°”íƒ€ ì°©ìš© ì‹¤íŒ¨:', error);
                    alert('ì•„ë°”íƒ€ ì°©ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            showError(message) {
                const loading = document.getElementById('shop-loading');
                loading.innerHTML = `
                    <div class="empty-state">
                        <h3>âŒ ì˜¤ë¥˜ ë°œìƒ</h3>
                        <p>${message}</p>
                    </div>
                `;
            }

            // ê°•ì œ í‘œì‹œ í•¨ìˆ˜
            forceDisplayAvatars() {
                console.log('ğŸ”§ ê°•ì œ í‘œì‹œ í•¨ìˆ˜ ì‹¤í–‰ ì¤‘...');
                
                const container = document.getElementById('shop-items');
                const loading = document.getElementById('shop-loading');
                
                if (!container) {
                    console.error('âŒ shop-items ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                    return;
                }
                
                // ë¡œë”© ì™„ì „íˆ ìˆ¨ê¸°ê¸°
                if (loading) {
                    loading.style.display = 'none';
                    loading.style.visibility = 'hidden';
                    loading.style.opacity = '0';
                    loading.style.height = '0';
                    loading.style.overflow = 'hidden';
                }
                
                // ì»¨í…Œì´ë„ˆ ê°•ì œ í‘œì‹œ
                container.style.cssText = `
                    display: grid !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)) !important;
                    gap: 25px !important;
                    margin-top: 20px !important;
                    min-height: 400px !important;
                    padding: 20px !important;
                    background: transparent !important;
                `;
                
                // ê° ì¹´ë“œ ê°•ì œ í‘œì‹œ
                const cards = container.querySelectorAll('.item-card');
                console.log(`ğŸ´ ë°œê²¬ëœ ì¹´ë“œ ìˆ˜: ${cards.length}`);
                
                cards.forEach((card, index) => {
                    card.style.cssText = `
                        display: block !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        min-height: 350px !important;
                        background: white !important;
                        border: 1px solid #e9ecef !important;
                        border-radius: 15px !important;
                        box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important;
                        padding: 16px !important;
                        margin: 0 !important;
                        position: relative !important;
                        overflow: hidden !important;
                        transition: all 0.3s ease !important;
                    `;
                    console.log(`âœ… ì¹´ë“œ ${index + 1} ê°•ì œ í‘œì‹œ ì™„ë£Œ`);
                });
                
                // íƒ­ ì»¨í…ì¸ ë„ í™•ì¸
                const tabContent = document.getElementById('shop-tab');
                if (tabContent) {
                    tabContent.style.display = 'block';
                    tabContent.style.visibility = 'visible';
                    tabContent.style.opacity = '1';
                    tabContent.classList.remove('hidden');
                }
                
                console.log('ğŸ¯ ê°•ì œ í‘œì‹œ ì™„ë£Œ!', {
                    containerDisplay: container.style.display,
                    containerVisibility: container.style.visibility,
                    containerOpacity: container.style.opacity,
                    cardsCount: cards.length,
                    tabContentDisplay: tabContent ? tabContent.style.display : 'N/A'
                });
            }
        }

        // ì „ì—­ í•¨ìˆ˜ë“¤
        function switchTab(tabName) {
            // íƒ­ ë²„íŠ¼ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // íƒ­ ì½˜í…ì¸  ì—…ë°ì´íŠ¸
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabName + '-tab').classList.remove('hidden');
        }

        function confirmPurchase() {
            avatarShop.confirmPurchase();
        }

        function closePurchaseModal() {
            avatarShop.closePurchaseModal();
        }

        // ì „ì—­ ê°•ì œ í‘œì‹œ í•¨ìˆ˜ (ì½˜ì†”ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)
        function forceShowAvatars() {
            if (window.avatarShop) {
                window.avatarShop.forceDisplayAvatars();
            } else {
                console.error('âŒ avatarShop ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const modal = document.getElementById('purchaseModal');
            if (event.target === modal) {
                avatarShop.closePurchaseModal();
            }
        }

        // ì•± ì´ˆê¸°í™”
        let avatarShop;
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ­ ì•„ë°”íƒ€ ìƒì  í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            
            // ë¨¼ì € ë¡œê·¸ì¸ ìƒíƒœë¥¼ ê°„ë‹¨íˆ í™•ì¸ (localStorageì—ì„œ)
            const quickAuthCheck = () => {
                try {
                    const supabaseSession = localStorage.getItem('sb-skpvtqohyspfsmvwrgoc-auth-token');
                    if (!supabaseSession) {
                        console.log('âš ï¸ ì €ì¥ëœ ì¸ì¦ í† í°ì´ ì—†ìŒ, ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™');
                        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        window.location.href = 'login.html';
                        return false;
                    }
                    return true;
                } catch (error) {
                    console.warn('âš ï¸ í† í° í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
                    return true; // ì˜¤ë¥˜ ë°œìƒì‹œ ê³„ì† ì§„í–‰
                }
            };
            
            if (quickAuthCheck()) {
                avatarShop = new AvatarShop();
            }
        });
    </script>
</body>
</html>
