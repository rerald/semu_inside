<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¡œí•„ - ì„¸ë¬´ì¸ì‚¬ì´ë“œ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/common.css">
    <style>
        .profile-container {
            display: flex;
            flex-direction: column;
            min-height: 600px;
        }

        .profile-layout {
            display: flex;
            gap: 30px;
            min-height: 80vh;
            margin-top: 20px;
        }

        .profile-sidebar {
            flex: 0 0 20%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 30px 20px;
            color: white;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            text-align: center;
        }

        .profile-main {
            flex: 1;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .sidebar-avatar {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            margin: 0 auto 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .sidebar-name {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .sidebar-email {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 30px;
        }

        .sidebar-stats {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        .category-performance {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .category-item {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 25px;
            border-left: 5px solid #007bff;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .category-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .category-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .category-stats {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .question-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
        }

        .accuracy-rate {
            font-size: 1.1rem;
            color: #28a745;
            font-weight: 600;
        }

        .rank-badge {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            white-space: nowrap;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .profile-layout {
                flex-direction: column;
                gap: 20px;
            }
            
            .profile-sidebar {
                flex: none;
            }
            
            .category-performance {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="container">
            <div class="profile-container">
                <!-- í—¤ë” -->
                <div class="header">
                    <div class="logo">
                        <i class="fas fa-graduation-cap"></i>
                        <h2>ì„¸ë¬´ì¸ì‚¬ì´ë“œ</h2>
                    </div>
                    <div class="nav-menu">
                        <a href="./dashboard.html" class="nav-link">
                            <i class="fas fa-home"></i> ëŒ€ì‹œë³´ë“œ
                        </a>
                        <a href="./exam.html" class="nav-link">
                            <i class="fas fa-clipboard-list"></i> ì‹œí—˜
                        </a>
                        <a href="./results.html" class="nav-link">
                            <i class="fas fa-chart-bar"></i> ê²°ê³¼
                        </a>
                        <a href="./profile.html" class="nav-link active">
                            <i class="fas fa-user"></i> í”„ë¡œí•„
                        </a>
                    </div>
                    <div class="user-menu">
                        <span class="user-name" id="userName">ì‚¬ìš©ìë‹˜</span>
                        <button class="btn btn-outline btn-small logout-btn">
                            <i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ
                        </button>
                    </div>
                </div>

                <!-- ìƒˆë¡œìš´ ë ˆì´ì•„ì›ƒ -->
                <div class="profile-layout">
                    <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” (20%) -->
                    <div class="profile-sidebar">
                        <div class="sidebar-avatar" id="profileAvatar">ì´</div>
                        <div class="sidebar-name" id="profileName">ì‚¬ìš©ìëª…</div>
                        <div class="sidebar-email" id="profileEmail">user@example.com</div>
                        
                        <div class="sidebar-stats">
                            <div class="stat-box">
                                <div class="stat-number" id="totalExamsCompleted">-</div>
                                <div class="stat-label">ì™„ë£Œí•œ ì‹œí—˜</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number" id="averageScore">-</div>
                                <div class="stat-label">í‰ê·  ì ìˆ˜</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number" id="ranking">-</div>
                                <div class="stat-label">ì „ì²´ ìˆœìœ„</div>
                            </div>
                        </div>
                    </div>

                    <!-- ìš°ì¸¡ ë©”ì¸ ì˜ì—­ (80%) -->
                    <div class="profile-main">
                        <h2 style="margin-bottom: 30px; color: #2c3e50;">ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ì„±ê³¼</h2>
                        <div class="category-performance" id="categoryPerformance">
                            <!-- ì¹´í…Œê³ ë¦¬ë³„ ì„±ê³¼ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    
    <!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="./assets/js/common.js"></script>
    
    <script>
        class ProfilePage {
            constructor() {
                this.init();
            }

            async init() {
                console.log('ğŸ‘¤ í”„ë¡œí•„ í˜ì´ì§€ ì´ˆê¸°í™”');
                
                // ì‚¬ìš©ì ì¸ì¦ í™•ì¸
                if (!await this.checkAuth()) {
                    return;
                }

                // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
                this.loadUserProfile();
                
                // í†µê³„ ì •ë³´ì™€ ì¹´í…Œê³ ë¦¬ë³„ ì„±ê³¼ë¥¼ ë³‘ë ¬ë¡œ ë¡œë“œ
                await Promise.all([
                    this.loadUserStats(),
                    this.loadCategoryPerformance()
                ]);
                
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                this.setupEventListeners();
            }

            async checkAuth() {
                console.log('â³ ì¸ì¦ ë° ì„¸ì…˜ ë³µì› ëŒ€ê¸° ì¤‘...');
                
                // common.js ì´ˆê¸°í™” ëŒ€ê¸°
                let retryCount = 0;
                while (!window.semuApp && retryCount < 30) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retryCount++;
                }

                if (!window.semuApp) {
                    console.error('âŒ common.js ì´ˆê¸°í™” ì‹¤íŒ¨');
                    window.location.href = './login.html';
                    return false;
                }

                console.log('ğŸ”„ ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘...');
                
                // window.semuApp.currentUserê°€ ìˆëŠ”ì§€ í™•ì¸
                if (!window.semuApp.currentUser) {
                    // ì„¸ì…˜ ë³µì›ì„ ìœ„í•´ ì•½ê°„ ë” ëŒ€ê¸°
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    if (!window.semuApp.currentUser) {
                        console.log('âŒ ì‚¬ìš©ì ì¸ì¦ ì‹¤íŒ¨, ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™');
                        window.location.href = './login.html';
                        return false;
                    }
                }

                console.log('âœ… ì‚¬ìš©ì ì¸ì¦ í™•ì¸ë¨:', window.semuApp.currentUser.email);
                console.log('âœ… ì‚¬ìš©ì ì •ë³´:', window.semuApp.currentUser);
                return true;
            }

            async loadUserStats() {
                try {
                    console.log('ğŸ“Š ì‚¬ìš©ì í†µê³„ ì •ë³´ ë¡œë“œ ì‹œì‘');
                    
                    const userId = window.semuApp.currentUser.id;
                    
                    // ì™„ë£Œëœ ì‹œí—˜ ìˆ˜ ì¡°íšŒ
                    const { data: completedExams, error: examsError } = await window.semuApp.supabaseClient
                        .from('exam_sessions')
                        .select('*')
                        .eq('employee_id', userId)
                        .eq('status', 'submitted');

                    if (!examsError && completedExams) {
                        document.getElementById('totalExamsCompleted').textContent = completedExams.length;
                        console.log('âœ… ì™„ë£Œëœ ì‹œí—˜ ìˆ˜:', completedExams.length);
                        
                        // í‰ê·  ì ìˆ˜ ê³„ì‚°
                        if (completedExams.length > 0) {
                            let totalScore = 0;
                            let validScores = 0;
                            
                            completedExams.forEach(exam => {
                                if (exam.score && exam.total_points) {
                                    const percentage = exam.score <= 100 ? 
                                        exam.score : 
                                        (exam.score / exam.total_points) * 100;
                                    totalScore += percentage;
                                    validScores++;
                                }
                            });
                            
                            if (validScores > 0) {
                                const averageScore = Math.round(totalScore / validScores);
                                document.getElementById('averageScore').textContent = averageScore;
                                console.log('âœ… í‰ê·  ì ìˆ˜:', averageScore);
                            }
                        }
                    }

                    // ì „ì²´ ìˆœìœ„ ê³„ì‚°
                    await this.calculateOverallRanking();

                } catch (error) {
                    console.error('âŒ í†µê³„ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            }

            async calculateOverallRanking() {
                try {
                    console.log('ğŸ† ì „ì²´ ìˆœìœ„ ê³„ì‚° ì‹œì‘');
                    
                    const currentUserId = window.semuApp.currentUser.id;
                    
                    // ëª¨ë“  ì‚¬ìš©ìì˜ í‰ê·  ì ìˆ˜ ê³„ì‚°
                    const { data: allUsers, error: userError } = await window.semuApp.supabaseClient
                        .from('profiles')
                        .select('id, name');

                    if (userError || !allUsers) {
                        console.error('âŒ ì „ì²´ ì‚¬ìš©ì ì¡°íšŒ ì‹¤íŒ¨:', userError);
                        return;
                    }

                    // ê° ì‚¬ìš©ìì˜ í‰ê·  ì ìˆ˜ ê³„ì‚°
                    const userScores = [];
                    
                    for (const user of allUsers) {
                        const { data: userExams, error: examError } = await window.semuApp.supabaseClient
                            .from('exam_sessions')
                            .select('score, total_points')
                            .eq('employee_id', user.id)
                            .eq('status', 'submitted');

                        if (!examError && userExams && userExams.length > 0) {
                            let totalScore = 0;
                            let totalCount = 0;
                            
                            userExams.forEach(exam => {
                                if (exam.score && exam.total_points) {
                                    if (exam.score <= 100) {
                                        totalScore += exam.score;
                                    } else {
                                        totalScore += (exam.score / exam.total_points) * 100;
                                    }
                                    totalCount++;
                                }
                            });
                            
                            if (totalCount > 0) {
                                const averageScore = totalScore / totalCount;
                                userScores.push({
                                    userId: user.id,
                                    name: user.name,
                                    averageScore: averageScore,
                                    examCount: totalCount
                                });
                            }
                        }
                    }

                    // í‰ê·  ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
                    userScores.sort((a, b) => {
                        if (b.averageScore !== a.averageScore) {
                            return b.averageScore - a.averageScore;
                        }
                        return b.examCount - a.examCount;
                    });

                    // í˜„ì¬ ì‚¬ìš©ìì˜ ìˆœìœ„ ì°¾ê¸°
                    const currentUserRank = userScores.findIndex(score => score.userId === currentUserId) + 1;
                    const totalUsers = userScores.length;

                    if (currentUserRank > 0) {
                        document.getElementById('ranking').textContent = `${currentUserRank}/${totalUsers}`;
                        console.log('âœ… ì „ì²´ ìˆœìœ„:', `${currentUserRank}/${totalUsers}`);
                    } else {
                        document.getElementById('ranking').textContent = '-';
                        console.log('âš ï¸ ìˆœìœ„ ê³„ì‚° ë¶ˆê°€ (ì‹œí—˜ ê¸°ë¡ ì—†ìŒ)');
                    }

                } catch (error) {
                    console.error('âŒ ì „ì²´ ìˆœìœ„ ê³„ì‚° ì‹¤íŒ¨:', error);
                    document.getElementById('ranking').textContent = '-';
                }
            }

            async loadCategoryPerformance() {
                try {
                    console.log('ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ì„±ê³¼ ë¡œë“œ ì‹œì‘');
                    
                    const userId = window.semuApp.currentUser.id;

                    // ì‚¬ìš©ìì˜ ëª¨ë“  ë‹µì•ˆì„ ì¹´í…Œê³ ë¦¬ ì •ë³´ì™€ í•¨ê»˜ ì¡°íšŒ
                    const { data: userAnswers, error: answersError } = await window.semuApp.supabaseClient
                        .from('exam_answers')
                        .select(`
                            *,
                            session_id,
                            exam_sessions!inner (
                                employee_id,
                                status
                            ),
                            questions (
                                id,
                                content,
                                category_id,
                                categories (
                                    id,
                                    name,
                                    code
                                )
                            )
                        `)
                        .eq('exam_sessions.employee_id', userId)
                        .eq('exam_sessions.status', 'submitted');

                    if (answersError || !userAnswers) {
                        console.error('âŒ ë‹µì•ˆ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:', answersError);
                        this.showNoCategoryData();
                        return;
                    }

                    console.log('ğŸ“Š ì¡°íšŒëœ ë‹µì•ˆ ë°ì´í„°:', userAnswers);
                    console.log('ğŸ“Š ì´ ë‹µì•ˆ ìˆ˜:', userAnswers.length);

                    // ì¹´í…Œê³ ë¦¬ë³„ í†µê³„ ê³„ì‚°
                    const categoryStats = {};
                    
                    userAnswers.forEach((answer, index) => {
                        const question = answer.questions;
                        const category = question?.categories;

                        console.log(`ğŸ“Š ë‹µì•ˆ ${index + 1}:`, {
                            questionId: question?.id,
                            categoryId: question?.category_id,
                            categoryName: category?.name || 'ì¹´í…Œê³ ë¦¬ ì—†ìŒ',
                            isCorrect: answer.is_correct
                        });

                        // ì¹´í…Œê³ ë¦¬ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ í†µê³„ì— í¬í•¨
                        if (category && category.name) {
                            const categoryKey = category.id;
                            
                            if (!categoryStats[categoryKey]) {
                                categoryStats[categoryKey] = {
                                    name: category.name,
                                    totalQuestions: 0,
                                    correctAnswers: 0
                                };
                            }
                            
                            categoryStats[categoryKey].totalQuestions++;
                            if (answer.is_correct) {
                                categoryStats[categoryKey].correctAnswers++;
                            }
                        }
                    });

                    console.log('ğŸ“Š ìµœì¢… ì¹´í…Œê³ ë¦¬ë³„ í†µê³„:', categoryStats);

                    // ì¹´í…Œê³ ë¦¬ë³„ ìˆœìœ„ ê³„ì‚° í›„ ë Œë”ë§
                    await this.calculateCategoryRankings(categoryStats);
                    this.renderCategoryPerformance(categoryStats);

                } catch (error) {
                    console.error('âŒ ì¹´í…Œê³ ë¦¬ë³„ ì„±ê³¼ ë¡œë“œ ì‹¤íŒ¨:', error);
                    this.showNoCategoryData();
                }
            }

            async calculateCategoryRankings(userCategoryStats) {
                try {
                    console.log('ğŸ† ì¹´í…Œê³ ë¦¬ë³„ ìˆœìœ„ ê³„ì‚° ì‹œì‘');
                    
                    // ëª¨ë“  ì‚¬ìš©ìì˜ ì¹´í…Œê³ ë¦¬ë³„ ì„±ê³¼ ì¡°íšŒ
                    const { data: allAnswers, error: answersError } = await window.semuApp.supabaseClient
                        .from('exam_answers')
                        .select(`
                            *,
                            session_id,
                            exam_sessions!inner (
                                employee_id,
                                status
                            ),
                            questions (
                                id,
                                content,
                                category_id,
                                categories (
                                    id,
                                    name,
                                    code
                                )
                            )
                        `)
                        .eq('exam_sessions.status', 'submitted');

                    if (answersError || !allAnswers) {
                        console.error('âŒ ì „ì²´ ì‚¬ìš©ì ë‹µì•ˆ ì¡°íšŒ ì‹¤íŒ¨:', answersError);
                        return;
                    }

                    const currentUserId = window.semuApp.currentUser.id;
                    
                    // ê° ì¹´í…Œê³ ë¦¬ë³„ë¡œ ìˆœìœ„ ê³„ì‚°
                    for (const [categoryId, userStats] of Object.entries(userCategoryStats)) {
                        console.log(`ğŸ† ${userStats.name} ì¹´í…Œê³ ë¦¬ ìˆœìœ„ ê³„ì‚° ì¤‘...`);
                        
                        const userAccuracies = {};
                        
                        // ì´ ì¹´í…Œê³ ë¦¬ì˜ ëª¨ë“  ë‹µì•ˆ í•„í„°ë§
                        const categoryAnswers = allAnswers.filter(answer => 
                            answer.questions?.category_id === categoryId
                        );
                        
                        console.log(`ğŸ“Š ${userStats.name} ì¹´í…Œê³ ë¦¬ ì´ ë‹µì•ˆ ìˆ˜:`, categoryAnswers.length);
                        
                        // ê° ì‚¬ìš©ìë³„ë¡œ ì´ ì¹´í…Œê³ ë¦¬ì˜ ì •ë‹µë¥  ê³„ì‚°
                        categoryAnswers.forEach(answer => {
                            const userId = answer.exam_sessions.employee_id;
                            if (!userAccuracies[userId]) {
                                userAccuracies[userId] = { correct: 0, total: 0 };
                            }
                            userAccuracies[userId].total++;
                            if (answer.is_correct) {
                                userAccuracies[userId].correct++;
                            }
                        });

                        // ì •ë‹µë¥ ë¡œ ë³€í™˜í•˜ê³  ì •ë ¬
                        const userAccuracyArray = Object.entries(userAccuracies)
                            .map(([userId, stats]) => ({
                                userId,
                                accuracy: (stats.correct / stats.total) * 100
                            }))
                            .sort((a, b) => b.accuracy - a.accuracy); // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬

                        console.log(`ğŸ“Š ${userStats.name} ì¹´í…Œê³ ë¦¬ ì‚¬ìš©ì ì •ë‹µë¥ :`, userAccuracyArray);

                        // í˜„ì¬ ì‚¬ìš©ìì˜ ìˆœìœ„ ì°¾ê¸°
                        const userRank = userAccuracyArray.findIndex(user => user.userId === currentUserId) + 1;
                        const totalUsers = userAccuracyArray.length;

                        console.log(`ğŸ† ${userStats.name} ìˆœìœ„: ${userRank}/${totalUsers}`);

                        if (userRank > 0 && totalUsers > 0) {
                            const rankPercent = Math.round((userRank / totalUsers) * 100);
                            userStats.rankPercent = rankPercent;
                            console.log(`ğŸ† ${userStats.name} ìƒìœ„: ${rankPercent}%`);
                        } else {
                            userStats.rankPercent = 100; // ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ì˜¤ë¥˜ ì‹œ 100%
                            console.log(`âš ï¸ ${userStats.name} ìˆœìœ„ ê³„ì‚° ì‹¤íŒ¨, ê¸°ë³¸ê°’ 100% ì„¤ì •`);
                        }
                    }
                    
                    console.log('ğŸ† ì¹´í…Œê³ ë¦¬ë³„ ìˆœìœ„ ê³„ì‚° ì™„ë£Œ');
                } catch (error) {
                    console.error('âŒ ì¹´í…Œê³ ë¦¬ë³„ ìˆœìœ„ ê³„ì‚° ì‹¤íŒ¨:', error);
                    // ì˜¤ë¥˜ ì‹œ ëª¨ë“  ì¹´í…Œê³ ë¦¬ì— ê¸°ë³¸ê°’ ì„¤ì •
                    Object.values(userCategoryStats).forEach(stats => {
                        stats.rankPercent = 100;
                    });
                }
            }

            renderCategoryPerformance(categoryStats) {
                const container = document.getElementById('categoryPerformance');
                if (!container) return;

                const categoriesWithData = Object.entries(categoryStats).filter(([_, stats]) => stats.totalQuestions > 0);

                if (categoriesWithData.length === 0) {
                    this.showNoCategoryData();
                    return;
                }

                let html = '';
                categoriesWithData.forEach(([categoryId, stats]) => {
                    const accuracy = Math.round((stats.correctAnswers / stats.totalQuestions) * 100);
                    const rankPercent = stats.rankPercent || 100; // ê³„ì‚°ëœ ìˆœìœ„ ë˜ëŠ” ê¸°ë³¸ê°’ 100%
                    
                    html += `
                        <div class="category-item">
                            <div class="category-title">${stats.name}</div>
                            <div class="category-stats">
                                <div class="question-count">
                                    ${stats.correctAnswers} / ${stats.totalQuestions}ë¬¸ì œ
                                </div>
                                <div class="accuracy-rate">
                                    ì •ë‹µë¥  ${accuracy}%
                                </div>
                                <div class="rank-badge">
                                    ìƒìœ„ ${rankPercent}%
                                </div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                console.log(`âœ… ${categoriesWithData.length}ê°œ ì¹´í…Œê³ ë¦¬ ì„±ê³¼ í‘œì‹œ ì™„ë£Œ`);
            }



            showNoCategoryData() {
                const container = document.getElementById('categoryPerformance');
                if (!container) return;

                container.innerHTML = `
                    <div class="category-item" style="text-align: center; grid-column: 1 / -1;">
                        <i class="fas fa-info-circle" style="font-size: 2rem; color: #6c757d; margin-bottom: 15px;"></i>
                        <div style="color: #6c757d; font-size: 1.1rem; margin-bottom: 5px;">ì•„ì§ ì¹´í…Œê³ ë¦¬ë³„ ì„±ê³¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                        <div style="color: #adb5bd; font-size: 0.9rem;">ì‹œí—˜ì„ ì‘ì‹œí•˜ë©´ ì—¬ê¸°ì— ì¹´í…Œê³ ë¦¬ë³„ ì„±ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
                    </div>
                `;
            }

            loadUserProfile() {
                console.log('ğŸ” ì‚¬ìš©ì í”„ë¡œí•„ ë¡œë“œ ì‹œì‘');
                const user = window.semuApp.currentUser;
                if (!user) {
                    console.error('âŒ ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }

                console.log('ğŸ‘¤ ë¡œë“œí•  ì‚¬ìš©ì ì •ë³´:', user);

                try {
                    // í—¤ë” ì •ë³´
                    const userNameElement = document.getElementById('userName');
                    if (userNameElement) {
                        userNameElement.textContent = user.name + 'ë‹˜';
                        console.log('âœ… í—¤ë” ì‚¬ìš©ìëª… ì„¤ì •:', user.name + 'ë‹˜');
                    }
                    
                    // í”„ë¡œí•„ ì‚¬ì´ë“œë°”
                    const profileNameElement = document.getElementById('profileName');
                    if (profileNameElement) {
                        profileNameElement.textContent = user.name;
                        console.log('âœ… í”„ë¡œí•„ ì´ë¦„ ì„¤ì •:', user.name);
                    }
                    
                    const profileEmailElement = document.getElementById('profileEmail');
                    if (profileEmailElement) {
                        profileEmailElement.textContent = user.email;
                        console.log('âœ… í”„ë¡œí•„ ì´ë©”ì¼ ì„¤ì •:', user.email);
                    }
                    
                    // ì•„ë°”íƒ€ (ì´ë¦„ì˜ ì²« ê¸€ì)
                    const avatarElement = document.getElementById('profileAvatar');
                    if (avatarElement) {
                        avatarElement.textContent = user.name.charAt(0);
                        console.log('âœ… ì•„ë°”íƒ€ ì„¤ì •:', user.name.charAt(0));
                    }
                    
                    console.log('âœ… ì‚¬ìš©ì í”„ë¡œí•„ ë¡œë“œ ì™„ë£Œ');
                } catch (error) {
                    console.error('âŒ í”„ë¡œí•„ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                }
            }

            setupEventListeners() {
                // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ (ê°œì„ ëœ ì˜¤ë¥˜ ì²˜ë¦¬)
                const logoutBtn = document.querySelector('.logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', async () => {
                        try {
                            console.log('ğŸ”„ í”„ë¡œí•„ í˜ì´ì§€ì—ì„œ ë¡œê·¸ì•„ì›ƒ ì‹œë„...');
                            await window.semuApp.logout();
                        } catch (error) {
                            console.error('âŒ ì¼ë°˜ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨, ê°•ì œ ë¡œê·¸ì•„ì›ƒ ì‹œë„:', error);
                            
                            // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ í›„ ê°•ì œ ë¡œê·¸ì•„ì›ƒ
                            if (confirm('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê°•ì œë¡œ ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                window.semuApp.forceLogout();
                            }
                        }
                    });
                }
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“± í”„ë¡œí•„ í˜ì´ì§€ DOM ë¡œë“œ ì™„ë£Œ');
            
            // Supabase ì´ˆê¸°í™” ëŒ€ê¸°
            if (typeof window.supabase !== 'undefined') {
                console.log('âœ… Supabase ì´ˆê¸°í™” ì™„ë£Œ');
            }
            
            // common.js ë¡œë“œ ëŒ€ê¸° í›„ í”„ë¡œí•„ í˜ì´ì§€ ì´ˆê¸°í™”
            if (window.semuApp) {
                console.log('âœ… common.js ì´ˆê¸°í™” ì™„ë£Œ, í”„ë¡œí•„ í˜ì´ì§€ ìƒì„±');
                new ProfilePage();
            } else {
                console.log('â³ common.js ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘...');
                window.addEventListener('semuAppReady', () => {
                    console.log('âœ… common.js ì´ˆê¸°í™” ì™„ë£Œ, í”„ë¡œí•„ í˜ì´ì§€ ìƒì„±');
                    new ProfilePage();
                });
            }
        });
    </script>
</body>
</html>
