<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>프로필 - 세무인사이드</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/common.css">
    <style>
        .profile-container {
            display: flex;
            flex-direction: column;
            min-height: 600px;
        }

        .profile-layout {
            display: flex;
            gap: 30px;
            min-height: 80vh;
            margin-top: 20px;
        }

        .profile-sidebar {
            flex: 0 0 20%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 30px 20px;
            color: white;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            text-align: center;
        }

        .profile-main {
            flex: 1;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .sidebar-avatar {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            margin: 0 auto 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .sidebar-name {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .sidebar-email {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 30px;
        }

        .sidebar-stats {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        .category-performance {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .category-item {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 25px;
            border-left: 5px solid #007bff;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .category-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .category-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .category-stats {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .question-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
        }

        .accuracy-rate {
            font-size: 1.1rem;
            color: #28a745;
            font-weight: 600;
        }

        .rank-badge {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            white-space: nowrap;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .profile-layout {
                flex-direction: column;
                gap: 20px;
            }
            
            .profile-sidebar {
                flex: none;
            }
            
            .category-performance {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="container">
            <div class="profile-container">
                <!-- 헤더 -->
                <div class="header">
                    <div class="logo">
                        <i class="fas fa-graduation-cap"></i>
                        <h2>세무인사이드</h2>
                    </div>
                    <div class="nav-menu">
                        <a href="./dashboard.html" class="nav-link">
                            <i class="fas fa-home"></i> 대시보드
                        </a>
                        <a href="./exam.html" class="nav-link">
                            <i class="fas fa-clipboard-list"></i> 시험
                        </a>
                        <a href="./results.html" class="nav-link">
                            <i class="fas fa-chart-bar"></i> 결과
                        </a>
                        <a href="./profile.html" class="nav-link active">
                            <i class="fas fa-user"></i> 프로필
                        </a>
                    </div>
                    <div class="user-menu">
                        <span class="user-name" id="userName">사용자님</span>
                        <button class="btn btn-outline btn-small logout-btn">
                            <i class="fas fa-sign-out-alt"></i> 로그아웃
                        </button>
                    </div>
                </div>

                <!-- 새로운 레이아웃 -->
                <div class="profile-layout">
                    <!-- 좌측 사이드바 (20%) -->
                    <div class="profile-sidebar">
                        <div class="sidebar-avatar" id="profileAvatar">이</div>
                        <div class="sidebar-name" id="profileName">사용자명</div>
                        <div class="sidebar-email" id="profileEmail">user@example.com</div>
                        
                        <div class="sidebar-stats">
                            <div class="stat-box">
                                <div class="stat-number" id="totalExamsCompleted">-</div>
                                <div class="stat-label">완료한 시험</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number" id="averageScore">-</div>
                                <div class="stat-label">평균 점수</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number" id="ranking">-</div>
                                <div class="stat-label">전체 순위</div>
                            </div>
                        </div>
                    </div>

                    <!-- 우측 메인 영역 (80%) -->
                    <div class="profile-main">
                        <h2 style="margin-bottom: 30px; color: #2c3e50;">📊 카테고리별 성과</h2>
                        <div class="category-performance" id="categoryPerformance">
                            <!-- 카테고리별 성과 데이터가 여기에 표시됩니다 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    
    <!-- 공통 스크립트 -->
    <script src="./assets/js/common.js"></script>
    
    <script>
        class ProfilePage {
            constructor() {
                this.init();
            }

            async init() {
                console.log('👤 프로필 페이지 초기화');
                
                // 사용자 인증 확인
                if (!await this.checkAuth()) {
                    return;
                }

                // 사용자 정보 로드
                this.loadUserProfile();
                
                // 통계 정보와 카테고리별 성과를 병렬로 로드
                await Promise.all([
                    this.loadUserStats(),
                    this.loadCategoryPerformance()
                ]);
                
                // 이벤트 리스너 설정
                this.setupEventListeners();
            }

            async checkAuth() {
                console.log('⏳ 인증 및 세션 복원 대기 중...');
                
                // common.js 초기화 대기
                let retryCount = 0;
                while (!window.semuApp && retryCount < 30) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retryCount++;
                }

                if (!window.semuApp) {
                    console.error('❌ common.js 초기화 실패');
                    window.location.href = './login.html';
                    return false;
                }

                console.log('🔄 인증 상태 확인 중...');
                
                // window.semuApp.currentUser가 있는지 확인
                if (!window.semuApp.currentUser) {
                    // 세션 복원을 위해 약간 더 대기
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    if (!window.semuApp.currentUser) {
                        console.log('❌ 사용자 인증 실패, 로그인 페이지로 이동');
                        window.location.href = './login.html';
                        return false;
                    }
                }

                console.log('✅ 사용자 인증 확인됨:', window.semuApp.currentUser.email);
                console.log('✅ 사용자 정보:', window.semuApp.currentUser);
                return true;
            }

            async loadUserStats() {
                try {
                    console.log('📊 사용자 통계 정보 로드 시작');
                    
                    const userId = window.semuApp.currentUser.id;
                    
                    // 완료된 시험 수 조회
                    const { data: completedExams, error: examsError } = await window.semuApp.supabaseClient
                        .from('exam_sessions')
                        .select('*')
                        .eq('employee_id', userId)
                        .eq('status', 'submitted');

                    if (!examsError && completedExams) {
                        document.getElementById('totalExamsCompleted').textContent = completedExams.length;
                        console.log('✅ 완료된 시험 수:', completedExams.length);
                        
                        // 평균 점수 계산
                        if (completedExams.length > 0) {
                            let totalScore = 0;
                            let validScores = 0;
                            
                            completedExams.forEach(exam => {
                                if (exam.score && exam.total_points) {
                                    const percentage = exam.score <= 100 ? 
                                        exam.score : 
                                        (exam.score / exam.total_points) * 100;
                                    totalScore += percentage;
                                    validScores++;
                                }
                            });
                            
                            if (validScores > 0) {
                                const averageScore = Math.round(totalScore / validScores);
                                document.getElementById('averageScore').textContent = averageScore;
                                console.log('✅ 평균 점수:', averageScore);
                            }
                        }
                    }

                    // 전체 순위 계산
                    await this.calculateOverallRanking();

                } catch (error) {
                    console.error('❌ 통계 정보 로드 실패:', error);
                }
            }

            async calculateOverallRanking() {
                try {
                    console.log('🏆 전체 순위 계산 시작');
                    
                    const currentUserId = window.semuApp.currentUser.id;
                    
                    // 모든 사용자의 평균 점수 계산
                    const { data: allUsers, error: userError } = await window.semuApp.supabaseClient
                        .from('profiles')
                        .select('id, name');

                    if (userError || !allUsers) {
                        console.error('❌ 전체 사용자 조회 실패:', userError);
                        return;
                    }

                    // 각 사용자의 평균 점수 계산
                    const userScores = [];
                    
                    for (const user of allUsers) {
                        const { data: userExams, error: examError } = await window.semuApp.supabaseClient
                            .from('exam_sessions')
                            .select('score, total_points')
                            .eq('employee_id', user.id)
                            .eq('status', 'submitted');

                        if (!examError && userExams && userExams.length > 0) {
                            let totalScore = 0;
                            let totalCount = 0;
                            
                            userExams.forEach(exam => {
                                if (exam.score && exam.total_points) {
                                    if (exam.score <= 100) {
                                        totalScore += exam.score;
                                    } else {
                                        totalScore += (exam.score / exam.total_points) * 100;
                                    }
                                    totalCount++;
                                }
                            });
                            
                            if (totalCount > 0) {
                                const averageScore = totalScore / totalCount;
                                userScores.push({
                                    userId: user.id,
                                    name: user.name,
                                    averageScore: averageScore,
                                    examCount: totalCount
                                });
                            }
                        }
                    }

                    // 평균 점수 기준으로 내림차순 정렬
                    userScores.sort((a, b) => {
                        if (b.averageScore !== a.averageScore) {
                            return b.averageScore - a.averageScore;
                        }
                        return b.examCount - a.examCount;
                    });

                    // 현재 사용자의 순위 찾기
                    const currentUserRank = userScores.findIndex(score => score.userId === currentUserId) + 1;
                    const totalUsers = userScores.length;

                    if (currentUserRank > 0) {
                        document.getElementById('ranking').textContent = `${currentUserRank}/${totalUsers}`;
                        console.log('✅ 전체 순위:', `${currentUserRank}/${totalUsers}`);
                    } else {
                        document.getElementById('ranking').textContent = '-';
                        console.log('⚠️ 순위 계산 불가 (시험 기록 없음)');
                    }

                } catch (error) {
                    console.error('❌ 전체 순위 계산 실패:', error);
                    document.getElementById('ranking').textContent = '-';
                }
            }

            async loadCategoryPerformance() {
                try {
                    console.log('📊 카테고리별 성과 로드 시작');
                    
                    const userId = window.semuApp.currentUser.id;

                    // 사용자의 모든 답안을 카테고리 정보와 함께 조회
                    const { data: userAnswers, error: answersError } = await window.semuApp.supabaseClient
                        .from('exam_answers')
                        .select(`
                            *,
                            session_id,
                            exam_sessions!inner (
                                employee_id,
                                status
                            ),
                            questions (
                                id,
                                content,
                                category_id,
                                categories (
                                    id,
                                    name,
                                    code
                                )
                            )
                        `)
                        .eq('exam_sessions.employee_id', userId)
                        .eq('exam_sessions.status', 'submitted');

                    if (answersError || !userAnswers) {
                        console.error('❌ 답안 데이터 조회 실패:', answersError);
                        this.showNoCategoryData();
                        return;
                    }

                    console.log('📊 조회된 답안 데이터:', userAnswers);
                    console.log('📊 총 답안 수:', userAnswers.length);

                    // 카테고리별 통계 계산
                    const categoryStats = {};
                    
                    userAnswers.forEach((answer, index) => {
                        const question = answer.questions;
                        const category = question?.categories;

                        console.log(`📊 답안 ${index + 1}:`, {
                            questionId: question?.id,
                            categoryId: question?.category_id,
                            categoryName: category?.name || '카테고리 없음',
                            isCorrect: answer.is_correct
                        });

                        // 카테고리가 있는 경우에만 통계에 포함
                        if (category && category.name) {
                            const categoryKey = category.id;
                            
                            if (!categoryStats[categoryKey]) {
                                categoryStats[categoryKey] = {
                                    name: category.name,
                                    totalQuestions: 0,
                                    correctAnswers: 0
                                };
                            }
                            
                            categoryStats[categoryKey].totalQuestions++;
                            if (answer.is_correct) {
                                categoryStats[categoryKey].correctAnswers++;
                            }
                        }
                    });

                    console.log('📊 최종 카테고리별 통계:', categoryStats);

                    // 카테고리별 순위 계산 후 렌더링
                    await this.calculateCategoryRankings(categoryStats);
                    this.renderCategoryPerformance(categoryStats);

                } catch (error) {
                    console.error('❌ 카테고리별 성과 로드 실패:', error);
                    this.showNoCategoryData();
                }
            }

            async calculateCategoryRankings(userCategoryStats) {
                try {
                    console.log('🏆 카테고리별 순위 계산 시작');
                    
                    // 모든 사용자의 카테고리별 성과 조회
                    const { data: allAnswers, error: answersError } = await window.semuApp.supabaseClient
                        .from('exam_answers')
                        .select(`
                            *,
                            session_id,
                            exam_sessions!inner (
                                employee_id,
                                status
                            ),
                            questions (
                                id,
                                content,
                                category_id,
                                categories (
                                    id,
                                    name,
                                    code
                                )
                            )
                        `)
                        .eq('exam_sessions.status', 'submitted');

                    if (answersError || !allAnswers) {
                        console.error('❌ 전체 사용자 답안 조회 실패:', answersError);
                        return;
                    }

                    const currentUserId = window.semuApp.currentUser.id;
                    
                    // 각 카테고리별로 순위 계산
                    for (const [categoryId, userStats] of Object.entries(userCategoryStats)) {
                        console.log(`🏆 ${userStats.name} 카테고리 순위 계산 중...`);
                        
                        const userAccuracies = {};
                        
                        // 이 카테고리의 모든 답안 필터링
                        const categoryAnswers = allAnswers.filter(answer => 
                            answer.questions?.category_id === categoryId
                        );
                        
                        console.log(`📊 ${userStats.name} 카테고리 총 답안 수:`, categoryAnswers.length);
                        
                        // 각 사용자별로 이 카테고리의 정답률 계산
                        categoryAnswers.forEach(answer => {
                            const userId = answer.exam_sessions.employee_id;
                            if (!userAccuracies[userId]) {
                                userAccuracies[userId] = { correct: 0, total: 0 };
                            }
                            userAccuracies[userId].total++;
                            if (answer.is_correct) {
                                userAccuracies[userId].correct++;
                            }
                        });

                        // 정답률로 변환하고 정렬
                        const userAccuracyArray = Object.entries(userAccuracies)
                            .map(([userId, stats]) => ({
                                userId,
                                accuracy: (stats.correct / stats.total) * 100
                            }))
                            .sort((a, b) => b.accuracy - a.accuracy); // 내림차순 정렬

                        console.log(`📊 ${userStats.name} 카테고리 사용자 정답률:`, userAccuracyArray);

                        // 현재 사용자의 순위 찾기
                        const userRank = userAccuracyArray.findIndex(user => user.userId === currentUserId) + 1;
                        const totalUsers = userAccuracyArray.length;

                        console.log(`🏆 ${userStats.name} 순위: ${userRank}/${totalUsers}`);

                        if (userRank > 0 && totalUsers > 0) {
                            const rankPercent = Math.round((userRank / totalUsers) * 100);
                            userStats.rankPercent = rankPercent;
                            console.log(`🏆 ${userStats.name} 상위: ${rankPercent}%`);
                        } else {
                            userStats.rankPercent = 100; // 데이터가 없거나 오류 시 100%
                            console.log(`⚠️ ${userStats.name} 순위 계산 실패, 기본값 100% 설정`);
                        }
                    }
                    
                    console.log('🏆 카테고리별 순위 계산 완료');
                } catch (error) {
                    console.error('❌ 카테고리별 순위 계산 실패:', error);
                    // 오류 시 모든 카테고리에 기본값 설정
                    Object.values(userCategoryStats).forEach(stats => {
                        stats.rankPercent = 100;
                    });
                }
            }

            renderCategoryPerformance(categoryStats) {
                const container = document.getElementById('categoryPerformance');
                if (!container) return;

                const categoriesWithData = Object.entries(categoryStats).filter(([_, stats]) => stats.totalQuestions > 0);

                if (categoriesWithData.length === 0) {
                    this.showNoCategoryData();
                    return;
                }

                let html = '';
                categoriesWithData.forEach(([categoryId, stats]) => {
                    const accuracy = Math.round((stats.correctAnswers / stats.totalQuestions) * 100);
                    const rankPercent = stats.rankPercent || 100; // 계산된 순위 또는 기본값 100%
                    
                    html += `
                        <div class="category-item">
                            <div class="category-title">${stats.name}</div>
                            <div class="category-stats">
                                <div class="question-count">
                                    ${stats.correctAnswers} / ${stats.totalQuestions}문제
                                </div>
                                <div class="accuracy-rate">
                                    정답률 ${accuracy}%
                                </div>
                                <div class="rank-badge">
                                    상위 ${rankPercent}%
                                </div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                console.log(`✅ ${categoriesWithData.length}개 카테고리 성과 표시 완료`);
            }



            showNoCategoryData() {
                const container = document.getElementById('categoryPerformance');
                if (!container) return;

                container.innerHTML = `
                    <div class="category-item" style="text-align: center; grid-column: 1 / -1;">
                        <i class="fas fa-info-circle" style="font-size: 2rem; color: #6c757d; margin-bottom: 15px;"></i>
                        <div style="color: #6c757d; font-size: 1.1rem; margin-bottom: 5px;">아직 카테고리별 성과 데이터가 없습니다.</div>
                        <div style="color: #adb5bd; font-size: 0.9rem;">시험을 응시하면 여기에 카테고리별 성과가 표시됩니다.</div>
                    </div>
                `;
            }

            loadUserProfile() {
                console.log('🔍 사용자 프로필 로드 시작');
                const user = window.semuApp.currentUser;
                if (!user) {
                    console.error('❌ 사용자 정보가 없습니다');
                    return;
                }

                console.log('👤 로드할 사용자 정보:', user);

                try {
                    // 헤더 정보
                    const userNameElement = document.getElementById('userName');
                    if (userNameElement) {
                        userNameElement.textContent = user.name + '님';
                        console.log('✅ 헤더 사용자명 설정:', user.name + '님');
                    }
                    
                    // 프로필 사이드바
                    const profileNameElement = document.getElementById('profileName');
                    if (profileNameElement) {
                        profileNameElement.textContent = user.name;
                        console.log('✅ 프로필 이름 설정:', user.name);
                    }
                    
                    const profileEmailElement = document.getElementById('profileEmail');
                    if (profileEmailElement) {
                        profileEmailElement.textContent = user.email;
                        console.log('✅ 프로필 이메일 설정:', user.email);
                    }
                    
                    // 아바타 (이름의 첫 글자)
                    const avatarElement = document.getElementById('profileAvatar');
                    if (avatarElement) {
                        avatarElement.textContent = user.name.charAt(0);
                        console.log('✅ 아바타 설정:', user.name.charAt(0));
                    }
                    
                    console.log('✅ 사용자 프로필 로드 완료');
                } catch (error) {
                    console.error('❌ 프로필 로드 중 오류:', error);
                }
            }

            setupEventListeners() {
                // 로그아웃 버튼 (개선된 오류 처리)
                const logoutBtn = document.querySelector('.logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', async () => {
                        try {
                            console.log('🔄 프로필 페이지에서 로그아웃 시도...');
                            await window.semuApp.logout();
                        } catch (error) {
                            console.error('❌ 일반 로그아웃 실패, 강제 로그아웃 시도:', error);
                            
                            // 사용자에게 알림 후 강제 로그아웃
                            if (confirm('로그아웃 중 오류가 발생했습니다. 강제로 로그아웃하시겠습니까?')) {
                                window.semuApp.forceLogout();
                            }
                        }
                    });
                }
            }
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', () => {
            console.log('📱 프로필 페이지 DOM 로드 완료');
            
            // Supabase 초기화 대기
            if (typeof window.supabase !== 'undefined') {
                console.log('✅ Supabase 초기화 완료');
            }
            
            // common.js 로드 대기 후 프로필 페이지 초기화
            if (window.semuApp) {
                console.log('✅ common.js 초기화 완료, 프로필 페이지 생성');
                new ProfilePage();
            } else {
                console.log('⏳ common.js 초기화 대기 중...');
                window.addEventListener('semuAppReady', () => {
                    console.log('✅ common.js 초기화 완료, 프로필 페이지 생성');
                    new ProfilePage();
                });
            }
        });
    </script>
</body>
</html>
