<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>대시보드 - 세무인사이드</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/common.css">
    <style>
        .dashboard-container {
            display: flex;
            flex-direction: column;
            min-height: 600px;
        }

        .main-content {
            flex: 1;
            padding: 30px;
            background: #f8f9fa;
        }

        .welcome-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .welcome-section h2 {
            color: var(--dark-gray);
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        .welcome-section p {
            color: var(--medium-gray);
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .stat-icon.exams {
            color: #667eea;
        }

        .stat-icon.completed {
            color: #28a745;
        }

        .stat-icon.pending {
            color: #ffc107;
        }

        .stat-icon.score {
            color: #17a2b8;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 5px;
            transition: transform 0.2s ease-in-out;
        }

        .stat-label {
            color: var(--medium-gray);
            font-size: 0.9rem;
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--dark-gray);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .exam-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s;
            cursor: pointer;
        }

        .exam-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .exam-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .exam-score-info {
            text-align: right;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .score-badge {
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .score-badge.excellent {
            background: linear-gradient(135deg, #28a745, #20c997);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .score-badge.good {
            background: linear-gradient(135deg, #17a2b8, #20c997);
            box-shadow: 0 2px 8px rgba(23, 162, 184, 0.3);
        }

        .score-badge.average {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
        }

        .score-badge.poor {
            background: linear-gradient(135deg, #dc3545, #e83e8c);
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }

        .score-detail {
            color: var(--medium-gray);
            font-size: 0.8rem;
            font-weight: 500;
        }

        .exam-title {
            font-size: 1.3rem;
            color: var(--dark-gray);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .exam-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .exam-status.available {
            background: #d4edda;
            color: #155724;
        }

        .exam-status.completed {
            background: #cce7ff;
            color: #004085;
        }

        .exam-status.scheduled {
            background: #fff3cd;
            color: #856404;
        }

        .exam-description {
            color: var(--medium-gray);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .exam-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: var(--medium-gray);
        }

        .exam-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .exam-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .quick-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            text-decoration: none;
            color: var(--dark-gray);
            transition: all 0.3s;
            font-weight: 500;
        }

        .quick-action-btn:hover {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        .quick-action-btn i {
            font-size: 1.2rem;
        }

        /* 로딩 및 오류 상태 스타일 */
        .loading-exams {
            text-align: center;
            padding: 40px 20px;
            color: var(--medium-gray);
        }

        .loading-exams i {
            font-size: 2rem;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .loading-exams p {
            margin: 0;
            font-size: 1.1rem;
        }

        .no-exams {
            text-align: center;
            padding: 40px 20px;
            color: var(--medium-gray);
        }

        .no-exams i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #dee2e6;
        }

        .no-exams p {
            margin: 0 0 10px 0;
            font-size: 1.1rem;
        }

        .no-exams small {
            color: #adb5bd;
        }

        .error-message {
            text-align: center;
            padding: 40px 20px;
            color: #dc3545;
        }

        .error-message i {
            font-size: 2rem;
            margin-bottom: 15px;
        }

        .error-message p {
            margin: 0;
            font-size: 1.1rem;
        }

        /* 시험 상태별 스타일 */
        .exam-status.completed {
            background-color: #28a745;
            color: white;
        }

        .exam-status.in-progress {
            background-color: #ffc107;
            color: #212529;
        }

        .exam-status.scheduled {
            background-color: #17a2b8;
            color: white;
        }

        .exam-status.expired {
            background-color: #6c757d;
            color: white;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .quick-actions {
                flex-direction: column;
            }
            
            .exam-meta {
                flex-direction: column;
                gap: 10px;
            }
            
            .exam-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="container">
            <div class="dashboard-container">
                <!-- 헤더 -->
                <div class="header">
                    <div class="logo">
                        <i class="fas fa-graduation-cap"></i>
                        <h2>세무인사이드</h2>
                    </div>
                    <div class="nav-menu">
                        <a href="./dashboard.html" class="nav-link active">
                            <i class="fas fa-home"></i> 대시보드
                        </a>
                        <a href="./exam.html" class="nav-link">
                            <i class="fas fa-clipboard-list"></i> 시험
                        </a>
                        <a href="#" onclick="showLatestResult()" class="nav-link">
                            <i class="fas fa-chart-bar"></i> 결과
                        </a>
                        <a href="./profile.html" class="nav-link">
                            <i class="fas fa-user"></i> 프로필
                        </a>
                        <a href="./admin.html" class="nav-link admin-only hidden">
                            <i class="fas fa-cog"></i> 관리
                        </a>
                    </div>
                    <div class="user-menu">
                        <span class="user-name" id="userName">사용자님</span>
                        <button class="btn btn-outline btn-small logout-btn">
                            <i class="fas fa-sign-out-alt"></i> 로그아웃
                        </button>
                    </div>
                </div>

                <!-- 메인 콘텐츠 -->
                <div class="main-content">
                    <!-- 환영 섹션 -->
                    <div class="welcome-section">
                        <h2 id="welcomeMessage">안녕하세요!</h2>
                        <p>오늘도 열심히 학습하고 성장하는 하루 되세요. 새로운 시험이나 결과를 확인해보세요.</p>
                    </div>

                    <!-- 통계 -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon exams">
                                <i class="fas fa-clipboard-list"></i>
                            </div>
                            <div class="stat-number" id="totalExams">-</div>
                            <div class="stat-label">전체 시험</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon completed">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-number" id="completedExams">-</div>
                            <div class="stat-label">완료한 시험</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon pending">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-number" id="pendingExams">-</div>
                            <div class="stat-label">대기 중인 시험</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon score">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <div class="stat-number" id="averageScore">-</div>
                            <div class="stat-label">평균 점수</div>
                        </div>
                    </div>

                    <!-- 빠른 액션 -->
                    <div class="quick-actions">
                        <a href="./exam.html" class="quick-action-btn">
                            <i class="fas fa-play"></i>
                            <span>시험 응시</span>
                        </a>
                        <a href="#" onclick="showLatestResult()" class="quick-action-btn">
                            <i class="fas fa-chart-line"></i>
                            <span>성적 확인</span>
                        </a>
                        <a href="./profile.html" class="quick-action-btn">
                            <i class="fas fa-user-edit"></i>
                            <span>프로필 수정</span>
                        </a>
                    </div>

                    <!-- 최근 시험 목록 -->
                    <h3 class="section-title">
                        <i class="fas fa-fire"></i>
                        최신 시험
                    </h3>

                    <div id="examList">
                        <!-- 시험 카드들이 동적으로 로드됩니다 -->
                        <div class="loading-exams">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>시험 목록을 불러오는 중...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    
    <!-- 공통 스크립트 -->
    <script src="./assets/js/common.js"></script>
    
    <script>
        // 대시보드 페이지 전용 스크립트
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📊 대시보드 페이지 로드됨');
            
            // Supabase 클라이언트 초기화 확인
            let checkCount = 0;
            const maxChecks = 50; // 최대 5초 대기 (50 * 100ms)
            
            const checkSupabaseClient = () => {
                checkCount++;
                
                if (window.supabaseClient && window.semuApp) {
                    console.log('✅ Supabase 클라이언트와 semuApp 모두 확인됨');
                    
                    // 세션 복원이 완료될 때까지 추가 대기
                    if (!window.semuApp.currentUser) {
                        console.log('⏳ 세션 복원 대기 중...');
                        if (checkCount < maxChecks) {
                            setTimeout(checkSupabaseClient, 200);
                            return;
                        } else {
                            console.warn('⚠️ 세션 복원 타임아웃, 로그인 페이지로 이동');
                            // 리다이렉트 루프 방지를 위한 플래그 추가
                            window.location.href = './login.html?redirect_from=dashboard';
                            return;
                        }
                    }
                    
                    console.log('✅ 사용자 인증 확인됨:', window.semuApp.currentUser.email);
                
                    // 관리자도 사용자 대시보드 접근 허용
                    const user = window.semuApp.currentUser;
                    if (user.role === 'super_admin' || user.role === 'admin') {
                        console.log('✅ 관리자 계정이 사용자 대시보드에 접근했습니다:', user.email);
                        // 관리자도 일반 사용자처럼 대시보드를 사용할 수 있도록 허용
                    }
                
                // 사용자 정보 표시
                updateUserInfo();
                
                // 통계 데이터 로드
                loadDashboardStats();
                    
                    // 시험 목록 로드
                    loadExamList();
                } else if (checkCount < maxChecks) {
                    console.log(`⏳ 초기화 대기 중... (${checkCount}/${maxChecks})`);
                    console.log('  - supabaseClient:', !!window.supabaseClient);
                    console.log('  - semuApp:', !!window.semuApp);
                    setTimeout(checkSupabaseClient, 100);
                } else {
                    console.error('❌ 초기화 실패 - 최대 대기 시간 초과');
                    document.getElementById('examList').innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>시스템 초기화에 실패했습니다. 페이지를 새로고침해주세요.</p>
                            <small>supabaseClient: ${!!window.supabaseClient}, semuApp: ${!!window.semuApp}</small>
                        </div>
                    `;
                }
            };
            
            // Supabase 클라이언트 확인 시작
            checkSupabaseClient();
        });

        function updateUserInfo() {
            const user = window.semuApp.currentUser;
            if (user) {
                document.getElementById('userName').textContent = user.name + '님';
                document.getElementById('welcomeMessage').textContent = 
                    `안녕하세요, ${user.name}님!`;
            }
        }

        async function loadDashboardStats() {
            try {
                console.log('📊 대시보드 통계 데이터 로딩 중...');
                
                // 현재 사용자 정보 가져오기
                const user = window.semuApp?.currentUser;
                if (!user) {
                    console.warn('⚠️ 사용자 정보가 없습니다.');
                    setDefaultStats();
                    return;
                }

                console.log('👤 통계 조회 사용자:', { id: user.id, email: user.email, role: user.role, department_id: user.department_id });

                // 1단계: 사용자가 응시 가능한 시험 ID들 조회
                let permissionsQuery;
                
                // 관리자인 경우 모든 시험에 접근 가능
                if (user.role === 'super_admin' || user.role === 'admin') {
                    console.log('🔑 관리자 권한으로 모든 시험 조회');
                    permissionsQuery = window.supabaseClient
                        .from('exam_permissions')
                        .select('exam_id');
                } else if (user.department_id) {
                    // 부서 ID가 있는 경우: 개인 권한 또는 부서 권한
                    console.log('👥 부서 권한 포함하여 조회');
                    permissionsQuery = window.supabaseClient
                        .from('exam_permissions')
                        .select('exam_id')
                        .or(`employee_id.eq.${user.id},department_id.eq.${user.department_id}`);
                } else {
                    // 부서 ID가 없는 경우: 개인 권한만
                    console.log('👤 개인 권한만 조회');
                    permissionsQuery = window.supabaseClient
                        .from('exam_permissions')
                        .select('exam_id')
                        .eq('employee_id', user.id);
                }

                const { data: permissions, error: permError } = await permissionsQuery;

                if (permError) {
                    console.error('❌ 권한 조회 실패:', permError);
                    throw permError;
                }

                if (!permissions || permissions.length === 0) {
                    console.log('📋 응시 가능한 시험이 없습니다.');
                    setDefaultStats();
                    return;
                }

                const examIds = [...new Set(permissions.map(p => p.exam_id))];
                console.log('🎯 응시 가능한 시험 ID들:', examIds);
                console.log('🎯 응시 가능한 시험 수:', examIds.length);

                // 2단계: 시험 정보와 사용자의 응시 세션 조회
                const { data: userSessions, error: sessionError } = await window.supabaseClient
                    .from('exam_sessions')
                    .select('exam_id, status, score, total_points, submit_time')
                    .eq('employee_id', user.id)
                    .in('exam_id', examIds);

                if (sessionError) {
                    console.error('❌ 세션 조회 실패:', sessionError);
                    throw sessionError;
                }

                console.log('📊 사용자 응시 세션:', userSessions);
                console.log('📊 세션 상세 정보:');
                userSessions?.forEach((session, index) => {
                    console.log(`  ${index + 1}. 시험 ID: ${session.exam_id}`);
                    console.log(`     상태: ${session.status}`);
                    console.log(`     점수: ${session.score}/${session.total_points}`);
                    console.log(`     제출시간: ${session.submit_time}`);
                });

                // 3단계: 게시된 시험 수 조회
                const { data: publishedExams, error: examError } = await window.supabaseClient
                    .from('exams')
                    .select('id')
                    .in('id', examIds)
                    .eq('status', 'published');

                if (examError) {
                    console.error('❌ 시험 조회 실패:', examError);
                    throw examError;
                }

                // 4단계: 통계 계산
                const totalExams = publishedExams?.length || 0;
                const sessionMap = new Map(userSessions?.map(s => [s.exam_id, s]) || []);
                
                console.log('📈 통계 계산 시작:');
                console.log(`  - 전체 게시된 시험: ${totalExams}개`);
                console.log(`  - 사용자 세션: ${userSessions?.length || 0}개`);
                
                let completedExams = 0;
                let totalScore = 0;
                let scoredExams = 0;

                publishedExams?.forEach((exam, index) => {
                    const session = sessionMap.get(exam.id);
                    console.log(`\n  🔍 시험 ${index + 1} (ID: ${exam.id}):`);
                    
                    if (session) {
                        console.log(`    - 세션 상태: ${session.status}`);
                        console.log(`    - 점수: ${session.score}/${session.total_points}`);
                        
                        if (session.status === 'submitted' || session.status === 'graded') {
                            completedExams++;
                            console.log(`    ✅ 완료된 시험으로 카운트 (완료 시험 수: ${completedExams})`);
                            
                            if (session.score !== null && session.total_points > 0) {
                                let percentage;
                                
                                // 데이터 검증 및 정리
                                if (session.score > session.total_points && session.score <= 100) {
                                    // 점수가 총점보다 크지만 100 이하면 백분율로 저장된 것
                                    percentage = Math.round(session.score);
                                    console.log(`    🔍 데이터 이상 - 백분율로 추정: ${session.score}% → ${percentage}%`);
                                    console.log(`    ⚠️ 데이터베이스 점수 오류: score=${session.score}, total_points=${session.total_points}`);
                                } else if (session.score > 100) {
                                    // 점수가 100보다 크면 잘못된 데이터
                                    console.log(`    ❌ 잘못된 점수 데이터: ${session.score}/${session.total_points} - 제외`);
                                    return; // 이 시험은 통계에서 제외
                                } else {
                                    // 정상적인 점수/총점 계산
                                    percentage = Math.round((session.score / session.total_points) * 100);
                                    console.log(`    ✅ 정상 점수 계산: ${session.score}/${session.total_points} × 100 = ${percentage}%`);
                                }
                                
                                totalScore += percentage;
                                scoredExams++;
                                console.log(`    📊 점수 추가: ${percentage}% (누적: ${totalScore}, 점수 있는 시험: ${scoredExams})`);
                            } else {
                                console.log(`    ⚠️ 점수 없음: score=${session.score}, total_points=${session.total_points}`);
                            }
                        } else {
                            console.log(`    ⏳ 미완료 상태: ${session.status}`);
                        }
                    } else {
                        console.log(`    📝 세션 없음 (미응시)`);
                    }
                });

                const pendingExams = totalExams - completedExams;
                const averageScore = scoredExams > 0 ? Math.round(totalScore / scoredExams) : 0;
                
                console.log('\n📊 최종 통계 계산 결과:');
                console.log(`  - 전체 시험: ${totalExams}`);
                console.log(`  - 완료한 시험: ${completedExams}`);
                console.log(`  - 대기 중인 시험: ${pendingExams}`);
                console.log(`  - 평균 점수 계산: ${totalScore} ÷ ${scoredExams} = ${averageScore}%`);

                // 추가 검증
                console.log('🔍 평균 점수 계산 검증:');
                console.log(`  totalScore: ${totalScore} (타입: ${typeof totalScore})`);
                console.log(`  scoredExams: ${scoredExams} (타입: ${typeof scoredExams})`);
                console.log(`  계산식: ${totalScore} / ${scoredExams} = ${totalScore / scoredExams}`);
                console.log(`  반올림 결과: ${Math.round(totalScore / scoredExams)}`);

                // 5단계: UI 업데이트
                console.log('\n🎯 UI 업데이트 시작:');
                console.log(`  - totalExams: ${totalExams}`);
                console.log(`  - completedExams: ${completedExams}`);
                console.log(`  - pendingExams: ${pendingExams}`);
                console.log(`  - averageScore: ${averageScore}`);

                animateNumber('totalExams', totalExams);
                animateNumber('completedExams', completedExams);
                animateNumber('pendingExams', pendingExams);
                animateNumber('averageScore', averageScore);

            } catch (error) {
                console.error('❌ 통계 로드 실패:', error);
                setDefaultStats();
            }
        }

        // 기본 통계값 설정
        function setDefaultStats() {
            console.log('📊 기본 통계값 설정');
            animateNumber('totalExams', 0);
            animateNumber('completedExams', 0);
            animateNumber('pendingExams', 0);
            animateNumber('averageScore', 0);
        }

        function animateNumber(elementId, targetNumber) {
            const element = document.getElementById(elementId);
            if (!element) {
                console.warn(`⚠️ Element not found: ${elementId}`);
                return;
            }

            // 기존 애니메이션 정리
            if (element._timer) {
                clearInterval(element._timer);
                element._timer = null;
            }

            // 즉시 값 설정 (애니메이션 없이)
            element.textContent = targetNumber;
            
            console.log(`🎯 ${elementId} 업데이트: ${targetNumber}`);

            // 간단한 애니메이션 효과만 (값 변경 없이)
            element.style.transform = 'scale(1.1)';
            setTimeout(() => {
                element.style.transform = 'scale(1)';
            }, 200);
        }

        // 시험 목록 로드
        async function loadExamList() {
            try {
                console.log('📋 시험 목록 로딩 중...');
                
                // 현재 사용자 정보 가져오기
                const user = window.semuApp?.currentUser;
                console.log('👤 현재 사용자:', user);
                
                if (!user) {
                    console.warn('사용자 정보가 없습니다.');
                    document.getElementById('examList').innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>사용자 정보를 가져올 수 없습니다. 로그인 상태를 확인해주세요.</p>
                        </div>
                    `;
                    return;
                }

                // 1단계: exam_permissions 테이블 확인
                console.log('🔍 1단계: exam_permissions 테이블 조회 중...');
                const { data: allPermissions, error: permissionsError } = await window.supabaseClient
                    .from('exam_permissions')
                    .select('*');
                
                if (permissionsError) {
                    console.error('❌ exam_permissions 조회 실패:', permissionsError);
                } else {
                    console.log('📋 전체 exam_permissions:', allPermissions);
                }

                // 2단계: 사용자별 권한 조회 (더 간단한 방식)
                console.log('🔍 2단계: 사용자별 권한 조회 중...');
                
                // 관리자 계정인지 확인
                if (user.role === 'super_admin' || user.role === 'admin') {
                    console.log('🔑 관리자 계정 - 모든 시험에 접근 권한 부여');
                    
                    // 모든 시험 권한을 가져오기
                    const { data: allExamPermissions, error: allPermissionsError } = await window.supabaseClient
                        .from('exam_permissions')
                        .select('exam_id');
                    
                    if (allPermissionsError) {
                        console.error('❌ 전체 시험 권한 조회 실패:', allPermissionsError);
                        throw allPermissionsError;
                    }
                    
                    const examIds = allExamPermissions.map(p => p.exam_id);
                    console.log('📋 관리자 - 모든 시험 ID들:', examIds);
                    
                    // 모든 시험 정보 가져오기
                    await loadExamDetails(examIds, user);
                    return;
                }
                
                // 일반 사용자 권한 조회
                let query;
                if (user.department_id) {
                    // 부서 ID가 있는 경우: 개인 권한 또는 부서 권한
                    query = window.supabaseClient
                        .from('exam_permissions')
                        .select('exam_id')
                        .or(`employee_id.eq.${user.id},department_id.eq.${user.department_id}`);
                } else {
                    // 부서 ID가 없는 경우: 개인 권한만
                    query = window.supabaseClient
                        .from('exam_permissions')
                        .select('exam_id')
                        .eq('employee_id', user.id);
                }
                
                const { data: userPermissions, error: examPermissionsError } = await query;
                
                if (examPermissionsError) throw examPermissionsError;
                
                if (!userPermissions || userPermissions.length === 0) {
                    console.log('📋 사용자에게 권한이 있는 시험이 없습니다.');
                    displayExamList([], user);
                    return;
                }
                
                const examIds = userPermissions.map(p => p.exam_id);
                console.log('📋 권한이 있는 시험 ID들:', examIds);
                
                // 권한이 있는 시험들의 상세 정보 가져오기
                const { data: permissions, error: examError } = await window.supabaseClient
                    .from('exams')
                    .select(`
                        id,
                        title,
                        description,
                        duration,
                        status,
                        start_time,
                        end_time,
                        exam_questions(count),
                        exam_sessions!left(
                            id,
                            employee_id,
                            status,
                            score,
                            total_points
                        )
                    `)
                    .in('id', examIds)
                    .eq('status', 'published');

                if (examError) throw examError;

                console.log('📋 응시 가능한 시험:', permissions);

                // 시험 목록 표시
                displayExamList(permissions, user);

            } catch (error) {
                console.error('시험 목록 로드 실패:', error);
                document.getElementById('examList').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>시험 목록을 불러오는 중 오류가 발생했습니다.</p>
                    </div>
                `;
            }
        }

        // 시험 상세 정보 로드 (관리자용)
        async function loadExamDetails(examIds, user) {
            try {
                console.log('🔍 시험 상세 정보 로드 중...');
                
                // 시험들의 상세 정보 가져오기
                const { data: permissions, error: examError } = await window.supabaseClient
                    .from('exams')
                    .select(`
                        id,
                        title,
                        description,
                        duration,
                        status,
                        start_time,
                        end_time,
                        exam_questions(count),
                        exam_sessions!left(
                            id,
                            employee_id,
                            status,
                            score,
                            total_points
                        )
                    `)
                    .in('id', examIds)
                    .eq('status', 'published');

                if (examError) throw examError;

                console.log('📋 관리자 - 응시 가능한 시험:', permissions);

                // 시험 목록 표시
                displayExamList(permissions, user);
                
            } catch (error) {
                console.error('❌ 시험 상세 정보 로드 실패:', error);
                document.getElementById('examList').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>시험 상세 정보를 불러오는 중 오류가 발생했습니다.</p>
                    </div>
                `;
            }
        }

        // 점수 정보 생성 함수
        function generateScoreInfo(userSession) {
            console.log('🎯 점수 정보 생성 시도:', { 
                userSession, 
                score: userSession?.score, 
                total_points: userSession?.total_points 
            });
            
            if (!userSession || userSession.score === null || !userSession.total_points) {
                console.log('❌ 점수 정보 생성 실패 - 데이터 부족');
                return '';
            }
            
            // score가 이미 백분율인 경우와 정답 개수인 경우를 구분
            let percentage, correctAnswers, displayScore;
            
            if (userSession.score > userSession.total_points) {
                // score가 백분율 (0-100)인 경우
                percentage = userSession.score;
                correctAnswers = Math.round((percentage / 100) * userSession.total_points);
                displayScore = `${percentage}점`;
            } else {
                // score가 정답 개수인 경우
                correctAnswers = userSession.score;
                percentage = Math.round((correctAnswers / userSession.total_points) * 100);
                displayScore = `${correctAnswers}점`;
            }
            
            let badgeClass = 'score-badge';
            
            if (percentage >= 90) badgeClass += ' excellent';
            else if (percentage >= 80) badgeClass += ' good';
            else if (percentage >= 60) badgeClass += ' average';
            else badgeClass += ' poor';
            
            console.log('✅ 점수 정보 생성 완료:', { 
                percentage, 
                correctAnswers, 
                total: userSession.total_points,
                displayScore 
            });
            
            return `
                <div class="exam-score-info">
                    <div class="${badgeClass}">${displayScore} (${percentage}%)</div>
                    <div class="score-detail">${correctAnswers}/${userSession.total_points} 정답</div>
                </div>
            `;
        }

        // 시험 목록 표시
        function displayExamList(permissions, user) {
            const examList = document.getElementById('examList');
            
            if (!permissions || permissions.length === 0) {
                examList.innerHTML = `
                    <div class="no-exams">
                        <i class="fas fa-clipboard-list"></i>
                        <p>응시 가능한 시험이 없습니다.</p>
                        <small>관리자에게 문의하세요.</small>
                    </div>
                `;
                return;
            }

            const examsHtml = permissions.map(exam => {
                const questionCount = exam.exam_questions?.[0]?.count || 0;
                const userSession = exam.exam_sessions?.find(s => s.employee_id === user.id);
                
                // 시험 상태 결정
                let status = 'available';
                let statusText = '응시 가능';
                let statusClass = 'available';
                let buttonText = '시험 시작';
                let buttonClass = 'btn-primary';
                let buttonIcon = 'fas fa-play';
                let buttonAction = `startExam('${exam.id}')`;
                let scoreInfo = ''; // 점수 정보 추가

                if (userSession) {
                    if (userSession.status === 'graded') {
                        status = 'completed';
                        statusText = '완료';
                        statusClass = 'completed';
                        buttonText = '결과 보기';
                        buttonClass = 'btn-success';
                        buttonIcon = 'fas fa-eye';
                        buttonAction = `viewResult('${exam.id}')`;
                        scoreInfo = generateScoreInfo(userSession);
                    } else if (userSession.status === 'submitted') {
                        status = 'submitted';
                        statusText = '제출됨';
                        statusClass = 'submitted';
                        buttonText = '결과 보기';
                        buttonClass = 'btn-info';
                        buttonIcon = 'fas fa-eye';
                        buttonAction = `viewResult('${exam.id}')`;
                        scoreInfo = generateScoreInfo(userSession);
                    } else if (userSession.status === 'in_progress') {
                        status = 'in-progress';
                        statusText = '진행 중';
                        statusClass = 'in-progress';
                        buttonText = '계속하기';
                        buttonClass = 'btn-warning';
                        buttonIcon = 'fas fa-play';
                        buttonAction = `continueExam('${exam.id}')`;
                    }
                }

                // 시험 기간 체크
                const now = new Date();
                const startTime = exam.start_time ? new Date(exam.start_time) : null;
                const endTime = exam.end_time ? new Date(exam.end_time) : null;
                
                if (startTime && now < startTime) {
                    status = 'scheduled';
                    statusText = '예정됨';
                    statusClass = 'scheduled';
                    buttonText = '예약됨';
                    buttonClass = 'btn-secondary';
                    buttonIcon = 'fas fa-clock';
                    buttonAction = 'return false;';
                } else if (endTime && now > endTime) {
                    status = 'expired';
                    statusText = '종료됨';
                    statusClass = 'expired';
                    buttonText = '종료됨';
                    buttonClass = 'btn-secondary';
                    buttonIcon = 'fas fa-times';
                    buttonAction = 'return false;';
                }

                return `
                    <div class="exam-card" data-exam-id="${exam.id}">
                        <div class="exam-header">
                            <div>
                                <h4 class="exam-title">${exam.title}</h4>
                                <span class="exam-status ${statusClass}">${statusText}</span>
                            </div>
                            ${scoreInfo}
                        </div>
                        <p class="exam-description">
                            ${exam.description || '설명이 없습니다.'}
                        </p>
                        <div class="exam-meta">
                            <span><i class="fas fa-clock"></i> ${exam.duration}분</span>
                            <span><i class="fas fa-question-circle"></i> ${questionCount}문항</span>
                            <span><i class="fas fa-calendar"></i> ${getExamTimeText(startTime, endTime)}</span>
                            <span><i class="fas fa-star"></i> 난이도: ${getDifficultyText(exam.difficulty)}</span>
                        </div>
                        <div class="exam-actions">
                            <button class="btn ${buttonClass}" onclick="${buttonAction}">
                                <i class="${buttonIcon}"></i> ${buttonText}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            examList.innerHTML = examsHtml;
        }

        // 시험 시간 텍스트 생성
        function getExamTimeText(startTime, endTime) {
            const now = new Date();
            
            if (startTime && endTime) {
                if (now < startTime) {
                    return `시작: ${formatDate(startTime)}`;
                } else if (now > endTime) {
                    return `종료: ${formatDate(endTime)}`;
                } else {
                    return '진행 중';
                }
            } else if (startTime) {
                if (now < startTime) {
                    return `시작: ${formatDate(startTime)}`;
                } else {
                    return '언제든지';
                }
            } else {
                return '언제든지';
            }
        }

        // 날짜 포맷팅
        function formatDate(date) {
            if (!date) return '';
            return new Intl.DateTimeFormat('ko-KR', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).format(new Date(date));
        }

        // 난이도 텍스트 변환
        function getDifficultyText(difficulty) {
            const difficultyMap = {
                1: '매우 쉬움',
                2: '쉬움', 
                3: '보통',
                4: '어려움',
                5: '매우 어려움'
            };
            return difficultyMap[difficulty] || '보통';
        }

        // 시험 시작 함수 (수정됨)
        async function startExam(examId) {
            try {
                console.log('🎯 시험 시작 요청:', examId);
                
                // 시험 정보 확인
                const { data: exam, error } = await window.supabaseClient
                    .from('exams')
                    .select('*')
                    .eq('id', examId)
                    .single();
                
                if (error) throw error;
                
                if (confirm(`"${exam.title}" 시험을 시작하시겠습니까?\n\n시험이 시작되면 제한 시간이 적용됩니다.`)) {
                    
                    // 하드코딩된 관리자 계정인지 확인
                    if (window.semuApp.currentUser.id === '17430453-d823-45a7-8a93-8512781b183a') {
                        console.log('🔑 하드코딩된 관리자 계정 - 시험 세션 생성 없이 바로 이동');
                        
                        // 시험 페이지로 바로 이동 (세션 생성 없음)
                        console.log('🚀 시험 페이지로 이동:', `./exam.html?id=${examId}`);
                        window.location.href = `./exam.html?id=${examId}`;
                        return;
                    }
                    
                    // 일반 사용자 계정 - 시험 세션 생성
                    // 기존 시험 세션 확인
                    const { data: existingSession, error: checkError } = await window.supabaseClient
                        .from('exam_sessions')
                        .select('*')
                        .eq('exam_id', examId)
                        .eq('employee_id', window.semuApp.currentUser.id)
                        .single();
                    
                    let sessionId;
                    
                    if (checkError && checkError.code === 'PGRST116') {
                        // 기존 세션이 없는 경우 - 새로 생성
                        console.log('🆕 새로운 시험 세션 생성');
                        const { data: newSession, error: sessionError } = await window.supabaseClient
                            .from('exam_sessions')
                            .insert([{
                                exam_id: examId,
                                employee_id: window.semuApp.currentUser.id,
                                status: 'in_progress'
                            }])
                            .select()
                            .single();
                        
                        if (sessionError) throw sessionError;
                        sessionId = newSession.id;
                        
                    } else if (checkError) {
                        // 다른 오류 발생
                        throw checkError;
                        
                    } else {
                        // 기존 세션이 있는 경우
                        if (existingSession.status === 'in_progress') {
                            // 진행 중인 세션 - 계속하기
                            console.log('🔄 기존 진행 중인 세션 사용');
                            sessionId = existingSession.id;
                        } else if (existingSession.status === 'submitted') {
                            // 이미 제출된 세션 - 재시도 확인
                            if (confirm('이미 제출된 시험입니다. 다시 응시하시겠습니까?\n\n기존 점수는 유지됩니다.')) {
                                // 새로운 세션 생성
                                const { data: newSession, error: sessionError } = await window.supabaseClient
                                    .from('exam_sessions')
                                    .insert([{
                                        exam_id: examId,
                                        employee_id: window.semuApp.currentUser.id,
                                        status: 'in_progress'
                                    }])
                                    .select()
                                    .single();
                                
                                if (sessionError) throw sessionError;
                                sessionId = newSession.id;
                            } else {
                                return; // 취소
                            }
                        }
                    }
                    
                // 시험 페이지로 이동
                    console.log('🚀 시험 페이지로 이동:', `./exam.html?id=${examId}`);
                    window.location.href = `./exam.html?id=${examId}`;
                }
                
            } catch (error) {
                console.error('시험 시작 오류:', error);
                
                if (error.code === '23505') {
                    alert('이미 진행 중인 시험이 있습니다. 시험 페이지로 이동합니다.');
                window.location.href = `./exam.html?id=${examId}`;
                } else {
                    alert('시험을 시작할 수 없습니다. 다시 시도해주세요.');
                }
            }
        }

        // 시험 결과 보기
        function viewResult(examId) {
            window.location.href = `./results.html?exam=${examId}`;
        }

        // 최근 시험 결과 보기
        async function showLatestResult() {
            try {
                const user = window.semuApp?.currentUser;
                if (!user) {
                    showAlert('로그인이 필요합니다.', 'warning');
                    return;
                }

                console.log('🔍 최근 시험 결과 조회 중...');

                // 사용자의 가장 최근 제출된 시험 세션 조회
                const { data: latestSession, error } = await window.supabaseClient
                    .from('exam_sessions')
                    .select('exam_id, submit_time')
                    .eq('employee_id', user.id)
                    .eq('status', 'submitted')
                    .order('submit_time', { ascending: false })
                    .limit(1)
                    .single();

                if (error || !latestSession) {
                    showAlert('아직 제출된 시험 결과가 없습니다.', 'info');
                    return;
                }

                // 해당 시험의 결과 페이지로 이동
                window.location.href = `./results.html?exam=${latestSession.exam_id}`;

            } catch (error) {
                console.error('❌ 최근 시험 결과 조회 실패:', error);
                showAlert('시험 결과를 불러오는 중 오류가 발생했습니다.', 'error');
            }
        }

        // 시험 계속하기
        function continueExam(examId) {
            // 기존 세션 찾기
            window.location.href = `./exam.html?id=${examId}`;
        }
    </script>
</body>
</html>
