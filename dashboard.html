<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ì‹œë³´ë“œ - ì„¸ë¬´ì¸ì‚¬ì´ë“œ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/common.css">
    <style>
        .dashboard-container {
            display: flex;
            flex-direction: column;
            min-height: 600px;
        }

        .main-content {
            flex: 1;
            padding: 30px;
            background: #f8f9fa;
        }

        .welcome-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .welcome-section h2 {
            color: var(--dark-gray);
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        .welcome-section p {
            color: var(--medium-gray);
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .stat-icon.exams {
            color: #667eea;
        }

        .stat-icon.completed {
            color: #28a745;
        }

        .stat-icon.pending {
            color: #ffc107;
        }

        .stat-icon.score {
            color: #17a2b8;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--medium-gray);
            font-size: 0.9rem;
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--dark-gray);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .exam-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s;
            cursor: pointer;
        }

        .exam-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .exam-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .exam-score-info {
            text-align: right;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .score-badge {
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .score-badge.excellent {
            background: linear-gradient(135deg, #28a745, #20c997);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .score-badge.good {
            background: linear-gradient(135deg, #17a2b8, #20c997);
            box-shadow: 0 2px 8px rgba(23, 162, 184, 0.3);
        }

        .score-badge.average {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
        }

        .score-badge.poor {
            background: linear-gradient(135deg, #dc3545, #e83e8c);
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }

        .score-detail {
            color: var(--medium-gray);
            font-size: 0.8rem;
            font-weight: 500;
        }

        .exam-title {
            font-size: 1.3rem;
            color: var(--dark-gray);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .exam-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .exam-status.available {
            background: #d4edda;
            color: #155724;
        }

        .exam-status.completed {
            background: #cce7ff;
            color: #004085;
        }

        .exam-status.scheduled {
            background: #fff3cd;
            color: #856404;
        }

        .exam-description {
            color: var(--medium-gray);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .exam-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: var(--medium-gray);
        }

        .exam-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .exam-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .quick-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            text-decoration: none;
            color: var(--dark-gray);
            transition: all 0.3s;
            font-weight: 500;
        }

        .quick-action-btn:hover {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        .quick-action-btn i {
            font-size: 1.2rem;
        }

        /* ë¡œë”© ë° ì˜¤ë¥˜ ìƒíƒœ ìŠ¤íƒ€ì¼ */
        .loading-exams {
            text-align: center;
            padding: 40px 20px;
            color: var(--medium-gray);
        }

        .loading-exams i {
            font-size: 2rem;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .loading-exams p {
            margin: 0;
            font-size: 1.1rem;
        }

        .no-exams {
            text-align: center;
            padding: 40px 20px;
            color: var(--medium-gray);
        }

        .no-exams i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #dee2e6;
        }

        .no-exams p {
            margin: 0 0 10px 0;
            font-size: 1.1rem;
        }

        .no-exams small {
            color: #adb5bd;
        }

        .error-message {
            text-align: center;
            padding: 40px 20px;
            color: #dc3545;
        }

        .error-message i {
            font-size: 2rem;
            margin-bottom: 15px;
        }

        .error-message p {
            margin: 0;
            font-size: 1.1rem;
        }

        /* ì‹œí—˜ ìƒíƒœë³„ ìŠ¤íƒ€ì¼ */
        .exam-status.completed {
            background-color: #28a745;
            color: white;
        }

        .exam-status.in-progress {
            background-color: #ffc107;
            color: #212529;
        }

        .exam-status.scheduled {
            background-color: #17a2b8;
            color: white;
        }

        .exam-status.expired {
            background-color: #6c757d;
            color: white;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .quick-actions {
                flex-direction: column;
            }
            
            .exam-meta {
                flex-direction: column;
                gap: 10px;
            }
            
            .exam-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="container">
            <div class="dashboard-container">
                <!-- í—¤ë” -->
                <div class="header">
                    <div class="logo">
                        <i class="fas fa-graduation-cap"></i>
                        <h2>ì„¸ë¬´ì¸ì‚¬ì´ë“œ</h2>
                    </div>
                    <div class="nav-menu">
                        <a href="./dashboard.html" class="nav-link active">
                            <i class="fas fa-home"></i> ëŒ€ì‹œë³´ë“œ
                        </a>
                        <a href="./exam.html" class="nav-link">
                            <i class="fas fa-clipboard-list"></i> ì‹œí—˜
                        </a>
                        <a href="#" onclick="showLatestResult()" class="nav-link">
                            <i class="fas fa-chart-bar"></i> ê²°ê³¼
                        </a>
                        <a href="./profile.html" class="nav-link">
                            <i class="fas fa-user"></i> í”„ë¡œí•„
                        </a>
                        <a href="./admin.html" class="nav-link admin-only hidden">
                            <i class="fas fa-cog"></i> ê´€ë¦¬
                        </a>
                    </div>
                    <div class="user-menu">
                        <span class="user-name" id="userName">ì‚¬ìš©ìë‹˜</span>
                        <button class="btn btn-outline btn-small logout-btn">
                            <i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ
                        </button>
                    </div>
                </div>

                <!-- ë©”ì¸ ì½˜í…ì¸  -->
                <div class="main-content">
                    <!-- í™˜ì˜ ì„¹ì…˜ -->
                    <div class="welcome-section">
                        <h2 id="welcomeMessage">ì•ˆë…•í•˜ì„¸ìš”!</h2>
                        <p>ì˜¤ëŠ˜ë„ ì—´ì‹¬íˆ í•™ìŠµí•˜ê³  ì„±ì¥í•˜ëŠ” í•˜ë£¨ ë˜ì„¸ìš”. ìƒˆë¡œìš´ ì‹œí—˜ì´ë‚˜ ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.</p>
                    </div>

                    <!-- í†µê³„ -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon exams">
                                <i class="fas fa-clipboard-list"></i>
                            </div>
                            <div class="stat-number" id="totalExams">5</div>
                            <div class="stat-label">ì „ì²´ ì‹œí—˜</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon completed">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-number" id="completedExams">2</div>
                            <div class="stat-label">ì™„ë£Œí•œ ì‹œí—˜</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon pending">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-number" id="pendingExams">3</div>
                            <div class="stat-label">ëŒ€ê¸° ì¤‘ì¸ ì‹œí—˜</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon score">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <div class="stat-number" id="averageScore">85</div>
                            <div class="stat-label">í‰ê·  ì ìˆ˜</div>
                        </div>
                    </div>

                    <!-- ë¹ ë¥¸ ì•¡ì…˜ -->
                    <div class="quick-actions">
                        <a href="./exam.html" class="quick-action-btn">
                            <i class="fas fa-play"></i>
                            <span>ì‹œí—˜ ì‘ì‹œ</span>
                        </a>
                        <a href="#" onclick="showLatestResult()" class="quick-action-btn">
                            <i class="fas fa-chart-line"></i>
                            <span>ì„±ì  í™•ì¸</span>
                        </a>
                        <a href="./profile.html" class="quick-action-btn">
                            <i class="fas fa-user-edit"></i>
                            <span>í”„ë¡œí•„ ìˆ˜ì •</span>
                        </a>
                    </div>

                    <!-- ìµœê·¼ ì‹œí—˜ ëª©ë¡ -->
                    <h3 class="section-title">
                        <i class="fas fa-fire"></i>
                        ìµœì‹  ì‹œí—˜
                    </h3>

                    <div id="examList">
                        <!-- ì‹œí—˜ ì¹´ë“œë“¤ì´ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                        <div class="loading-exams">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>ì‹œí—˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    
    <!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="./assets/js/common.js"></script>
    
    <script>
        // ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ ì „ìš© ìŠ¤í¬ë¦½íŠ¸
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“Š ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ ë¡œë“œë¨');
            
            // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” í™•ì¸
            let checkCount = 0;
            const maxChecks = 50; // ìµœëŒ€ 5ì´ˆ ëŒ€ê¸° (50 * 100ms)
            
            const checkSupabaseClient = () => {
                checkCount++;
                
                if (window.supabaseClient && window.semuApp) {
                    console.log('âœ… Supabase í´ë¼ì´ì–¸íŠ¸ì™€ semuApp ëª¨ë‘ í™•ì¸ë¨');
                    
                    // ì„¸ì…˜ ë³µì›ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ì¶”ê°€ ëŒ€ê¸°
                    if (!window.semuApp.currentUser) {
                        console.log('â³ ì„¸ì…˜ ë³µì› ëŒ€ê¸° ì¤‘...');
                        if (checkCount < maxChecks) {
                            setTimeout(checkSupabaseClient, 200);
                            return;
                        } else {
                            console.warn('âš ï¸ ì„¸ì…˜ ë³µì› íƒ€ì„ì•„ì›ƒ, ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™');
                            // ë¦¬ë‹¤ì´ë ‰íŠ¸ ë£¨í”„ ë°©ì§€ë¥¼ ìœ„í•œ í”Œë˜ê·¸ ì¶”ê°€
                            window.location.href = './login.html?redirect_from=dashboard';
                            return;
                        }
                    }
                    
                    console.log('âœ… ì‚¬ìš©ì ì¸ì¦ í™•ì¸ë¨:', window.semuApp.currentUser.email);
                
                // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
                updateUserInfo();
                
                // í†µê³„ ë°ì´í„° ë¡œë“œ
                loadDashboardStats();
                    
                    // ì‹œí—˜ ëª©ë¡ ë¡œë“œ
                    loadExamList();
                } else if (checkCount < maxChecks) {
                    console.log(`â³ ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘... (${checkCount}/${maxChecks})`);
                    console.log('  - supabaseClient:', !!window.supabaseClient);
                    console.log('  - semuApp:', !!window.semuApp);
                    setTimeout(checkSupabaseClient, 100);
                } else {
                    console.error('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨ - ìµœëŒ€ ëŒ€ê¸° ì‹œê°„ ì´ˆê³¼');
                    document.getElementById('examList').innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>ì‹œìŠ¤í…œ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.</p>
                            <small>supabaseClient: ${!!window.supabaseClient}, semuApp: ${!!window.semuApp}</small>
                        </div>
                    `;
                }
            };
            
            // Supabase í´ë¼ì´ì–¸íŠ¸ í™•ì¸ ì‹œì‘
            checkSupabaseClient();
        });

        function updateUserInfo() {
            const user = window.semuApp.currentUser;
            if (user) {
                document.getElementById('userName').textContent = user.name + 'ë‹˜';
                document.getElementById('welcomeMessage').textContent = 
                    `ì•ˆë…•í•˜ì„¸ìš”, ${user.name}ë‹˜!`;
            }
        }

        async function loadDashboardStats() {
            try {
                console.log('ğŸ“Š ëŒ€ì‹œë³´ë“œ í†µê³„ ë°ì´í„° ë¡œë”© ì¤‘...');
                
                // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const user = window.semuApp?.currentUser;
                if (!user) {
                    console.warn('ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // ì‚¬ìš©ìê°€ ì‘ì‹œ ê°€ëŠ¥í•œ ì‹œí—˜ í†µê³„ ì¡°íšŒ (ë” ê°„ë‹¨í•œ ë°©ì‹)
                let examIds = [];
                
                // í•˜ë“œì½”ë”©ëœ ê´€ë¦¬ì ê³„ì •ì¸ì§€ í™•ì¸
                if (user.id === '17430453-d823-45a7-8a93-8512781b183a' && user.role === 'admin') {
                    console.log('ğŸ”‘ í•˜ë“œì½”ë”©ëœ ê´€ë¦¬ì ê³„ì • - ëª¨ë“  ì‹œí—˜ í†µê³„ ì¡°íšŒ');
                    
                    // ëª¨ë“  ì‹œí—˜ ê¶Œí•œì„ ê°€ì ¸ì˜¤ê¸°
                    const { data: allExamPermissions, error: allPermissionsError } = await window.supabaseClient
                        .from('exam_permissions')
                        .select('exam_id');
                    
                    if (allPermissionsError) {
                        console.error('âŒ ì „ì²´ ì‹œí—˜ ê¶Œí•œ ì¡°íšŒ ì‹¤íŒ¨:', allPermissionsError);
                        throw allPermissionsError;
                    }
                    
                    examIds = [...new Set(allExamPermissions.map(p => p.exam_id))]; // ì¤‘ë³µ ì œê±°
                    console.log('ğŸ“‹ ê´€ë¦¬ì - ëª¨ë“  ì‹œí—˜ IDë“¤ (í†µê³„):', examIds);
                } else {
                    // ì¼ë°˜ ì‚¬ìš©ì ê¶Œí•œ ì¡°íšŒ
                    let query = window.supabaseClient
                        .from('exam_permissions')
                        .select('exam_id');
                    
                    // ì¡°ê±´ì— ë”°ë¼ ì¿¼ë¦¬ êµ¬ì„±
                    if (user.department_id) {
                        query = query.or(`employee_id.eq.${user.id},department_id.eq.${user.department_id}`);
                    } else {
                        query = query.eq('employee_id', user.id);
                    }
                    
                    const { data: userPermissions, error: statsPermissionsError } = await query;
                    
                    if (statsPermissionsError) throw statsPermissionsError;
                    
                    if (!userPermissions || userPermissions.length === 0) {
                        console.log('ğŸ“‹ ì‚¬ìš©ìì—ê²Œ ê¶Œí•œì´ ìˆëŠ” ì‹œí—˜ì´ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    examIds = [...new Set(userPermissions.map(p => p.exam_id))]; // ì¤‘ë³µ ì œê±°
                }
                
                // ê¶Œí•œì´ ìˆëŠ” ì‹œí—˜ë“¤ì˜ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const { data: stats, error: statsError } = await window.supabaseClient
                    .from('exams')
                    .select(`
                        id,
                        title,
                        status,
                        exam_sessions!left(
                            id,
                            employee_id,
                            status,
                            score,
                            total_points
                        )
                    `)
                    .in('id', examIds)
                    .eq('status', 'published');

                if (statsError) throw statsError;

                // í†µê³„ ê³„ì‚°
                const totalExams = stats?.length || 0;
                let completedExams = 0;
                let pendingExams = 0;
                let totalScore = 0;
                let scoredExams = 0;

                stats?.forEach(exam => {
                    if (exam.status === 'published') {
                        const sessions = exam.exam_sessions || [];
                        const userSession = sessions.find(s => s.employee_id === user.id);
                        
                        if (userSession) {
                            if (userSession.status === 'graded' || userSession.status === 'submitted') {
                                completedExams++;
                                if (userSession.score !== null) {
                                    totalScore += userSession.score;
                                    scoredExams++;
                                }
                            } else if (userSession.status === 'in_progress') {
                                pendingExams++;
                            }
                        } else {
                            // ì„¸ì…˜ì´ ì—†ëŠ” ê²½ìš° ëŒ€ê¸° ì¤‘ì¸ ì‹œí—˜ìœ¼ë¡œ ê°„ì£¼
                            pendingExams++;
                        }
                    }
                });

                const averageScore = scoredExams > 0 ? Math.round(totalScore / scoredExams) : 0;

                console.log('ğŸ“Š í†µê³„ ë°ì´í„°:', { totalExams, completedExams, pendingExams, averageScore });

                // ì• ë‹ˆë©”ì´ì…˜ê³¼ í•¨ê»˜ ìˆ«ì ì—…ë°ì´íŠ¸
                animateNumber('totalExams', totalExams);
                animateNumber('completedExams', completedExams);
                animateNumber('pendingExams', pendingExams);
                animateNumber('averageScore', averageScore);

            } catch (error) {
                console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
                // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ê°’ í‘œì‹œ
                animateNumber('totalExams', 0);
                animateNumber('completedExams', 0);
                animateNumber('pendingExams', 0);
                animateNumber('averageScore', 0);
            }
        }

        function animateNumber(elementId, targetNumber) {
            const element = document.getElementById(elementId);
            const startNumber = 0;
            const duration = 1000; // 1ì´ˆ
            const increment = targetNumber / (duration / 16); // 60fps
            
            let currentNumber = startNumber;
            
            const timer = setInterval(() => {
                currentNumber += increment;
                
                if (currentNumber >= targetNumber) {
                    currentNumber = targetNumber;
                    clearInterval(timer);
                }
                
                element.textContent = Math.round(currentNumber);
            }, 16);
        }

        // ì‹œí—˜ ëª©ë¡ ë¡œë“œ
        async function loadExamList() {
            try {
                console.log('ğŸ“‹ ì‹œí—˜ ëª©ë¡ ë¡œë”© ì¤‘...');
                
                // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const user = window.semuApp?.currentUser;
                console.log('ğŸ‘¤ í˜„ì¬ ì‚¬ìš©ì:', user);
                
                if (!user) {
                    console.warn('ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    document.getElementById('examList').innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
                        </div>
                    `;
                    return;
                }

                // 1ë‹¨ê³„: exam_permissions í…Œì´ë¸” í™•ì¸
                console.log('ğŸ” 1ë‹¨ê³„: exam_permissions í…Œì´ë¸” ì¡°íšŒ ì¤‘...');
                const { data: allPermissions, error: permissionsError } = await window.supabaseClient
                    .from('exam_permissions')
                    .select('*');
                
                if (permissionsError) {
                    console.error('âŒ exam_permissions ì¡°íšŒ ì‹¤íŒ¨:', permissionsError);
                } else {
                    console.log('ğŸ“‹ ì „ì²´ exam_permissions:', allPermissions);
                }

                // 2ë‹¨ê³„: ì‚¬ìš©ìë³„ ê¶Œí•œ ì¡°íšŒ (ë” ê°„ë‹¨í•œ ë°©ì‹)
                console.log('ğŸ” 2ë‹¨ê³„: ì‚¬ìš©ìë³„ ê¶Œí•œ ì¡°íšŒ ì¤‘...');
                
                // í•˜ë“œì½”ë”©ëœ ê´€ë¦¬ì ê³„ì •ì¸ì§€ í™•ì¸
                if (user.id === '17430453-d823-45a7-8a93-8512781b183a' && user.role === 'admin') {
                    console.log('ğŸ”‘ í•˜ë“œì½”ë”©ëœ ê´€ë¦¬ì ê³„ì • - ëª¨ë“  ì‹œí—˜ì— ì ‘ê·¼ ê¶Œí•œ ë¶€ì—¬');
                    
                    // ëª¨ë“  ì‹œí—˜ ê¶Œí•œì„ ê°€ì ¸ì˜¤ê¸°
                    const { data: allExamPermissions, error: allPermissionsError } = await window.supabaseClient
                        .from('exam_permissions')
                        .select('exam_id');
                    
                    if (allPermissionsError) {
                        console.error('âŒ ì „ì²´ ì‹œí—˜ ê¶Œí•œ ì¡°íšŒ ì‹¤íŒ¨:', allPermissionsError);
                        throw allPermissionsError;
                    }
                    
                    const examIds = allExamPermissions.map(p => p.exam_id);
                    console.log('ğŸ“‹ ê´€ë¦¬ì - ëª¨ë“  ì‹œí—˜ IDë“¤:', examIds);
                    
                    // ëª¨ë“  ì‹œí—˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    await loadExamDetails(examIds, user);
                    return;
                }
                
                // ì¼ë°˜ ì‚¬ìš©ì ê¶Œí•œ ì¡°íšŒ
                let query = window.supabaseClient
                    .from('exam_permissions')
                    .select('exam_id');
                
                // ì¡°ê±´ì— ë”°ë¼ ì¿¼ë¦¬ êµ¬ì„±
                if (user.department_id) {
                    query = query.or(`employee_id.eq.${user.id},department_id.eq.${user.department_id}`);
                } else {
                    query = query.eq('employee_id', user.id);
                }
                
                const { data: userPermissions, error: examPermissionsError } = await query;
                
                if (examPermissionsError) throw examPermissionsError;
                
                if (!userPermissions || userPermissions.length === 0) {
                    console.log('ğŸ“‹ ì‚¬ìš©ìì—ê²Œ ê¶Œí•œì´ ìˆëŠ” ì‹œí—˜ì´ ì—†ìŠµë‹ˆë‹¤.');
                    displayExamList([], user);
                    return;
                }
                
                const examIds = userPermissions.map(p => p.exam_id);
                console.log('ğŸ“‹ ê¶Œí•œì´ ìˆëŠ” ì‹œí—˜ IDë“¤:', examIds);
                
                // ê¶Œí•œì´ ìˆëŠ” ì‹œí—˜ë“¤ì˜ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const { data: permissions, error: examError } = await window.supabaseClient
                    .from('exams')
                    .select(`
                        id,
                        title,
                        description,
                        duration,
                        status,
                        start_time,
                        end_time,
                        exam_questions(count),
                        exam_sessions!left(
                            id,
                            employee_id,
                            status,
                            score,
                            total_points
                        )
                    `)
                    .in('id', examIds)
                    .eq('status', 'published');

                if (examError) throw examError;

                console.log('ğŸ“‹ ì‘ì‹œ ê°€ëŠ¥í•œ ì‹œí—˜:', permissions);

                // ì‹œí—˜ ëª©ë¡ í‘œì‹œ
                displayExamList(permissions, user);

            } catch (error) {
                console.error('ì‹œí—˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('examList').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>ì‹œí—˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
            }
        }

        // ì‹œí—˜ ìƒì„¸ ì •ë³´ ë¡œë“œ (ê´€ë¦¬ììš©)
        async function loadExamDetails(examIds, user) {
            try {
                console.log('ğŸ” ì‹œí—˜ ìƒì„¸ ì •ë³´ ë¡œë“œ ì¤‘...');
                
                // ì‹œí—˜ë“¤ì˜ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const { data: permissions, error: examError } = await window.supabaseClient
                    .from('exams')
                    .select(`
                        id,
                        title,
                        description,
                        duration,
                        status,
                        start_time,
                        end_time,
                        exam_questions(count),
                        exam_sessions!left(
                            id,
                            employee_id,
                            status,
                            score,
                            total_points
                        )
                    `)
                    .in('id', examIds)
                    .eq('status', 'published');

                if (examError) throw examError;

                console.log('ğŸ“‹ ê´€ë¦¬ì - ì‘ì‹œ ê°€ëŠ¥í•œ ì‹œí—˜:', permissions);

                // ì‹œí—˜ ëª©ë¡ í‘œì‹œ
                displayExamList(permissions, user);
                
            } catch (error) {
                console.error('âŒ ì‹œí—˜ ìƒì„¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('examList').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>ì‹œí—˜ ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
            }
        }

        // ì ìˆ˜ ì •ë³´ ìƒì„± í•¨ìˆ˜
        function generateScoreInfo(userSession) {
            console.log('ğŸ¯ ì ìˆ˜ ì •ë³´ ìƒì„± ì‹œë„:', { 
                userSession, 
                score: userSession?.score, 
                total_points: userSession?.total_points 
            });
            
            if (!userSession || userSession.score === null || !userSession.total_points) {
                console.log('âŒ ì ìˆ˜ ì •ë³´ ìƒì„± ì‹¤íŒ¨ - ë°ì´í„° ë¶€ì¡±');
                return '';
            }
            
            // scoreê°€ ì´ë¯¸ ë°±ë¶„ìœ¨ì¸ ê²½ìš°ì™€ ì •ë‹µ ê°œìˆ˜ì¸ ê²½ìš°ë¥¼ êµ¬ë¶„
            let percentage, correctAnswers, displayScore;
            
            if (userSession.score > userSession.total_points) {
                // scoreê°€ ë°±ë¶„ìœ¨ (0-100)ì¸ ê²½ìš°
                percentage = userSession.score;
                correctAnswers = Math.round((percentage / 100) * userSession.total_points);
                displayScore = `${percentage}ì `;
            } else {
                // scoreê°€ ì •ë‹µ ê°œìˆ˜ì¸ ê²½ìš°
                correctAnswers = userSession.score;
                percentage = Math.round((correctAnswers / userSession.total_points) * 100);
                displayScore = `${correctAnswers}ì `;
            }
            
            let badgeClass = 'score-badge';
            
            if (percentage >= 90) badgeClass += ' excellent';
            else if (percentage >= 80) badgeClass += ' good';
            else if (percentage >= 60) badgeClass += ' average';
            else badgeClass += ' poor';
            
            console.log('âœ… ì ìˆ˜ ì •ë³´ ìƒì„± ì™„ë£Œ:', { 
                percentage, 
                correctAnswers, 
                total: userSession.total_points,
                displayScore 
            });
            
            return `
                <div class="exam-score-info">
                    <div class="${badgeClass}">${displayScore} (${percentage}%)</div>
                    <div class="score-detail">${correctAnswers}/${userSession.total_points} ì •ë‹µ</div>
                </div>
            `;
        }

        // ì‹œí—˜ ëª©ë¡ í‘œì‹œ
        function displayExamList(permissions, user) {
            const examList = document.getElementById('examList');
            
            if (!permissions || permissions.length === 0) {
                examList.innerHTML = `
                    <div class="no-exams">
                        <i class="fas fa-clipboard-list"></i>
                        <p>ì‘ì‹œ ê°€ëŠ¥í•œ ì‹œí—˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        <small>ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.</small>
                    </div>
                `;
                return;
            }

            const examsHtml = permissions.map(exam => {
                const questionCount = exam.exam_questions?.[0]?.count || 0;
                const userSession = exam.exam_sessions?.find(s => s.employee_id === user.id);
                
                // ì‹œí—˜ ìƒíƒœ ê²°ì •
                let status = 'available';
                let statusText = 'ì‘ì‹œ ê°€ëŠ¥';
                let statusClass = 'available';
                let buttonText = 'ì‹œí—˜ ì‹œì‘';
                let buttonClass = 'btn-primary';
                let buttonIcon = 'fas fa-play';
                let buttonAction = `startExam('${exam.id}')`;
                let scoreInfo = ''; // ì ìˆ˜ ì •ë³´ ì¶”ê°€

                if (userSession) {
                    if (userSession.status === 'graded') {
                        status = 'completed';
                        statusText = 'ì™„ë£Œ';
                        statusClass = 'completed';
                        buttonText = 'ê²°ê³¼ ë³´ê¸°';
                        buttonClass = 'btn-success';
                        buttonIcon = 'fas fa-eye';
                        buttonAction = `viewResult('${exam.id}')`;
                        scoreInfo = generateScoreInfo(userSession);
                    } else if (userSession.status === 'submitted') {
                        status = 'submitted';
                        statusText = 'ì œì¶œë¨';
                        statusClass = 'submitted';
                        buttonText = 'ê²°ê³¼ ë³´ê¸°';
                        buttonClass = 'btn-info';
                        buttonIcon = 'fas fa-eye';
                        buttonAction = `viewResult('${exam.id}')`;
                        scoreInfo = generateScoreInfo(userSession);
                    } else if (userSession.status === 'in_progress') {
                        status = 'in-progress';
                        statusText = 'ì§„í–‰ ì¤‘';
                        statusClass = 'in-progress';
                        buttonText = 'ê³„ì†í•˜ê¸°';
                        buttonClass = 'btn-warning';
                        buttonIcon = 'fas fa-play';
                        buttonAction = `continueExam('${exam.id}')`;
                    }
                }

                // ì‹œí—˜ ê¸°ê°„ ì²´í¬
                const now = new Date();
                const startTime = exam.start_time ? new Date(exam.start_time) : null;
                const endTime = exam.end_time ? new Date(exam.end_time) : null;
                
                if (startTime && now < startTime) {
                    status = 'scheduled';
                    statusText = 'ì˜ˆì •ë¨';
                    statusClass = 'scheduled';
                    buttonText = 'ì˜ˆì•½ë¨';
                    buttonClass = 'btn-secondary';
                    buttonIcon = 'fas fa-clock';
                    buttonAction = 'return false;';
                } else if (endTime && now > endTime) {
                    status = 'expired';
                    statusText = 'ì¢…ë£Œë¨';
                    statusClass = 'expired';
                    buttonText = 'ì¢…ë£Œë¨';
                    buttonClass = 'btn-secondary';
                    buttonIcon = 'fas fa-times';
                    buttonAction = 'return false;';
                }

                return `
                    <div class="exam-card" data-exam-id="${exam.id}">
                        <div class="exam-header">
                            <div>
                                <h4 class="exam-title">${exam.title}</h4>
                                <span class="exam-status ${statusClass}">${statusText}</span>
                            </div>
                            ${scoreInfo}
                        </div>
                        <p class="exam-description">
                            ${exam.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}
                        </p>
                        <div class="exam-meta">
                            <span><i class="fas fa-clock"></i> ${exam.duration}ë¶„</span>
                            <span><i class="fas fa-question-circle"></i> ${questionCount}ë¬¸í•­</span>
                            <span><i class="fas fa-calendar"></i> ${getExamTimeText(startTime, endTime)}</span>
                            <span><i class="fas fa-star"></i> ë‚œì´ë„: ${getDifficultyText(exam.difficulty)}</span>
                        </div>
                        <div class="exam-actions">
                            <button class="btn ${buttonClass}" onclick="${buttonAction}">
                                <i class="${buttonIcon}"></i> ${buttonText}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            examList.innerHTML = examsHtml;
        }

        // ì‹œí—˜ ì‹œê°„ í…ìŠ¤íŠ¸ ìƒì„±
        function getExamTimeText(startTime, endTime) {
            const now = new Date();
            
            if (startTime && endTime) {
                if (now < startTime) {
                    return `ì‹œì‘: ${formatDate(startTime)}`;
                } else if (now > endTime) {
                    return `ì¢…ë£Œ: ${formatDate(endTime)}`;
                } else {
                    return 'ì§„í–‰ ì¤‘';
                }
            } else if (startTime) {
                if (now < startTime) {
                    return `ì‹œì‘: ${formatDate(startTime)}`;
                } else {
                    return 'ì–¸ì œë“ ì§€';
                }
            } else {
                return 'ì–¸ì œë“ ì§€';
            }
        }

        // ë‚ ì§œ í¬ë§·íŒ…
        function formatDate(date) {
            if (!date) return '';
            return new Intl.DateTimeFormat('ko-KR', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).format(new Date(date));
        }

        // ë‚œì´ë„ í…ìŠ¤íŠ¸ ë³€í™˜
        function getDifficultyText(difficulty) {
            const difficultyMap = {
                1: 'ë§¤ìš° ì‰¬ì›€',
                2: 'ì‰¬ì›€', 
                3: 'ë³´í†µ',
                4: 'ì–´ë ¤ì›€',
                5: 'ë§¤ìš° ì–´ë ¤ì›€'
            };
            return difficultyMap[difficulty] || 'ë³´í†µ';
        }

        // ì‹œí—˜ ì‹œì‘ í•¨ìˆ˜ (ìˆ˜ì •ë¨)
        async function startExam(examId) {
            try {
                console.log('ğŸ¯ ì‹œí—˜ ì‹œì‘ ìš”ì²­:', examId);
                
                // ì‹œí—˜ ì •ë³´ í™•ì¸
                const { data: exam, error } = await window.supabaseClient
                    .from('exams')
                    .select('*')
                    .eq('id', examId)
                    .single();
                
                if (error) throw error;
                
                if (confirm(`"${exam.title}" ì‹œí—˜ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‹œí—˜ì´ ì‹œì‘ë˜ë©´ ì œí•œ ì‹œê°„ì´ ì ìš©ë©ë‹ˆë‹¤.`)) {
                    
                    // í•˜ë“œì½”ë”©ëœ ê´€ë¦¬ì ê³„ì •ì¸ì§€ í™•ì¸
                    if (window.semuApp.currentUser.id === '17430453-d823-45a7-8a93-8512781b183a') {
                        console.log('ğŸ”‘ í•˜ë“œì½”ë”©ëœ ê´€ë¦¬ì ê³„ì • - ì‹œí—˜ ì„¸ì…˜ ìƒì„± ì—†ì´ ë°”ë¡œ ì´ë™');
                        
                        // ì‹œí—˜ í˜ì´ì§€ë¡œ ë°”ë¡œ ì´ë™ (ì„¸ì…˜ ìƒì„± ì—†ìŒ)
                        console.log('ğŸš€ ì‹œí—˜ í˜ì´ì§€ë¡œ ì´ë™:', `./exam.html?id=${examId}`);
                        window.location.href = `./exam.html?id=${examId}`;
                        return;
                    }
                    
                    // ì¼ë°˜ ì‚¬ìš©ì ê³„ì • - ì‹œí—˜ ì„¸ì…˜ ìƒì„±
                    // ê¸°ì¡´ ì‹œí—˜ ì„¸ì…˜ í™•ì¸
                    const { data: existingSession, error: checkError } = await window.supabaseClient
                        .from('exam_sessions')
                        .select('*')
                        .eq('exam_id', examId)
                        .eq('employee_id', window.semuApp.currentUser.id)
                        .single();
                    
                    let sessionId;
                    
                    if (checkError && checkError.code === 'PGRST116') {
                        // ê¸°ì¡´ ì„¸ì…˜ì´ ì—†ëŠ” ê²½ìš° - ìƒˆë¡œ ìƒì„±
                        console.log('ğŸ†• ìƒˆë¡œìš´ ì‹œí—˜ ì„¸ì…˜ ìƒì„±');
                        const { data: newSession, error: sessionError } = await window.supabaseClient
                            .from('exam_sessions')
                            .insert([{
                                exam_id: examId,
                                employee_id: window.semuApp.currentUser.id,
                                status: 'in_progress'
                            }])
                            .select()
                            .single();
                        
                        if (sessionError) throw sessionError;
                        sessionId = newSession.id;
                        
                    } else if (checkError) {
                        // ë‹¤ë¥¸ ì˜¤ë¥˜ ë°œìƒ
                        throw checkError;
                        
                    } else {
                        // ê¸°ì¡´ ì„¸ì…˜ì´ ìˆëŠ” ê²½ìš°
                        if (existingSession.status === 'in_progress') {
                            // ì§„í–‰ ì¤‘ì¸ ì„¸ì…˜ - ê³„ì†í•˜ê¸°
                            console.log('ğŸ”„ ê¸°ì¡´ ì§„í–‰ ì¤‘ì¸ ì„¸ì…˜ ì‚¬ìš©');
                            sessionId = existingSession.id;
                        } else if (existingSession.status === 'submitted') {
                            // ì´ë¯¸ ì œì¶œëœ ì„¸ì…˜ - ì¬ì‹œë„ í™•ì¸
                            if (confirm('ì´ë¯¸ ì œì¶œëœ ì‹œí—˜ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì‘ì‹œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê¸°ì¡´ ì ìˆ˜ëŠ” ìœ ì§€ë©ë‹ˆë‹¤.')) {
                                // ìƒˆë¡œìš´ ì„¸ì…˜ ìƒì„±
                                const { data: newSession, error: sessionError } = await window.supabaseClient
                                    .from('exam_sessions')
                                    .insert([{
                                        exam_id: examId,
                                        employee_id: window.semuApp.currentUser.id,
                                        status: 'in_progress'
                                    }])
                                    .select()
                                    .single();
                                
                                if (sessionError) throw sessionError;
                                sessionId = newSession.id;
                            } else {
                                return; // ì·¨ì†Œ
                            }
                        }
                    }
                    
                // ì‹œí—˜ í˜ì´ì§€ë¡œ ì´ë™
                    console.log('ğŸš€ ì‹œí—˜ í˜ì´ì§€ë¡œ ì´ë™:', `./exam.html?id=${examId}`);
                    window.location.href = `./exam.html?id=${examId}`;
                }
                
            } catch (error) {
                console.error('ì‹œí—˜ ì‹œì‘ ì˜¤ë¥˜:', error);
                
                if (error.code === '23505') {
                    alert('ì´ë¯¸ ì§„í–‰ ì¤‘ì¸ ì‹œí—˜ì´ ìˆìŠµë‹ˆë‹¤. ì‹œí—˜ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                window.location.href = `./exam.html?id=${examId}`;
                } else {
                    alert('ì‹œí—˜ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            }
        }

        // ì‹œí—˜ ê²°ê³¼ ë³´ê¸°
        function viewResult(examId) {
            window.location.href = `./results.html?exam=${examId}`;
        }

        // ìµœê·¼ ì‹œí—˜ ê²°ê³¼ ë³´ê¸°
        async function showLatestResult() {
            try {
                const user = window.semuApp?.currentUser;
                if (!user) {
                    showAlert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
                    return;
                }

                console.log('ğŸ” ìµœê·¼ ì‹œí—˜ ê²°ê³¼ ì¡°íšŒ ì¤‘...');

                // ì‚¬ìš©ìì˜ ê°€ì¥ ìµœê·¼ ì œì¶œëœ ì‹œí—˜ ì„¸ì…˜ ì¡°íšŒ
                const { data: latestSession, error } = await window.supabaseClient
                    .from('exam_sessions')
                    .select('exam_id, submit_time')
                    .eq('employee_id', user.id)
                    .eq('status', 'submitted')
                    .order('submit_time', { ascending: false })
                    .limit(1)
                    .single();

                if (error || !latestSession) {
                    showAlert('ì•„ì§ ì œì¶œëœ ì‹œí—˜ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.', 'info');
                    return;
                }

                // í•´ë‹¹ ì‹œí—˜ì˜ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = `./results.html?exam=${latestSession.exam_id}`;

            } catch (error) {
                console.error('âŒ ìµœê·¼ ì‹œí—˜ ê²°ê³¼ ì¡°íšŒ ì‹¤íŒ¨:', error);
                showAlert('ì‹œí—˜ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì‹œí—˜ ê³„ì†í•˜ê¸°
        function continueExam(examId) {
            // ê¸°ì¡´ ì„¸ì…˜ ì°¾ê¸°
            window.location.href = `./exam.html?id=${examId}`;
        }
    </script>
</body>
</html>
